<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Produtividade Judicial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .realtime-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        .status-pendente { background-color: #fef3c7; color: #92400e; }
        .status-assinada { background-color: #d1fae5; color: #065f46; }
        .status-excluida { background-color: #fee2e2; color: #991b1b; }
        .status-correcao { background-color: #dbeafe; color: #1e40af; }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Indicador de Conex√£o -->
    <div id="connection-status" class="realtime-indicator no-print">
        <div class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center">
            <div class="w-2 h-2 bg-white rounded-full mr-2 pulse"></div>
            Conectado
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="mx-auto h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="scale" class="h-8 w-8 text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Sistema de Produtividade Judicial</h1>
                <p class="text-gray-600">Digite suas credenciais para acessar</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio</label>
                    <select id="login-usuario" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione o usu√°rio</option>
                        <option value="juiz">Juiz</option>
                        <option value="gilbert">Gilbert Juliano</option>
                        <option value="laise">La√≠se Vital</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="login-senha" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite sua senha">
                </div>
                
                <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                    <i data-lucide="log-in" class="h-5 w-5 mr-2 inline"></i>
                    Entrar
                </button>
            </div>
        </div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="main-app" class="hidden p-4 max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Sistema de Produtividade Judicial</h1>
                    <p id="user-info" class="text-gray-600"></p>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors flex items-center">
                    <i data-lucide="log-out" class="h-4 w-4 mr-2"></i>
                    Sair
                </button>
            </div>
            
            <!-- Navega√ß√£o -->
            <div id="navigation" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-12 no-print">
            <div class="loading-spinner"></div>
            <p class="text-gray-600 mt-4">Carregando dados...</p>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-view" class="hidden space-y-6"></div>

        <!-- Registro -->
        <div id="registro-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-6">
                    <i data-lucide="plus" class="h-6 w-6 text-blue-600 mr-2"></i>
                    <h2 class="text-xl font-semibold text-gray-800">Registrar Nova Minuta</h2>
                </div>
                
                <div id="registro-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Processo</label>
                        <input type="text" id="numero-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 1234567-89.2024.8.12.3456">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Minuta</label>
                        <select id="tipo-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione o tipo</option>
                            <option value="Despacho">Despacho</option>
                            <option value="Decis√£o">Decis√£o</option>
                            <option value="Senten√ßa">Senten√ßa</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <select id="categoria-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione a categoria</option>
                            <option value="meta1">Meta 1 CNJ</option>
                            <option value="sem_movimento">Sem movimenta√ß√£o 100+ dias</option>
                            <option value="outros">Pedidos/Atos/Urgentes</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                        <textarea id="observacoes-minuta" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Coment√°rios sobre a minuta (opcional)"></textarea>
                    </div>
                    
                    <button onclick="registrarMinuta()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                        Registrar Minuta
                    </button>
                </div>
            </div>
        </div>

        <!-- Hist√≥rico -->
        <div id="historico-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="clock" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Hist√≥rico de Minutas</h2>
                    </div>
                    <div class="flex gap-2">
                        <select id="filtro-assessor" class="border border-gray-300 rounded-md px-3 py-1 text-sm no-print">
                            <option value="">Todos os assessores</option>
                            <option value="gilbert">Gilbert Juliano</option>
                            <option value="laise">La√≠se Vital</option>
                        </select>
                        <select id="filtro-status" class="border border-gray-300 rounded-md px-3 py-1 text-sm no-print">
                            <option value="">Todos os status</option>
                            <option value="pendente">Pendente</option>
                            <option value="assinada">Assinada</option>
                            <option value="excluida">Exclu√≠da</option>
                            <option value="correcao">Precisa Corre√ß√£o</option>
                        </select>
                    </div>
                </div>
                <div id="historico-content"></div>
            </div>
        </div>

        <!-- Modal de Edi√ß√£o -->
        <div id="modal-edicao" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 no-print" onclick="event.target === this && fecharModalEdicao()">
            <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-800">Editar Minuta</h3>
                    <button onclick="fecharModalEdicao()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="h-5 w-5"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Processo</label>
                        <input type="text" id="edit-numero-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Minuta</label>
                        <select id="edit-tipo-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="Despacho">Despacho</option>
                            <option value="Decis√£o">Decis√£o</option>
                            <option value="Senten√ßa">Senten√ßa</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                        <select id="edit-categoria-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="meta1">Meta 1 CNJ</option>
                            <option value="sem_movimento">Sem movimenta√ß√£o 100+ dias</option>
                            <option value="outros">Pedidos/Atos/Urgentes</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                        <textarea id="edit-observacoes-minuta" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                    </div>
                    
                    <div class="flex gap-2 pt-4">
                        <button onclick="salvarEdicao()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors" title="Ctrl+Enter">
                            Salvar Altera√ß√µes
                        </button>
                        <button onclick="fecharModalEdicao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors" title="ESC">
                            Cancelar
                        </button>
                    </div>
                    
                    <div class="text-xs text-gray-500 text-center mt-2">
                        <span class="mr-4">üí° <strong>Ctrl+Enter:</strong> Salvar</span>
                        <span><strong>ESC:</strong> Cancelar</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios -->
        <div id="relatorios-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="bar-chart" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Relat√≥rios de Produtividade</h2>
                    </div>
                    <div class="flex gap-2 no-print">
                        <button onclick="gerarRelatorio('semanal')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm">
                            Relat√≥rio Semanal
                        </button>
                        <button onclick="gerarRelatorio('mensal')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors text-sm">
                            Relat√≥rio Mensal
                        </button>
                        <button onclick="limparDadosInconsistentes()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors text-sm">
                            Limpar Dados
                        </button>
                        <button onclick="window.print()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm">
                            <i data-lucide="printer" class="h-4 w-4 mr-1 inline"></i>
                            Imprimir
                        </button>
                    </div>
                </div>
                <div id="relatorio-content"></div>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCzuoRgbvKQSjOFssde-qUEtNDqGNJML7E",
            authDomain: "produtividade-gabinete.firebaseapp.com",
            databaseURL: "https://produtividade-gabinete-default-rtdb.firebaseio.com",
            projectId: "produtividade-gabinete",
            storageBucket: "produtividade-gabinete.firebasestorage.app",
            messagingSenderId: "370364917935",
            appId: "1:370364917935:web:a6205cc718748abcbdcc5a"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        lucide.createIcons();

        // Credenciais de acesso
        const credenciais = {
            'juiz': { senha: 'Juiz@2024!', nome: 'Juiz', tipo: 'juiz' },
            'gilbert': { senha: 'Gilbert@2024!', nome: 'Gilbert Juliano', tipo: 'assessor', assessorId: 'gilbert' },
            'laise': { senha: 'Laise@2024!', nome: 'La√≠se Vital', tipo: 'assessor', assessorId: 'laise' }
        };

        // Estado da aplica√ß√£o
        let currentUser = null;
        let currentView = 'dashboard';
        let minutas = {};
        let minutaEditando = null;

        let assessores = {
            gilbert: { nome: 'Gilbert Juliano', ativo: true },
            laise: { nome: 'La√≠se Vital', ativo: true }
        };

        const categorias = {
            'meta1': { nome: 'Meta 1 CNJ', cor: 'bg-red-500', meta: 2 },
            'sem_movimento': { nome: 'Sem movimenta√ß√£o 100+ dias', cor: 'bg-orange-500', meta: 5 },
            'outros': { nome: 'Pedidos/Atos/Urgentes', cor: 'bg-blue-500', meta: 3 }
        };

        const statusOptions = {
            'pendente': { nome: 'Pendente', cor: 'status-pendente' },
            'assinada': { nome: 'Assinada', cor: 'status-assinada' },
            'excluida': { nome: 'Exclu√≠da', cor: 'status-excluida' },
            'correcao': { nome: 'Precisa Corre√ß√£o', cor: 'status-correcao' }
        };

        // Utilit√°rios
        function isDiaUtil(data) {
            const dia = data.getDay();
            return dia >= 1 && dia <= 5;
        }

        function getHojeString() {
            return new Date().toISOString().split('T')[0];
        }

        function getMinutasHoje(assessorId) {
            return Object.values(minutas).filter(m => {
                // Compatibilidade com dados antigos e novos
                const assessorMatch = m.assessorId === assessorId || 
                                    (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || m.assessorNome === 'Gilbert Juliano')) ||
                                    (assessorId === 'laise' && (m.assessorId === 'assessor2' || m.assessorNome === 'La√≠se Vital'));
                
                return assessorMatch && m.data === getHojeString();
            });
        }

        function getProgressoCategoria(assessorId, categoria) {
            const minutasHoje = getMinutasHoje(assessorId);
            const count = minutasHoje.filter(m => m.categoria === categoria).length;
            const meta = categorias[categoria].meta;
            return { atual: count, meta, percentual: Math.min((count / meta) * 100, 100) };
        }

        function getProgressoTotal(assessorId) {
            const minutasHoje = getMinutasHoje(assessorId);
            const total = minutasHoje.length;
            const meta = 10;
            return { atual: total, meta, percentual: Math.min((total / meta) * 100, 100) };
        }

        // Autentica√ß√£o
        function fazerLogin() {
            const usuario = document.getElementById('login-usuario').value;
            const senha = document.getElementById('login-senha').value;

            if (!usuario || !senha) {
                alert('Por favor, selecione o usu√°rio e digite a senha.');
                return;
            }

            const cred = credenciais[usuario];
            if (!cred || cred.senha !== senha) {
                alert('Usu√°rio ou senha incorretos.');
                return;
            }

            currentUser = {
                usuario: usuario,
                nome: cred.nome,
                tipo: cred.tipo,
                isJuiz: cred.tipo === 'juiz',
                assessorId: cred.assessorId
            };

            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            initializeApp();
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-usuario').value = '';
            document.getElementById('login-senha').value = '';
        }

        // Inicializa√ß√£o da aplica√ß√£o
        function initializeApp() {
            setupUserInfo();
            setupNavigation();
            setupFirebaseListeners();
            showView('dashboard');
        }

        function setupUserInfo() {
            document.getElementById('user-info').textContent = 
                `Logado como: ${currentUser.nome}`;
        }

        function setupNavigation() {
            const nav = document.getElementById('navigation');
            let buttons = '';

            buttons += `
                <button onclick="showView('dashboard')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-blue-600 text-white">
                    <i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i>
                    Dashboard
                </button>
            `;

            if (!currentUser.isJuiz) {
                buttons += `
                    <button onclick="showView('registro')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                        Registrar Minuta
                    </button>
                `;
            }

            buttons += `
                <button onclick="showView('historico')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
                    Hist√≥rico
                </button>
            `;

            if (currentUser.isJuiz) {
                buttons += `
                    <button onclick="showView('relatorios')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="bar-chart" class="h-4 w-4 mr-2"></i>
                        Relat√≥rios
                    </button>
                `;
            }

            nav.innerHTML = buttons;
            lucide.createIcons();
        }

        function showView(view) {
            document.querySelectorAll('[id$="-view"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('loading').classList.add('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = 'nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200';
            });
            
            const activeBtn = event?.target.closest('button');
            if (activeBtn) {
                activeBtn.className = 'nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-blue-600 text-white';
            }

            currentView = view;
            
            if (view === 'dashboard') {
                renderDashboard();
            } else if (view === 'registro') {
                document.getElementById('registro-view').classList.remove('hidden');
            } else if (view === 'historico') {
                setupHistoricoFilters();
                renderHistorico();
            } else if (view === 'relatorios') {
                document.getElementById('relatorios-view').classList.remove('hidden');
            }
        }

        // Firebase
        function setupFirebaseListeners() {
            document.getElementById('loading').classList.add('hidden');
            
            try {
                database.ref('minutas').on('value', (snapshot) => {
                    const firebaseMinutas = snapshot.val() || {};
                    minutas = firebaseMinutas;
                    if (currentView === 'dashboard') renderDashboard();
                    if (currentView === 'historico') renderHistorico();
                });

                database.ref('assessores').on('value', (snapshot) => {
                    const assessoresFirebase = snapshot.val();
                    if (assessoresFirebase) {
                        assessores = { ...assessores, ...assessoresFirebase };
                    }
                });

                database.ref('assessores').once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        database.ref('assessores').set({
                            gilbert: { nome: 'Gilbert Juliano', ativo: true },
                            laise: { nome: 'La√≠se Vital', ativo: true }
                        });
                    }
                });

                database.ref('.info/connected').on('value', (snapshot) => {
                    const connected = snapshot.val();
                    const statusDiv = document.getElementById('connection-status');
                    
                    if (connected) {
                        statusDiv.innerHTML = `
                            <div class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center">
                                <div class="w-2 h-2 bg-white rounded-full mr-2 pulse"></div>
                                Online
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div class="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center">
                                <div class="w-2 h-2 bg-white rounded-full mr-2"></div>
                                Offline
                            </div>
                        `;
                    }
                });

            } catch (error) {
                document.getElementById('connection-status').innerHTML = `
                    <div class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium">
                        Modo Local
                    </div>
                `;
            }
            
            renderDashboard();
        }

        function registrarMinuta() {
            const numeroProcesso = document.getElementById('numero-processo').value;
            const tipoMinuta = document.getElementById('tipo-minuta').value;
            const categoria = document.getElementById('categoria-minuta').value;
            const observacoes = document.getElementById('observacoes-minuta').value;

            if (!numeroProcesso || !tipoMinuta || !categoria) {
                alert('Por favor, preencha os campos obrigat√≥rios.');
                return;
            }

            const novaMinuta = {
                assessorId: currentUser.assessorId,
                assessorNome: currentUser.nome,
                numeroProcesso,
                tipoMinuta,
                categoria,
                observacoes: observacoes || '',
                status: 'pendente',
                data: getHojeString(),
                timestamp: new Date().toLocaleTimeString(),
                createdAt: Date.now()
            };

            try {
                const minutaComTimestamp = {
                    ...novaMinuta,
                    createdAt: firebase.database.ServerValue.TIMESTAMP
                };
                
                database.ref('minutas').push(minutaComTimestamp)
                    .then(() => {
                        limparFormularioRegistro();
                        alert('Minuta registrada com sucesso!');
                        showView('dashboard');
                    })
                    .catch((error) => {
                        salvarMinutaLocal(novaMinuta);
                    });
            } catch (error) {
                salvarMinutaLocal(novaMinuta);
            }
        }

        function salvarMinutaLocal(minuta) {
            const id = 'local_' + Date.now();
            minutas[id] = minuta;
            
            limparFormularioRegistro();
            alert('Minuta registrada localmente!');
            showView('dashboard');
        }

        function limparFormularioRegistro() {
            document.getElementById('numero-processo').value = '';
            document.getElementById('tipo-minuta').value = '';
            document.getElementById('categoria-minuta').value = '';
            document.getElementById('observacoes-minuta').value = '';
        }

        function atualizarStatus(minutaId, novoStatus) {
            if (!currentUser.isJuiz) return;

            try {
                database.ref(`minutas/${minutaId}/status`).set(novoStatus)
                    .then(() => {
                        minutas[minutaId].status = novoStatus;
                        renderHistorico();
                    });
            } catch (error) {
                minutas[minutaId].status = novoStatus;
                renderHistorico();
            }
        }

        function editarMinuta(minutaId) {
            if (currentUser.isJuiz) return;

            const minuta = minutas[minutaId];
            if (!minuta) return;

            // Verificar se a minuta pertence ao assessor atual
            const isOwner = minuta.assessorId === currentUser.assessorId || 
                          (currentUser.assessorId === 'gilbert' && (minuta.assessorId === 'assessor1' || minuta.assessorNome === 'Gilbert Juliano')) ||
                          (currentUser.assessorId === 'laise' && (minuta.assessorId === 'assessor2' || minuta.assessorNome === 'La√≠se Vital'));

            if (!isOwner) {
                alert('Voc√™ s√≥ pode editar suas pr√≥prias minutas.');
                return;
            }

            minutaEditando = { id: minutaId, ...minuta };

            // Preencher formul√°rio de edi√ß√£o
            document.getElementById('edit-numero-processo').value = minuta.numeroProcesso || '';
            document.getElementById('edit-tipo-minuta').value = minuta.tipoMinuta || '';
            document.getElementById('edit-categoria-minuta').value = minuta.categoria || '';
            document.getElementById('edit-observacoes-minuta').value = minuta.observacoes || '';

            // Mostrar modal
            document.getElementById('modal-edicao').classList.remove('hidden');
            lucide.createIcons();
        }

        function fecharModalEdicao() {
            document.getElementById('modal-edicao').classList.add('hidden');
            minutaEditando = null;
        }

        function salvarEdicao() {
            if (!minutaEditando) return;

            const numeroProcesso = document.getElementById('edit-numero-processo').value;
            const tipoMinuta = document.getElementById('edit-tipo-minuta').value;
            const categoria = document.getElementById('edit-categoria-minuta').value;
            const observacoes = document.getElementById('edit-observacoes-minuta').value;

            if (!numeroProcesso || !tipoMinuta || !categoria) {
                alert('Por favor, preencha os campos obrigat√≥rios.');
                return;
            }

            const minutaAtualizada = {
                ...minutaEditando,
                numeroProcesso,
                tipoMinuta,
                categoria,
                observacoes,
                editadaEm: new Date().toLocaleString('pt-BR')
            };

            try {
                database.ref(`minutas/${minutaEditando.id}`).set(minutaAtualizada)
                    .then(() => {
                        minutas[minutaEditando.id] = minutaAtualizada;
                        fecharModalEdicao();
                        renderHistorico();
                        renderDashboard();
                        alert('Minuta atualizada com sucesso!');
                    })
                    .catch(() => {
                        minutas[minutaEditando.id] = minutaAtualizada;
                        fecharModalEdicao();
                        renderHistorico();
                        renderDashboard();
                        alert('Minuta atualizada localmente!');
                    });
            } catch (error) {
                minutas[minutaEditando.id] = minutaAtualizada;
                fecharModalEdicao();
                renderHistorico();
                renderDashboard();
                alert('Minuta atualizada localmente!');
            }
        }

        function excluirMinuta(minutaId) {
            if (currentUser.isJuiz) return;

            const minuta = minutas[minutaId];
            if (!minuta) return;

            // Verificar se a minuta pertence ao assessor atual
            const isOwner = minuta.assessorId === currentUser.assessorId || 
                          (currentUser.assessorId === 'gilbert' && (minuta.assessorId === 'assessor1' || minuta.assessorNome === 'Gilbert Juliano')) ||
                          (currentUser.assessorId === 'laise' && (minuta.assessorId === 'assessor2' || minuta.assessorNome === 'La√≠se Vital'));

            if (!isOwner) {
                alert('Voc√™ s√≥ pode excluir suas pr√≥prias minutas.');
                return;
            }

            if (!confirm('Tem certeza que deseja excluir esta minuta? Esta a√ß√£o n√£o pode ser desfeita.')) {
                return;
            }

            try {
                database.ref(`minutas/${minutaId}`).remove()
                    .then(() => {
                        delete minutas[minutaId];
                        renderHistorico();
                        renderDashboard();
                        alert('Minuta exclu√≠da com sucesso!');
                    })
                    .catch(() => {
                        delete minutas[minutaId];
                        renderHistorico();
                        renderDashboard();
                        alert('Minuta exclu√≠da localmente!');
                    });
            } catch (error) {
                delete minutas[minutaId];
                renderHistorico();
                renderDashboard();
                alert('Minuta exclu√≠da localmente!');
            }
        }

        // Renderiza√ß√£o
        function renderDashboard() {
            const dashboard = document.getElementById('dashboard-view');
            const hoje = new Date();
            
            if (!isDiaUtil(hoje)) {
                dashboard.innerHTML = `
                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                        <i data-lucide="calendar" class="mx-auto h-12 w-12 text-yellow-500 mb-4"></i>
                        <h3 class="text-lg font-semibold text-yellow-800 mb-2">Fim de Semana</h3>
                        <p class="text-yellow-700">Hoje n√£o √© um dia √∫til. O controle de produtividade ser√° retomado na pr√≥xima segunda-feira.</p>
                    </div>
                    ${renderAssessoresCards()}
                `;
            } else {
                const totalMinutasHoje = Object.values(minutas).filter(m => m.data === getHojeString()).length;
                const metaTotal = 20;

                dashboard.innerHTML = `
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">Produtividade do Dia</h2>
                                <p class="text-blue-100">
                                    ${hoje.toLocaleDateString('pt-BR', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    })}
                                </p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold">${totalMinutasHoje}/${metaTotal}</div>
                                <div class="text-blue-100">minutas produzidas</div>
                            </div>
                        </div>
                    </div>
                    ${renderAssessoresCards()}
                `;
            }
            
            dashboard.classList.remove('hidden');
            lucide.createIcons();
        }

        function renderAssessoresCards() {
            if (currentUser.isJuiz) {
                return `
                    <div class="grid md:grid-cols-2 gap-6">
                        ${renderAssessorCard('gilbert')}
                        ${renderAssessorCard('laise')}
                    </div>
                `;
            } else {
                return `
                    <div class="max-w-md mx-auto">
                        ${renderAssessorCard(currentUser.assessorId)}
                    </div>
                `;
            }
        }

        function renderAssessorCard(assessorId) {
            const assessor = assessores[assessorId];
            const progressoTotal = getProgressoTotal(assessorId);
            const minutasHoje = getMinutasHoje(assessorId);
            
            let categoriasHtml = '';
            Object.entries(categorias).forEach(([key, cat]) => {
                const progresso = getProgressoCategoria(assessorId, key);
                categoriasHtml += `
                    <div>
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>${cat.nome}</span>
                            <span>${progresso.atual}/${progresso.meta}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="${cat.cor} h-3 rounded-full transition-all duration-300" style="width: ${progresso.percentual}%"></div>
                        </div>
                    </div>
                `;
            });

            let ultimasMinutasHtml = '';
            if (minutasHoje.length > 0) {
                const ultimasMinutas = minutasHoje.slice(-3).reverse();
                ultimasMinutasHtml = `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">√öltimas minutas</h4>
                        <div class="space-y-1 max-h-32 overflow-y-auto">
                            ${ultimasMinutas.map(minuta => `
                                <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded ${minuta.editadaEm ? 'border-l-2 border-orange-400' : ''}">
                                    <div class="font-medium flex items-center gap-1">
                                        ${minuta.numeroProcesso}
                                        ${minuta.editadaEm ? '<span class="text-orange-600" title="Minuta editada">‚úèÔ∏è</span>' : ''}
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span>${minuta.tipoMinuta} - ${categorias[minuta.categoria].nome}</span>
                                        <span class="status-badge ${statusOptions[minuta.status].cor}">${statusOptions[minuta.status].nome}</span>
                                    </div>
                                    <div class="text-gray-500">${minuta.timestamp}</div>
                                    ${minuta.editadaEm ? `<div class="text-xs text-orange-600">Editada: ${minuta.editadaEm}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            return `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">${assessor.nome}</h3>
                        <div class="px-3 py-1 rounded-full text-sm font-medium ${
                            progressoTotal.atual >= 10 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                        }">
                            ${progressoTotal.atual}/10 minutas
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Progresso Di√°rio</span>
                            <span>${Math.round(progressoTotal.percentual)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="${progressoTotal.atual >= 10 ? 'bg-green-500' : 'bg-blue-500'} h-3 rounded-full transition-all duration-300" style="width: ${progressoTotal.percentual}%"></div>
                        </div>
                    </div>
                    
                    <div class="space-y-3">
                        ${categoriasHtml}
                    </div>
                    
                    ${ultimasMinutasHtml}
                </div>
            `;
        }

        function setupHistoricoFilters() {
            const filtroAssessor = document.getElementById('filtro-assessor');
            const filtroStatus = document.getElementById('filtro-status');
            
            if (currentUser.isJuiz) {
                filtroAssessor.style.display = 'block';
                filtroStatus.style.display = 'block';
            } else {
                filtroAssessor.style.display = 'none';
                filtroStatus.style.display = 'none';
            }

            filtroAssessor.onchange = renderHistorico;
            filtroStatus.onchange = renderHistorico;
        }

        function renderHistorico() {
            const historico = document.getElementById('historico-view');
            const minutasArray = Object.entries(minutas).map(([key, minuta]) => ({
                ...minuta,
                id: key
            })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
            
            let minutasFiltradas = minutasArray;

            // Filtros
            if (currentUser.isJuiz) {
                const filtroAssessor = document.getElementById('filtro-assessor').value;
                const filtroStatus = document.getElementById('filtro-status').value;
                
                if (filtroAssessor) {
                    minutasFiltradas = minutasFiltradas.filter(m => {
                        // Compatibilidade com dados antigos e novos
                        return m.assessorId === filtroAssessor || 
                               (filtroAssessor === 'gilbert' && (m.assessorId === 'assessor1' || m.assessorNome === 'Gilbert Juliano')) ||
                               (filtroAssessor === 'laise' && (m.assessorId === 'assessor2' || m.assessorNome === 'La√≠se Vital'));
                    });
                }
                if (filtroStatus) {
                    minutasFiltradas = minutasFiltradas.filter(m => m.status === filtroStatus);
                }
            } else {
                minutasFiltradas = minutasFiltradas.filter(m => {
                    // Compatibilidade para assessores
                    return m.assessorId === currentUser.assessorId || 
                           (currentUser.assessorId === 'gilbert' && (m.assessorId === 'assessor1' || m.assessorNome === 'Gilbert Juliano')) ||
                           (currentUser.assessorId === 'laise' && (m.assessorId === 'assessor2' || m.assessorNome === 'La√≠se Vital'));
                });
            }
            
            let content = '';
            if (minutasFiltradas.length === 0) {
                content = `
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="file-text" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                        <p>Nenhuma minuta encontrada.</p>
                    </div>
                `;
            } else {
                content = `
                    <div class="space-y-3">
                        ${minutasFiltradas.map(minuta => {
                            const categoria = categorias[minuta.categoria];
                            const status = statusOptions[minuta.status];
                            
                            return `
                                <div class="border border-gray-200 rounded-lg p-4">
                                    <div class="flex items-start justify-between">
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-2">
                                                <span class="font-medium text-gray-800">${minuta.assessorNome || assessores[minuta.assessorId]?.nome}</span>
                                                <span class="px-2 py-1 rounded-full text-xs font-medium ${categoria.cor} text-white">
                                                    ${categoria.nome}
                                                </span>
                                                <span class="status-badge ${status.cor}">${status.nome}</span>
                                                ${minuta.editadaEm ? '<span class="text-xs text-orange-600">(Editada)</span>' : ''}
                                            </div>
                                            <div class="text-sm text-gray-600 mb-2">
                                                <div><strong>Processo:</strong> ${minuta.numeroProcesso}</div>
                                                <div><strong>Tipo:</strong> ${minuta.tipoMinuta}</div>
                                                ${minuta.observacoes ? `<div><strong>Observa√ß√µes:</strong> ${minuta.observacoes}</div>` : ''}
                                                ${minuta.editadaEm ? `<div class="text-xs text-gray-500"><strong>Editada em:</strong> ${minuta.editadaEm}</div>` : ''}
                                            </div>
                                            ${currentUser.isJuiz ? `
                                                <div class="flex gap-2 mt-2">
                                                    <button onclick="atualizarStatus('${minuta.id}', 'assinada')" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200">Assinada</button>
                                                    <button onclick="atualizarStatus('${minuta.id}', 'correcao')" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200">Corre√ß√£o</button>
                                                    <button onclick="atualizarStatus('${minuta.id}', 'excluida')" class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200">Excluir</button>
                                                </div>
                                            ` : `
                                                <div class="flex gap-2 mt-2">
                                                    <button onclick="editarMinuta('${minuta.id}')" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 flex items-center">
                                                        <i data-lucide="edit-2" class="h-3 w-3 mr-1"></i>Editar
                                                    </button>
                                                    <button onclick="excluirMinuta('${minuta.id}')" class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200 flex items-center">
                                                        <i data-lucide="trash-2" class="h-3 w-3 mr-1"></i>Excluir
                                                    </button>
                                                </div>
                                            `}
                                        </div>
                                        <div class="text-xs text-gray-500 text-right">
                                            <div>${new Date(minuta.data).toLocaleDateString('pt-BR')}</div>
                                            <div>${minuta.timestamp}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            document.getElementById('historico-content').innerHTML = content;
            historico.classList.remove('hidden');
            lucide.createIcons();
        }

        function gerarRelatorio(tipo) {
            const hoje = new Date();
            let dataInicio, dataFim, titulo;
            
            if (tipo === 'semanal') {
                const inicioSemana = new Date(hoje.setDate(hoje.getDate() - hoje.getDay() + 1));
                const fimSemana = new Date(hoje.setDate(hoje.getDate() - hoje.getDay() + 7));
                dataInicio = inicioSemana.toISOString().split('T')[0];
                dataFim = fimSemana.toISOString().split('T')[0];
                titulo = `Relat√≥rio Semanal (${inicioSemana.toLocaleDateString('pt-BR')} - ${fimSemana.toLocaleDateString('pt-BR')})`;
            } else {
                const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                dataInicio = inicioMes.toISOString().split('T')[0];
                dataFim = fimMes.toISOString().split('T')[0];
                titulo = `Relat√≥rio Mensal (${inicioMes.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })})`;
            }

            const minutasPeriodo = Object.values(minutas).filter(m => 
                m.data >= dataInicio && m.data <= dataFim
            );

            const estatisticas = {};
            ['gilbert', 'laise'].forEach(assessorId => {
                const minutasAssessor = minutasPeriodo.filter(m => {
                    // Compatibilidade com dados antigos e novos
                    return m.assessorId === assessorId || 
                           (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || m.assessorNome === 'Gilbert Juliano')) ||
                           (assessorId === 'laise' && (m.assessorId === 'assessor2' || m.assessorNome === 'La√≠se Vital'));
                });
                
                estatisticas[assessorId] = {
                    nome: assessores[assessorId].nome,
                    total: minutasAssessor.length,
                    porCategoria: {
                        meta1: minutasAssessor.filter(m => m.categoria === 'meta1').length,
                        sem_movimento: minutasAssessor.filter(m => m.categoria === 'sem_movimento').length,
                        outros: minutasAssessor.filter(m => m.categoria === 'outros').length
                    },
                    porStatus: {
                        assinada: minutasAssessor.filter(m => m.status === 'assinada').length,
                        pendente: minutasAssessor.filter(m => m.status === 'pendente').length,
                        correcao: minutasAssessor.filter(m => m.status === 'correcao').length,
                        excluida: minutasAssessor.filter(m => m.status === 'excluida').length
                    }
                };
            });

            const relatorioHtml = `
                <div class="space-y-6">
                    <div class="text-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-800">${titulo}</h2>
                        <p class="text-gray-600">Gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-6">
                        ${Object.entries(estatisticas).map(([assessorId, stats]) => `
                            <div class="bg-gray-50 rounded-lg p-6">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">${stats.nome}</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span>Total de Minutas:</span>
                                        <span class="font-semibold">${stats.total}</span>
                                    </div>
                                    <div class="border-t pt-2">
                                        <h4 class="font-medium text-gray-700 mb-2">Por Categoria:</h4>
                                        <div class="space-y-1 text-sm">
                                            <div class="flex justify-between">
                                                <span>Meta 1 CNJ:</span>
                                                <span>${stats.porCategoria.meta1}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Sem movimenta√ß√£o 100+ dias:</span>
                                                <span>${stats.porCategoria.sem_movimento}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Pedidos/Atos/Urgentes:</span>
                                                <span>${stats.porCategoria.outros}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="border-t pt-2">
                                        <h4 class="font-medium text-gray-700 mb-2">Por Status:</h4>
                                        <div class="space-y-1 text-sm">
                                            <div class="flex justify-between">
                                                <span>Assinadas:</span>
                                                <span class="text-green-600 font-medium">${stats.porStatus.assinada}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Pendentes:</span>
                                                <span class="text-yellow-600 font-medium">${stats.porStatus.pendente}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Precisam Corre√ß√£o:</span>
                                                <span class="text-blue-600 font-medium">${stats.porStatus.correcao}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span>Exclu√≠das:</span>
                                                <span class="text-red-600 font-medium">${stats.porStatus.excluida}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="bg-blue-50 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Resumo Geral</h3>
                        <div class="grid md:grid-cols-3 gap-4 text-center">
                            <div>
                                <div class="text-2xl font-bold text-blue-600">${minutasPeriodo.length}</div>
                                <div class="text-sm text-gray-600">Total de Minutas</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-green-600">${minutasPeriodo.filter(m => m.status === 'assinada').length}</div>
                                <div class="text-sm text-gray-600">Minutas Assinadas</div>
                            </div>
                            <div>
                                <div class="text-2xl font-bold text-yellow-600">${minutasPeriodo.filter(m => m.status === 'pendente').length}</div>
                                <div class="text-sm text-gray-600">Minutas Pendentes</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('relatorio-content').innerHTML = relatorioHtml;
        }

        function limparDadosInconsistentes() {
            if (!currentUser.isJuiz) return;
            
            if (confirm('Deseja limpar dados inconsistentes? Esta a√ß√£o n√£o pode ser desfeita.')) {
                try {
                    // Remover dados demo e inconsistentes
                    Object.keys(minutas).forEach(id => {
                        if (id.startsWith('demo') || !minutas[id].assessorNome) {
                            database.ref(`minutas/${id}`).remove();
                        }
                    });
                    alert('Dados inconsistentes removidos!');
                } catch (error) {
                    console.error('Erro ao limpar dados:', error);
                }
            }
        }

        // Inicializar aplica√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
            
            // Atalhos de teclado
            document.addEventListener('keydown', function(e) {
                // ESC para fechar modal
                if (e.key === 'Escape' && !document.getElementById('modal-edicao').classList.contains('hidden')) {
                    fecharModalEdicao();
                }
                
                // Ctrl+Enter para salvar edi√ß√£o
                if (e.ctrlKey && e.key === 'Enter' && !document.getElementById('modal-edicao').classList.contains('hidden')) {
                    salvarEdicao();
                }
            });
        });
    </script>
</body>
</html>
