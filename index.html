<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Produtividade Judicial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        // ==================== HISTÓRICO ====================
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-pendente { background-color: #fef3c7; color: #92400e; }
        .status-assinada { background-color: #d1fae5; color: #065f46; }
        .status-excluida { background-color: #fee2e2; color: #991b1b; }
        .status-correcao { background-color: #dbeafe; color: #1e40af; }
        .status-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
        .calendar-day {
            min-height: 40px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px;
        }
        .calendar-day:hover {
            background-color: #f3f4f6;
        }
        .calendar-day.today {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .calendar-day.selected {
            background-color: #1d4ed8;
            color: white;
        }
        .calendar-day.has-data {
            background-color: #f0fdf4;
            border-color: #22c55e;
        }
        .calendar-day.has-data.selected {
            background-color: #15803d;
        }
        .calendar-day.other-month {
            color: #9ca3af;
            background-color: #f9fafb;
        }
        .productivity-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #22c55e;
        }
        .day-number {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .day-count {
            font-size: 0.75rem;
            text-align: center;
            background-color: rgba(34, 197, 94, 0.1);
            border-radius: 4px;
            padding: 1px 3px;
            margin-top: 2px;
        }
        .meta10-alert {
            animation: pulse 2s infinite;
            border-left: 4px solid #ef4444;
        }
        .meta10-success {
            border-left: 4px solid #22c55e;
        }
        .meta2-alert {
            animation: pulse 2s infinite;
            border-left: 4px solid #dc2626;
        }
        .meta2-success {
            border-left: 4px solid #16a34a;
        }
        .week-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .week-success { background-color: #22c55e; }
        .week-warning { background-color: #f59e0b; }
        .week-danger { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Indicador de Conexão -->
    <div id="connection-status" class="fixed top-4 right-4 z-50 no-print">
        <div class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium">
            Carregando...
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="mx-auto h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="scale" class="h-8 w-8 text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Sistema de Produtividade Judicial</h1>
                <p class="text-gray-600">Digite suas credenciais para acessar</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                    <select id="login-usuario" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione o usuário</option>
                        <option value="juiz">Juiz</option>
                        <option value="gilbert">Gilbert Juliano</option>
                        <option value="laise">Laíse Vital</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="login-senha" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite sua senha">
                </div>
                
                <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                    <i data-lucide="log-in" class="h-5 w-5 mr-2 inline"></i>
                    Entrar
                </button>
            </div>
        </div>
    </div>

    <!-- Aplicação Principal -->
    <div id="main-app" class="hidden p-4 max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Sistema de Produtividade Judicial</h1>
                    <p id="user-info" class="text-gray-600"></p>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors flex items-center">
                    <i data-lucide="log-out" class="h-4 w-4 mr-2"></i>
                    Sair
                </button>
            </div>
            
            <!-- Navegação -->
            <div id="navigation" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-view" class="hidden space-y-6"></div>

        <!-- Registro de Minuta -->
        <div id="registro-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-6">
                    <i data-lucide="plus" class="h-6 w-6 text-blue-600 mr-2"></i>
                    <h2 class="text-xl font-semibold text-gray-800">Registrar Nova Minuta</h2>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Número do Processo *</label>
                        <input type="text" id="numero-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 1234567-89.2024.8.12.3456">
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Minuta *</label>
                            <select id="tipo-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="validarTipoMinuta()">
                                <option value="">Selecione o tipo</option>
                                <option value="Despacho">Despacho</option>
                                <option value="Decisão">Decisão</option>
                                <option value="Sentença">Sentença</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                            <select id="categoria-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Selecione a categoria</option>
                                <option value="meta1">Meta 1 CNJ (2/dia)</option>
                                <option value="meta2">Meta 2 CNJ (1 sentença/semana)</option>
                                <option value="meta10" id="meta10-option" class="hidden">Meta 10 CNJ (1/semana)</option>
                                <option value="seeu" id="seeu-option" class="hidden">SEEU - Execução Penal (controle de acesso - não conta para meta diária)</option>
                                <option value="sem_movimento">Sem movimentação 100+ dias (5/dia)</option>
                                <option value="outros">Pedidos/Atos/Urgentes (3/dia)</option>
                                <option value="alem_meta">Além da Meta (produtividade adicional - não conta para meta diária)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                        <textarea id="observacoes-minuta" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Comentários sobre a minuta (opcional)"></textarea>
                    </div>
                    
                    <button onclick="registrarMinuta()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                        <i data-lucide="save" class="h-5 w-5 mr-2 inline"></i>
                        Registrar Minuta
                    </button>
                    
                    <div class="text-xs text-gray-500 text-center mt-2 bg-gray-50 p-2 rounded">
                        ℹ️ Minutas registradas contam automaticamente para a produtividade. O juiz pode excluí-las da contagem posteriormente se necessário.<br>
                        📋 <strong>Nota:</strong> SEEU é apenas controle de acesso e não conta para a meta diária de 10 minutas.
                    </div>
                </div>
            </div>
        </div>

        <!-- Histórico -->
        <div id="historico-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="clock" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Histórico de Minutas</h2>
                    </div>
                    <div id="historico-filters" class="flex gap-2 no-print"></div>
                </div>
                <div id="historico-content"></div>
            </div>
        </div>

        <!-- Calendário -->
        <div id="calendario-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="calendar-days" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Calendário de Produtividade</h2>
                    </div>
                    <div class="flex items-center gap-2 no-print">
                        <button onclick="navegarMes(-1)" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                            <i data-lucide="chevron-left" class="h-5 w-5"></i>
                        </button>
                        <span id="calendario-mes-ano" class="text-lg font-medium px-4"></span>
                        <button onclick="navegarMes(1)" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                            <i data-lucide="chevron-right" class="h-5 w-5"></i>
                        </button>
                        <button onclick="irParaHoje()" class="ml-4 bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition-colors text-sm">
                            Hoje
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Calendário -->
                    <div class="space-y-4">
                        <!-- Cabeçalho dos dias da semana -->
                        <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600">
                            <div class="py-2">Dom</div>
                            <div class="py-2">Seg</div>
                            <div class="py-2">Ter</div>
                            <div class="py-2">Qua</div>
                            <div class="py-2">Qui</div>
                            <div class="py-2">Sex</div>
                            <div class="py-2">Sáb</div>
                        </div>
                        
                        <!-- Dias do calendário -->
                        <div id="calendario-dias" class="grid grid-cols-7 gap-1"></div>
                        
                        <!-- Legenda -->
                        <div class="mt-4 text-xs text-gray-600 space-y-1">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-200 border border-blue-400 rounded"></div>
                                <span>Hoje</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-50 border border-green-500 rounded"></div>
                                <span>Dias com produtividade</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-800 rounded"></div>
                                <span>Dia selecionado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span>Meta 10 cumprida na semana</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span>Meta 10 não cumprida</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-teal-500 rounded-full"></div>
                                <span>SEEU acessado</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detalhes do dia selecionado -->
                    <div id="calendario-detalhes" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <i data-lucide="calendar-check" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                            <p>Clique em um dia para ver os detalhes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relatórios -->
        <div id="relatorios-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="bar-chart" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Relatórios de Produtividade</h2>
                    </div>
                    <div class="flex gap-2 no-print">
                        <button onclick="gerarRelatorio('semanal')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm">
                            <i data-lucide="calendar-week" class="h-4 w-4 mr-1 inline"></i>
                            Relatório Semanal
                        </button>
                        <button onclick="gerarRelatorio('mensal')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors text-sm">
                            <i data-lucide="calendar-month" class="h-4 w-4 mr-1 inline"></i>
                            Relatório Mensal
                        </button>
                        <button onclick="window.print()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm">
                            <i data-lucide="printer" class="h-4 w-4 mr-1 inline"></i>
                            Imprimir
                        </button>
                    </div>
                </div>
                <div id="relatorio-content"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Correção -->
    <div id="modal-correcao" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalCorrecao()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i data-lucide="edit" class="h-5 w-5 text-blue-600 mr-2"></i>
                    Solicitar Correção
                </h3>
                <button onclick="fecharModalCorrecao()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="text-sm text-blue-800">
                        <div class="font-medium" id="modal-correcao-processo">Processo: </div>
                        <div class="text-xs mt-1" id="modal-correcao-assessor">Assessor: </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Especifique a correção necessária: *
                    </label>
                    <textarea 
                        id="correcao-detalhes" 
                        rows="4" 
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        placeholder="Descreva detalhadamente o que precisa ser corrigido nesta minuta..."
                    ></textarea>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="confirmarCorrecao()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        <i data-lucide="check" class="h-4 w-4 mr-1 inline"></i>
                        Solicitar Correção
                    </button>
                    <button onclick="fecharModalCorrecao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
                
                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">💡 Ctrl+Enter: Confirmar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="modal-edicao" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalEdicao()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Editar Minuta</h3>
                <button onclick="fecharModalEdicao()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Número do Processo *</label>
                    <input type="text" id="edit-numero-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Minuta *</label>
                    <select id="edit-tipo-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="validarTipoMinutaEdicao()">
                        <option value="Despacho">Despacho</option>
                        <option value="Decisão">Decisão</option>
                        <option value="Sentença">Sentença</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                    <select id="edit-categoria-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="meta1">Meta 1 CNJ</option>
                        <option value="meta2">Meta 2 CNJ</option>
                        <option value="meta10" id="edit-meta10-option" class="hidden">Meta 10 CNJ</option>
                        <option value="seeu" id="edit-seeu-option" class="hidden">SEEU - Execução Penal (controle)</option>
                        <option value="sem_movimento">Sem movimentação 100+ dias</option>
                        <option value="outros">Pedidos/Atos/Urgentes</option>
                        <option value="alem_meta">Além da Meta (produtividade adicional)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="edit-observacoes-minuta" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="salvarEdicao()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        <i data-lucide="save" class="h-4 w-4 mr-1 inline"></i>
                        Salvar
                    </button>
                    <button onclick="fecharModalEdicao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
                
                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">💡 Ctrl+Enter: Salvar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURAÇÃO ====================
        
        const firebaseConfig = {
            apiKey: "AIzaSyCzuoRgbvKQSjOFssde-qUEtNDqGNJML7E",
            authDomain: "produtividade-gabinete.firebaseapp.com",
            databaseURL: "https://produtividade-gabinete-default-rtdb.firebaseio.com",
            projectId: "produtividade-gabinete",
            storageBucket: "produtividade-gabinete.firebasestorage.app",
            messagingSenderId: "370364917935",
            appId: "1:370364917935:web:a6205cc718748abcbdcc5a"
        };

        // Credenciais seguras
        const credenciais = {
            'juiz': { senha: 'Juiz@2024!', nome: 'Juiz', tipo: 'juiz' },
            'gilbert': { senha: 'Gilbert@2024!', nome: 'Gilbert Juliano', tipo: 'assessor', assessorId: 'gilbert' },
            'laise': { senha: 'Laise@2024!', nome: 'Laíse Vital', tipo: 'assessor', assessorId: 'laise' }
        };

        const categorias = {
            'meta1': { nome: 'Meta 1 CNJ', cor: 'bg-red-500', meta: 2 },
            'meta2': { nome: 'Meta 2 CNJ', cor: 'bg-pink-500', meta: 1, semanal: true, requerSentenca: true },
            'meta10': { nome: 'Meta 10 CNJ', cor: 'bg-purple-500', meta: 1, semanal: true, totalAnual: 9 },
            'seeu': { nome: 'SEEU - Execução Penal (controle de acesso)', cor: 'bg-teal-500', meta: 1, prazo: 10, naoContaParaMeta: true },
            'sem_movimento': { nome: 'Sem movimentação 100+ dias', cor: 'bg-orange-500', meta: 5 },
            'outros': { nome: 'Pedidos/Atos/Urgentes', cor: 'bg-blue-500', meta: 3 },
            'alem_meta': { nome: 'Além da Meta (produtividade adicional)', cor: 'bg-gray-500', meta: 0, semMeta: true, naoContaParaMeta: true }
        };

        const statusOptions = {
            'pendente': { nome: 'Pendente', cor: 'status-pendente' },
            'assinada': { nome: 'Assinada', cor: 'status-assinada' },
            'excluida': { nome: 'Excluída', cor: 'status-excluida' },
            'correcao': { nome: 'Precisa Correção', cor: 'status-correcao' }
        };

        // ==================== ESTADO GLOBAL ====================
        
        let firebase, database;
        let currentUser = null;
        let currentView = 'dashboard';
        let minutas = {};
        let minutaEditando = null;
        let minutaCorrecao = null; // Para o modal de correção
        let calendarioData = {
            mesAtual: getDataHoraBrasilia().getMonth(),
            anoAtual: getDataHoraBrasilia().getFullYear(),
            diaSelecionado: null
        };
        let assessores = {
            gilbert: { nome: 'Gilbert Juliano', ativo: true },
            laise: { nome: 'Laíse Vital', ativo: true }
        };

        // ==================== UTILITÁRIOS ====================
        
        // CORREÇÃO DE FUSO HORÁRIO: 
        // Todas as funções de data/hora agora usam o Horário de Brasília (UTC-3)
        // para evitar que minutas registradas após 20:00 sejam marcadas como do dia seguinte
        
        function isDiaUtil(data) {
            // Se não for passada uma data, usar a data atual de Brasília
            const dataParaVerificar = data || getDataHoraBrasilia();
            const dia = dataParaVerificar.getDay();
            return dia >= 1 && dia <= 5; // Segunda a Sexta
        }

        function getHojeString() {
            // Criar data no fuso horário de Brasília (UTC-3)
            const agora = new Date();
            const brasiliaOffset = -3; // UTC-3
            const utc = agora.getTime() + (agora.getTimezoneOffset() * 60000);
            const brasilia = new Date(utc + (brasiliaOffset * 3600000));
            
            // Retornar data no formato YYYY-MM-DD baseada no horário de Brasília
            const ano = brasilia.getFullYear();
            const mes = String(brasilia.getMonth() + 1).padStart(2, '0');
            const dia = String(brasilia.getDate()).padStart(2, '0');
            
            return `${ano}-${mes}-${dia}`;
        }

        function getDataHoraBrasilia() {
            // Função auxiliar para obter data/hora completa no horário de Brasília
            const agora = new Date();
            const brasiliaOffset = -3; // UTC-3
            const utc = agora.getTime() + (agora.getTimezoneOffset() * 60000);
            const brasilia = new Date(utc + (brasiliaOffset * 3600000));
            
            return brasilia;
        }

        function getInicioSemana(data) {
            const d = new Date(data);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getFimSemana(data) {
            const inicio = getInicioSemana(data);
            const fim = new Date(inicio);
            fim.setDate(inicio.getDate() + 6);
            return fim;
        }

        function getNumeroSemana(data) {
            const d = new Date(data);
            const inicio = new Date(d.getFullYear(), 0, 1);
            return Math.ceil(((d - inicio) / 86400000 + inicio.getDay() + 1) / 7);
        }

        function log(message, data = null) {
            const brasilia = getDataHoraBrasilia();
            const timestamp = brasilia.toLocaleTimeString('pt-BR');
            console.log(`[${timestamp} BRT] ${message}`, data || '');
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translate(-50%, -100px)';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function validarTipoMinuta() {
            const tipoMinuta = document.getElementById('tipo-minuta').value;
            const categoriaSelect = document.getElementById('categoria-minuta');
            const meta2Option = categoriaSelect.querySelector('option[value="meta2"]');
            
            if (tipoMinuta === 'Sentença') {
                meta2Option.style.display = 'block';
            } else {
                meta2Option.style.display = 'none';
                if (categoriaSelect.value === 'meta2') {
                    categoriaSelect.value = '';
                }
            }
        }

        function validarTipoMinutaEdicao() {
            const tipoMinuta = document.getElementById('edit-tipo-minuta').value;
            const categoriaSelect = document.getElementById('edit-categoria-minuta');
            const meta2Option = categoriaSelect.querySelector('option[value="meta2"]');
            
            if (tipoMinuta === 'Sentença') {
                meta2Option.style.display = 'block';
            } else {
                meta2Option.style.display = 'none';
                if (categoriaSelect.value === 'meta2') {
                    categoriaSelect.value = 'meta1';
                }
            }
        }

        // ==================== CÁLCULOS DE PRODUTIVIDADE ====================
        
        function getMinutasHoje(assessorId) {
            const hoje = getHojeString();
            return Object.values(minutas).filter(m => {
                if (!m || !m.data || m.data !== hoje) return false;
                if (m.status === 'excluida') return false; // Excluir minutas marcadas como excluídas
                
                return m.assessorId === assessorId || 
                       (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                       (assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('Laíse'))));
            });
        }

        function getMinutasPorData(data, assessorId = null) {
            return Object.values(minutas).filter(m => {
                if (!m || !m.data || m.data !== data) return false;
                if (m.status === 'excluida') return false; // Excluir minutas marcadas como excluídas
                
                if (assessorId) {
                    return m.assessorId === assessorId || 
                           (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                           (assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('Laíse'))));
                }
                
                return true;
            });
        }

        function getMinutasSemana(inicioSemana, fimSemana, assessorId, categoria = null) {
            const inicioStr = inicioSemana.toISOString().split('T')[0];
            const fimStr = fimSemana.toISOString().split('T')[0];
            
            return Object.values(minutas).filter(m => {
                if (!m || !m.data || m.data < inicioStr || m.data > fimStr) return false;
                if (m.status === 'excluida') return false; // Excluir minutas marcadas como excluídas
                
                const isAssessor = m.assessorId === assessorId || 
                                 (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                                 (assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('Laíse'))));
                
                if (!isAssessor) return false;
                
                if (categoria) return m.categoria === categoria;
                
                return true;
            });
        }

        function getMeta2Status(assessorId) {
            const hoje = getDataHoraBrasilia(); // Usar horário de Brasília
            const inicioSemanaAtual = getInicioSemana(hoje);
            const fimSemanaAtual = getFimSemana(hoje);
            
            // Minutas da Meta 2 na semana atual
            const minutasMeta2Semana = getMinutasSemana(inicioSemanaAtual, fimSemanaAtual, assessorId, 'meta2');
            const metaSemanaCumprida = minutasMeta2Semana.length > 0;
            
            // Histórico do ano
            const inicioAno = new Date(hoje.getFullYear(), 0, 1);
            const fimAno = new Date(hoje.getFullYear(), 11, 31);
            const minutasMeta2Ano = getMinutasSemana(inicioAno, fimAno, assessorId, 'meta2');
            
            // Histórico semanal do ano
            const semanas = [];
            const inicioCalculo = new Date(hoje.getFullYear(), 0, 1);
            let semanaAtual = getInicioSemana(inicioCalculo);
            
            while (semanaAtual <= hoje) {
                const fimSemana = getFimSemana(semanaAtual);
                const minutasSemana = getMinutasSemana(semanaAtual, fimSemana, assessorId, 'meta2');
                
                semanas.push({
                    inicio: new Date(semanaAtual),
                    fim: new Date(fimSemana),
                    numero: getNumeroSemana(semanaAtual),
                    cumprida: minutasSemana.length > 0,
                    minutas: minutasSemana.length
                });
                
                semanaAtual.setDate(semanaAtual.getDate() + 7);
            }
            
            const semanasPassadas = semanas.filter(s => s.fim < hoje).length;
            const semanasCumpridas = semanas.filter(s => s.cumprida && s.fim < hoje).length;
            const percentualCumprimento = semanasPassadas > 0 ? (semanasCumpridas / semanasPassadas) * 100 : 0;
            
            return {
                totalSentencas: minutasMeta2Ano.length,
                metaSemanaCumprida,
                semanas,
                percentualCumprimento: Math.round(percentualCumprimento),
                semanasPassadas,
                semanasCumpridas,
                status: metaSemanaCumprida ? 'em_dia' : 'atrasada'
            };
        }

        function getMeta10Status() {
            const hoje = getDataHoraBrasilia(); // Usar horário de Brasília
            const inicioAno = new Date(hoje.getFullYear(), 0, 1);
            const fimAno = new Date(hoje.getFullYear(), 11, 31);
            
            // Minutas da Meta 10 no ano
            const minutasMeta10 = getMinutasSemana(inicioAno, fimAno, 'gilbert', 'meta10');
            const processosJulgados = minutasMeta10.length;
            const processosRestantes = Math.max(0, 9 - processosJulgados);
            
            // Status da semana atual
            const inicioSemanaAtual = getInicioSemana(hoje);
            const fimSemanaAtual = getFimSemana(hoje);
            const minutasSemanaAtual = getMinutasSemana(inicioSemanaAtual, fimSemanaAtual, 'gilbert', 'meta10');
            const metaSemanaCumprida = minutasSemanaAtual.length > 0;
            
            // Histórico semanal do ano
            const semanas = [];
            const inicioCalculo = new Date(hoje.getFullYear(), 0, 1);
            let semanaAtual = getInicioSemana(inicioCalculo);
            
            while (semanaAtual <= hoje) {
                const fimSemana = getFimSemana(semanaAtual);
                const minutasSemana = getMinutasSemana(semanaAtual, fimSemana, 'gilbert', 'meta10');
                
                semanas.push({
                    inicio: new Date(semanaAtual),
                    fim: new Date(fimSemana),
                    numero: getNumeroSemana(semanaAtual),
                    cumprida: minutasSemana.length > 0,
                    minutas: minutasSemana.length
                });
                
                semanaAtual.setDate(semanaAtual.getDate() + 7);
            }
            
            return {
                processosJulgados,
                processosRestantes,
                metaSemanaCumprida,
                percentualAnual: Math.min((processosJulgados / 9) * 100, 100),
                semanas,
                proximasSemanas: Math.ceil(processosRestantes),
                status: processosRestantes === 0 ? 'completa' : 
                       metaSemanaCumprida ? 'em_dia' : 'atrasada'
            };
        }

        function getSEEUStatus() {
            const hoje = getDataHoraBrasilia(); // Usar horário de Brasília
            const inicioAno = new Date(hoje.getFullYear(), 0, 1);
            const fimAno = new Date(hoje.getFullYear(), 11, 31);
            
            // Obter todas as minutas SEEU da Laíse no ano (excluindo as marcadas como excluídas)
            const minutasSEEU = Object.values(minutas).filter(m => {
                if (!m || !m.data) return false;
                if (m.status === 'excluida') return false; // Excluir minutas marcadas como excluídas
                
                const dataMinuta = new Date(m.data);
                if (dataMinuta < inicioAno || dataMinuta > fimAno) return false;
                
                const isLaise = m.assessorId === 'laise' || 
                              m.assessorId === 'assessor2' || 
                              (m.assessorNome && m.assessorNome.includes('Laíse'));
                
                return isLaise && m.categoria === 'seeu';
            }).sort((a, b) => new Date(a.data) - new Date(b.data));
            
            // Última minuta SEEU
            const ultimaMinutaSEEU = minutasSEEU.length > 0 ? minutasSEEU[minutasSEEU.length - 1] : null;
            
            let diasSemSEEU = 0;
            let status = 'nunca_acessou';
            let proximoVencimento = null;
            
            if (ultimaMinutaSEEU) {
                const ultimaData = new Date(ultimaMinutaSEEU.data);
                diasSemSEEU = Math.floor((hoje - ultimaData) / (1000 * 60 * 60 * 24));
                
                proximoVencimento = new Date(ultimaData);
                proximoVencimento.setDate(proximoVencimento.getDate() + 10);
                
                if (diasSemSEEU <= 7) {
                    status = 'em_dia';
                } else if (diasSemSEEU <= 10) {
                    status = 'atencao';
                } else {
                    status = 'atrasado';
                }
            } else {
                diasSemSEEU = Math.floor((hoje - inicioAno) / (1000 * 60 * 60 * 24));
                status = 'nunca_acessou';
                proximoVencimento = new Date();
            }
            
            // Histórico dos últimos acessos (últimos 10)
            const historico = minutasSEEU.slice(-10).map(minuta => ({
                data: minuta.data,
                numeroProcesso: minuta.numeroProcesso,
                diasEntre: null
            }));
            
            // Calcular dias entre acessos
            for (let i = 1; i < historico.length; i++) {
                const dataAnterior = new Date(historico[i-1].data);
                const dataAtual = new Date(historico[i].data);
                historico[i].diasEntre = Math.floor((dataAtual - dataAnterior) / (1000 * 60 * 60 * 24));
            }
            
            return {
                totalAcessos: minutasSEEU.length,
                ultimoAcesso: ultimaMinutaSEEU ? ultimaMinutaSEEU.data : null,
                diasSemSEEU,
                status,
                proximoVencimento,
                diasParaVencimento: proximoVencimento ? Math.ceil((proximoVencimento - hoje) / (1000 * 60 * 60 * 24)) : 0,
                historico,
                mediaIntervalo: historico.length > 1 ? 
                    Math.round(historico.slice(1).reduce((acc, h) => acc + (h.diasEntre || 0), 0) / (historico.length - 1)) : 0
            };
        }

        function getProgressoCategoria(assessorId, categoria) {
            if (categoria === 'meta10') {
                const meta10Status = getMeta10Status();
                return {
                    atual: meta10Status.metaSemanaCumprida ? 1 : 0,
                    meta: 1,
                    percentual: meta10Status.metaSemanaCumprida ? 100 : 0,
                    semanal: true
                };
            }
            
            if (categoria === 'meta2') {
                const meta2Status = getMeta2Status(assessorId);
                return {
                    atual: meta2Status.metaSemanaCumprida ? 1 : 0,
                    meta: 1,
                    percentual: meta2Status.metaSemanaCumprida ? 100 : 0,
                    semanal: true
                };
            }
            
            const minutasHoje = getMinutasHoje(assessorId);
            const count = minutasHoje.filter(m => m.categoria === categoria).length;
            const categoriaInfo = categorias[categoria];
            
            // Categorias especiais que não contam para meta diária
            if (categoriaInfo && (categoriaInfo.semMeta || categoriaInfo.naoContaParaMeta)) {
                return { 
                    atual: count, 
                    meta: categoriaInfo.meta || 0, 
                    percentual: 0,
                    semMeta: true,
                    naoContaParaMeta: categoriaInfo.naoContaParaMeta
                };
            }
            
            const meta = categoriaInfo ? categoriaInfo.meta : 0;
            return { 
                atual: count, 
                meta, 
                percentual: meta > 0 ? Math.min((count / meta) * 100, 100) : 0
            };
        }

        function getProgressoTotal(assessorId) {
            const minutasHoje = getMinutasHoje(assessorId);
            // Excluir minutas "Além da Meta" e "SEEU" do cálculo da meta diária
            const minutasParaMeta = minutasHoje.filter(m => m.categoria !== 'alem_meta' && m.categoria !== 'seeu');
            const total = minutasParaMeta.length;
            const meta = 10;
            return { 
                atual: total, 
                meta, 
                percentual: Math.min((total / meta) * 100, 100),
                totalGeral: minutasHoje.length, // Total incluindo "Além da Meta" e "SEEU"
                alemDaMeta: minutasHoje.filter(m => m.categoria === 'alem_meta').length,
                seeu: minutasHoje.filter(m => m.categoria === 'seeu').length
            };
        }

        // ==================== AUTENTICAÇÃO ====================
        
        function fazerLogin() {
            const usuario = document.getElementById('login-usuario').value;
            const senha = document.getElementById('login-senha').value;

            if (!usuario || !senha) {
                showNotification('Por favor, selecione o usuário e digite a senha.', 'warning');
                return;
            }

            const cred = credenciais[usuario];
            if (!cred || cred.senha !== senha) {
                showNotification('Usuário ou senha incorretos.', 'error');
                return;
            }

            currentUser = {
                usuario: usuario,
                nome: cred.nome,
                tipo: cred.tipo,
                isJuiz: cred.tipo === 'juiz',
                assessorId: cred.assessorId
            };

            log('Login realizado', currentUser.nome);
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Mostrar notificação sobre correção do fuso horário
            setTimeout(() => {
                showNotification('🕐 Sistema ajustado para o Horário de Brasília. Minutas agora são registradas com data/hora corretas!', 'info');
            }, 1000);
            
            initializeApp();
        }

        function logout() {
            log('Logout realizado', currentUser?.nome);
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-usuario').value = '';
            document.getElementById('login-senha').value = '';
        }

        // ==================== INICIALIZAÇÃO ====================
        
        function initializeApp() {
            try {
                // Inicializar Firebase (modo offline se falhar)
                try {
                    firebase = window.firebase;
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                } catch (error) {
                    log('Firebase não disponível - modo offline', error);
                    database = null;
                }
                
                setupUserInfo();
                setupNavigation();
                setupMeta10Options();
                if (database) setupFirebaseListeners();
                showView('dashboard');
                
                log('Aplicação inicializada com sucesso');
                
            } catch (error) {
                log('Erro na inicialização', error);
                showNotification('Erro ao inicializar aplicação', 'error');
            }
        }

        function setupUserInfo() {
            document.getElementById('user-info').textContent = `Logado como: ${currentUser.nome}`;
        }

        function setupMeta10Options() {
            // Mostrar opção Meta 10 apenas para Gilbert
            const meta10Option = document.getElementById('meta10-option');
            const editMeta10Option = document.getElementById('edit-meta10-option');
            
            // Mostrar opção SEEU apenas para Laíse
            const seuOption = document.getElementById('seeu-option');
            const editSeuOption = document.getElementById('edit-seeu-option');
            
            if (currentUser.assessorId === 'gilbert') {
                meta10Option?.classList.remove('hidden');
                editMeta10Option?.classList.remove('hidden');
                seuOption?.classList.add('hidden');
                editSeuOption?.classList.add('hidden');
            } else if (currentUser.assessorId === 'laise') {
                meta10Option?.classList.add('hidden');
                editMeta10Option?.classList.add('hidden');
                seuOption?.classList.remove('hidden');
                editSeuOption?.classList.remove('hidden');
            } else {
                meta10Option?.classList.add('hidden');
                editMeta10Option?.classList.add('hidden');
                seuOption?.classList.add('hidden');
                editSeuOption?.classList.add('hidden');
            }
        }

        function setupNavigation() {
            const nav = document.getElementById('navigation');
            let buttons = '';

            // Dashboard sempre disponível
            buttons += `
                <button onclick="showView('dashboard')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-blue-600 text-white">
                    <i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i>
                    Dashboard
                </button>
            `;

            // Registro apenas para assessores
            if (!currentUser.isJuiz) {
                buttons += `
                    <button onclick="showView('registro')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                        Registrar Minuta
                    </button>
                `;
            }

            // Histórico sempre disponível
            buttons += `
                <button onclick="showView('historico')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
                    Histórico
                </button>
            `;

            // Calendário e Relatórios apenas para juiz
            if (currentUser.isJuiz) {
                buttons += `
                    <button onclick="showView('calendario')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="calendar-days" class="h-4 w-4 mr-2"></i>
                        Calendário
                    </button>
                    <button onclick="showView('relatorios')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="bar-chart" class="h-4 w-4 mr-2"></i>
                        Relatórios
                    </button>
                `;
            }

            nav.innerHTML = buttons;
            lucide.createIcons();
        }

        function showView(view) {
            try {
                log(`Navegando para: ${view}`);
                
                // Esconder todas as views
                document.querySelectorAll('[id$="-view"]').forEach(el => {
                    if (el) el.classList.add('hidden');
                });

                // Atualizar navegação
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (btn) {
                        btn.className = 'nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200';
                    }
                });

                // Destacar botão ativo
                const activeBtn = event?.target?.closest('button');
                if (activeBtn) {
                    activeBtn.className = 'nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-blue-600 text-white';
                }

                currentView = view;

                // Mostrar view solicitada
                switch(view) {
                    case 'dashboard':
                        renderDashboard();
                        break;
                    case 'registro':
                        document.getElementById('registro-view')?.classList.remove('hidden');
                        break;
                    case 'historico':
                        setupHistoricoFilters();
                        renderHistorico();
                        break;
                    case 'calendario':
                        renderCalendario();
                        break;
                    case 'relatorios':
                        document.getElementById('relatorios-view')?.classList.remove('hidden');
                        break;
                }

                log(`View ${view} carregada`);
                
            } catch (error) {
                log(`Erro ao carregar view ${view}`, error);
                showNotification(`Erro ao carregar ${view}`, 'error');
            }
        }

        // ==================== FIREBASE ====================
        
        function setupFirebaseListeners() {
            try {
                // Listener para minutas
                database.ref('minutas').on('value', (snapshot) => {
                    minutas = snapshot.val() || {};
                    log(`Minutas carregadas: ${Object.keys(minutas).length}`);
                    
                    if (currentView === 'dashboard') renderDashboard();
                    if (currentView === 'historico') renderHistorico();
                    if (currentView === 'calendario') renderCalendario();
                });

                // Listener para assessores
                database.ref('assessores').on('value', (snapshot) => {
                    const assessoresFirebase = snapshot.val();
                    if (assessoresFirebase) {
                        assessores = { ...assessores, ...assessoresFirebase };
                        log('Assessores atualizados');
                    }
                });

                // Configurar dados iniciais
                database.ref('assessores').once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        database.ref('assessores').set(assessores);
                        log('Dados iniciais dos assessores criados');
                    }
                });

                // Status de conexão
                database.ref('.info/connected').on('value', (snapshot) => {
                    const connected = snapshot.val();
                    const statusDiv = document.getElementById('connection-status');
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = connected ? 
                            `<div class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center">
                                <div class="w-2 h-2 bg-white rounded-full mr-2 pulse"></div>
                                Online
                            </div>` :
                            `<div class="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-medium">
                                Offline
                            </div>`;
                    }
                });

                log('Firebase configurado com sucesso');
                
            } catch (error) {
                log('Erro no Firebase - modo local ativado', error);
                
                const statusDiv = document.getElementById('connection-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium">
                            Modo Local
                        </div>
                    `;
                }
            }
        }

        // ==================== REGISTRO DE MINUTAS ====================
        
        function registrarMinuta() {
            const numeroProcesso = document.getElementById('numero-processo').value.trim();
            const tipoMinuta = document.getElementById('tipo-minuta').value;
            const categoria = document.getElementById('categoria-minuta').value;
            const observacoes = document.getElementById('observacoes-minuta').value.trim();

            if (!numeroProcesso || !tipoMinuta || !categoria) {
                showNotification('Por favor, preencha todos os campos obrigatórios.', 'warning');
                return;
            }

            // Validação especial para Meta 2 - só aceita Sentença
            if (categoria === 'meta2' && tipoMinuta !== 'Sentença') {
                showNotification('Meta 2 CNJ aceita apenas minutas de Sentença.', 'error');
                return;
            }

            // Validação especial para Meta 10
            if (categoria === 'meta10' && currentUser.assessorId !== 'gilbert') {
                showNotification('Apenas Gilbert pode registrar minutas da Meta 10 CNJ.', 'error');
                return;
            }

            // Validação especial para SEEU
            if (categoria === 'seeu' && currentUser.assessorId !== 'laise') {
                showNotification('Apenas Laíse pode registrar minutas do SEEU.', 'error');
                return;
            }

            const novaMinuta = {
                assessorId: currentUser.assessorId,
                assessorNome: currentUser.nome,
                numeroProcesso,
                tipoMinuta,
                categoria,
                observacoes,
                status: 'pendente',
                data: getHojeString(),
                timestamp: getDataHoraBrasilia().toLocaleTimeString('pt-BR'),
                createdAt: getDataHoraBrasilia().getTime()
            };

            try {
                if (database) {
                    // Salvar no Firebase
                    database.ref('minutas').push({
                        ...novaMinuta,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        limparFormularioRegistro();
                        if (categoria === 'meta2') {
                            showNotification('🎯 Sentença da Meta 2 CNJ registrada! Meta semanal cumprida!', 'success');
                        } else if (categoria === 'meta10') {
                            showNotification('✨ Processo da Meta 10 CNJ registrado! Meta semanal cumprida!', 'success');
                        } else if (categoria === 'seeu') {
                            showNotification('🛡️ Acesso ao SEEU registrado! Controle de 10 dias cumprido (não conta para meta diária).', 'success');
                        } else if (categoria === 'alem_meta') {
                            showNotification('➕ Minuta "Além da Meta" registrada! Produtividade adicional contabilizada (não conta para meta diária).', 'success');
                        } else {
                            showNotification('Minuta registrada com sucesso!', 'success');
                        }
                        showView('dashboard');
                        log('Minuta registrada no Firebase', numeroProcesso);
                    }).catch(() => {
                        salvarMinutaLocal(novaMinuta);
                    });
                } else {
                    salvarMinutaLocal(novaMinuta);
                }
                
            } catch (error) {
                salvarMinutaLocal(novaMinuta);
            }
        }

        function salvarMinutaLocal(minuta) {
            const id = 'local_' + getDataHoraBrasilia().getTime();
            minutas[id] = minuta;
            
            limparFormularioRegistro();
            if (minuta.categoria === 'meta2') {
                showNotification('🎯 Sentença da Meta 2 registrada localmente!', 'warning');
            } else if (minuta.categoria === 'meta10') {
                showNotification('✨ Processo da Meta 10 registrado localmente!', 'warning');
            } else if (minuta.categoria === 'seeu') {
                showNotification('🛡️ Acesso ao SEEU registrado localmente! (controle de acesso - não conta para meta diária)', 'warning');
            } else if (minuta.categoria === 'alem_meta') {
                showNotification('➕ Minuta "Além da Meta" registrada localmente! (não conta para meta diária)', 'warning');
            } else {
                showNotification('Minuta registrada localmente!', 'warning');
            }
            showView('dashboard');
            log('Minuta salva localmente', minuta.numeroProcesso);
        }

        function limparFormularioRegistro() {
            document.getElementById('numero-processo').value = '';
            document.getElementById('tipo-minuta').value = '';
            document.getElementById('categoria-minuta').value = '';
            document.getElementById('observacoes-minuta').value = '';
        }

        // ==================== RENDERIZAÇÃO ====================
        
        function renderDashboard() {
            try {
                const dashboard = document.getElementById('dashboard-view');
                if (!dashboard) return;

                const hoje = getDataHoraBrasilia(); // Usar horário de Brasília
                let content = '';

                // Para assessores, verificar correções pendentes ANTES de tudo
                if (!currentUser.isJuiz) {
                    const correcoesPendentes = Object.values(minutas).filter(m => {
                        if (!m || m.status !== 'correcao') return false;
                        
                        return m.assessorId === currentUser.assessorId || 
                               (currentUser.assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                               (currentUser.assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('Laíse'))));
                    });

                    if (correcoesPendentes.length > 0) {
                        content += `
                            <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-6 mb-6 shadow-lg animate-pulse">
                                <div class="flex items-center">
                                    <i data-lucide="alert-triangle" class="h-8 w-8 text-red-600 mr-3"></i>
                                    <div>
                                        <h2 class="text-xl font-bold text-red-800">
                                            🚨 ATENÇÃO: ${correcoesPendentes.length} Correç${correcoesPendentes.length === 1 ? 'ão Pendente' : 'ões Pendentes'}!
                                        </h2>
                                        <p class="text-red-700 font-medium">
                                            O juiz solicitou correções em suas minutas. Veja abaixo os detalhes e no histórico as instruções completas.
                                        </p>
                                    </div>
                                </div>
                                <div class="mt-4 grid gap-3">
                                    ${correcoesPendentes.slice(0, 2).map(minuta => `
                                        <div class="bg-white border border-red-200 rounded-lg p-3">
                                            <div class="font-bold text-red-900 flex items-center">
                                                <i data-lucide="file-text" class="h-4 w-4 mr-2"></i>
                                                📄 ${minuta.numeroProcesso || 'Sem número'} - ${minuta.tipoMinuta}
                                            </div>
                                            <div class="text-sm text-red-700 mt-2 bg-red-50 p-2 rounded border">
                                                <strong>Correção solicitada:</strong><br>
                                                "${minuta.correcaoSolicitada}"
                                            </div>
                                            <div class="text-xs text-red-600 mt-1 flex items-center">
                                                <i data-lucide="clock" class="h-3 w-3 mr-1"></i>
                                                Solicitado em ${minuta.correcaoSolicitadaEm}
                                            </div>
                                        </div>
                                    `).join('')}
                                    ${correcoesPendentes.length > 2 ? `
                                        <div class="text-center bg-white border border-red-200 rounded-lg p-2">
                                            <span class="text-red-700 font-medium">
                                                +${correcoesPendentes.length - 2} correções adicionais no histórico
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="mt-4 bg-yellow-50 border border-yellow-300 rounded p-3">
                                    <div class="text-yellow-800 text-sm font-medium flex items-center">
                                        <i data-lucide="info" class="h-4 w-4 mr-2"></i>
                                        <strong>Próximos passos:</strong> Acesse o histórico, faça as correções e clique em "Marcar como Corrigida"
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                if (!isDiaUtil(hoje)) {
                    content += `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
                            <i data-lucide="calendar" class="mx-auto h-12 w-12 text-yellow-500 mb-4"></i>
                            <h3 class="text-lg font-semibold text-yellow-800 mb-2">Fim de Semana</h3>
                            <p class="text-yellow-700">Hoje não é um dia útil. O controle de produtividade será retomado na próxima segunda-feira.</p>
                        </div>
                        ${renderAssessoresCards()}
                    `;
                } else {
                    const totalMinutasHoje = Object.values(minutas).filter(m => m?.data === getHojeString() && m.status !== 'excluida').length;
                    const minutasParaMeta = Object.values(minutas).filter(m => m?.data === getHojeString() && m.categoria !== 'alem_meta' && m.categoria !== 'seeu' && m.status !== 'excluida').length;
                    const minutasAlemMeta = Object.values(minutas).filter(m => m?.data === getHojeString() && m.categoria === 'alem_meta' && m.status !== 'excluida').length;
                    const minutasSEEU = Object.values(minutas).filter(m => m?.data === getHojeString() && m.categoria === 'seeu' && m.status !== 'excluida').length;
                    const metaTotal = 20; // Meta total do gabinete (10 por assessor)

                    content += `
                        <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg p-6 mb-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h2 class="text-2xl font-bold mb-2">Produtividade do Dia</h2>
                                    <p class="text-blue-100">
                                        ${hoje.toLocaleDateString('pt-BR', { 
                                            weekday: 'long', 
                                            year: 'numeric', 
                                            month: 'long', 
                                            day: 'numeric' 
                                        })}
                                    </p>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold">${minutasParaMeta}/${metaTotal}</div>
                                    <div class="text-blue-100 text-sm">minutas para metas CNJ</div>
                                    ${(minutasAlemMeta > 0 || minutasSEEU > 0) ? `
                                        <div class="text-lg font-medium mt-2 text-blue-200">
                                            ${minutasAlemMeta > 0 ? `+${minutasAlemMeta} além da meta` : ''}
                                            ${minutasAlemMeta > 0 && minutasSEEU > 0 ? ' • ' : ''}
                                            ${minutasSEEU > 0 ? `${minutasSEEU} SEEU` : ''}
                                        </div>
                                        <div class="text-blue-200 text-sm">Total produzido: ${totalMinutasHoje} minutas</div>
                                        <div class="text-xs text-blue-300 mt-1">
                                            📊 Apenas minutas das metas CNJ contam para produtividade diária
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${(minutasAlemMeta > 0 || minutasSEEU > 0) ? `
                                <div class="mt-4 pt-4 border-t border-blue-500">
                                    <div class="grid grid-cols-${minutasAlemMeta > 0 && minutasSEEU > 0 ? '3' : '2'} gap-4 text-center">
                                        <div>
                                            <div class="text-xl font-bold">${minutasParaMeta}</div>
                                            <div class="text-blue-100 text-sm">Metas CNJ</div>
                                        </div>
                                        ${minutasAlemMeta > 0 ? `
                                            <div>
                                                <div class="text-xl font-bold text-blue-200">${minutasAlemMeta}</div>
                                                <div class="text-blue-200 text-sm">Além da Meta</div>
                                            </div>
                                        ` : ''}
                                        ${minutasSEEU > 0 ? `
                                            <div>
                                                <div class="text-xl font-bold text-teal-200">${minutasSEEU}</div>
                                                <div class="text-teal-200 text-sm">Acessos SEEU</div>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        ${renderAssessoresCards()}
                    `;
                }

                dashboard.innerHTML = content;
                dashboard.classList.remove('hidden');
                
                setTimeout(() => lucide.createIcons(), 100);
                log('Dashboard renderizado');
                
            } catch (error) {
                log('Erro ao renderizar dashboard', error);
                showNotification('Erro ao carregar dashboard', 'error');
            }
        }

        function renderAssessoresCards() {
            if (!currentUser) return '';

            if (currentUser.isJuiz) {
                return `
                    <div class="grid md:grid-cols-2 gap-6">
                        ${renderAssessorCard('gilbert')}
                        ${renderAssessorCard('laise')}
                    </div>
                `;
            } else {
                // Para assessores, verificar se há correções pendentes primeiro
                const correcoesPendentes = Object.values(minutas).filter(m => {
                    if (!m || m.status !== 'correcao') return false;
                    
                    return m.assessorId === currentUser.assessorId || 
                           (currentUser.assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                           (currentUser.assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('Laíse'))));
                });

                let alertaCorrecoes = '';
                if (correcoesPendentes.length > 0) {
                    alertaCorrecoes = `
                        <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4 mb-6 animate-pulse">
                            <div class="flex items-center">
                                <i data-lucide="alert-circle" class="h-6 w-6 text-blue-600 mr-3"></i>
                                <div>
                                    <h3 class="text-lg font-semibold text-blue-800">
                                        ⚠️ ${correcoesPendentes.length} Correç${correcoesPendentes.length === 1 ? 'ão Pendente' : 'ões Pendentes'}
                                    </h3>
                                    <p class="text-blue-700 text-sm">
                                        O juiz solicitou correções em algumas de suas minutas. Verifique o histórico para detalhes.
                                    </p>
                                </div>
                            </div>
                            <div class="mt-3 space-y-2">
                                ${correcoesPendentes.slice(0, 3).map(minuta => `
                                    <div class="bg-white border border-blue-200 rounded p-3">
                                        <div class="font-medium text-blue-900">
                                            📄 ${minuta.numeroProcesso || 'Sem número'} - ${minuta.tipoMinuta}
                                        </div>
                                        <div class="text-sm text-blue-700 mt-1 bg-blue-50 p-2 rounded">
                                            <strong>Correção solicitada:</strong> "${minuta.correcaoSolicitada}"
                                        </div>
                                        <div class="text-xs text-blue-600 mt-1">
                                            Solicitado em ${minuta.correcaoSolicitadaEm}
                                        </div>
                                    </div>
                                `).join('')}
                                ${correcoesPendentes.length > 3 ? `
                                    <div class="text-center">
                                        <span class="text-blue-600 text-sm">
                                            +${correcoesPendentes.length - 3} correções adicionais no histórico
                                        </span>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }

                return `
                    ${alertaCorrecoes}
                    <div class="max-w-md mx-auto">
                        ${renderAssessorCard(currentUser.assessorId)}
                    </div>
                `;
            }
        }

        function renderAssessorCard(assessorId) {
            try {
                const assessor = assessores[assessorId];
                if (!assessor) return `<div class="text-red-500">Assessor ${assessorId} não encontrado</div>`;

                const progressoTotal = getProgressoTotal(assessorId);
                const minutasHoje = getMinutasHoje(assessorId);
                const meta2Status = getMeta2Status(assessorId);

                // Card especial da Meta 2 (para ambos assessores)
                let meta2Card = `
                    <div class="bg-gradient-to-r from-pink-600 to-pink-700 text-white rounded-lg p-6 mb-6 ${meta2Status.status === 'atrasada' ? 'meta2-alert' : meta2Status.status === 'em_dia' ? 'meta2-success' : ''}">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center">
                                <i data-lucide="gavel" class="h-8 w-8 mr-3"></i>
                                <div>
                                    <h3 class="text-xl font-bold">Meta 2 CNJ</h3>
                                    <p class="text-pink-100">Sentenças Semanais</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold">${meta2Status.totalSentencas}</div>
                                <div class="text-pink-100">sentenças no ano</div>
                            </div>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <div class="flex justify-between text-sm text-pink-100 mb-1">
                                    <span>Cumprimento Anual</span>
                                    <span>${meta2Status.percentualCumprimento}%</span>
                                </div>
                                <div class="w-full bg-pink-800 rounded-full h-3">
                                    <div class="bg-white h-3 rounded-full transition-all duration-300" style="width: ${meta2Status.percentualCumprimento}%"></div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center pt-2 border-t border-pink-500">
                                <div class="text-center">
                                    <div class="text-2xl font-bold">${meta2Status.semanasCumpridas}</div>
                                    <div class="text-xs text-pink-100">semanas cumpridas</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold ${meta2Status.metaSemanaCumprida ? '✅' : '❌'}">${meta2Status.metaSemanaCumprida ? '✅' : '❌'}</div>
                                    <div class="text-xs text-pink-100">esta semana</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-2xl font-bold">${meta2Status.semanasPassadas}</div>
                                    <div class="text-xs text-pink-100">semanas do ano</div>
                                </div>
                            </div>
                            
                            ${meta2Status.status === 'atrasada' ? `
                                <div class="bg-red-500 text-white p-3 rounded-lg text-center text-sm font-medium">
                                    ⚠️ Meta semanal não cumprida! Registre uma sentença da Meta 2 esta semana.
                                </div>
                            ` : meta2Status.metaSemanaCumprida ? `
                                <div class="bg-green-500 text-white p-3 rounded-lg text-center text-sm font-medium">
                                    🎯 Meta semanal cumprida! Parabéns!
                                </div>
                            ` : ''}
                            
                            ${meta2Status.semanas.length > 5 ? `
                                <div class="pt-2 border-t border-pink-500">
                                    <div class="text-xs text-pink-100 mb-2">Últimas 10 semanas</div>
                                    <div class="grid grid-cols-10 gap-1">
                                        ${meta2Status.semanas.slice(-10).map(semana => `
                                            <div class="h-6 rounded flex items-center justify-center text-xs font-medium ${
                                                semana.cumprida ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                                            }" title="Semana ${semana.numero}: ${semana.cumprida ? 'Cumprida' : 'Não cumprida'}">
                                                ${semana.numero}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                // Card específico do Gilbert
                if (assessorId === 'gilbert') {
                    const meta10Status = getMeta10Status();
                    
                    let meta10Card = `
                        <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg p-6 mb-6 ${meta10Status.status === 'atrasada' ? 'meta10-alert' : meta10Status.status === 'em_dia' ? 'meta10-success' : ''}">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <i data-lucide="target" class="h-8 w-8 mr-3"></i>
                                    <div>
                                        <h3 class="text-xl font-bold">Meta 10 CNJ</h3>
                                        <p class="text-purple-100">Processos para Sentença</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold">${meta10Status.processosJulgados}/9</div>
                                    <div class="text-purple-100">processos</div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div>
                                    <div class="flex justify-between text-sm text-purple-100 mb-1">
                                        <span>Progresso Anual</span>
                                        <span>${Math.round(meta10Status.percentualAnual)}%</span>
                                    </div>
                                    <div class="w-full bg-purple-800 rounded-full h-3">
                                        <div class="bg-white h-3 rounded-full transition-all duration-300" style="width: ${meta10Status.percentualAnual}%"></div>
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-center pt-2 border-t border-purple-500">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">${meta10Status.processosRestantes}</div>
                                        <div class="text-xs text-purple-100">restantes</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold ${meta10Status.metaSemanaCumprida ? '✅' : '❌'}">${meta10Status.metaSemanaCumprida ? '✅' : '❌'}</div>
                                        <div class="text-xs text-purple-100">esta semana</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">${meta10Status.proximasSemanas}</div>
                                        <div class="text-xs text-purple-100">semanas restantes</div>
                                    </div>
                                </div>
                                
                                ${meta10Status.status === 'atrasada' ? `
                                    <div class="bg-red-500 text-white p-3 rounded-lg text-center text-sm font-medium">
                                        ⚠️ Meta semanal não cumprida! Registre um processo da Meta 10 esta semana.
                                    </div>
                                ` : meta10Status.metaSemanaCumprida ? `
                                    <div class="bg-green-500 text-white p-3 rounded-lg text-center text-sm font-medium">
                                        🎯 Meta semanal cumprida! Parabéns!
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;

                    return meta2Card + meta10Card + renderAssessorNormalCard(assessorId, assessor, progressoTotal, minutasHoje);
                }

                // Card específico da Laíse
                if (assessorId === 'laise') {
                    const seuStatus = getSEEUStatus();
                    
                    let seuCard = `
                        <div class="bg-gradient-to-r from-teal-600 to-teal-700 text-white rounded-lg p-6 mb-6 ${seuStatus.status === 'atrasado' || seuStatus.status === 'nunca_acessou' ? 'meta10-alert' : seuStatus.status === 'em_dia' ? 'meta10-success' : ''}">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex items-center">
                                    <i data-lucide="shield-check" class="h-8 w-8 mr-3"></i>
                                    <div>
                                        <h3 class="text-xl font-bold">SEEU - Execução Penal</h3>
                                        <p class="text-teal-100">Sistema Eletrônico de Execução Unificada</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-bold">${seuStatus.totalAcessos}</div>
                                    <div class="text-teal-100">acessos este ano</div>
                                </div>
                            </div>
                            
                            <div class="space-y-3">
                                <div class="flex justify-between items-center pt-2 border-t border-teal-500">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">${seuStatus.diasSemSEEU}</div>
                                        <div class="text-xs text-teal-100">dias sem acesso</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">${seuStatus.ultimoAcesso ? new Date(seuStatus.ultimoAcesso).toLocaleDateString('pt-BR') : 'Nunca'}</div>
                                        <div class="text-xs text-teal-100">último acesso</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold">${seuStatus.diasParaVencimento}</div>
                                        <div class="text-xs text-teal-100">dias ${seuStatus.diasParaVencimento > 0 ? 'restantes' : 'em atraso'}</div>
                                    </div>
                                </div>
                                
                                ${seuStatus.status === 'atrasado' || seuStatus.status === 'nunca_acessou' ? `
                                    <div class="bg-red-500 text-white p-3 rounded-lg text-center text-sm font-medium">
                                        ⚠️ ${seuStatus.status === 'nunca_acessou' ? 'SEEU ainda não foi acessado este ano!' : `Meta de 10 dias ultrapassada! ${seuStatus.diasSemSEEU} dias sem acesso.`}
                                    </div>
                                ` : seuStatus.status === 'atencao' ? `
                                    <div class="bg-yellow-500 text-white p-3 rounded-lg text-center text-sm font-medium">
                                        ⚡ Atenção! Prazo de 10 dias se aproximando. Último acesso há ${seuStatus.diasSemSEEU} dias.
                                    </div>
                                ` : `
                                <div class="bg-green-500 text-white p-3 rounded-lg text-center text-sm font-medium">
                                        ✅ Meta SEEU em dia! Último acesso há ${seuStatus.diasSemSEEU} dias.
                                    </div>
                                `}
                                
                                ${seuStatus.historico.length > 1 ? `
                                    <div class="pt-2 border-t border-teal-500">
                                        <div class="text-xs text-teal-100 mb-2">Últimos acessos (intervalo médio: ${seuStatus.mediaIntervalo} dias)</div>
                                        <div class="flex gap-1 overflow-x-auto">
                                            ${seuStatus.historico.slice(-5).map((h, i) => `
                                                <div class="bg-teal-800 rounded px-2 py-1 text-xs whitespace-nowrap" title="${new Date(h.data).toLocaleDateString('pt-BR')}">
                                                    ${new Date(h.data).toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' })}
                                                    ${h.diasEntre ? `(+${h.diasEntre}d)` : ''}
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;

                    return meta2Card + seuCard + renderAssessorNormalCard(assessorId, assessor, progressoTotal, minutasHoje);
                }

                // Card normal para outros assessores
                return meta2Card + renderAssessorNormalCard(assessorId, assessor, progressoTotal, minutasHoje);
                
            } catch (error) {
                log(`Erro ao renderizar card ${assessorId}`, error);
                return `<div class="bg-red-50 p-4 rounded-lg text-red-800">Erro ao carregar ${assessorId}</div>`;
            }
        }

        function renderAssessorNormalCard(assessorId, assessor, progressoTotal, minutasHoje) {
            let categoriasHtml = '';
            
            // Definir ordem específica das categorias
            const ordemCategorias = ['meta1', 'meta2', 'meta10', 'seeu', 'sem_movimento', 'outros', 'alem_meta'];
            
            ordemCategorias.forEach(key => {
                if (!categorias[key]) return;
                if (key === 'meta10' && assessorId !== 'gilbert') return; // Meta 10 é só do Gilbert
                if (key === 'seeu' && assessorId !== 'laise') return; // SEEU é só da Laíse
                
                const cat = categorias[key];
                const progresso = getProgressoCategoria(assessorId, key);
                
                let metaText = '';
                if (key === 'meta10' || key === 'meta2') {
                    metaText = progresso.semanal ? `${progresso.atual}/${progresso.meta} (semanal)` : `${progresso.atual}/${progresso.meta}`;
                } else if (key === 'seeu') {
                    metaText = `${progresso.atual}/${progresso.meta} (controle de acesso - não conta para meta diária)`;
                } else if (key === 'alem_meta') {
                    metaText = `${progresso.atual} (sem limite de meta)`;
                } else {
                    metaText = `${progresso.atual}/${progresso.meta}`;
                }
                
                // Destacar categorias especiais
                const isAlemMeta = key === 'alem_meta';
                const isSEEU = key === 'seeu';
                const isEspecial = isAlemMeta || isSEEU;
                
                categoriasHtml += `
                    <div class="mb-3 ${isEspecial ? `border-l-4 ${isSEEU ? 'border-teal-400' : 'border-gray-400'} pl-3 ${isSEEU ? 'bg-teal-50' : 'bg-gray-50'} rounded-r-lg py-2` : ''}">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span class="${isEspecial ? 'font-medium text-gray-700' : ''}">${cat.nome}</span>
                            <span class="font-medium ${isEspecial ? 'text-gray-800' : ''}">${metaText}</span>
                        </div>
                        ${progresso.semMeta || isSEEU ? `
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="${cat.cor} h-2 rounded-full transition-all duration-300" style="width: ${progresso.atual > 0 ? '100%' : '0%'}"></div>
                            </div>
                            ${isAlemMeta && progresso.atual > 0 ? `
                                <div class="text-xs text-gray-500 mt-1 text-center">
                                    ➕ Produtividade adicional (não conta para meta diária)
                                </div>
                            ` : ''}
                            ${isSEEU && progresso.atual > 0 ? `
                                <div class="text-xs text-teal-600 mt-1 text-center">
                                    🛡️ Controle de acesso ao sistema (não conta para meta diária)
                                </div>
                            ` : ''}
                        ` : `
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="${cat.cor} h-2 rounded-full transition-all duration-300" style="width: ${progresso.percentual}%"></div>
                            </div>
                        `}
                    </div>
                `;
            });

            let ultimasMinutasHtml = '';
            if (minutasHoje.length > 0) {
                const ultimasMinutas = minutasHoje.slice(-3).reverse();
                ultimasMinutasHtml = `
                    <div class="mt-4 pt-4 border-t border-gray-200">
                        <h4 class="text-sm font-medium text-gray-700 mb-2">Últimas minutas</h4>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
                            ${ultimasMinutas.map(minuta => `
                                <div class="text-xs text-gray-600 bg-gray-50 p-2 rounded ${minuta.editadaEm ? 'border-l-2 border-orange-400' : ''} ${minuta.categoria === 'meta10' ? 'border-l-2 border-purple-400 bg-purple-50' : minuta.categoria === 'meta2' ? 'border-l-2 border-pink-400 bg-pink-50' : minuta.categoria === 'seeu' ? 'border-l-2 border-teal-400 bg-teal-50' : minuta.categoria === 'alem_meta' ? 'border-l-2 border-gray-400 bg-gray-100' : ''} ${minuta.status === 'correcao' ? 'border-l-4 border-blue-500 bg-blue-50 animate-pulse shadow-md' : ''}">
                                    <div class="font-medium flex items-center gap-1">
                                        ${minuta.numeroProcesso || 'Sem número'}
                                        ${minuta.categoria === 'meta10' ? '<span class="text-purple-600">🎯</span>' : ''}
                                        ${minuta.categoria === 'meta2' ? '<span class="text-pink-600">⚖️</span>' : ''}
                                        ${minuta.categoria === 'seeu' ? '<span class="text-teal-600">🛡️</span>' : ''}
                                        ${minuta.categoria === 'alem_meta' ? '<span class="text-gray-600">➕</span>' : ''}
                                        ${minuta.editadaEm ? '<span class="text-orange-600" title="Editada">✏️</span>' : ''}
                                        ${minuta.status === 'correcao' ? '<span class="text-blue-600 font-bold" title="Correção Solicitada">🔴📝</span>' : ''}
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-xs">${minuta.tipoMinuta} - ${categorias[minuta.categoria]?.nome}</span>
                                        <span class="status-badge ${statusOptions[minuta.status]?.cor || 'status-pendente'}">${statusOptions[minuta.status]?.nome || 'Pendente'}</span>
                                    </div>
                                    ${minuta.status === 'correcao' && minuta.correcaoSolicitada ? `
                                        <div class="mt-2 p-2 bg-blue-100 border border-blue-300 rounded text-xs">
                                            <div class="font-bold text-blue-800 flex items-center">
                                                <i data-lucide="alert-triangle" class="h-3 w-3 mr-1"></i>
                                                CORREÇÃO NECESSÁRIA:
                                            </div>
                                            <div class="text-blue-700 mt-1 font-medium bg-white p-1 rounded">"${minuta.correcaoSolicitada.length > 80 ? minuta.correcaoSolicitada.substring(0, 80) + '...' : minuta.correcaoSolicitada}"</div>
                                            <div class="text-blue-600 mt-1 text-xs">
                                                📄 Veja o histórico para detalhes completos
                                            </div>
                                        </div>
                                    ` : ''}
                                    <div class="text-gray-500 text-xs">${minuta.timestamp}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            // Verificar se há correções pendentes
            const correcoesPendentes = minutasHoje.filter(m => m.status === 'correcao').length;
            let alertaCorrecoes = '';
            
            if (correcoesPendentes > 0) {
                alertaCorrecoes = `
                    <div class="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-3">
                        <div class="flex items-center">
                            <i data-lucide="alert-circle" class="h-5 w-5 text-blue-600 mr-2"></i>
                            <div>
                                <div class="font-medium text-blue-800">
                                    ${correcoesPendentes} correç${correcoesPendentes === 1 ? 'ão pendente' : 'ões pendentes'}
                                </div>
                                <div class="text-xs text-blue-600">
                                    Verifique o histórico para detalhes das correções solicitadas
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Verificar alertas específicos por categoria
            const minutasSEEU = minutasHoje.filter(m => m.categoria === 'seeu').length;
            let alertasExtras = '';
            
            if (minutasSEEU > 0) {
                alertasExtras += `
                    <div class="mt-4 bg-teal-50 border border-teal-200 rounded-lg p-3">
                        <div class="flex items-center">
                            <i data-lucide="shield-check" class="h-5 w-5 text-teal-600 mr-2"></i>
                            <div>
                                <div class="font-medium text-teal-800">
                                    ${minutasSEEU} acesso${minutasSEEU === 1 ? '' : 's'} ao SEEU registrado${minutasSEEU === 1 ? '' : 's'} hoje
                                </div>
                                <div class="text-xs text-teal-600">
                                    🛡️ SEEU é controle de acesso - não conta para meta diária de 10 minutas
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            return `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">${assessor.nome}</h3>
                        <div class="text-right">
                            <div class="px-3 py-1 rounded-full text-sm font-medium ${
                                progressoTotal.atual >= 10 ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                            }">
                                ${progressoTotal.atual}/10 minutas CNJ
                            </div>
                            ${(progressoTotal.alemDaMeta > 0 || progressoTotal.seeu > 0) ? `
                                <div class="text-xs text-gray-600 mt-1 space-x-2">
                                    ${progressoTotal.alemDaMeta > 0 ? `<span class="bg-gray-100 px-2 py-1 rounded">+${progressoTotal.alemDaMeta} extra</span>` : ''}
                                    ${progressoTotal.seeu > 0 ? `<span class="bg-teal-100 text-teal-700 px-2 py-1 rounded">${progressoTotal.seeu} SEEU</span>` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex justify-between text-sm text-gray-600 mb-1">
                            <span>Progresso Diário (Metas CNJ Apenas)</span>
                            <span class="font-medium">${Math.round(progressoTotal.percentual)}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-3">
                            <div class="${progressoTotal.atual >= 10 ? 'bg-green-500' : 'bg-blue-500'} h-3 rounded-full transition-all duration-300" style="width: ${progressoTotal.percentual}%"></div>
                        </div>
                        ${(progressoTotal.alemDaMeta > 0 || progressoTotal.seeu > 0) ? `
                            <div class="text-xs text-gray-500 mt-1 text-center">
                                Total geral: ${progressoTotal.totalGeral} minutas 
                                (${progressoTotal.atual} CNJ${progressoTotal.alemDaMeta > 0 ? ` + ${progressoTotal.alemDaMeta} extra` : ''}${progressoTotal.seeu > 0 ? ` + ${progressoTotal.seeu} SEEU` : ''})
                            </div>
                            <div class="text-xs text-blue-600 mt-1 text-center">
                                📋 SEEU = controle de acesso (não conta para meta diária)
                            </div>
                        ` : ''}
                    </div>
                    
                    <div>
                        ${categoriasHtml}
                    </div>
                    
                    ${alertaCorrecoes}
                    ${alertasExtras}
                    ${ultimasMinutasHtml}
                </div>
            `;
        }

        // ==================== CALENDÁRIO ====================
        
        function renderCalendario() {
            try {
                const calendarioView = document.getElementById('calendario-view');
                if (!calendarioView) return;

                // Atualizar cabeçalho do mês/ano
                const mesAno = document.getElementById('calendario-mes-ano');
                const dataAtual = new Date(calendarioData.anoAtual, calendarioData.mesAtual, 1);
                mesAno.textContent = dataAtual.toLocaleDateString('pt-BR', { 
                    month: 'long', 
                    year: 'numeric' 
                }).replace(/^\w/, c => c.toUpperCase());

                // Renderizar dias do calendário
                renderDiasCalendario();

                calendarioView.classList.remove('hidden');
                setTimeout(() => lucide.createIcons(), 100);
                log('Calendário renderizado');
                
            } catch (error) {
                log('Erro ao renderizar calendário', error);
                showNotification('Erro ao carregar calendário', 'error');
            }
        }

        function renderDiasCalendario() {
            const calendarioDias = document.getElementById('calendario-dias');
            if (!calendarioDias) return;

            const hoje = getDataHoraBrasilia(); // Usar horário de Brasília
            const hojeString = getHojeString();
            
            const primeiroDia = new Date(calendarioData.anoAtual, calendarioData.mesAtual, 1);
            const ultimoDia = new Date(calendarioData.anoAtual, calendarioData.mesAtual + 1, 0);
            
            // Calcular dias do mês anterior para preencher a primeira semana
            const diasMesAnterior = primeiroDia.getDay();
            const inicioCalendario = new Date(primeiroDia);
            inicioCalendario.setDate(inicioCalendario.getDate() - diasMesAnterior);
            
            let diasHtml = '';
            let dataAtual = new Date(inicioCalendario);
            
            // Renderizar 6 semanas (42 dias)
            for (let i = 0; i < 42; i++) {
                const dataString = dataAtual.toISOString().split('T')[0];
                const isHoje = dataString === hojeString;
                const isOutroMes = dataAtual.getMonth() !== calendarioData.mesAtual;
                const isSelecionado = dataString === calendarioData.diaSelecionado;
                
                // Obter minutas do dia (excluindo as marcadas como excluídas)
                const minutasDia = getMinutasPorData(dataString).filter(m => m.status !== 'excluida');
                const hasData = minutasDia.length > 0;
                
                // Verificar status da Meta 10 para a semana
                const inicioSemana = getInicioSemana(dataAtual);
                const fimSemana = getFimSemana(dataAtual);
                const minutasMeta10Semana = getMinutasSemana(inicioSemana, fimSemana, 'gilbert', 'meta10');
                const metaSemanaCumprida = minutasMeta10Semana.length > 0;
                
                // Verificar acesso SEEU no dia
                const minutasSEEUDia = minutasDia.filter(m => m.categoria === 'seeu');
                const temSEEU = minutasSEEUDia.length > 0;
                
                let classes = 'calendar-day';
                if (isHoje) classes += ' today';
                if (isOutroMes) classes += ' other-month';
                if (isSelecionado) classes += ' selected';
                if (hasData && !isOutroMes) classes += ' has-data';
                
                // Indicadores especiais
                let weekIndicator = '';
                let seuIndicator = '';
                
                if (!isOutroMes && dataAtual.getDay() === 1) { // Segunda-feira para Meta 10
                    const indicatorClass = metaSemanaCumprida ? 'week-success' : 
                                         dataAtual <= hoje ? 'week-danger' : 'week-warning';
                    weekIndicator = `<div class="week-indicator ${indicatorClass}"></div>`;
                }
                
                if (!isOutroMes && temSEEU) { // Indicador SEEU
                    seuIndicator = `<div class="week-indicator week-success" style="left: 8px; background-color: #14b8a6;"></div>`;
                }
                
                diasHtml += `
                    <div class="${classes}" onclick="selecionarDia('${dataString}')">
                        ${weekIndicator}
                        ${seuIndicator}
                        <div class="day-number">${dataAtual.getDate()}</div>
                        ${hasData && !isOutroMes ? `<div class="day-count">${minutasDia.length}</div>` : ''}
                    </div>
                `;
                
                dataAtual.setDate(dataAtual.getDate() + 1);
            }
            
            calendarioDias.innerHTML = diasHtml;
        }

        function navegarMes(direcao) {
            calendarioData.mesAtual += direcao;
            
            if (calendarioData.mesAtual > 11) {
                calendarioData.mesAtual = 0;
                calendarioData.anoAtual++;
            } else if (calendarioData.mesAtual < 0) {
                calendarioData.mesAtual = 11;
                calendarioData.anoAtual--;
            }
            
            renderCalendario();
        }

        function irParaHoje() {
            const hoje = getDataHoraBrasilia(); // Usar horário de Brasília
            calendarioData.mesAtual = hoje.getMonth();
            calendarioData.anoAtual = hoje.getFullYear();
            calendarioData.diaSelecionado = getHojeString();
            
            renderCalendario();
            renderDetalhesCalendario(calendarioData.diaSelecionado);
        }

        function selecionarDia(dataString) {
            calendarioData.diaSelecionado = dataString;
            renderDiasCalendario();
            renderDetalhesCalendario(dataString);
        }

        function renderDetalhesCalendario(dataString) {
            const detalhesDiv = document.getElementById('calendario-detalhes');
            if (!detalhesDiv || !dataString) return;

            const data = new Date(dataString + 'T12:00:00');
            const todasMinutasDia = Object.values(minutas).filter(m => m?.data === dataString);
            const minutasDia = todasMinutasDia.filter(m => m.status !== 'excluida'); // Apenas as que contam para produtividade
            const minutasExcluidas = todasMinutasDia.filter(m => m.status === 'excluida'); // Separar excluídas
            
            if (todasMinutasDia.length === 0) {
                detalhesDiv.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="calendar-x" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-600 mb-2">
                            ${data.toLocaleDateString('pt-BR', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </h3>
                        <p>Nenhuma minuta registrada neste dia</p>
                    </div>
                `;
                setTimeout(() => lucide.createIcons(), 100);
                return;
            }

            // Agrupar minutas por assessor (apenas as válidas para produtividade)
            const minutasPorAssessor = {
                gilbert: minutasDia.filter(m => 
                    m.assessorId === 'gilbert' || 
                    m.assessorId === 'assessor1' || 
                    (m.assessorNome && m.assessorNome.includes('Gilbert'))
                ),
                laise: minutasDia.filter(m => 
                    m.assessorId === 'laise' || 
                    m.assessorId === 'assessor2' || 
                    (m.assessorNome && m.assessorNome.includes('Laíse'))
                )
            };

            let detalhesHtml = `
                <div class="space-y-4">
                    <div class="text-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">
                            ${data.toLocaleDateString('pt-BR', { 
                                weekday: 'long', 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric' 
                            })}
                        </h3>
                        <div class="bg-blue-100 text-blue-800 px-4 py-2 rounded-lg inline-flex items-center">
                            <i data-lucide="file-text" class="h-5 w-5 mr-2"></i>
                            ${minutasDia.length} minutas válidas para produtividade
                        </div>
                        ${minutasExcluidas.length > 0 ? `
                            <div class="bg-red-100 text-red-800 px-4 py-2 rounded-lg inline-flex items-center mt-2">
                                <i data-lucide="x-circle" class="h-5 w-5 mr-2"></i>
                                ${minutasExcluidas.length} minutas excluídas (não contam para produtividade)
                            </div>
                        ` : ''}
                    </div>
            `;

            // Renderizar minutas por assessor
            Object.entries(minutasPorAssessor).forEach(([assessorId, minutasAssessor]) => {
                if (minutasAssessor.length === 0) return;

                const assessor = assessores[assessorId];
                const estatisticas = {
                    meta1: minutasAssessor.filter(m => m.categoria === 'meta1').length,
                    meta2: minutasAssessor.filter(m => m.categoria === 'meta2').length,
                    meta10: minutasAssessor.filter(m => m.categoria === 'meta10').length,
                    seeu: minutasAssessor.filter(m => m.categoria === 'seeu').length,
                    sem_movimento: minutasAssessor.filter(m => m.categoria === 'sem_movimento').length,
                    outros: minutasAssessor.filter(m => m.categoria === 'outros').length,
                    alem_meta: minutasAssessor.filter(m => m.categoria === 'alem_meta').length
                };

                detalhesHtml += `
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-gray-800">${assessor.nome}</h4>
                            <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">${minutasAssessor.length} minutas</span>
                        </div>
                        
                        <div class="grid grid-cols-${assessorId === 'gilbert' ? '6' : assessorId === 'laise' ? '6' : '5'} gap-2 mb-3 text-xs">
                            <div class="bg-red-100 text-red-800 p-2 rounded text-center">
                                <div class="font-medium">${estatisticas.meta1}</div>
                                <div>Meta 1</div>
                            </div>
                            <div class="bg-pink-100 text-pink-800 p-2 rounded text-center">
                                <div class="font-medium">${estatisticas.meta2}</div>
                                <div>Meta 2</div>
                            </div>
                            ${assessorId === 'gilbert' ? `
                                <div class="bg-purple-100 text-purple-800 p-2 rounded text-center">
                                    <div class="font-medium">${estatisticas.meta10}</div>
                                    <div>Meta 10</div>
                                </div>
                            ` : ''}
                            ${assessorId === 'laise' ? `
                                <div class="bg-teal-100 text-teal-800 p-2 rounded text-center">
                                    <div class="font-medium">${estatisticas.seeu}</div>
                                    <div>SEEU</div>
                                </div>
                            ` : ''}
                            <div class="bg-orange-100 text-orange-800 p-2 rounded text-center">
                                <div class="font-medium">${estatisticas.sem_movimento}</div>
                                <div>100+ dias</div>
                            </div>
                            <div class="bg-blue-100 text-blue-800 p-2 rounded text-center">
                                <div class="font-medium">${estatisticas.outros}</div>
                                <div>Outros</div>
                            </div>
                            <div class="bg-gray-100 text-gray-800 p-2 rounded text-center">
                                <div class="font-medium">${estatisticas.alem_meta}</div>
                                <div>Além da Meta</div>
                            </div>
                        </div>
                        
                        <div class="space-y-2 max-h-40 overflow-y-auto">
                            ${minutasAssessor.map(minuta => {
                                const categoria = categorias[minuta.categoria];
                                const status = statusOptions[minuta.status || 'pendente'];
                                
                                return `
                                    <div class="bg-white p-2 rounded border text-xs ${minuta.categoria === 'meta10' ? 'border-purple-300 bg-purple-50' : minuta.categoria === 'meta2' ? 'border-pink-300 bg-pink-50' : minuta.categoria === 'seeu' ? 'border-teal-300 bg-teal-50' : minuta.categoria === 'alem_meta' ? 'border-gray-300 bg-gray-100' : ''}">
                                        <div class="font-medium text-gray-800 flex items-center gap-1">
                                            ${minuta.numeroProcesso || 'Sem número'}
                                            ${minuta.categoria === 'meta10' ? '<span class="text-purple-600">🎯</span>' : ''}
                                            ${minuta.categoria === 'meta2' ? '<span class="text-pink-600">⚖️</span>' : ''}
                                            ${minuta.categoria === 'seeu' ? '<span class="text-teal-600">🛡️</span>' : ''}
                                            ${minuta.categoria === 'alem_meta' ? '<span class="text-gray-600">➕</span>' : ''}
                                        </div>
                                        <div class="flex justify-between items-center mt-1">
                                            <span class="text-gray-600">${minuta.tipoMinuta}</span>
                                            <span class="status-badge ${status.cor}">${status.nome}</span>
                                        </div>
                                        ${minuta.timestamp ? `<div class="text-gray-500 mt-1">${minuta.timestamp}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            });

            // Adicionar seção de minutas excluídas se existirem
            if (minutasExcluidas.length > 0) {
                detalhesHtml += `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h4 class="font-medium text-red-800 mb-3 flex items-center">
                            <i data-lucide="x-circle" class="h-4 w-4 mr-2"></i>
                            Minutas Excluídas (${minutasExcluidas.length})
                        </h4>
                        <div class="text-xs text-red-700 mb-3">
                            ⚠️ Estas minutas foram excluídas pelo juiz e não contam para a produtividade
                        </div>
                        <div class="space-y-2 max-h-32 overflow-y-auto">
                            ${minutasExcluidas.map(minuta => {
                                const categoria = categorias[minuta.categoria];
                                const assessorNome = minuta.assessorNome || 
                                    (minuta.assessorId === 'gilbert' || minuta.assessorId === 'assessor1' ? 'Gilbert Juliano' :
                                     minuta.assessorId === 'laise' || minuta.assessorId === 'assessor2' ? 'Laíse Vital' : 'Assessor');
                                
                                return `
                                    <div class="bg-white p-2 rounded border border-red-200 text-xs opacity-75">
                                        <div class="font-medium text-red-800 flex items-center gap-1">
                                            ${minuta.numeroProcesso || 'Sem número'} - ${assessorNome}
                                            <span class="text-xs text-red-600 bg-red-100 px-2 py-1 rounded-full">EXCLUÍDA</span>
                                        </div>
                                        <div class="flex justify-between items-center mt-1">
                                            <span class="text-red-600">${minuta.tipoMinuta} - ${categoria?.nome}</span>
                                        </div>
                                        ${minuta.timestamp ? `<div class="text-red-500 mt-1">${minuta.timestamp}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            detalhesHtml += '</div>';
            detalhesDiv.innerHTML = detalhesHtml;
            setTimeout(() => lucide.createIcons(), 100);
        }

        // ==================== EDIÇÃO/EXCLUSÃO ====================
        
        function editarMinuta(minutaId) {
            const minuta = minutas[minutaId];
            if (!minuta || currentUser.isJuiz) return;

            // Verificar propriedade
            const isOwner = minuta.assessorId === currentUser.assessorId || 
                          (currentUser.assessorId === 'gilbert' && (minuta.assessorId === 'assessor1' || minuta.assessorNome?.includes('Gilbert'))) ||
                          (currentUser.assessorId === 'laise' && (minuta.assessorId === 'assessor2' || minuta.assessorNome?.includes('Laíse')));

            if (!isOwner) {
                showNotification('Você só pode editar suas próprias minutas.', 'error');
                return;
            }

            minutaEditando = { id: minutaId, ...minuta };

            // Preencher formulário
            document.getElementById('edit-numero-processo').value = minuta.numeroProcesso || '';
            document.getElementById('edit-tipo-minuta').value = minuta.tipoMinuta || '';
            document.getElementById('edit-categoria-minuta').value = minuta.categoria || '';
            document.getElementById('edit-observacoes-minuta').value = minuta.observacoes || '';

            // Validar Meta 2 se necessário
            validarTipoMinutaEdicao();

            document.getElementById('modal-edicao').classList.remove('hidden');
            lucide.createIcons();
        }

        function fecharModalEdicao() {
            document.getElementById('modal-edicao').classList.add('hidden');
            minutaEditando = null;
        }

        function salvarEdicao() {
            if (!minutaEditando) return;

            const numeroProcesso = document.getElementById('edit-numero-processo').value.trim();
            const tipoMinuta = document.getElementById('edit-tipo-minuta').value;
            const categoria = document.getElementById('edit-categoria-minuta').value;
            const observacoes = document.getElementById('edit-observacoes-minuta').value.trim();

            if (!numeroProcesso || !tipoMinuta || !categoria) {
                showNotification('Por favor, preencha todos os campos obrigatórios.', 'warning');
                return;
            }

            // Validação especial para Meta 2 - só aceita Sentença
            if (categoria === 'meta2' && tipoMinuta !== 'Sentença') {
                showNotification('Meta 2 CNJ aceita apenas minutas de Sentença.', 'error');
                return;
            }

            // Validação especial para Meta 10
            if (categoria === 'meta10' && currentUser.assessorId !== 'gilbert') {
                showNotification('Apenas Gilbert pode editar minutas da Meta 10 CNJ.', 'error');
                return;
            }

            // Validação especial para SEEU
            if (categoria === 'seeu' && currentUser.assessorId !== 'laise') {
                showNotification('Apenas Laíse pode editar minutas do SEEU.', 'error');
                return;
            }

            const minutaAtualizada = {
                ...minutaEditando,
                numeroProcesso,
                tipoMinuta,
                categoria,
                observacoes,
                editadaEm: getDataHoraBrasilia().toLocaleString('pt-BR')
            };

            try {
                if (database) {
                    database.ref(`minutas/${minutaEditando.id}`).set(minutaAtualizada)
                        .then(() => {
                            minutas[minutaEditando.id] = minutaAtualizada;
                            fecharModalEdicao();
                            renderHistorico();
                            renderDashboard();
                            showNotification('Minuta atualizada com sucesso!', 'success');
                            log('Minuta editada no Firebase', numeroProcesso);
                        })
                        .catch(() => {
                            minutas[minutaEditando.id] = minutaAtualizada;
                            fecharModalEdicao();
                            renderHistorico();
                            renderDashboard();
                            showNotification('Minuta atualizada localmente!', 'warning');
                        });
                } else {
                    minutas[minutaEditando.id] = minutaAtualizada;
                    fecharModalEdicao();
                    renderHistorico();
                    renderDashboard();
                    showNotification('Minuta atualizada localmente!', 'warning');
                }
            } catch (error) {
                minutas[minutaEditando.id] = minutaAtualizada;
                fecharModalEdicao();
                renderHistorico();
                renderDashboard();
                showNotification('Minuta atualizada localmente!', 'warning');
            }
        }

        function excluirMinuta(minutaId) {
            const minuta = minutas[minutaId];
            if (!minuta || currentUser.isJuiz) return;

            // Verificar propriedade
            const isOwner = minuta.assessorId === currentUser.assessorId || 
                          (currentUser.assessorId === 'gilbert' && (minuta.assessorId === 'assessor1' || minuta.assessorNome?.includes('Gilbert'))) ||
                          (currentUser.assessorId === 'laise' && (minuta.assessorId === 'assessor2' || minuta.assessorNome?.includes('Laíse')));

            if (!isOwner) {
                showNotification('Você só pode excluir suas próprias minutas.', 'error');
                return;
            }

            const isMetã10 = minuta.categoria === 'meta10';
            const isMetã2 = minuta.categoria === 'meta2';
            const isSEEU = minuta.categoria === 'seeu';
            
            let confirmMessage = 'Tem certeza que deseja excluir esta minuta? Esta ação não pode ser desfeita.';
            
            if (isMetã10) {
                confirmMessage = 'ATENÇÃO: Você está excluindo um processo da Meta 10 CNJ! Isso pode afetar o cumprimento da meta semanal. Tem certeza?';
            } else if (isMetã2) {
                confirmMessage = 'ATENÇÃO: Você está excluindo uma sentença da Meta 2 CNJ! Isso pode afetar o cumprimento da meta semanal. Tem certeza?';
            } else if (isSEEU) {
                confirmMessage = 'ATENÇÃO: Você está excluindo um acesso ao SEEU! Isso pode afetar o controle da meta de 10 dias. Tem certeza?';
            }

            if (!confirm(confirmMessage)) {
                return;
            }

            try {
                if (database) {
                    database.ref(`minutas/${minutaId}`).remove()
                        .then(() => {
                            delete minutas[minutaId];
                            renderHistorico();
                            renderDashboard();
                            showNotification('Minuta excluída com sucesso!', 'success');
                            log('Minuta excluída do Firebase', minuta.numeroProcesso);
                        })
                        .catch(() => {
                            delete minutas[minutaId];
                            renderHistorico();
                            renderDashboard();
                            showNotification('Minuta excluída localmente!', 'warning');
                        });
                } else {
                    delete minutas[minutaId];
                    renderHistorico();
                    renderDashboard();
                    showNotification('Minuta excluída localmente!', 'warning');
                }
            } catch (error) {
                delete minutas[minutaId];
                renderHistorico();
                renderDashboard();
                showNotification('Minuta excluída localmente!', 'warning');
            }
        }

        function atualizarStatus(minutaId, novoStatus) {
            if (!currentUser.isJuiz) return;

            // Se for correção, abrir modal para especificar detalhes
            if (novoStatus === 'correcao') {
                solicitarCorrecao(minutaId);
                return;
            }

            const minuta = minutas[minutaId];
            const statusAnterior = minuta?.status || 'pendente';

            try {
                if (database) {
                    database.ref(`minutas/${minutaId}/status`).set(novoStatus)
                        .then(() => {
                            minutas[minutaId].status = novoStatus;
                            
                            // Limpar correção se não for mais necessária
                            if (novoStatus !== 'correcao' && minutas[minutaId].correcaoSolicitada) {
                                database.ref(`minutas/${minutaId}/correcaoSolicitada`).remove();
                                database.ref(`minutas/${minutaId}/correcaoSolicitadaEm`).remove();
                                delete minutas[minutaId].correcaoSolicitada;
                                delete minutas[minutaId].correcaoSolicitadaEm;
                            }
                            
                            renderHistorico();
                            renderDashboard(); // Atualizar dashboard para recalcular produtividade
                            
                            let mensagem = `Status atualizado para: ${statusOptions[novoStatus].nome}`;
                            let tipo = 'success';
                            
                            if (novoStatus === 'excluida' && statusAnterior !== 'excluida') {
                                mensagem = `✖️ Minuta excluída - removida da contagem de produtividade`;
                                tipo = 'warning';
                            } else if (statusAnterior === 'excluida' && novoStatus !== 'excluida') {
                                mensagem = `✅ Minuta reativada - incluída novamente na produtividade`;
                                tipo = 'success';
                            }
                            
                            showNotification(mensagem, tipo);
                            log('Status atualizado', `${minutaId} -> ${novoStatus}`);
                        });
                } else {
                    minutas[minutaId].status = novoStatus;
                    renderHistorico();
                    renderDashboard();
                    showNotification('Status atualizado localmente!', 'warning');
                }
            } catch (error) {
                minutas[minutaId].status = novoStatus;
                renderHistorico();
                renderDashboard();
                showNotification('Status atualizado localmente!', 'warning');
            }
        }

        function solicitarCorrecao(minutaId) {
            const minuta = minutas[minutaId];
            if (!minuta) return;

            minutaCorrecao = { id: minutaId, ...minuta };
            
            // Preencher informações da minuta no modal
            document.getElementById('modal-correcao-processo').textContent = `Processo: ${minuta.numeroProcesso || 'Não informado'}`;
            document.getElementById('modal-correcao-assessor').textContent = `Assessor: ${minuta.assessorNome || assessores[minuta.assessorId]?.nome || 'Assessor'}`;
            
            // Limpar campo de correção
            document.getElementById('correcao-detalhes').value = '';
            
            document.getElementById('modal-correcao').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('correcao-detalhes').focus();
                lucide.createIcons();
            }, 100);
        }

        function fecharModalCorrecao() {
            document.getElementById('modal-correcao').classList.add('hidden');
            minutaCorrecao = null;
        }

        function confirmarCorrecao() {
            if (!minutaCorrecao) return;

            const correcaoDetalhes = document.getElementById('correcao-detalhes').value.trim();
            
            if (!correcaoDetalhes) {
                showNotification('Por favor, especifique a correção necessária.', 'warning');
                return;
            }

            const agora = getDataHoraBrasilia();
            const correcaoData = {
                status: 'correcao',
                correcaoSolicitada: correcaoDetalhes,
                correcaoSolicitadaEm: agora.toLocaleString('pt-BR'),
                correcaoSolicitadaPor: currentUser.nome
            };

            try {
                if (database) {
                    // Atualizar no Firebase
                    const updates = {};
                    updates[`minutas/${minutaCorrecao.id}/status`] = 'correcao';
                    updates[`minutas/${minutaCorrecao.id}/correcaoSolicitada`] = correcaoDetalhes;
                    database.ref().update(updates)
                        .then(() => {
                            Object.assign(minutas[minutaCorrecao.id], correcaoData);
                            fecharModalCorrecao();
                            renderHistorico();
                            renderDashboard();
                            showNotification('📝 Correção solicitada! O assessor foi notificado sobre as alterações necessárias.', 'success');
                            log('Correção solicitada', minutaCorrecao.numeroProcesso);
                        })
                        .catch(() => {
                            Object.assign(minutas[minutaCorrecao.id], correcaoData);
                            fecharModalCorrecao();
                            renderHistorico();
                            renderDashboard();
                            showNotification('Correção solicitada localmente!', 'warning');
                        });
                } else {
                    Object.assign(minutas[minutaCorrecao.id], correcaoData);
                    fecharModalCorrecao();
                    renderHistorico();
                    renderDashboard();
                    showNotification('Correção solicitada localmente!', 'warning');
                }
            } catch (error) {
                Object.assign(minutas[minutaCorrecao.id], correcaoData);
                fecharModalCorrecao();
                renderHistorico();
                renderDashboard();
                showNotification('Correção solicitada localmente!', 'warning');
            }
        }

        function marcarComoCorrigida(minutaId) {
            const minuta = minutas[minutaId];
            if (!minuta || currentUser.isJuiz) return;

            // Verificar propriedade
            const isOwner = minuta.assessorId === currentUser.assessorId || 
                          (currentUser.assessorId === 'gilbert' && (minuta.assessorId === 'assessor1' || minuta.assessorNome?.includes('Gilbert'))) ||
                          (currentUser.assessorId === 'laise' && (minuta.assessorId === 'assessor2' || minuta.assessorNome?.includes('Laíse')));

            if (!isOwner) {
                showNotification('Você só pode marcar suas próprias minutas como corrigidas.', 'error');
                return;
            }

            if (!confirm('Confirma que as correções solicitadas foram realizadas? A minuta retornará para análise do juiz.')) {
                return;
            }

            const agora = getDataHoraBrasilia();
            const updates = {
                status: 'pendente',
                corrigidaEm: agora.toLocaleString('pt-BR'),
                corrigidaPor: currentUser.nome
            };

            try {
                if (database) {
                    const firebaseUpdates = {};
                    firebaseUpdates[`minutas/${minutaId}/status`] = 'pendente';
                    firebaseUpdates[`minutas/${minutaId}/corrigidaEm`] = agora.toLocaleString('pt-BR');
                    firebaseUpdates[`minutas/${minutaId}/corrigidaPor`] = currentUser.nome;
                    
                    database.ref().update(firebaseUpdates)
                        .then(() => {
                            Object.assign(minutas[minutaId], updates);
                            renderHistorico();
                            renderDashboard();
                            showNotification('✅ Minuta marcada como corrigida! Aguardando nova análise do juiz.', 'success');
                            log('Minuta corrigida', minuta.numeroProcesso);
                        })
                        .catch(() => {
                            Object.assign(minutas[minutaId], updates);
                            renderHistorico();
                            renderDashboard();
                            showNotification('Minuta marcada como corrigida localmente!', 'warning');
                        });
                } else {
                    Object.assign(minutas[minutaId], updates);
                    renderHistorico();
                    renderDashboard();
                    showNotification('Minuta marcada como corrigida localmente!', 'warning');
                }
            } catch (error) {
                Object.assign(minutas[minutaId], updates);
                renderHistorico();
                renderDashboard();
                showNotification('Minuta marcada como corrigida localmente!', 'warning');
            }
        }
        
        function setupHistoricoFilters() {
            const filtersDiv = document.getElementById('historico-filters');
            
            if (currentUser.isJuiz) {
                filtersDiv.innerHTML = `
                    <select id="filtro-assessor" onchange="renderHistorico()" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                        <option value="">Todos os assessores</option>
                        <option value="gilbert">Gilbert Juliano</option>
                        <option value="laise">Laíse Vital</option>
                    </select>
                    <select id="filtro-status" onchange="renderHistorico()" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                        <option value="">Todos os status</option>
                        <option value="pendente">Pendente</option>
                        <option value="assinada">Assinada</option>
                        <option value="excluida">Excluída</option>
                        <option value="correcao">Precisa Correção</option>
                    </select>
                    <select id="filtro-categoria" onchange="renderHistorico()" class="border border-gray-300 rounded-md px-3 py-1 text-sm">
                        <option value="">Todas as categorias</option>
                        <option value="meta1">Meta 1 CNJ</option>
                        <option value="meta2">Meta 2 CNJ</option>
                        <option value="meta10">Meta 10 CNJ</option>
                        <option value="seeu">SEEU - Execução Penal (controle)</option>
                        <option value="sem_movimento">Sem movimentação 100+ dias</option>
                        <option value="outros">Pedidos/Atos/Urgentes</option>
                        <option value="alem_meta">Além da Meta (adicional)</option>
                    </select>
                `;
            } else {
                filtersDiv.innerHTML = '';
            }
        }

        function renderHistorico() {
            try {
                const historico = document.getElementById('historico-view');
                if (!historico) return;

                const minutasArray = Object.entries(minutas).map(([key, minuta]) => ({
                    ...minuta,
                    id: key
                })).sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                let minutasFiltradas = minutasArray;

                // Aplicar filtros
                if (currentUser.isJuiz) {
                    const filtroAssessor = document.getElementById('filtro-assessor')?.value;
                    const filtroStatus = document.getElementById('filtro-status')?.value;
                    const filtroCategoria = document.getElementById('filtro-categoria')?.value;
                    
                    if (filtroAssessor) {
                        minutasFiltradas = minutasFiltradas.filter(m => {
                            return m.assessorId === filtroAssessor || 
                                   (filtroAssessor === 'gilbert' && (m.assessorId === 'assessor1' || m.assessorNome?.includes('Gilbert'))) ||
                                   (filtroAssessor === 'laise' && (m.assessorId === 'assessor2' || m.assessorNome?.includes('Laíse')));
                        });
                    }
                    if (filtroStatus) {
                        minutasFiltradas = minutasFiltradas.filter(m => m.status === filtroStatus);
                    }
                    if (filtroCategoria) {
                        minutasFiltradas = minutasFiltradas.filter(m => m.categoria === filtroCategoria);
                    }
                } else {
                    minutasFiltradas = minutasFiltradas.filter(m => {
                        return m.assessorId === currentUser.assessorId || 
                               (currentUser.assessorId === 'gilbert' && (m.assessorId === 'assessor1' || m.assessorNome?.includes('Gilbert'))) ||
                               (currentUser.assessorId === 'laise' && (m.assessorId === 'assessor2' || m.assessorNome?.includes('Laíse')));
                    });
                }

                let content = '';
                if (minutasFiltradas.length === 0) {
                    content = `
                        <div class="text-center text-gray-500 py-12">
                            <i data-lucide="file-text" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                            <p>Nenhuma minuta encontrada.</p>
                        </div>
                    `;
                } else {
                    // Separar minutas com correção pendente para destacar
                    const minutasComCorrecao = minutasFiltradas.filter(m => m.status === 'correcao');
                    const outrasMinutas = minutasFiltradas.filter(m => m.status !== 'correcao');
                    
                    // Reorganizar: correções primeiro, depois as outras
                    const minutasOrdenadas = [...minutasComCorrecao, ...outrasMinutas];

                    content = `
                        <div class="space-y-3">
                            ${minutasOrdenadas.map(minuta => {
                                const categoria = categorias[minuta.categoria];
                                const status = statusOptions[minuta.status || 'pendente'];
                                
                                return `
                                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow ${minuta.categoria === 'meta10' ? 'border-purple-300 bg-purple-50' : minuta.categoria === 'meta2' ? 'border-pink-300 bg-pink-50' : minuta.categoria === 'seeu' ? 'border-teal-300 bg-teal-50' : minuta.categoria === 'alem_meta' ? 'border-gray-300 bg-gray-100' : ''} ${minuta.status === 'excluida' ? 'opacity-60 border-red-300 bg-red-50' : minuta.status === 'correcao' ? 'border-blue-400 bg-blue-50 shadow-lg' : ''}">
                                        <div class="flex items-start justify-between">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2 mb-2">
                                                    <span class="font-medium text-gray-800">${minuta.assessorNome || assessores[minuta.assessorId]?.nome || 'Assessor'}</span>
                                                    <span class="px-2 py-1 rounded-full text-xs font-medium ${categoria?.cor || 'bg-gray-500'} text-white">
                                                        ${categoria?.nome || 'Categoria'}
                                                    </span>
                                                    <span class="status-badge ${status.cor}">${status.nome}</span>
                                                    ${minuta.status === 'excluida' ? '<span class="text-xs text-red-600 bg-red-100 px-2 py-1 rounded-full font-medium">⚠️ NÃO CONTA PARA PRODUTIVIDADE</span>' : ''}
                                                    ${minuta.status === 'correcao' ? '<span class="text-xs text-blue-600 bg-blue-100 px-2 py-1 rounded-full font-medium animate-pulse">📝 CORREÇÃO SOLICITADA</span>' : ''}
                                                    ${minuta.categoria === 'meta10' ? '<span class="text-xs text-purple-600 bg-purple-100 px-2 py-1 rounded-full">Meta 10 🎯</span>' : ''}
                                                    ${minuta.categoria === 'meta2' ? '<span class="text-xs text-pink-600 bg-pink-100 px-2 py-1 rounded-full">Meta 2 ⚖️</span>' : ''}
                                                    ${minuta.categoria === 'seeu' ? '<span class="text-xs text-teal-600 bg-teal-100 px-2 py-1 rounded-full">SEEU 🛡️</span>' : ''}
                                                    ${minuta.categoria === 'alem_meta' ? '<span class="text-xs text-gray-600 bg-gray-100 px-2 py-1 rounded-full">Além da Meta ➕</span>' : ''}
                                                    ${minuta.editadaEm ? '<span class="text-xs text-orange-600 bg-orange-100 px-2 py-1 rounded-full">Editada</span>' : ''}
                                                    ${minuta.corrigidaEm ? '<span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded-full">Corrigida</span>' : ''}
                                                </div>
                                                <div class="text-sm text-gray-600 mb-2">
                                                    <div><strong>Processo:</strong> ${minuta.numeroProcesso || 'Não informado'}</div>
                                                    <div><strong>Tipo:</strong> ${minuta.tipoMinuta || 'Não informado'}</div>
                                                    ${minuta.observacoes ? `<div><strong>Observações:</strong> ${minuta.observacoes}</div>` : ''}
                                                    ${minuta.editadaEm ? `<div class="text-xs text-orange-600"><strong>Editada em:</strong> ${minuta.editadaEm}</div>` : ''}
                                                    ${minuta.corrigidaEm ? `<div class="text-xs text-green-600"><strong>Corrigida em:</strong> ${minuta.corrigidaEm} por ${minuta.corrigidaPor}</div>` : ''}
                                                </div>
                                                
                                                ${minuta.status === 'correcao' && minuta.correcaoSolicitada ? `
                                                    <div class="bg-blue-100 border-l-4 border-blue-500 rounded-lg p-4 mb-3 shadow-inner">
                                                        <div class="flex items-center mb-2">
                                                            <i data-lucide="alert-circle" class="h-5 w-5 text-blue-600 mr-2"></i>
                                                            <span class="font-bold text-blue-800">🔴 CORREÇÃO SOLICITADA PELO JUIZ</span>
                                                        </div>
                                                        <div class="text-sm text-blue-700 bg-white rounded p-3 border border-blue-200 font-medium">
                                                            "${minuta.correcaoSolicitada}"
                                                        </div>
                                                        <div class="text-xs text-blue-600 mt-2 flex items-center">
                                                            <i data-lucide="user" class="h-3 w-3 mr-1"></i>
                                                            Solicitado por ${minuta.correcaoSolicitadaPor || 'Juiz'} em ${minuta.correcaoSolicitadaEm}
                                                        </div>
                                                        ${!currentUser.isJuiz ? `
                                                            <div class="mt-3 p-2 bg-yellow-50 border border-yellow-200 rounded">
                                                                <div class="text-xs text-yellow-800 flex items-center">
                                                                    <i data-lucide="info" class="h-3 w-3 mr-1"></i>
                                                                    <strong>Ação necessária:</strong> Faça as correções solicitadas e clique em "Marcar como Corrigida"
                                                                </div>
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                ` : ''}
                                                
                                                ${currentUser.isJuiz ? `
                                                    <div class="flex gap-2 mt-2">
                                                        <button onclick="atualizarStatus('${minuta.id}', 'assinada')" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200 transition-colors">
                                                            <i data-lucide="check" class="h-3 w-3 mr-1 inline"></i>Assinada
                                                        </button>
                                                        <button onclick="atualizarStatus('${minuta.id}', 'correcao')" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 transition-colors">
                                                            <i data-lucide="edit" class="h-3 w-3 mr-1 inline"></i>Correção
                                                        </button>
                                                        <button onclick="atualizarStatus('${minuta.id}', 'excluida')" class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200 transition-colors">
                                                            <i data-lucide="x" class="h-3 w-3 mr-1 inline"></i>Excluir
                                                        </button>
                                                    </div>
                                                ` : `
                                                    <div class="flex gap-2 mt-2">
                                                        <button onclick="editarMinuta('${minuta.id}')" class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded hover:bg-blue-200 transition-colors">
                                                            <i data-lucide="edit-2" class="h-3 w-3 mr-1 inline"></i>Editar
                                                        </button>
                                                        <button onclick="excluirMinuta('${minuta.id}')" class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded hover:bg-red-200 transition-colors">
                                                            <i data-lucide="trash-2" class="h-3 w-3 mr-1 inline"></i>Excluir
                                                        </button>
                                                        ${minuta.status === 'correcao' ? `
                                                            <button onclick="marcarComoCorrigida('${minuta.id}')" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded hover:bg-green-200 transition-colors font-medium">
                                                                <i data-lucide="check-circle" class="h-3 w-3 mr-1 inline"></i>Marcar como Corrigida
                                                            </button>
                                                        ` : ''}
                                                    </div>
                                                `}
                                            </div>
                                            <div class="text-xs text-gray-500 text-right">
                                                <div>${new Date(minuta.data || Date.now()).toLocaleDateString('pt-BR')}</div>
                                                <div>${minuta.timestamp || ''}</div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                }

                document.getElementById('historico-content').innerHTML = content;
                historico.classList.remove('hidden');
                
                setTimeout(() => lucide.createIcons(), 100);
                log('Histórico renderizado');
                
            } catch (error) {
                log('Erro ao renderizar histórico', error);
                showNotification('Erro ao carregar histórico', 'error');
            }
        }

        // ==================== RELATÓRIOS ====================
        
        function gerarRelatorio(tipo) {
            try {
                const hoje = getDataHoraBrasilia(); // Usar horário de Brasília
                let dataInicio, dataFim, titulo;
                
                if (tipo === 'semanal') {
                    const inicioSemana = new Date(hoje);
                    inicioSemana.setDate(hoje.getDate() - hoje.getDay() + 1);
                    const fimSemana = new Date(inicioSemana);
                    fimSemana.setDate(inicioSemana.getDate() + 6);
                    
                    dataInicio = inicioSemana.toISOString().split('T')[0];
                    dataFim = fimSemana.toISOString().split('T')[0];
                    titulo = `Relatório Semanal (${inicioSemana.toLocaleDateString('pt-BR')} - ${fimSemana.toLocaleDateString('pt-BR')})`;
                } else {
                    const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                    
                    dataInicio = inicioMes.toISOString().split('T')[0];
                    dataFim = fimMes.toISOString().split('T')[0];
                    titulo = `Relatório Mensal (${inicioMes.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })})`;
                }

                const minutasPeriodo = Object.values(minutas).filter(m => 
                    m?.data && m.data >= dataInicio && m.data <= dataFim && m.status !== 'excluida'
                );

                const minutasExcluidasPeriodo = Object.values(minutas).filter(m => 
                    m?.data && m.data >= dataInicio && m.data <= dataFim && m.status === 'excluida'
                );

                const estatisticas = {};
                ['gilbert', 'laise'].forEach(assessorId => {
                    const minutasAssessor = minutasPeriodo.filter(m => {
                        return m.assessorId === assessorId || 
                               (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || m.assessorNome?.includes('Gilbert'))) ||
                               (assessorId === 'laise' && (m.assessorId === 'assessor2' || m.assessorNome?.includes('Laíse')));
                    });
                    
                    estatisticas[assessorId] = {
                        nome: assessores[assessorId].nome,
                        total: minutasAssessor.length,
                        porCategoria: {
                            meta1: minutasAssessor.filter(m => m.categoria === 'meta1').length,
                            meta2: minutasAssessor.filter(m => m.categoria === 'meta2').length,
                            meta10: minutasAssessor.filter(m => m.categoria === 'meta10').length,
                            seeu: minutasAssessor.filter(m => m.categoria === 'seeu').length,
                            sem_movimento: minutasAssessor.filter(m => m.categoria === 'sem_movimento').length,
                            outros: minutasAssessor.filter(m => m.categoria === 'outros').length,
                            alem_meta: minutasAssessor.filter(m => m.categoria === 'alem_meta').length
                        },
                        porStatus: {
                            assinada: minutasAssessor.filter(m => m.status === 'assinada').length,
                            pendente: minutasAssessor.filter(m => (m.status || 'pendente') === 'pendente').length,
                            correcao: minutasAssessor.filter(m => m.status === 'correcao').length,
                            excluida: minutasAssessor.filter(m => m.status === 'excluida').length
                        }
                    };
                });

                // Relatório especial da Meta 2
                const meta2Gilbert = getMeta2Status('gilbert');
                const meta2Laise = getMeta2Status('laise');
                const meta2Html = `
                    <div class="bg-pink-50 border border-pink-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center mb-4">
                            <i data-lucide="gavel" class="h-6 w-6 text-pink-600 mr-2"></i>
                            <h3 class="text-lg font-semibold text-pink-800">Meta 2 CNJ - Status Semanal</h3>
                        </div>
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-white rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-3">Gilbert Juliano</h4>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="bg-pink-100 rounded p-2">
                                        <div class="text-lg font-bold text-pink-600">${meta2Gilbert.totalSentencas}</div>
                                        <div class="text-xs text-gray-600">Total ano</div>
                                    </div>
                                    <div class="bg-white border rounded p-2">
                                        <div class="text-lg font-bold ${meta2Gilbert.metaSemanaCumprida ? 'text-green-600' : 'text-red-600'}">${meta2Gilbert.metaSemanaCumprida ? '✅' : '❌'}</div>
                                        <div class="text-xs text-gray-600">Esta semana</div>
                                    </div>
                                    <div class="bg-gray-100 rounded p-2">
                                        <div class="text-lg font-bold text-gray-600">${meta2Gilbert.percentualCumprimento}%</div>
                                        <div class="text-xs text-gray-600">Cumprimento</div>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <h4 class="font-medium text-gray-800 mb-3">Laíse Vital</h4>
                                <div class="grid grid-cols-3 gap-2 text-center">
                                    <div class="bg-pink-100 rounded p-2">
                                        <div class="text-lg font-bold text-pink-600">${meta2Laise.totalSentencas}</div>
                                        <div class="text-xs text-gray-600">Total ano</div>
                                    </div>
                                    <div class="bg-white border rounded p-2">
                                        <div class="text-lg font-bold ${meta2Laise.metaSemanaCumprida ? 'text-green-600' : 'text-red-600'}">${meta2Laise.metaSemanaCumprida ? '✅' : '❌'}</div>
                                        <div class="text-xs text-gray-600">Esta semana</div>
                                    </div>
                                    <div class="bg-gray-100 rounded p-2">
                                        <div class="text-lg font-bold text-gray-600">${meta2Laise.percentualCumprimento}%</div>
                                        <div class="text-xs text-gray-600">Cumprimento</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Relatório especial da Meta 10
                const meta10Status = getMeta10Status();
                const meta10Html = `
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center mb-4">
                            <i data-lucide="target" class="h-6 w-6 text-purple-600 mr-2"></i>
                            <h3 class="text-lg font-semibold text-purple-800">Meta 10 CNJ - Status Anual</h3>
                        </div>
                        <div class="grid md:grid-cols-4 gap-4 text-center">
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-purple-600">${meta10Status.processosJulgados}/9</div>
                                <div class="text-sm text-gray-600">Processos Julgados</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-orange-600">${meta10Status.processosRestantes}</div>
                                <div class="text-sm text-gray-600">Processos Restantes</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold ${meta10Status.metaSemanaCumprida ? 'text-green-600' : 'text-red-600'}">${meta10Status.metaSemanaCumprida ? '✅' : '❌'}</div>
                                <div class="text-sm text-gray-600">Meta Semanal</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-blue-600">${Math.round(meta10Status.percentualAnual)}%</div>
                                <div class="text-sm text-gray-600">Progresso Anual</div>
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h4 class="font-medium text-purple-800 mb-2">Histórico Semanal (${meta10Status.semanas.length} semanas)</h4>
                            <div class="grid grid-cols-10 gap-1">
                                ${meta10Status.semanas.map(semana => `
                                    <div class="h-8 rounded flex items-center justify-center text-xs font-medium ${
                                        semana.cumprida ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                                    }" title="Semana ${semana.numero}: ${semana.cumprida ? 'Cumprida' : 'Não cumprida'}">
                                        ${semana.numero}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                // Relatório especial SEEU
                const seuStatus = getSEEUStatus();
                const seuHtml = `
                    <div class="bg-teal-50 border border-teal-200 rounded-lg p-6 mb-6">
                        <div class="flex items-center mb-4">
                            <i data-lucide="shield-check" class="h-6 w-6 text-teal-600 mr-2"></i>
                            <h3 class="text-lg font-semibold text-teal-800">SEEU - Sistema de Execução Penal</h3>
                        </div>
                        <div class="grid md:grid-cols-4 gap-4 text-center">
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-teal-600">${seuStatus.totalAcessos}</div>
                                <div class="text-sm text-gray-600">Acessos no Ano</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-orange-600">${seuStatus.diasSemSEEU}</div>
                                <div class="text-sm text-gray-600">Dias sem Acesso</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold ${seuStatus.status === 'em_dia' ? 'text-green-600' : seuStatus.status === 'atencao' ? 'text-yellow-600' : 'text-red-600'}">${
                                    seuStatus.status === 'em_dia' ? '✅' : 
                                    seuStatus.status === 'atencao' ? '⚡' : '❌'
                                }</div>
                                <div class="text-sm text-gray-600">Status Atual</div>
                            </div>
                            <div class="bg-white rounded-lg p-4">
                                <div class="text-2xl font-bold text-blue-600">${seuStatus.mediaIntervalo || 0}</div>
                                <div class="text-sm text-gray-600">Média de Dias</div>
                            </div>
                        </div>
                        
                        ${seuStatus.historico.length > 0 ? `
                            <div class="mt-4">
                                <h4 class="font-medium text-teal-800 mb-2">Últimos Acessos (${seuStatus.historico.length})</h4>
                                <div class="grid grid-cols-5 gap-2">
                                    ${seuStatus.historico.slice(-10).map(h => `
                                        <div class="bg-white rounded p-2 text-center text-xs">
                                            <div class="font-medium text-teal-800">${new Date(h.data).toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' })}</div>
                                            ${h.diasEntre ? `<div class="text-gray-500">(+${h.diasEntre}d)</div>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;

                const relatorioHtml = `
                    <div class="space-y-6">
                        <div class="text-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-800">${titulo}</h2>
                            <p class="text-gray-600">Gerado em ${getDataHoraBrasilia().toLocaleDateString('pt-BR')} às ${getDataHoraBrasilia().toLocaleTimeString('pt-BR')} (Horário de Brasília)</p>
                        </div>
                        
                        ${meta2Html}
                        ${meta10Html}
                        ${seuHtml}
                        
                        <div class="grid md:grid-cols-2 gap-6">
                            ${Object.entries(estatisticas).map(([assessorId, stats]) => `
                                <div class="bg-gray-50 rounded-lg p-6">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-4">${stats.nome}</h3>
                                    <div class="space-y-4">
                                        <div class="flex justify-between items-center">
                                            <span class="font-medium">Total de Minutas:</span>
                                            <span class="text-2xl font-bold text-blue-600">${stats.total}</span>
                                        </div>
                                        
                                        <div class="border-t pt-3">
                                            <h4 class="font-medium text-gray-700 mb-2">Por Categoria:</h4>
                                            <div class="space-y-2 text-sm">
                                                <div class="flex justify-between">
                                                    <span>Meta 1 CNJ:</span>
                                                    <span class="font-medium">${stats.porCategoria.meta1}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Meta 2 CNJ:</span>
                                                    <span class="font-medium text-pink-600">${stats.porCategoria.meta2}</span>
                                                </div>
                                                ${assessorId === 'gilbert' ? `
                                                    <div class="flex justify-between">
                                                        <span>Meta 10 CNJ:</span>
                                                        <span class="font-medium text-purple-600">${stats.porCategoria.meta10}</span>
                                                    </div>
                                                ` : ''}
                                                ${assessorId === 'laise' ? `
                                                    <div class="flex justify-between">
                                                        <span>SEEU - Execução Penal:</span>
                                                        <span class="font-medium text-teal-600">${stats.porCategoria.seeu}</span>
                                                    </div>
                                                ` : ''}
                                                <div class="flex justify-between">
                                                    <span>Sem movimentação 100+ dias:</span>
                                                    <span class="font-medium">${stats.porCategoria.sem_movimento}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Pedidos/Atos/Urgentes:</span>
                                                    <span class="font-medium">${stats.porCategoria.outros}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Além da Meta:</span>
                                                    <span class="font-medium text-gray-600">${stats.porCategoria.alem_meta}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="border-t pt-3">
                                            <h4 class="font-medium text-gray-700 mb-2">Por Status:</h4>
                                            <div class="space-y-2 text-sm">
                                                <div class="flex justify-between">
                                                    <span>Assinadas:</span>
                                                    <span class="font-medium text-green-600">${stats.porStatus.assinada}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Pendentes:</span>
                                                    <span class="font-medium text-yellow-600">${stats.porStatus.pendente}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Precisam Correção:</span>
                                                    <span class="font-medium text-blue-600">${stats.porStatus.correcao}</span>
                                                </div>
                                                <div class="flex justify-between">
                                                    <span>Excluídas:</span>
                                                    <span class="font-medium text-red-600">${stats.porStatus.excluida}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Resumo Geral</h3>
                            <div class="grid md:grid-cols-6 gap-4 text-center">
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-2xl font-bold text-blue-600">${minutasPeriodo.length}</div>
                                    <div class="text-sm text-gray-600">Minutas Válidas</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-2xl font-bold text-pink-600">${minutasPeriodo.filter(m => m.categoria === 'meta2').length}</div>
                                    <div class="text-sm text-gray-600">Sentenças Meta 2</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-2xl font-bold text-gray-600">${minutasPeriodo.filter(m => m.categoria === 'alem_meta').length}</div>
                                    <div class="text-sm text-gray-600">Além da Meta</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-2xl font-bold text-green-600">${minutasPeriodo.filter(m => m.status === 'assinada').length}</div>
                                    <div class="text-sm text-gray-600">Minutas Assinadas</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-2xl font-bold text-yellow-600">${minutasPeriodo.filter(m => (m.status || 'pendente') === 'pendente').length}</div>
                                    <div class="text-sm text-gray-600">Minutas Pendentes</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-2xl font-bold text-red-600">${minutasPeriodo.filter(m => m.status === 'correcao').length}</div>
                                    <div class="text-sm text-gray-600">Precisam Correção</div>
                                </div>
                            </div>
                            ${minutasExcluidasPeriodo.length > 0 ? `
                                <div class="mt-4 bg-red-50 border border-red-200 rounded-lg p-4">
                                    <h4 class="font-medium text-red-800 mb-2 flex items-center">
                                        <i data-lucide="x-circle" class="h-4 w-4 mr-2"></i>
                                        Minutas Excluídas no Período
                                    </h4>
                                    <div class="grid md:grid-cols-3 gap-4 text-center">
                                        <div class="bg-white rounded-lg p-3">
                                            <div class="text-xl font-bold text-red-600">${minutasExcluidasPeriodo.length}</div>
                                            <div class="text-sm text-gray-600">Total Excluídas</div>
                                        </div>
                                        <div class="bg-white rounded-lg p-3">
                                            <div class="text-xl font-bold text-red-600">${minutasExcluidasPeriodo.filter(m => m.assessorId === 'gilbert' || m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert'))).length}</div>
                                            <div class="text-sm text-gray-600">Gilbert</div>
                                        </div>
                                        <div class="bg-white rounded-lg p-3">
                                            <div class="text-xl font-bold text-red-600">${minutasExcluidasPeriodo.filter(m => m.assessorId === 'laise' || m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('Laíse'))).length}</div>
                                            <div class="text-sm text-gray-600">Laíse</div>
                                        </div>
                                    </div>
                                    <div class="text-xs text-red-700 mt-2 text-center">
                                        ⚠️ Minutas excluídas não contam para as metas de produtividade
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;

                document.getElementById('relatorio-content').innerHTML = relatorioHtml;
                log(`Relatório ${tipo} gerado`);
                
            } catch (error) {
                log(`Erro ao gerar relatório ${tipo}`, error);
                showNotification('Erro ao gerar relatório', 'error');
            }
        }

        // ==================== EVENTOS ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                lucide.createIcons();
                log('Aplicação carregada');
                
                // Atalhos de teclado
                document.addEventListener('keydown', function(e) {
                    // ESC para fechar modais
                    if (e.key === 'Escape') {
                        if (!document.getElementById('modal-edicao').classList.contains('hidden')) {
                            fecharModalEdicao();
                        }
                        if (!document.getElementById('modal-correcao').classList.contains('hidden')) {
                            fecharModalCorrecao();
                        }
                    }
                    
                    // Ctrl+Enter para salvar
                    if (e.ctrlKey && e.key === 'Enter') {
                        if (!document.getElementById('modal-edicao').classList.contains('hidden')) {
                            salvarEdicao();
                        }
                        if (!document.getElementById('modal-correcao').classList.contains('hidden')) {
                            confirmarCorrecao();
                        }
                    }
                });
                
            } catch (error) {
                log('Erro na inicialização da página', error);
            }
        });
    </script>
</body>
</html>
