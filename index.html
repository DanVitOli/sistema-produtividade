<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema de Produtividade Judicial</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Sistema de controle de produtividade para gabinete judicial">
    <meta name="theme-color" content="#4F46E5">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Produtividade">
    <meta name="application-name" content="Produtividade Judicial">
    <meta name="msapplication-TileColor" content="#4F46E5">
    <meta name="msapplication-TileImage" content="/icons/icon-144x144.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">

    <!-- √çcones para iOS -->
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

    <!-- √çcone padr√£o (SVG com fallback PNG) -->
    <link rel="icon" type="image/svg+xml" href="/icons/icon.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192x192.png">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons com fallbacks -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"
            onerror="this.onerror=null;this.src='https://unpkg.com/lucide@latest/dist/umd/lucide.js'"></script>
    <!-- SheetJS para leitura de arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-pendente { background-color: #fef3c7; color: #92400e; }
        .status-assinada { background-color: #d1fae5; color: #065f46; }
        .status-excluida { background-color: #fee2e2; color: #991b1b; }
        .status-correcao { background-color: #dbeafe; color: #1e40af; }
        .status-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
        .calendar-day {
            min-height: 40px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px;
        }
        .calendar-day:hover {
            background-color: #f3f4f6;
        }
        .calendar-day.today {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .calendar-day.selected {
            background-color: #1d4ed8;
            color: white;
        }
        .calendar-day.has-data {
            background-color: #f0fdf4;
            border-color: #22c55e;
        }
        .calendar-day.has-data.selected {
            background-color: #15803d;
        }
        .calendar-day.other-month {
            color: #9ca3af;
            background-color: #f9fafb;
        }
        .productivity-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #22c55e;
        }
        .day-number {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .day-count {
            font-size: 0.75rem;
            text-align: center;
            background-color: rgba(34, 197, 94, 0.1);
            border-radius: 4px;
            padding: 1px 3px;
            margin-top: 2px;
        }
        .meta10-alert {
            animation: pulse 2s infinite;
            border-left: 4px solid #ef4444;
        }
        .meta10-success {
            border-left: 4px solid #22c55e;
        }
        .meta2-alert {
            animation: pulse 2s infinite;
            border-left: 4px solid #dc2626;
        }
        .meta2-success {
            border-left: 4px solid #16a34a;
        }
        .week-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .week-success { background-color: #22c55e; }
        .week-warning { background-color: #f59e0b; }
        .week-danger { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Indicador de Conex√£o -->
    <div id="connection-status" class="fixed top-4 right-4 z-50 no-print">
        <div class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium">
            Carregando...
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="mx-auto h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="scale" class="h-8 w-8 text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Sistema de Produtividade Judicial</h1>
                <p class="text-gray-600">Digite suas credenciais para acessar</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usu√°rio</label>
                    <select id="login-usuario" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione o usu√°rio</option>
                        <option value="juiz">Juiz</option>
                        <option value="gilbert">Gilbert Juliano</option>
                        <option value="laise">La√≠se Vital</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="login-senha" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite sua senha">
                </div>
                
                <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                    <i data-lucide="log-in" class="h-5 w-5 mr-2 inline"></i>
                    Entrar
                </button>
            </div>
        </div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="main-app" class="hidden p-4 max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Sistema de Produtividade Judicial</h1>
                    <p id="user-info" class="text-gray-600"></p>
                </div>
                <div class="flex items-center gap-3">
                    <!-- Indicador de Notifica√ß√µes (apenas para juiz) -->
                    <div id="notificacoes-container" class="hidden">
                        <button onclick="abrirModalNotificacoes()" class="relative bg-indigo-500 text-white p-2 rounded-full hover:bg-indigo-600 transition-colors" title="Notifica√ß√µes">
                            <i data-lucide="bell" class="h-5 w-5"></i>
                            <span id="notificacoes-badge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </button>
                    </div>
                    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors flex items-center">
                        <i data-lucide="log-out" class="h-4 w-4 mr-2"></i>
                        Sair
                    </button>
                </div>
            </div>
            
            <!-- Navega√ß√£o -->
            <div id="navigation" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-view" class="hidden space-y-6"></div>

        <!-- Registro de Minuta -->
        <div id="registro-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-6">
                    <i data-lucide="plus" class="h-6 w-6 text-blue-600 mr-2"></i>
                    <h2 class="text-xl font-semibold text-gray-800">Registrar Nova Minuta</h2>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Processo *</label>
                        <input type="text" id="numero-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 1234567-89.2024.8.12.3456">
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Minuta *</label>
                            <select id="tipo-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="validarTipoMinuta()">
                                <option value="">Selecione o tipo</option>
                                <option value="Despacho">Despacho</option>
                                <option value="Decis√£o">Decis√£o</option>
                                <option value="Senten√ßa">Senten√ßa</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Categorias/Metas Aplic√°veis *</label>
                            <div class="text-xs text-gray-600 mb-2">
                                ‚ÑπÔ∏è Selecione todas as categorias que se aplicam a esta minuta. Para a meta di√°ria, contar√° como 1 √∫nica minuta.
                            </div>
                            <div class="space-y-2 border border-gray-300 rounded-md p-3 bg-gray-50" id="categorias-container">
                                <label class="flex items-center">
                                    <input type="checkbox" name="categorias" value="meta1" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Meta 1 CNJ (2/dia)</span>
                                </label>
                                <label class="flex items-center" id="meta2-checkbox" style="display: none;">
                                    <input type="checkbox" name="categorias" value="meta2" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Meta 2 CNJ (1 senten√ßa/semana)</span>
                                </label>
                                <label class="flex items-center" id="meta10-checkbox" style="display: none;">
                                    <input type="checkbox" name="categorias" value="meta10" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Meta 10 CNJ (1/semana)</span>
                                </label>
                                <label class="flex items-center" id="seeu-checkbox" style="display: none;">
                                    <input type="checkbox" name="categorias" value="seeu" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">SEEU - Execu√ß√£o Penal (controle de acesso)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="categorias" value="sem_movimento" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Sem movimenta√ß√£o 60+ dias (5/dia)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="categorias" value="outros" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Pedidos/Atos/Urgentes (3/dia)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="categorias" value="alem_meta" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Al√©m da Meta (produtividade adicional)</span>
                                </label>

                                <!-- Pain√©is de Acompanhamento Especiais (15 dias) -->
                                <div class="border-t border-gray-300 mt-3 pt-3">
                                    <p class="text-xs text-gray-500 mb-2 font-medium">üìã Pain√©is de Acompanhamento (a cada 15 dias):</p>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="categorias" value="conhecimento_10anos" class="mr-2 h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded">
                                        <span class="text-sm">Conhecimento > 10 anos</span>
                                    </label>
                                    <label class="flex items-center" id="violencia-domestica-checkbox" style="display: none;">
                                        <input type="checkbox" name="categorias" value="violencia_domestica" class="mr-2 h-4 w-4 text-pink-600 focus:ring-pink-500 border-gray-300 rounded">
                                        <span class="text-sm">Viol√™ncia Dom√©stica (at√© 2025)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="categorias" value="acoes_saude" class="mr-2 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                                        <span class="text-sm">A√ß√µes de Sa√∫de (at√© 2025)</span>
                                    </label>
                                    <label class="flex items-center" id="acoes-penais-checkbox" style="display: none;">
                                        <input type="checkbox" name="categorias" value="acoes_penais" class="mr-2 h-4 w-4 text-gray-600 focus:ring-gray-500 border-gray-300 rounded">
                                        <span class="text-sm">A√ß√µes Penais (at√© 2023)</span>
                                    </label>
                                    <label class="flex items-center" id="processos-juri-checkbox" style="display: none;">
                                        <input type="checkbox" name="categorias" value="processos_juri" class="mr-2 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                                        <span class="text-sm">J√∫ri (at√© 2021)</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" name="categorias" value="acoes_ambientais" class="mr-2 h-4 w-4 text-emerald-600 focus:ring-emerald-500 border-gray-300 rounded">
                                        <span class="text-sm">A√ß√µes Ambientais (at√© 2022)</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campo de Substitui√ß√£o -->
                    <div class="bg-amber-50 border border-amber-200 rounded-md p-3">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="substituicao-checkbox" class="mr-3 h-5 w-5 text-amber-600 focus:ring-amber-500 border-gray-300 rounded">
                            <div>
                                <span class="text-sm font-medium text-amber-800">Produzida durante substitui√ß√£o do juiz titular</span>
                                <p class="text-xs text-amber-600 mt-1">Marque se esta minuta foi elaborada e/ou assinada durante per√≠odo de substitui√ß√£o.</p>
                            </div>
                        </label>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                        <textarea id="observacoes-minuta" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Coment√°rios sobre a minuta (opcional)"></textarea>
                    </div>
                    
                    <button onclick="registrarMinuta()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                        <i data-lucide="save" class="h-5 w-5 mr-2 inline"></i>
                        Registrar Minuta
                    </button>
                    
                    <div class="text-xs text-gray-500 text-center mt-2 bg-gray-50 p-2 rounded">
                        ‚ÑπÔ∏è Minutas registradas contam automaticamente para a produtividade. O juiz pode exclu√≠-las da contagem posteriormente se necess√°rio.<br>
                        üìã <strong>Nota:</strong> SEEU √© apenas controle de acesso e n√£o conta para a meta di√°ria de 10 minutas.
                    </div>
                </div>
            </div>
        </div>

        <!-- Hist√≥rico -->
        <div id="historico-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="clock" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Hist√≥rico de Minutas</h2>
                    </div>
                    <div id="historico-filters" class="flex gap-2 no-print"></div>
                </div>
                <div id="historico-content"></div>
            </div>
        </div>

        <!-- Calend√°rio -->
        <div id="calendario-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="calendar-days" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Calend√°rio de Produtividade</h2>
                    </div>
                    <div class="flex items-center gap-2 no-print">
                        <button onclick="navegarMes(-1)" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                            <i data-lucide="chevron-left" class="h-5 w-5"></i>
                        </button>
                        <span id="calendario-mes-ano" class="text-lg font-medium px-4"></span>
                        <button onclick="navegarMes(1)" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                            <i data-lucide="chevron-right" class="h-5 w-5"></i>
                        </button>
                        <button onclick="irParaHoje()" class="ml-4 bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition-colors text-sm">
                            Hoje
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Calend√°rio -->
                    <div class="space-y-4">
                        <!-- Cabe√ßalho dos dias da semana -->
                        <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600">
                            <div class="py-2">Dom</div>
                            <div class="py-2">Seg</div>
                            <div class="py-2">Ter</div>
                            <div class="py-2">Qua</div>
                            <div class="py-2">Qui</div>
                            <div class="py-2">Sex</div>
                            <div class="py-2">S√°b</div>
                        </div>
                        
                        <!-- Dias do calend√°rio -->
                        <div id="calendario-dias" class="grid grid-cols-7 gap-1"></div>
                        
                        <!-- Legenda -->
                        <div class="mt-4 text-xs text-gray-600 space-y-1">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-200 border border-blue-400 rounded"></div>
                                <span>Hoje</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-50 border border-green-500 rounded"></div>
                                <span>Dias com produtividade</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-800 rounded"></div>
                                <span>Dia selecionado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span>Meta 10 cumprida na semana</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span>Meta 10 n√£o cumprida</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-teal-500 rounded-full"></div>
                                <span>SEEU acessado</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detalhes do dia selecionado -->
                    <div id="calendario-detalhes" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <i data-lucide="calendar-check" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                            <p>Clique em um dia para ver os detalhes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios -->
        <div id="relatorios-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="bar-chart" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Relat√≥rios de Produtividade</h2>
                    </div>
                    <div class="flex gap-2 no-print">
                        <button onclick="gerarRelatorio('semanal')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm">
                            <i data-lucide="calendar-week" class="h-4 w-4 mr-1 inline"></i>
                            Relat√≥rio Semanal
                        </button>
                        <button onclick="gerarRelatorio('mensal')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors text-sm">
                            <i data-lucide="calendar-month" class="h-4 w-4 mr-1 inline"></i>
                            Relat√≥rio Mensal
                        </button>
                        <button onclick="mostrarRelatorioPersonalizado()" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition-colors text-sm">
                            <i data-lucide="calendar-range" class="h-4 w-4 mr-1 inline"></i>
                            Personalizado
                        </button>
                        <button onclick="window.print()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm">
                            <i data-lucide="printer" class="h-4 w-4 mr-1 inline"></i>
                            Imprimir
                        </button>
                    </div>
                </div>
                <div id="relatorio-content"></div>
            </div>
        </div>

        <!-- Balc√£o Virtual -->
        <div id="balcao-view" class="hidden">
            <!-- Painel de Monitoramento -->
            <div id="balcao-painel" class="mb-6"></div>

            <!-- Abas de Navega√ß√£o do Balc√£o -->
            <div class="bg-white rounded-lg shadow-md mb-6 no-print">
                <div class="border-b border-gray-200">
                    <nav class="flex -mb-px" id="balcao-tabs">
                        <button onclick="mudarAbaBalcao('cadastro')" id="tab-cadastro" class="balcao-tab px-6 py-3 text-sm font-medium border-b-2 border-purple-500 text-purple-600">
                            <i data-lucide="plus-circle" class="h-4 w-4 mr-2 inline"></i>
                            Cadastrar Pedido
                        </button>
                        <button onclick="mudarAbaBalcao('lista')" id="tab-lista" class="balcao-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i data-lucide="list" class="h-4 w-4 mr-2 inline"></i>
                            Lista de Pedidos
                        </button>
                        <button onclick="mudarAbaBalcao('relatorios')" id="tab-relatorios" class="balcao-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                            <i data-lucide="file-text" class="h-4 w-4 mr-2 inline"></i>
                            Relat√≥rios
                        </button>
                    </nav>
                </div>
            </div>

            <!-- Cadastro de Pedido -->
            <div id="balcao-aba-cadastro" class="bg-white rounded-lg shadow-md p-6 mb-6">
                <div class="flex items-center mb-6">
                    <i data-lucide="inbox" class="h-6 w-6 text-purple-600 mr-2"></i>
                    <h2 class="text-xl font-semibold text-gray-800">Cadastrar Pedido do Balc√£o Virtual</h2>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Processo *</label>
                        <input type="text" id="balcao-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ex: 1234567-89.2024.8.12.3456">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sequencial *</label>
                        <input type="number" id="balcao-sequencial" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ex: 1, 2, 3...">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Classe *</label>
                        <select id="balcao-classe" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Selecione</option>
                            <option value="civel">C√≠vel</option>
                            <option value="criminal">Criminal</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria/Urg√™ncia *</label>
                        <select id="balcao-categoria" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Selecione a categoria</option>
                            <option value="urgencia">Urg√™ncia (72h)</option>
                            <option value="meta_cnj">Meta do CNJ - exceto Meta 1 (72h)</option>
                            <option value="saude">Sa√∫de (72h)</option>
                            <option value="crime">Crime (72h)</option>
                            <option value="alvara">Alvar√° (72h)</option>
                            <option value="crianca">Crian√ßa (72h)</option>
                            <option value="incapaz">Incapaz (72h)</option>
                            <option value="idoso">Idoso - exceto a√ß√£o banc√°ria (72h)</option>
                            <option value="andamento_atrasado">Andamento Atrasado (72h)</option>
                            <option value="embargos">Embargos Declarat√≥rios (72h)</option>
                            <option value="extincao">Extin√ß√£o por desist√™ncia/perda objeto (72h)</option>
                            <option value="acordo">Acordo (72h)</option>
                            <option value="diligencia_simples">Dilig√™ncia Simples (72h)</option>
                            <option value="outros">Outros (60 dias)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data do Pedido *</label>
                        <input type="date" id="balcao-data-pedido" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Solicitante *</label>
                        <select id="balcao-tipo-solicitante" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="">Selecione</option>
                            <option value="advogado">Advogado</option>
                            <option value="parte">Parte</option>
                        </select>
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Solicitante</label>
                        <input type="text" id="balcao-nome-solicitante" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Nome do advogado ou parte">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Resumo do Pedido *</label>
                        <textarea id="balcao-resumo" rows="2" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Descreva brevemente o pedido..."></textarea>
                    </div>

                    <div class="md:col-span-2">
                        <label class="flex items-center cursor-pointer bg-blue-50 border border-blue-200 rounded-md p-3">
                            <input type="checkbox" id="balcao-despacho-virtual" class="mr-3 h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            <div>
                                <span class="text-sm font-medium text-blue-800">Necessita despacho virtual com o MM. Juiz</span>
                                <p class="text-xs text-blue-600">Marque se for necess√°rio agendar despacho virtual</p>
                            </div>
                        </label>
                    </div>
                </div>

                <button onclick="cadastrarPedidoBalcao()" class="w-full mt-4 bg-purple-600 text-white py-3 px-4 rounded-md hover:bg-purple-700 transition-colors font-medium">
                    <i data-lucide="plus" class="h-5 w-5 mr-2 inline"></i>
                    Cadastrar Pedido
                </button>
            </div>

            <!-- Lista de Pedidos -->
            <div id="balcao-aba-lista" class="bg-white rounded-lg shadow-md p-6 hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <i data-lucide="list" class="h-6 w-6 text-purple-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Pedidos Cadastrados</h2>
                    </div>
                </div>

                <!-- Filtros -->
                <div id="balcao-filtros" class="flex flex-wrap gap-2 mb-4">
                    <select id="filtro-balcao-status" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="renderBalcaoLista()">
                        <option value="">Todos os status</option>
                        <option value="pendente" selected>Pendentes</option>
                        <option value="minutado">Minutados</option>
                        <option value="cancelado">Cancelados</option>
                    </select>
                    <select id="filtro-balcao-categoria" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="renderBalcaoLista()">
                        <option value="">Todas as categorias</option>
                    </select>
                    <select id="filtro-balcao-assessor" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="renderBalcaoLista()">
                        <option value="">Todos os assessores</option>
                        <option value="gilbert">Gilbert</option>
                        <option value="laise">La√≠se</option>
                    </select>
                    <select id="filtro-balcao-prazo" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500" onchange="renderBalcaoLista()">
                        <option value="">Todos os prazos</option>
                        <option value="vencido">Vencidos</option>
                        <option value="vencendo">Vencendo hoje</option>
                        <option value="no_prazo">No prazo</option>
                    </select>
                    <button onclick="limparFiltrosBalcao()" class="bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600 transition-colors text-sm">
                        <i data-lucide="x" class="h-3 w-3 mr-1 inline"></i>
                        Limpar
                    </button>
                </div>

                <div id="balcao-lista"></div>
            </div>

            <!-- Relat√≥rios do Balc√£o Virtual -->
            <div id="balcao-aba-relatorios" class="hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center">
                            <i data-lucide="file-text" class="h-6 w-6 text-purple-600 mr-2"></i>
                            <h2 class="text-xl font-semibold text-gray-800">Relat√≥rios do Balc√£o Virtual</h2>
                        </div>
                        <div class="flex gap-2 no-print">
                            <button onclick="gerarRelatorioBalcao('semanal')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm">
                                <i data-lucide="calendar-week" class="h-4 w-4 mr-1 inline"></i>
                                Semanal
                            </button>
                            <button onclick="gerarRelatorioBalcao('mensal')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors text-sm">
                                <i data-lucide="calendar" class="h-4 w-4 mr-1 inline"></i>
                                Mensal
                            </button>
                            <button onclick="mostrarRelatorioBalcaoPersonalizado()" class="bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition-colors text-sm">
                                <i data-lucide="calendar-range" class="h-4 w-4 mr-1 inline"></i>
                                Personalizado
                            </button>
                            <button onclick="window.print()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm">
                                <i data-lucide="printer" class="h-4 w-4 mr-1 inline"></i>
                                Imprimir
                            </button>
                        </div>
                    </div>
                    <div id="balcao-relatorio-content">
                        <div class="text-center py-12">
                            <i data-lucide="bar-chart-3" class="mx-auto h-16 w-16 text-gray-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-gray-800 mb-2">Relat√≥rios do Balc√£o Virtual</h3>
                            <p class="text-gray-600 mb-6">Selecione o tipo de relat√≥rio que deseja gerar</p>

                            <div class="grid md:grid-cols-3 gap-4 max-w-4xl mx-auto">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                                    <h4 class="font-semibold text-blue-800 mb-2">üìÖ Relat√≥rio Semanal</h4>
                                    <p class="text-sm text-blue-700 mb-3">An√°lise dos pedidos da semana atual com estat√≠sticas de atendimento e prazos.</p>
                                    <button onclick="gerarRelatorioBalcao('semanal')" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm font-medium">
                                        Gerar Semanal
                                    </button>
                                </div>

                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                                    <h4 class="font-semibold text-green-800 mb-2">üìä Relat√≥rio Mensal</h4>
                                    <p class="text-sm text-green-700 mb-3">Vis√£o completa do m√™s com gr√°ficos de performance e tempo m√©dio de atendimento.</p>
                                    <button onclick="gerarRelatorioBalcao('mensal')" class="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors text-sm font-medium">
                                        Gerar Mensal
                                    </button>
                                </div>

                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-left">
                                    <h4 class="font-semibold text-purple-800 mb-2">üéØ Relat√≥rio Personalizado</h4>
                                    <p class="text-sm text-purple-700 mb-3">Escolha per√≠odo espec√≠fico para an√°lise detalhada dos pedidos.</p>
                                    <button onclick="mostrarRelatorioBalcaoPersonalizado()" class="w-full bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition-colors text-sm font-medium">
                                        Personalizar
                                    </button>
                                </div>
                            </div>

                            <div class="mt-8 text-xs text-gray-500">
                                <p>üí° <strong>Dica:</strong> Os relat√≥rios mostram estat√≠sticas de atendimento, tempo m√©dio de resposta e distribui√ß√£o por categoria.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- M√≥dulo Metas - A√ß√µes Penais -->
    <div id="metas-view" class="hidden">
        <!-- Dashboard da Meta -->
        <div id="metas-dashboard" class="mb-6">
            <!-- Ser√° preenchido pelo JavaScript -->
        </div>

        <!-- Abas de Navega√ß√£o das Metas -->
        <div class="bg-white rounded-lg shadow-md mb-6 no-print">
            <div class="border-b border-gray-200">
                <nav class="flex -mb-px" id="metas-tabs">
                    <button onclick="mudarAbaMetas('lista')" id="tab-metas-lista" class="metas-tab px-6 py-3 text-sm font-medium border-b-2 border-amber-500 text-amber-600">
                        <i data-lucide="list" class="h-4 w-4 mr-2 inline"></i>
                        Lista de Processos
                    </button>
                    <button onclick="mudarAbaMetas('cadastro')" id="tab-metas-cadastro" class="metas-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i data-lucide="plus-circle" class="h-4 w-4 mr-2 inline"></i>
                        Cadastrar Processo
                    </button>
                    <button onclick="mudarAbaMetas('relatorios')" id="tab-metas-relatorios" class="metas-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i data-lucide="bar-chart" class="h-4 w-4 mr-2 inline"></i>
                        Relat√≥rios
                    </button>
                    <button onclick="mudarAbaMetas('importar')" id="tab-metas-importar" class="metas-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
                        <i data-lucide="upload" class="h-4 w-4 mr-2 inline"></i>
                        Importar XLSX
                    </button>
                </nav>
            </div>
        </div>

        <!-- Lista de Processos da Meta -->
        <div id="metas-aba-lista" class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center">
                    <i data-lucide="scale" class="h-6 w-6 text-amber-600 mr-2"></i>
                    <h2 class="text-xl font-semibold text-gray-800">Processos da Meta 4 - A√ß√µes Penais</h2>
                </div>
            </div>

            <!-- Filtros -->
            <div class="flex flex-wrap gap-2 mb-4">
                <input type="text" id="filtro-metas-processo" placeholder="Buscar por n¬∫ do processo" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500 min-w-48" oninput="renderListaMetas()">
                <select id="filtro-metas-status" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" onchange="renderListaMetas()">
                    <option value="">Todos os status</option>
                    <option value="em_andamento">Em Andamento</option>
                    <option value="baixado">Baixado</option>
                    <option value="suspenso">Suspenso</option>
                    <option value="sobrestado">Sobrestado</option>
                    <option value="arquivado">Arquivado</option>
                </select>
                <select id="filtro-metas-fase" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" onchange="renderListaMetas()">
                    <option value="">Todas as fases</option>
                    <option value="inquerito">Inqu√©rito/Investiga√ß√£o</option>
                    <option value="denuncia">Den√∫ncia Recebida</option>
                    <option value="citacao">Cita√ß√£o</option>
                    <option value="resposta">Resposta √† Acusa√ß√£o</option>
                    <option value="instrucao">Instru√ß√£o</option>
                    <option value="alegacoes">Alega√ß√µes Finais</option>
                    <option value="sentenca">Senten√ßa</option>
                    <option value="recurso">Recurso</option>
                    <option value="transitado">Tr√¢nsito em Julgado</option>
                    <option value="execucao">Execu√ß√£o</option>
                </select>
                <select id="filtro-metas-parado" class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" onchange="renderListaMetas()">
                    <option value="">Movimenta√ß√£o</option>
                    <option value="30">Parados h√° +30 dias</option>
                    <option value="60">Parados h√° +60 dias</option>
                    <option value="90">Parados h√° +90 dias</option>
                </select>
                <button onclick="limparFiltrosMetas()" class="bg-gray-500 text-white px-3 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm">
                    <i data-lucide="x" class="h-3 w-3 mr-1 inline"></i>
                    Limpar
                </button>
            </div>

            <div id="metas-lista-processos">
                <!-- Ser√° preenchido pelo JavaScript -->
            </div>
        </div>

        <!-- Cadastro de Processo -->
        <div id="metas-aba-cadastro" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <div class="flex items-center mb-6">
                <i data-lucide="plus-circle" class="h-6 w-6 text-amber-600 mr-2"></i>
                <h2 class="text-xl font-semibold text-gray-800">Cadastrar Processo na Meta</h2>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Processo *</label>
                    <input type="text" id="meta-processo-numero" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Ex: 0000000-00.0000.8.02.0000">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                    <select id="meta-processo-status" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="em_andamento">Em Andamento</option>
                        <option value="baixado">Baixado</option>
                        <option value="suspenso">Suspenso</option>
                        <option value="sobrestado">Sobrestado</option>
                        <option value="arquivado">Arquivado</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fase Processual *</label>
                    <select id="meta-processo-fase" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="">Selecione a fase</option>
                        <option value="inquerito">Inqu√©rito/Investiga√ß√£o</option>
                        <option value="denuncia">Den√∫ncia Recebida</option>
                        <option value="citacao">Cita√ß√£o</option>
                        <option value="resposta">Resposta √† Acusa√ß√£o</option>
                        <option value="instrucao">Instru√ß√£o</option>
                        <option value="alegacoes">Alega√ß√µes Finais</option>
                        <option value="sentenca">Senten√ßa</option>
                        <option value="recurso">Recurso</option>
                        <option value="transitado">Tr√¢nsito em Julgado</option>
                        <option value="execucao">Execu√ß√£o</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data da √öltima Movimenta√ß√£o *</label>
                    <input type="date" id="meta-processo-ultima-mov" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes / Pend√™ncias</label>
                    <textarea id="meta-processo-observacoes" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Anota√ß√µes sobre o processo, pend√™ncias, etc..."></textarea>
                </div>
            </div>

            <button onclick="cadastrarProcessoMeta()" class="w-full mt-4 bg-amber-600 text-white py-3 px-4 rounded-md hover:bg-amber-700 transition-colors font-medium">
                <i data-lucide="plus" class="h-5 w-5 mr-2 inline"></i>
                Cadastrar Processo
            </button>
        </div>

        <!-- Relat√≥rios da Meta -->
        <div id="metas-aba-relatorios" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center">
                    <i data-lucide="bar-chart" class="h-6 w-6 text-amber-600 mr-2"></i>
                    <h2 class="text-xl font-semibold text-gray-800">Relat√≥rios da Meta</h2>
                </div>
                <button onclick="window.print()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm no-print">
                    <i data-lucide="printer" class="h-4 w-4 mr-1 inline"></i>
                    Imprimir
                </button>
            </div>

            <div id="metas-relatorio-content">
                <!-- Ser√° preenchido pelo JavaScript -->
            </div>
        </div>

        <!-- Importar Processos do XLSX -->
        <div id="metas-aba-importar" class="bg-white rounded-lg shadow-md p-6 mb-6 hidden">
            <div class="flex items-center mb-6">
                <i data-lucide="upload" class="h-6 w-6 text-amber-600 mr-2"></i>
                <h2 class="text-xl font-semibold text-gray-800">Importar Processos de Arquivo Excel</h2>
            </div>

            <div class="space-y-6">
                <!-- Instru√ß√µes -->
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-4">
                    <h3 class="font-medium text-amber-800 mb-2">üìã Instru√ß√µes</h3>
                    <ul class="text-sm text-amber-700 space-y-1">
                        <li>‚Ä¢ O arquivo deve estar no formato <strong>.xlsx</strong> ou <strong>.xls</strong></li>
                        <li>‚Ä¢ Os n√∫meros dos processos devem estar em uma coluna do arquivo</li>
                        <li>‚Ä¢ Formato esperado: 0000000-00.0000.0.00.0000</li>
                        <li>‚Ä¢ Processos j√° cadastrados ser√£o ignorados automaticamente</li>
                    </ul>
                </div>

                <!-- Upload do arquivo -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">1. Selecione o arquivo Excel</label>
                    <div class="flex items-center gap-4">
                        <input type="file" id="meta-arquivo-xlsx" accept=".xlsx,.xls" class="hidden" onchange="carregarArquivoXLSX(event)">
                        <button onclick="document.getElementById('meta-arquivo-xlsx').click()" class="bg-amber-600 text-white px-4 py-2 rounded-md hover:bg-amber-700 transition-colors">
                            <i data-lucide="file-spreadsheet" class="h-4 w-4 mr-2 inline"></i>
                            Selecionar Arquivo
                        </button>
                        <span id="meta-arquivo-nome" class="text-gray-600 text-sm">Nenhum arquivo selecionado</span>
                    </div>
                </div>

                <!-- Mapeamento de colunas -->
                <div id="meta-selecao-coluna" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">2. Mapeie as colunas do arquivo</label>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-3">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Coluna: N√∫mero do Processo *</label>
                                <select id="meta-coluna-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" onchange="atualizarPreviewImportacao()">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Coluna: Classe</label>
                                <select id="meta-coluna-classe" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" onchange="atualizarPreviewImportacao()">
                                    <option value="">N√£o importar</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Coluna: Situa√ß√£o</label>
                                <select id="meta-coluna-situacao" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-amber-500" onchange="atualizarPreviewImportacao()">
                                    <option value="">N√£o importar</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500">
                            üí° O sistema tentar√° detectar as colunas automaticamente pelo nome do cabe√ßalho.
                        </div>
                    </div>
                </div>

                <!-- Mapeamento de valores de situa√ß√£o -->
                <div id="meta-mapeamento-situacao" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">3. Mapeamento de Situa√ß√£o ‚Üí Status</label>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="text-xs text-blue-700 mb-3">
                            Configure como os valores da coluna "Situa√ß√£o" ser√£o convertidos para o status do sistema:
                        </div>
                        <div id="meta-mapeamento-valores" class="space-y-2">
                            <!-- Ser√° preenchido pelo JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Preview dos dados -->
                <div id="meta-preview-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">4. Pr√©via dos processos encontrados</label>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 max-h-64 overflow-y-auto">
                        <div id="meta-preview-lista" class="space-y-1 text-sm">
                            <!-- Ser√° preenchido pelo JavaScript -->
                        </div>
                    </div>
                    <div id="meta-preview-stats" class="mt-2 text-sm text-gray-600">
                        <!-- Ser√° preenchido pelo JavaScript -->
                    </div>
                </div>

                <!-- Op√ß√µes de importa√ß√£o (fase padr√£o) -->
                <div id="meta-opcoes-importacao" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">5. Fase processual padr√£o</label>
                    <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                        <div class="text-xs text-gray-600 mb-2">
                            Defina a fase inicial para os processos importados:
                        </div>
                        <select id="meta-import-fase" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="inquerito">Inqu√©rito/Investiga√ß√£o</option>
                            <option value="denuncia">Den√∫ncia Recebida</option>
                            <option value="citacao">Cita√ß√£o</option>
                            <option value="resposta">Resposta √† Acusa√ß√£o</option>
                            <option value="instrucao" selected>Instru√ß√£o</option>
                            <option value="alegacoes">Alega√ß√µes Finais</option>
                            <option value="sentenca">Senten√ßa</option>
                            <option value="recurso">Recurso</option>
                            <option value="transitado">Tr√¢nsito em Julgado</option>
                            <option value="execucao">Execu√ß√£o</option>
                        </select>
                    </div>
                </div>

                <!-- Bot√£o de importa√ß√£o -->
                <div id="meta-botao-importar" class="hidden">
                    <button onclick="executarImportacaoMeta()" class="w-full bg-green-600 text-white py-3 px-4 rounded-md hover:bg-green-700 transition-colors font-medium">
                        <i data-lucide="download" class="h-5 w-5 mr-2 inline"></i>
                        Importar Processos
                    </button>
                </div>

                <!-- Progresso da importa√ß√£o -->
                <div id="meta-progresso-importacao" class="hidden">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center mb-2">
                            <div class="loading-spinner mr-3" style="width: 20px; height: 20px; border-width: 2px;"></div>
                            <span class="text-blue-800 font-medium">Importando processos...</span>
                        </div>
                        <div class="bg-blue-200 rounded-full h-2 overflow-hidden">
                            <div id="meta-progresso-barra" class="bg-blue-600 h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <div id="meta-progresso-texto" class="text-xs text-blue-700 mt-1">0 de 0</div>
                    </div>
                </div>

                <!-- Resultado da importa√ß√£o -->
                <div id="meta-resultado-importacao" class="hidden">
                    <!-- Ser√° preenchido pelo JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Processo da Meta -->
    <div id="modal-edicao-processo-meta" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalEdicaoProcessoMeta()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i data-lucide="edit-2" class="h-5 w-5 text-amber-600 mr-2"></i>
                    Atualizar Processo
                </h3>
                <button onclick="fecharModalEdicaoProcessoMeta()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>

            <input type="hidden" id="edicao-meta-processo-id">

            <div class="space-y-4">
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3">
                    <div class="text-sm text-amber-800">
                        <div class="font-medium" id="edicao-meta-processo-numero-display">Processo: </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status *</label>
                    <select id="edicao-meta-processo-status" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="em_andamento">Em Andamento</option>
                        <option value="baixado">Baixado</option>
                        <option value="suspenso">Suspenso</option>
                        <option value="sobrestado">Sobrestado</option>
                        <option value="arquivado">Arquivado</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fase Processual *</label>
                    <select id="edicao-meta-processo-fase" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="inquerito">Inqu√©rito/Investiga√ß√£o</option>
                        <option value="denuncia">Den√∫ncia Recebida</option>
                        <option value="citacao">Cita√ß√£o</option>
                        <option value="resposta">Resposta √† Acusa√ß√£o</option>
                        <option value="instrucao">Instru√ß√£o</option>
                        <option value="alegacoes">Alega√ß√µes Finais</option>
                        <option value="sentenca">Senten√ßa</option>
                        <option value="recurso">Recurso</option>
                        <option value="transitado">Tr√¢nsito em Julgado</option>
                        <option value="execucao">Execu√ß√£o</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data da √öltima Movimenta√ß√£o *</label>
                    <input type="date" id="edicao-meta-processo-ultima-mov" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes / Pend√™ncias</label>
                    <textarea id="edicao-meta-processo-observacoes" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="Anota√ß√µes sobre o processo..."></textarea>
                </div>

                <div class="flex gap-2 pt-4">
                    <button onclick="salvarEdicaoProcessoMeta()" class="flex-1 bg-amber-600 text-white py-2 px-4 rounded-md hover:bg-amber-700 transition-colors">
                        <i data-lucide="save" class="h-4 w-4 mr-1 inline"></i>
                        Salvar Altera√ß√µes
                    </button>
                    <button onclick="fecharModalEdicaoProcessoMeta()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>

                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">üí° Ctrl+Enter: Salvar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Corre√ß√£o -->
    <div id="modal-correcao" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalCorrecao()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i data-lucide="edit" class="h-5 w-5 text-blue-600 mr-2"></i>
                    Solicitar Corre√ß√£o
                </h3>
                <button onclick="fecharModalCorrecao()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="text-sm text-blue-800">
                        <div class="font-medium" id="modal-correcao-processo">Processo: </div>
                        <div class="text-xs mt-1" id="modal-correcao-assessor">Assessor: </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Especifique a corre√ß√£o necess√°ria: *
                    </label>
                    <textarea 
                        id="correcao-detalhes" 
                        rows="4" 
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        placeholder="Descreva detalhadamente o que precisa ser corrigido nesta minuta..."
                    ></textarea>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="confirmarCorrecao()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        <i data-lucide="check" class="h-4 w-4 mr-1 inline"></i>
                        Solicitar Corre√ß√£o
                    </button>
                    <button onclick="fecharModalCorrecao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
                
                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">üí° Ctrl+Enter: Confirmar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Coment√°rio de Corre√ß√£o (Assessor) -->
    <div id="modal-comentario-correcao" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalComentarioCorrecao()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i data-lucide="message-square" class="h-5 w-5 text-green-600 mr-2"></i>
                    Marcar como Corrigida
                </h3>
                <button onclick="fecharModalComentarioCorrecao()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                    <div class="text-sm text-green-800">
                        <div class="font-medium" id="modal-comentario-processo">Processo: </div>
                        <div class="text-xs mt-1" id="modal-comentario-correcao-solicitada">Corre√ß√£o solicitada: </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Descreva as corre√ß√µes realizadas (opcional):
                    </label>
                    <textarea
                        id="comentario-correcao-assessor"
                        rows="4"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-500"
                        placeholder="Explique o que foi corrigido ou ajustado na minuta..."
                    ></textarea>
                </div>

                <div class="flex gap-2 pt-4">
                    <button onclick="confirmarCorrecaoAssessor()" class="flex-1 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors">
                        <i data-lucide="check" class="h-4 w-4 mr-1 inline"></i>
                        Confirmar Corre√ß√£o
                    </button>
                    <button onclick="fecharModalComentarioCorrecao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>

                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">üí° Ctrl+Enter: Confirmar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o -->
    <div id="modal-edicao" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalEdicao()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Editar Minuta</h3>
                <button onclick="fecharModalEdicao()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Processo *</label>
                    <input type="text" id="edit-numero-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Minuta *</label>
                    <select id="edit-tipo-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="validarTipoMinutaEdicao()">
                        <option value="Despacho">Despacho</option>
                        <option value="Decis√£o">Decis√£o</option>
                        <option value="Senten√ßa">Senten√ßa</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                    <select id="edit-categoria-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="meta1">Meta 1 CNJ</option>
                        <option value="meta2">Meta 2 CNJ</option>
                        <option value="meta10" id="edit-meta10-option" class="hidden">Meta 10 CNJ</option>
                        <option value="seeu" id="edit-seeu-option" class="hidden">SEEU - Execu√ß√£o Penal (controle)</option>
                        <option value="sem_movimento">Sem movimenta√ß√£o 60+ dias</option>
                        <option value="outros">Pedidos/Atos/Urgentes</option>
                        <option value="alem_meta">Al√©m da Meta (produtividade adicional)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observa√ß√µes</label>
                    <textarea id="edit-observacoes-minuta" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <!-- Campo de Substitui√ß√£o na Edi√ß√£o -->
                <div class="bg-amber-50 border border-amber-200 rounded-md p-3">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="edit-substituicao-checkbox" class="mr-3 h-5 w-5 text-amber-600 focus:ring-amber-500 border-gray-300 rounded">
                        <div>
                            <span class="text-sm font-medium text-amber-800">Produzida durante substitui√ß√£o</span>
                        </div>
                    </label>
                </div>

                <div class="flex gap-2 pt-4">
                    <button onclick="salvarEdicao()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        <i data-lucide="save" class="h-4 w-4 mr-1 inline"></i>
                        Salvar
                    </button>
                    <button onclick="fecharModalEdicao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
                
                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">üí° Ctrl+Enter: Salvar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Relat√≥rio Personalizado -->
    <div id="modal-relatorio-personalizado" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalRelatorioPersonalizado()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i data-lucide="calendar-range" class="h-5 w-5 text-purple-600 mr-2"></i>
                    Relat√≥rio Personalizado
                </h3>
                <button onclick="fecharModalRelatorioPersonalizado()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                    <div class="text-sm text-purple-800">
                        <div class="font-medium">üìä Gere relat√≥rios para per√≠odos espec√≠ficos</div>
                        <div class="text-xs mt-1">Selecione as datas de in√≠cio e fim para an√°lise detalhada</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data In√≠cio *</label>
                        <input type="date" id="relatorio-data-inicio" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Fim *</label>
                        <input type="date" id="relatorio-data-fim" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>
                
                <div class="text-xs text-gray-600 bg-gray-50 p-3 rounded">
                    üí° <strong>Dicas:</strong><br>
                    ‚Ä¢ Para relat√≥rio semanal: selecione segunda a domingo<br>
                    ‚Ä¢ Para comparar meses: use primeiro e √∫ltimo dia<br>
                    ‚Ä¢ M√°ximo recomendado: 3 meses por relat√≥rio
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="gerarRelatorioPersonalizado()" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition-colors">
                        <i data-lucide="bar-chart" class="h-4 w-4 mr-1 inline"></i>
                        Gerar Relat√≥rio
                    </button>
                    <button onclick="fecharModalRelatorioPersonalizado()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
                
                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">üí° Ctrl+Enter: Gerar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Relat√≥rio Personalizado do Balc√£o Virtual -->
    <div id="modal-relatorio-balcao-personalizado" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalRelatorioBalcaoPersonalizado()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i data-lucide="calendar-range" class="h-5 w-5 text-purple-600 mr-2"></i>
                    Relat√≥rio do Balc√£o - Personalizado
                </h3>
                <button onclick="fecharModalRelatorioBalcaoPersonalizado()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                    <div class="text-sm text-purple-800">
                        <div class="font-medium">üìä Relat√≥rio personalizado do Balc√£o Virtual</div>
                        <div class="text-xs mt-1">Selecione o per√≠odo para an√°lise detalhada dos pedidos</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data In√≠cio *</label>
                        <input type="date" id="balcao-relatorio-data-inicio" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data Fim *</label>
                        <input type="date" id="balcao-relatorio-data-fim" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Categoria (opcional)</label>
                    <select id="balcao-relatorio-categoria" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Todas as categorias</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Assessor (opcional)</label>
                    <select id="balcao-relatorio-assessor" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="">Todos os assessores</option>
                        <option value="gilbert">Gilbert Juliano</option>
                        <option value="laise">La√≠se Vital</option>
                    </select>
                </div>

                <div class="text-xs text-gray-600 bg-gray-50 p-3 rounded">
                    üí° <strong>Dicas:</strong><br>
                    ‚Ä¢ Inclui estat√≠sticas de atendimento e tempo m√©dio de resposta<br>
                    ‚Ä¢ Mostra distribui√ß√£o por categoria e por assessor<br>
                    ‚Ä¢ Identifica pedidos vencidos e cumprimento de prazos
                </div>

                <div class="flex gap-2 pt-4">
                    <button onclick="gerarRelatorioBalcaoPersonalizado()" class="flex-1 bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition-colors">
                        <i data-lucide="bar-chart" class="h-4 w-4 mr-1 inline"></i>
                        Gerar Relat√≥rio
                    </button>
                    <button onclick="fecharModalRelatorioBalcaoPersonalizado()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>

                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">üí° Ctrl+Enter: Gerar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Notifica√ß√µes do Juiz -->
    <div id="modal-notificacoes" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalNotificacoes()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden flex flex-col" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i data-lucide="bell" class="h-5 w-5 text-indigo-600 mr-2"></i>
                    Notifica√ß√µes
                    <span id="modal-notificacoes-count" class="ml-2 bg-indigo-100 text-indigo-800 text-xs font-medium px-2 py-1 rounded-full">0</span>
                </h3>
                <div class="flex items-center gap-2">
                    <button onclick="marcarTodasComoLidas()" class="text-sm text-indigo-600 hover:text-indigo-800 font-medium">
                        Marcar todas como lidas
                    </button>
                    <button onclick="fecharModalNotificacoes()" class="text-gray-500 hover:text-gray-700">
                        <i data-lucide="x" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>

            <div id="notificacoes-lista" class="flex-1 overflow-y-auto space-y-3">
                <div class="text-center text-gray-500 py-8">
                    <i data-lucide="bell-off" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                    <p>Nenhuma notifica√ß√£o pendente</p>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t text-center">
                <button onclick="fecharModalNotificacoes()" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-400 transition-colors">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Edi√ß√£o de Pedido do Balc√£o -->
    <div id="modal-edicao-pedido-balcao" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalEdicaoPedidoBalcao()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i data-lucide="edit-2" class="h-5 w-5 text-blue-600 mr-2"></i>
                    Editar Pedido #<span id="edicao-pedido-sequencial"></span>
                </h3>
                <button onclick="fecharModalEdicaoPedidoBalcao()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>

            <input type="hidden" id="edicao-pedido-id">

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">N√∫mero do Processo *</label>
                    <input type="text" id="edicao-pedido-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0000000-00.0000.0.00.0000">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Sequencial *</label>
                        <input type="number" id="edicao-pedido-sequencial-input" min="1" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Classe *</label>
                        <select id="edicao-pedido-classe" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="civel">C√≠vel</option>
                            <option value="criminal">Criminal</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                        <select id="edicao-pedido-categoria" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Selecione...</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data do Pedido *</label>
                        <input type="date" id="edicao-pedido-data" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Solicitante *</label>
                        <select id="edicao-pedido-tipo-solicitante" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="advogado">Advogado</option>
                            <option value="parte">Parte</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome do Solicitante</label>
                        <input type="text" id="edicao-pedido-nome-solicitante" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Nome (opcional)">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Resumo do Pedido *</label>
                    <textarea id="edicao-pedido-resumo" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Descreva o pedido..."></textarea>
                </div>

                <div class="flex items-center">
                    <input type="checkbox" id="edicao-pedido-despacho-virtual" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <label for="edicao-pedido-despacho-virtual" class="ml-2 text-sm text-gray-700">
                        üìπ Necessita Despacho Virtual com o Juiz
                    </label>
                </div>

                <div class="flex gap-2 pt-4">
                    <button onclick="salvarEdicaoPedidoBalcao()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        <i data-lucide="save" class="h-4 w-4 mr-1 inline"></i>
                        Salvar Altera√ß√µes
                    </button>
                    <button onclick="fecharModalEdicaoPedidoBalcao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>

                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">üí° Ctrl+Enter: Salvar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURA√á√ÉO ====================

        const firebaseConfig = {
            apiKey: "AIzaSyCzuoRgbvKQSjOFssde-qUEtNDqGNJML7E",
            authDomain: "produtividade-gabinete.firebaseapp.com",
            databaseURL: "https://produtividade-gabinete-default-rtdb.firebaseio.com",
            projectId: "produtividade-gabinete",
            storageBucket: "produtividade-gabinete.firebasestorage.app",
            messagingSenderId: "370364917935",
            appId: "1:370364917935:web:a6205cc718748abcbdcc5a"
        };

        // Credenciais seguras
        const credenciais = {
            'juiz': { senha: 'Juiz@2024!', nome: 'Juiz', tipo: 'juiz' },
            'gilbert': { senha: 'Gilbert@2024!', nome: 'Gilbert Juliano', tipo: 'assessor', assessorId: 'gilbert' },
            'laise': { senha: 'Laise@2024!', nome: 'La√≠se Vital', tipo: 'assessor', assessorId: 'laise' }
        };

        const categorias = {
            'meta1': { nome: 'Meta 1 CNJ', cor: 'bg-red-500', meta: 2 },
            'meta2': { nome: 'Meta 2 CNJ', cor: 'bg-pink-500', meta: 1, semanal: true, requerSentenca: true },
            'meta10': { 
                nome: 'Meta 10 CNJ (minutar semanalmente)', 
                cor: 'bg-purple-500', 
                meta: 1, 
                semanal: true, 
                explicacao: 'Minutar semanalmente em qualquer dos 9 processos mais antigos para impulsionar julgamentos'
            },
            'seeu': { nome: 'SEEU - Execu√ß√£o Penal (controle de acesso)', cor: 'bg-teal-500', meta: 1, prazo: 10, naoContaParaMeta: true, exclusivoAssessor: 'laise' },
            'sem_movimento': { nome: 'Sem movimenta√ß√£o 60+ dias', cor: 'bg-orange-500', meta: 5 },
            'outros': { nome: 'Pedidos/Atos/Urgentes', cor: 'bg-blue-500', meta: 3 },
            'alem_meta': { nome: 'Al√©m da Meta (produtividade adicional)', cor: 'bg-gray-500', meta: 0, semMeta: true, naoContaParaMeta: true },
            // Pain√©is de Acompanhamento Especiais (meta: minutar a cada 15 dias)
            'conhecimento_10anos': {
                nome: 'Conhecimento > 10 anos',
                cor: 'bg-red-700',
                meta: 1,
                prazo: 15,
                naoContaParaMeta: true,
                descricao: 'Processos de conhecimento em tr√¢mite h√° mais de 10 anos'
            },
            'violencia_domestica': {
                nome: 'Viol√™ncia Dom√©stica (at√© 2025)',
                cor: 'bg-pink-700',
                meta: 1,
                prazo: 15,
                naoContaParaMeta: true,
                exclusivoAssessor: 'laise',
                descricao: 'A√ß√µes de viol√™ncia dom√©stica distribu√≠das at√© 2025'
            },
            'acoes_saude': {
                nome: 'A√ß√µes de Sa√∫de (at√© 2025)',
                cor: 'bg-green-700',
                meta: 1,
                prazo: 15,
                naoContaParaMeta: true,
                descricao: 'A√ß√µes de sa√∫de distribu√≠das at√© 2025'
            },
            'acoes_penais': {
                nome: 'A√ß√µes Penais (at√© 2023)',
                cor: 'bg-gray-700',
                meta: 1,
                prazo: 15,
                naoContaParaMeta: true,
                exclusivoAssessor: 'laise',
                descricao: 'A√ß√µes penais distribu√≠das at√© 2023'
            },
            'processos_juri': {
                nome: 'J√∫ri (at√© 2021)',
                cor: 'bg-indigo-700',
                meta: 1,
                prazo: 15,
                naoContaParaMeta: true,
                exclusivoAssessor: 'laise',
                descricao: 'Processos de j√∫ri distribu√≠dos at√© 2021'
            },
            'acoes_ambientais': {
                nome: 'A√ß√µes Ambientais (at√© 2022)',
                cor: 'bg-emerald-700',
                meta: 1,
                prazo: 15,
                naoContaParaMeta: true,
                descricao: 'A√ß√µes ambientais distribu√≠das at√© 2022'
            }
        };

        const statusOptions = {
            'pendente': { nome: 'Pendente', cor: 'status-pendente' },
            'assinada': { nome: 'Assinada', cor: 'status-assinada' },
            'excluida': { nome: 'Exclu√≠da', cor: 'status-excluida' },
            'correcao': { nome: 'Precisa Corre√ß√£o', cor: 'status-correcao' }
        };

        // ==================== BALC√ÉO VIRTUAL ====================
        const categoriasBalcao = {
            'urgencia': { nome: 'Urg√™ncia', cor: 'bg-red-600', prazoHoras: 72 },
            'meta_cnj': { nome: 'Meta do CNJ (exceto Meta 1)', cor: 'bg-purple-600', prazoHoras: 72 },
            'saude': { nome: 'Sa√∫de', cor: 'bg-green-600', prazoHoras: 72 },
            'crime': { nome: 'Crime', cor: 'bg-gray-700', prazoHoras: 72 },
            'alvara': { nome: 'Alvar√°', cor: 'bg-yellow-600', prazoHoras: 72 },
            'crianca': { nome: 'Crian√ßa', cor: 'bg-pink-500', prazoHoras: 72 },
            'incapaz': { nome: 'Incapaz', cor: 'bg-orange-500', prazoHoras: 72 },
            'idoso': { nome: 'Idoso (exceto a√ß√£o banc√°ria)', cor: 'bg-amber-600', prazoHoras: 72 },
            'andamento_atrasado': { nome: 'Andamento Atrasado', cor: 'bg-red-500', prazoHoras: 72 },
            'embargos': { nome: 'Embargos Declarat√≥rios', cor: 'bg-indigo-500', prazoHoras: 72 },
            'extincao': { nome: 'Extin√ß√£o (desist√™ncia/perda objeto)', cor: 'bg-slate-500', prazoHoras: 72 },
            'acordo': { nome: 'Acordo', cor: 'bg-teal-500', prazoHoras: 72 },
            'diligencia_simples': { nome: 'Dilig√™ncia Simples', cor: 'bg-cyan-500', prazoHoras: 72 },
            'outros': { nome: 'Outros', cor: 'bg-gray-500', prazoHoras: 1440 } // 60 dias = 1440 horas
        };

        const statusBalcao = {
            'pendente': { nome: 'Pendente', cor: 'bg-yellow-500' },
            'minutado': { nome: 'Minutado', cor: 'bg-green-500' },
            'cancelado': { nome: 'Cancelado', cor: 'bg-gray-400' }
        };

        // ==================== METAS - A√á√ïES PENAIS ====================
        const META_ACOES_PENAIS = {
            nome: 'Meta 4 - A√ß√µes Penais',
            prazoFinal: '2026-12-19',
            descricao: 'Acompanhamento das a√ß√µes penais para cumprimento da meta'
        };

        const statusProcessoMeta = {
            'em_andamento': { nome: 'Em Andamento', cor: 'bg-blue-500', icone: 'clock' },
            'baixado': { nome: 'Baixado', cor: 'bg-green-600', icone: 'check-circle' },
            'suspenso': { nome: 'Suspenso', cor: 'bg-yellow-500', icone: 'pause-circle' },
            'sobrestado': { nome: 'Sobrestado', cor: 'bg-orange-500', icone: 'pause' },
            'arquivado': { nome: 'Arquivado', cor: 'bg-gray-500', icone: 'archive' }
        };

        const fasesProcessoMeta = {
            'inquerito': { nome: 'Inqu√©rito/Investiga√ß√£o', ordem: 1 },
            'denuncia': { nome: 'Den√∫ncia Recebida', ordem: 2 },
            'citacao': { nome: 'Cita√ß√£o', ordem: 3 },
            'resposta': { nome: 'Resposta √† Acusa√ß√£o', ordem: 4 },
            'instrucao': { nome: 'Instru√ß√£o', ordem: 5 },
            'alegacoes': { nome: 'Alega√ß√µes Finais', ordem: 6 },
            'sentenca': { nome: 'Senten√ßa', ordem: 7 },
            'recurso': { nome: 'Recurso', ordem: 8 },
            'transitado': { nome: 'Tr√¢nsito em Julgado', ordem: 9 },
            'execucao': { nome: 'Execu√ß√£o', ordem: 10 }
        };

        // ==================== ESTADO GLOBAL ====================
        
        let firebase, database;
        let currentUser = null;
        let currentView = 'dashboard';
        let minutas = {};
        let pedidosBalcao = {};
        let minutaEditando = null;
        let minutaCorrecao = null;
        let calendarioData = {
            mesAtual: getDataHoraBrasilia().getMonth(),
            anoAtual: getDataHoraBrasilia().getFullYear(),
            diaSelecionado: null
        };
        let assessores = {
            gilbert: { nome: 'Gilbert Juliano', ativo: true },
            laise: { nome: 'La√≠se Vital', ativo: true }
        };
        let notificacoesJuiz = {};
        let processosMetaAcoesPenais = {};

        // ==================== UTILIT√ÅRIOS ====================
        
        // ===== FUN√á√ÉO UTILIT√ÅRIA PARA NORMALIZAR CATEGORIAS =====
        function normalizarCategorias(minuta) {
            let categorias = [];

            if (Array.isArray(minuta.categorias)) {
                categorias = minuta.categorias;
            } else if (minuta.categoria) {
                categorias = [minuta.categoria];
            } else if (typeof minuta.categorias === 'string') {
                categorias = [minuta.categorias];
            }

            return categorias.filter(cat => cat && cat.trim()); // Remove vazios
        }

        // ===== FUN√á√ÉO DE SANITIZA√á√ÉO PARA PREVENIR XSS =====
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const text = String(str);
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, char => map[char]);
        }

        // ===== FUN√á√ÉO PARA ESCAPAR IDs PARA USO EM ATRIBUTOS =====
        function escapeAttr(str) {
            if (str === null || str === undefined) return '';
            return String(str).replace(/['"\\]/g, '\\$&');
        }

        // ===== FUN√á√ÉO PARA CRIAR √çCONES COM FALLBACK =====
        function criarIcones() {
            try {
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    lucide.createIcons();
                } else {
                    console.warn('Lucide n√£o dispon√≠vel - sistema funcionar√° sem √≠cones');
                }
            } catch (error) {
                console.warn('Erro ao criar √≠cones:', error);
            }
        }
        
        function isDiaUtil(data) {
            const dataParaVerificar = data || getDataHoraBrasilia();
            const dia = dataParaVerificar.getDay();
            return dia >= 1 && dia <= 5;
        }

        function getDataHoraBrasilia() {
            // Retorna um objeto Date ajustado para o timezone de Bras√≠lia
            // Usado principalmente para obter dia da semana e hora
            const now = new Date();

            // Obter os componentes de data/hora em Bras√≠lia
            const options = {
                timeZone: 'America/Sao_Paulo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            };

            const formatter = new Intl.DateTimeFormat('en-CA', options);
            const parts = formatter.formatToParts(now);

            const dateObj = {};
            parts.forEach(part => {
                dateObj[part.type] = part.value;
            });

            // Criar Date com os componentes de Bras√≠lia
            // Nota: Este Date √© usado para obter dia da semana, hora, etc.
            return new Date(
                parseInt(dateObj.year),
                parseInt(dateObj.month) - 1,
                parseInt(dateObj.day),
                parseInt(dateObj.hour),
                parseInt(dateObj.minute),
                parseInt(dateObj.second)
            );
        }

        function getHojeString() {
            // Retorna a data de hoje em Bras√≠lia no formato YYYY-MM-DD
            // Esta √© a fun√ß√£o principal para comparar datas de minutas
            const now = new Date();
            return now.toLocaleDateString('en-CA', {
                timeZone: 'America/Sao_Paulo',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }); // Formato: "2024-12-09"
        }

        function formatarDataBrasilia(dataString) {
            // Formata uma string de data (YYYY-MM-DD) para exibi√ß√£o em pt-BR
            // Evita problemas de timezone ao interpretar a data
            if (!dataString) return 'Data n√£o dispon√≠vel';
            const [ano, mes, dia] = dataString.split('-').map(Number);
            if (!ano || !mes || !dia) return 'Data inv√°lida';
            // Retorna no formato DD/MM/YYYY
            return `${String(dia).padStart(2, '0')}/${String(mes).padStart(2, '0')}/${ano}`;
        }

        function getInicioSemana(data) {
            const d = new Date(data);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getFimSemana(data) {
            const inicio = getInicioSemana(data);
            const fim = new Date(inicio);
            fim.setDate(inicio.getDate() + 6);
            return fim;
        }

        function getNumeroSemana(data) {
            const d = new Date(data);
            const inicio = new Date(d.getFullYear(), 0, 1);
            return Math.ceil(((d - inicio) / 86400000 + inicio.getDay() + 1) / 7);
        }

        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString('pt-BR', { timeZone: 'America/Sao_Paulo' });

            // Log padr√£o
            console.log(`[${timestamp} BRT] ${message}`, data || '');

            // Se for um erro, adicionar stack trace
            if (message.toLowerCase().includes('erro') && data instanceof Error) {
                console.error('Stack trace:', data.stack);
            }

            // Debug adicional para relat√≥rios
            if (message.includes('relat√≥rio') || message.includes('gr√°fico')) {
                console.group(`üìä Debug Relat√≥rio - ${timestamp}`);
                console.log('Mensagem:', message);
                if (data) console.log('Dados:', data);
                console.log('Total minutas no sistema:', Object.keys(minutas).length);
                console.log('Usu√°rio atual:', currentUser?.nome);
                console.groupEnd();
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translate(-50%, -100px)';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function validarTipoMinuta() {
            const tipoMinuta = document.getElementById('tipo-minuta').value;
            const meta2Checkbox = document.getElementById('meta2-checkbox');
            
            if (tipoMinuta === 'Senten√ßa') {
                meta2Checkbox.style.display = 'block';
            } else {
                meta2Checkbox.style.display = 'none';
                const meta2Input = meta2Checkbox.querySelector('input[value="meta2"]');
                if (meta2Input) meta2Input.checked = false;
            }
        }

        function validarTipoMinutaEdicao() {
            const tipoMinuta = document.getElementById('edit-tipo-minuta').value;
            const meta2Option = document.getElementById('edit-categoria-minuta').querySelector('option[value="meta2"]');
            
            if (tipoMinuta === 'Senten√ßa') {
                meta2Option.style.display = 'block';
            } else {
                meta2Option.style.display = 'none';
                const selectCategoria = document.getElementById('edit-categoria-minuta');
                if (selectCategoria.value === 'meta2') {
                    selectCategoria.value = 'meta1';
                }
            }
        }

        // ==================== C√ÅLCULOS DE PRODUTIVIDADE ====================
        
        function getMinutasHoje(assessorId) {
            const hoje = getHojeString();
            return Object.values(minutas).filter(m => {
                if (!m || !m.data || m.data !== hoje) return false;
                if (m.status === 'excluida') return false;
                
                return m.assessorId === assessorId || 
                       (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                       (assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('La√≠se'))));
            });
        }

        function getMinutasPorData(data, assessorId = null) {
            return Object.values(minutas).filter(m => {
                if (!m || !m.data || m.data !== data) return false;
                if (m.status === 'excluida') return false;
                
                if (assessorId) {
                    return m.assessorId === assessorId || 
                           (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                           (assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('La√≠se'))));
                }
                
                return true;
            });
        }

        // ===== CORRE√á√ÉO APLICADA =====
        function getMinutasSemana(inicioSemana, fimSemana, assessorId, categoria = null) {
            const inicioStr = inicioSemana.toISOString().split('T')[0];
            const fimStr = fimSemana.toISOString().split('T')[0];
            
            return Object.values(minutas).filter(m => {
                if (!m || !m.data || m.data < inicioStr || m.data > fimStr) return false;
                if (m.status === 'excluida') return false;
                
                const isAssessor = m.assessorId === assessorId || 
                                 (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                                 (assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('La√≠se'))));
                
                if (!isAssessor) return false;
                
                if (categoria) {
                    const categorias = normalizarCategorias(m);
                    return categorias.includes(categoria);
                }
                
                return true;
            });
        }

        function getMeta2Status(assessorId) {
            const hoje = getDataHoraBrasilia();
            const inicioSemanaAtual = getInicioSemana(hoje);
            const fimSemanaAtual = getFimSemana(hoje);
            
            const minutasMeta2Semana = getMinutasSemana(inicioSemanaAtual, fimSemanaAtual, assessorId, 'meta2');
            const metaSemanaCumprida = minutasMeta2Semana.length > 0;
            
            const inicioAno = new Date(hoje.getFullYear(), 0, 1);
            const fimAno = new Date(hoje.getFullYear(), 11, 31);
            const minutasMeta2Ano = getMinutasSemana(inicioAno, fimAno, assessorId, 'meta2');
            
            const semanas = [];
            const inicioCalculo = new Date(hoje.getFullYear(), 0, 1);
            let semanaAtual = getInicioSemana(inicioCalculo);
            
            while (semanaAtual <= hoje) {
                const fimSemana = getFimSemana(semanaAtual);
                const minutasSemana = getMinutasSemana(semanaAtual, fimSemana, assessorId, 'meta2');
                
                semanas.push({
                    inicio: new Date(semanaAtual),
                    fim: new Date(fimSemana),
                    numero: getNumeroSemana(semanaAtual),
                    cumprida: minutasSemana.length > 0,
                    minutas: minutasSemana.length
                });
                
                semanaAtual.setDate(semanaAtual.getDate() + 7);
            }
            
            const semanasPassadas = semanas.filter(s => s.fim < hoje).length;
            const semanasCumpridas = semanas.filter(s => s.cumprida && s.fim < hoje).length;
            const percentualCumprimento = semanasPassadas > 0 ? (semanasCumpridas / semanasPassadas) * 100 : 0;
            
            return {
                totalSentencas: minutasMeta2Ano.length,
                metaSemanaCumprida,
                semanas,
                percentualCumprimento: Math.round(percentualCumprimento),
                semanasPassadas,
                semanasCumpridas,
                status: metaSemanaCumprida ? 'em_dia' : 'atrasada'
            };
        }

        function getMeta10Status() {
            const hoje = getDataHoraBrasilia();
            
            const inicioSemanaAtual = getInicioSemana(hoje);
            const fimSemanaAtual = getFimSemana(hoje);
            const minutasSemanaAtual = getMinutasSemana(inicioSemanaAtual, fimSemanaAtual, 'gilbert', 'meta10');
            const metaSemanaCumprida = minutasSemanaAtual.length > 0;
            
            const semanas = [];
            const inicioAno = new Date(hoje.getFullYear(), 0, 1);
            let semanaAtual = getInicioSemana(inicioAno);
            
            let semanasComMeta10 = 0;
            let totalSemanas = 0;
            
            while (semanaAtual <= hoje) {
                const fimSemana = getFimSemana(semanaAtual);
                const minutasSemana = getMinutasSemana(semanaAtual, fimSemana, 'gilbert', 'meta10');
                const cumprida = minutasSemana.length > 0;
                
                semanas.push({
                    inicio: new Date(semanaAtual),
                    fim: new Date(fimSemana),
                    numero: getNumeroSemana(semanaAtual),
                    cumprida: cumprida,
                    minutas: minutasSemana.length
                });
                
                if (cumprida) semanasComMeta10++;
                totalSemanas++;
                
                semanaAtual.setDate(semanaAtual.getDate() + 7);
            }
            
            return {
                metaSemanaCumprida,
                semanasComMeta10,
                totalSemanas,
                percentualCumprimento: totalSemanas > 0 ? Math.round((semanasComMeta10 / totalSemanas) * 100) : 0,
                semanas,
                status: metaSemanaCumprida ? 'em_dia' : 'atrasada'
            };
        }

        // ===== CORRE√á√ÉO APLICADA =====
        function getSEEUStatus() {
            const hoje = getDataHoraBrasilia();
            const inicioAno = new Date(hoje.getFullYear(), 0, 1);
            const fimAno = new Date(hoje.getFullYear(), 11, 31);
            
            const minutasSEEU = Object.values(minutas).filter(m => {
                if (!m || !m.data) return false;
                if (m.status === 'excluida') return false;
                
                const dataMinuta = new Date(m.data);
                if (dataMinuta < inicioAno || dataMinuta > fimAno) return false;
                
                const isLaise = m.assessorId === 'laise' || 
                              m.assessorId === 'assessor2' || 
                              (m.assessorNome && m.assessorNome.includes('La√≠se'));
                
                if (!isLaise) return false;
                
                const categorias = normalizarCategorias(m);
                return categorias.includes('seeu');
            }).sort((a, b) => new Date(a.data) - new Date(b.data));
            
            const ultimaMinutaSEEU = minutasSEEU.length > 0 ? minutasSEEU[minutasSEEU.length - 1] : null;
            
            let diasSemSEEU = 0;
            let status = 'nunca_acessou';
            let proximoVencimento = null;
            
            if (ultimaMinutaSEEU) {
                const ultimaData = new Date(ultimaMinutaSEEU.data);
                diasSemSEEU = Math.floor((hoje - ultimaData) / (1000 * 60 * 60 * 24));
                
                proximoVencimento = new Date(ultimaData);
                proximoVencimento.setDate(proximoVencimento.getDate() + 10);
                
                if (diasSemSEEU <= 7) {
                    status = 'em_dia';
                } else if (diasSemSEEU <= 10) {
                    status = 'atencao';
                } else {
                    status = 'atrasado';
                }
            } else {
                diasSemSEEU = Math.floor((hoje - inicioAno) / (1000 * 60 * 60 * 24));
                status = 'nunca_acessou';
                proximoVencimento = new Date();
            }
            
            const historico = minutasSEEU.slice(-10).map(minuta => ({
                data: minuta.data,
                numeroProcesso: minuta.numeroProcesso,
                diasEntre: null
            }));
            
            for (let i = 1; i < historico.length; i++) {
                const dataAnterior = new Date(historico[i-1].data);
                const dataAtual = new Date(historico[i].data);
                historico[i].diasEntre = Math.floor((dataAtual - dataAnterior) / (1000 * 60 * 60 * 24));
            }
            
            return {
                totalAcessos: minutasSEEU.length,
                ultimoAcesso: ultimaMinutaSEEU ? ultimaMinutaSEEU.data : null,
                diasSemSEEU,
                status,
                proximoVencimento,
                diasParaVencimento: proximoVencimento ? Math.ceil((proximoVencimento - hoje) / (1000 * 60 * 60 * 24)) : 0,
                historico,
                mediaIntervalo: historico.length > 1 ? 
                    Math.round(historico.slice(1).reduce((acc, h) => acc + (h.diasEntre || 0), 0) / (historico.length - 1)) : 0
            };
        }

        // ===== FUN√á√ÉO PARA CALCULAR STATUS DOS PAIN√âIS DE ACOMPANHAMENTO (15 DIAS) =====
        function getPainelAcompanhamentoStatus(assessorId, categoriaKey) {
            const hoje = getDataHoraBrasilia();
            const categoria = categorias[categoriaKey];
            const prazo = categoria?.prazo || 15;

            // Buscar minutas desta categoria para este assessor
            const minutasCategoria = Object.values(minutas).filter(m => {
                if (!m || !m.data) return false;
                if (m.status === 'excluida') return false;

                // Verificar se √© do assessor correto
                const isAssessor = m.assessorId === assessorId ||
                                  (assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                                  (assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('La√≠se'))));

                if (!isAssessor) return false;

                const cats = normalizarCategorias(m);
                return cats.includes(categoriaKey);
            }).sort((a, b) => new Date(b.data) - new Date(a.data)); // Mais recente primeiro

            const ultimaMinuta = minutasCategoria.length > 0 ? minutasCategoria[0] : null;

            let diasSemMinuta = 0;
            let status = 'nunca';
            let proximoVencimento = null;

            if (ultimaMinuta) {
                const ultimaData = new Date(ultimaMinuta.data);
                diasSemMinuta = Math.floor((hoje - ultimaData) / (1000 * 60 * 60 * 24));

                proximoVencimento = new Date(ultimaData);
                proximoVencimento.setDate(proximoVencimento.getDate() + prazo);

                if (diasSemMinuta <= 10) {
                    status = 'em_dia';
                } else if (diasSemMinuta <= prazo) {
                    status = 'atencao';
                } else {
                    status = 'atrasado';
                }
            }

            return {
                totalMinutas: minutasCategoria.length,
                ultimaMinuta: ultimaMinuta ? ultimaMinuta.data : null,
                diasSemMinuta,
                status,
                proximoVencimento,
                diasParaVencimento: proximoVencimento ? Math.ceil((proximoVencimento - hoje) / (1000 * 60 * 60 * 24)) : -prazo,
                prazo
            };
        }

        // ===== FUN√á√ÉO PARA RENDERIZAR PAIN√âIS DE ACOMPANHAMENTO =====
        function renderPaineisAcompanhamento() {
            // Identificar categorias de pain√©is de acompanhamento (aquelas com prazo)
            const categoriasAcompanhamento = Object.keys(categorias).filter(key => categorias[key].prazo);

            if (categoriasAcompanhamento.length === 0) return '';

            let html = `
                <div class="mt-6">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                        <i data-lucide="clipboard-list" class="h-5 w-5 mr-2 text-purple-600"></i>
                        Pain√©is de Acompanhamento (Meta: minutar a cada 15 dias)
                    </h3>
            `;

            // Para o juiz, mostrar painel de cada assessor
            if (currentUser.isJuiz) {
                html += renderPaineisParaJuiz(categoriasAcompanhamento);
            } else {
                // Para assessor, mostrar apenas seus pain√©is
                html += renderPaineisParaAssessor(categoriasAcompanhamento, currentUser.assessorId);
            }

            html += '</div>';
            return html;
        }

        function renderPaineisParaJuiz(categoriasAcompanhamento) {
            let html = '';

            // Gilbert
            html += `
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span>
                        Gilbert
                    </h4>
                    <div class="grid md:grid-cols-3 gap-3">
            `;

            const categoriasGilbert = categoriasAcompanhamento.filter(key => !categorias[key].exclusivoAssessor);
            for (const catKey of categoriasGilbert) {
                html += renderPainelCard(catKey, 'gilbert');
            }

            html += '</div></div>';

            // La√≠se
            html += `
                <div class="mb-6">
                    <h4 class="font-semibold text-gray-700 mb-3 flex items-center">
                        <span class="w-3 h-3 rounded-full bg-pink-500 mr-2"></span>
                        La√≠se
                    </h4>
                    <div class="grid md:grid-cols-3 gap-3">
            `;

            // La√≠se v√™ todas as categorias
            for (const catKey of categoriasAcompanhamento) {
                html += renderPainelCard(catKey, 'laise');
            }

            html += '</div></div>';

            return html;
        }

        function renderPaineisParaAssessor(categoriasAcompanhamento, assessorId) {
            // Filtrar categorias baseado no assessor
            const categoriasVisiveis = categoriasAcompanhamento.filter(key => {
                const cat = categorias[key];
                if (cat.exclusivoAssessor && cat.exclusivoAssessor !== assessorId) {
                    return false;
                }
                return true;
            });

            let html = '<div class="grid md:grid-cols-2 lg:grid-cols-3 gap-3">';

            for (const catKey of categoriasVisiveis) {
                html += renderPainelCard(catKey, assessorId);
            }

            html += '</div>';
            return html;
        }

        function renderPainelCard(categoriaKey, assessorId) {
            const cat = categorias[categoriaKey];
            const status = getPainelAcompanhamentoStatus(assessorId, categoriaKey);

            const statusColors = {
                'em_dia': { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-700', badge: 'bg-green-100 text-green-800', icon: 'check-circle' },
                'atencao': { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-700', badge: 'bg-yellow-100 text-yellow-800', icon: 'alert-circle' },
                'atrasado': { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-700', badge: 'bg-red-100 text-red-800', icon: 'alert-triangle' },
                'nunca': { bg: 'bg-gray-50', border: 'border-gray-200', text: 'text-gray-600', badge: 'bg-gray-100 text-gray-800', icon: 'help-circle' }
            };

            const colors = statusColors[status.status];
            const statusLabel = {
                'em_dia': 'Em dia',
                'atencao': 'Aten√ß√£o',
                'atrasado': 'Atrasado',
                'nunca': 'Sem registro'
            };

            return `
                <div class="${colors.bg} ${colors.border} border rounded-lg p-4">
                    <div class="flex items-start justify-between mb-2">
                        <h5 class="font-medium text-sm ${colors.text} flex-1">${escapeHtml(cat.nome)}</h5>
                        <span class="text-xs px-2 py-1 rounded-full ${colors.badge} ml-2 whitespace-nowrap">
                            ${statusLabel[status.status]}
                        </span>
                    </div>
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-2xl font-bold ${colors.text}">
                                ${status.status === 'nunca' ? '-' : status.diasSemMinuta}
                            </div>
                            <div class="text-xs text-gray-500">dias sem minuta</div>
                        </div>
                        <div class="text-right">
                            ${status.ultimaMinuta ? `
                                <div class="text-xs text-gray-500">√öltima:</div>
                                <div class="text-xs font-medium ${colors.text}">${formatarDataBrasilia(status.ultimaMinuta)}</div>
                            ` : `
                                <div class="text-xs text-gray-500">Nenhum registro</div>
                            `}
                        </div>
                    </div>
                    ${status.status === 'atencao' ? `
                        <div class="mt-2 text-xs ${colors.text} bg-yellow-100 rounded px-2 py-1">
                            ‚è∞ Vence em ${status.diasParaVencimento} dia${status.diasParaVencimento !== 1 ? 's' : ''}
                        </div>
                    ` : ''}
                    ${status.status === 'atrasado' ? `
                        <div class="mt-2 text-xs ${colors.text} bg-red-100 rounded px-2 py-1">
                            ‚ö†Ô∏è Atrasado h√° ${Math.abs(status.diasParaVencimento)} dia${Math.abs(status.diasParaVencimento) !== 1 ? 's' : ''}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // ===== CORRE√á√ÉO APLICADA =====
        function getProgressoCategoria(assessorId, categoria) {
            if (categoria === 'meta10') {
                const meta10Status = getMeta10Status();
                return {
                    atual: meta10Status.metaSemanaCumprida ? 1 : 0,
                    meta: 1,
                    percentual: meta10Status.metaSemanaCumprida ? 100 : 0,
                    semanal: true
                };
            }
            
            if (categoria === 'meta2') {
                const meta2Status = getMeta2Status(assessorId);
                return {
                    atual: meta2Status.metaSemanaCumprida ? 1 : 0,
                    meta: 1,
                    percentual: meta2Status.metaSemanaCumprida ? 100 : 0,
                    semanal: true
                };
            }
            
            const minutasHoje = getMinutasHoje(assessorId);
            const count = minutasHoje.filter(m => {
                const categorias = normalizarCategorias(m);
                return categorias.includes(categoria);
            }).length;
            
            const categoriaInfo = categorias[categoria];
            
            if (categoriaInfo && (categoriaInfo.semMeta || categoriaInfo.naoContaParaMeta)) {
                return { 
                    atual: count, 
                    meta: categoriaInfo.meta || 0, 
                    percentual: 0,
                    semMeta: true,
                    naoContaParaMeta: categoriaInfo.naoContaParaMeta
                };
            }
            
            const meta = categoriaInfo ? categoriaInfo.meta : 0;
            return { 
                atual: count, 
                meta, 
                percentual: meta > 0 ? Math.min((count / meta) * 100, 100) : 0
            };
        }

        // ===== CORRE√á√ÉO APLICADA =====
        function getProgressoTotal(assessorId) {
            const minutasHoje = getMinutasHoje(assessorId);
            const minutasParaMeta = minutasHoje.filter(m => {
                const categorias = normalizarCategorias(m);
                return categorias.some(cat => cat !== 'alem_meta' && cat !== 'seeu');
            });
            
            const total = minutasParaMeta.length;
            const meta = 10;
            
            const alemDaMeta = minutasHoje.filter(m => {
                const categorias = normalizarCategorias(m);
                return categorias.includes('alem_meta');
            }).length;
            
            const seeu = minutasHoje.filter(m => {
                const categorias = normalizarCategorias(m);
                return categorias.includes('seeu');
            }).length;
            
            return { 
                atual: total, 
                meta, 
                percentual: Math.min((total / meta) * 100, 100),
                totalGeral: minutasHoje.length,
                alemDaMeta,
                seeu
            };
        }

        // ==================== AUTENTICA√á√ÉO ====================
        
        function fazerLogin() {
            const usuario = document.getElementById('login-usuario').value;
            const senha = document.getElementById('login-senha').value;

            if (!usuario || !senha) {
                showNotification('Por favor, selecione o usu√°rio e digite a senha.', 'warning');
                return;
            }

            const cred = credenciais[usuario];
            if (!cred || cred.senha !== senha) {
                showNotification('Usu√°rio ou senha incorretos.', 'error');
                return;
            }

            currentUser = {
                usuario: usuario,
                nome: cred.nome,
                tipo: cred.tipo,
                isJuiz: cred.tipo === 'juiz',
                assessorId: cred.assessorId
            };

            log('Login realizado', currentUser.nome);
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            setTimeout(() => {
                showNotification('üïê Sistema ajustado para o Hor√°rio de Bras√≠lia. Minutas agora s√£o registradas com data/hora corretas!', 'info');
            }, 1000);
            
            initializeApp();
        }

        function logout() {
            log('Logout realizado', currentUser?.nome);
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-usuario').value = '';
            document.getElementById('login-senha').value = '';
        }

        function initializeApp() {
            try {
                try {
                    firebase = window.firebase;
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    
                    firebase.auth().signInAnonymously()
                        .then(() => {
                            console.log('‚úÖ Firebase autenticado com sucesso');
                            
                            setupUserInfo();
                            setupNavigation();
                            setupMeta10Options();
                            if (database) setupFirebaseListeners();
                            showView('dashboard');
                            
                            log('Aplica√ß√£o inicializada com sucesso');
                        })
                        .catch((error) => {
                            console.error('‚ùå Erro na autentica√ß√£o:', error);
                            setupUserInfo();
                            setupNavigation();
                            setupMeta10Options();
                            showView('dashboard');
                            log('Aplica√ß√£o inicializada sem autentica√ß√£o Firebase');
                        });
                        
                } catch (error) {
                    log('Firebase n√£o dispon√≠vel - modo offline', error);
                    database = null;
                    setupUserInfo();
                    setupNavigation();
                    setupMeta10Options();
                    showView('dashboard');
                }
                
            } catch (error) {
                log('Erro na inicializa√ß√£o', error);
                showNotification('Erro ao inicializar aplica√ß√£o', 'error');
            }
        }

        function setupUserInfo() {
            document.getElementById('user-info').textContent = `Logado como: ${currentUser.nome}`;
        }

        function setupMeta10Options() {
            const meta10Checkbox = document.getElementById('meta10-checkbox');
            const editMeta10Option = document.getElementById('edit-meta10-option');

            const seuCheckbox = document.getElementById('seeu-checkbox');
            const editSeuOption = document.getElementById('edit-seeu-option');

            // Checkboxes exclusivos da La√≠se (pain√©is de acompanhamento)
            const violenciaDomesticaCheckbox = document.getElementById('violencia-domestica-checkbox');
            const acoesPenaisCheckbox = document.getElementById('acoes-penais-checkbox');
            const processosJuriCheckbox = document.getElementById('processos-juri-checkbox');

            if (currentUser.assessorId === 'gilbert') {
                meta10Checkbox?.style.setProperty('display', 'block');
                editMeta10Option?.classList.remove('hidden');
                seuCheckbox?.style.setProperty('display', 'none');
                editSeuOption?.classList.add('hidden');
                // Esconder categorias exclusivas da La√≠se
                violenciaDomesticaCheckbox?.style.setProperty('display', 'none');
                acoesPenaisCheckbox?.style.setProperty('display', 'none');
                processosJuriCheckbox?.style.setProperty('display', 'none');
            } else if (currentUser.assessorId === 'laise') {
                meta10Checkbox?.style.setProperty('display', 'none');
                editMeta10Option?.classList.add('hidden');
                seuCheckbox?.style.setProperty('display', 'block');
                editSeuOption?.classList.remove('hidden');
                // Mostrar categorias exclusivas da La√≠se
                violenciaDomesticaCheckbox?.style.setProperty('display', 'block');
                acoesPenaisCheckbox?.style.setProperty('display', 'block');
                processosJuriCheckbox?.style.setProperty('display', 'block');
            } else {
                // Juiz v√™ todas as op√ß√µes
                meta10Checkbox?.style.setProperty('display', 'block');
                editMeta10Option?.classList.remove('hidden');
                seuCheckbox?.style.setProperty('display', 'block');
                editSeuOption?.classList.remove('hidden');
                violenciaDomesticaCheckbox?.style.setProperty('display', 'block');
                acoesPenaisCheckbox?.style.setProperty('display', 'block');
                processosJuriCheckbox?.style.setProperty('display', 'block');
            }
        }

        function setupNavigation() {
            const nav = document.getElementById('navigation');
            let buttons = '';

            buttons += `
                <button onclick="showView('dashboard')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-blue-600 text-white">
                    <i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i>
                    Dashboard
                </button>
            `;

            if (!currentUser.isJuiz) {
                buttons += `
                    <button onclick="showView('registro')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                        Registrar Minuta
                    </button>
                `;
            }

            buttons += `
                <button onclick="showView('historico')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
                    Hist√≥rico
                </button>
                <button onclick="showView('balcao')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="inbox" class="h-4 w-4 mr-2"></i>
                    Balc√£o Virtual
                </button>
            `;

            if (currentUser.isJuiz) {
                buttons += `
                    <button onclick="showView('calendario')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="calendar-days" class="h-4 w-4 mr-2"></i>
                        Calend√°rio
                    </button>
                    <button onclick="showView('relatorios')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="bar-chart" class="h-4 w-4 mr-2"></i>
                        Relat√≥rios
                    </button>
                    <button onclick="showView('metas')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="target" class="h-4 w-4 mr-2"></i>
                        Metas
                    </button>
                `;
            }

            nav.innerHTML = buttons;
            criarIcones();
        }

        function setupHistoricoFilters() {
            const filters = document.getElementById('historico-filters');
            if (!filters) return;

            // Mostrar filtro de assessor apenas para o juiz
            const filtroAssessorHtml = currentUser.isJuiz ? `
                <select id="filtro-assessor" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="renderHistorico()">
                    <option value="">Todos os assessores</option>
                    <option value="gilbert">Gilbert Juliano</option>
                    <option value="laise">La√≠se Vital</option>
                </select>
            ` : '';

            filters.innerHTML = `
                <div class="flex flex-wrap gap-2">
                    <input type="text" id="filtro-processo" placeholder="Buscar por n¬∫ do processo" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-48" oninput="renderHistorico()">
                    ${filtroAssessorHtml}
                    <select id="filtro-tipo" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="renderHistorico()">
                        <option value="">Todos os tipos</option>
                        <option value="Despacho">Despacho</option>
                        <option value="Decis√£o">Decis√£o</option>
                        <option value="Senten√ßa">Senten√ßa</option>
                    </select>
                    <select id="filtro-status" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="renderHistorico()">
                        <option value="">Todos os status</option>
                        <option value="pendente">Pendentes</option>
                        <option value="assinada">Assinadas</option>
                        <option value="correcao">Precisam Corre√ß√£o</option>
                        <option value="excluida">Exclu√≠das</option>
                    </select>
                    <select id="filtro-categoria" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="renderHistorico()">
                        <option value="">Todas as categorias</option>
                        <option value="meta1">Meta 1 CNJ</option>
                        <option value="meta2">Meta 2 CNJ</option>
                        <option value="meta10">Meta 10 CNJ</option>
                        <option value="seeu">SEEU</option>
                        <option value="sem_movimento">Sem movimenta√ß√£o 60+</option>
                        <option value="outros">Pedidos/Atos</option>
                        <option value="alem_meta">Al√©m da Meta</option>
                        <optgroup label="Pain√©is de Acompanhamento">
                            <option value="conhecimento_10anos">Conhecimento > 10 anos</option>
                            <option value="violencia_domestica">Viol√™ncia Dom√©stica</option>
                            <option value="acoes_saude">A√ß√µes de Sa√∫de</option>
                            <option value="acoes_penais">A√ß√µes Penais</option>
                            <option value="processos_juri">J√∫ri</option>
                            <option value="acoes_ambientais">A√ß√µes Ambientais</option>
                        </optgroup>
                    </select>
                    <button onclick="limparFiltros()" class="bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600 transition-colors text-sm">
                        <i data-lucide="x" class="h-3 w-3 mr-1 inline"></i>
                        Limpar
                    </button>
                </div>
            `;

            setTimeout(() => criarIcones(), 100);
        }

        function limparFiltros() {
            const filtroProcesso = document.getElementById('filtro-processo');
            const filtroTipo = document.getElementById('filtro-tipo');
            const filtroStatus = document.getElementById('filtro-status');
            const filtroCategoria = document.getElementById('filtro-categoria');
            const filtroAssessor = document.getElementById('filtro-assessor');

            if (filtroProcesso) filtroProcesso.value = '';
            if (filtroTipo) filtroTipo.value = '';
            if (filtroStatus) filtroStatus.value = '';
            if (filtroCategoria) filtroCategoria.value = '';
            if (filtroAssessor) filtroAssessor.value = '';

            renderHistorico();
            showNotification('Filtros limpos', 'info');
        }

        function showView(view) {
            try {
                log(`Navegando para: ${view}`);
                
                document.querySelectorAll('[id$="-view"]').forEach(el => {
                    if (el) el.classList.add('hidden');
                });

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (btn) {
                        btn.className = 'nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200';
                    }
                });

                const activeBtn = event?.target?.closest('button');
                if (activeBtn) {
                    activeBtn.className = 'nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-blue-600 text-white';
                }

                currentView = view;

                switch(view) {
                    case 'dashboard':
                        renderDashboard();
                        break;
                    case 'registro':
                        document.getElementById('registro-view')?.classList.remove('hidden');
                        break;
                    case 'historico':
                        renderHistorico();
                        break;
                    case 'calendario':
                        renderCalendario();
                        break;
                    case 'relatorios':
                        renderRelatorios();
                        break;
                    case 'balcao':
                        renderBalcaoVirtual();
                        break;
                    case 'metas':
                        renderMetasAcoesPenais();
                        break;
                }

                log(`View ${view} carregada`);
                
            } catch (error) {
                log(`Erro ao carregar view ${view}`, error);
                showNotification(`Erro ao carregar ${view}`, 'error');
            }
        }

        // ==================== BALC√ÉO VIRTUAL - FUN√á√ïES ====================

        function renderBalcaoVirtual() {
            const balcaoView = document.getElementById('balcao-view');
            if (!balcaoView) return;

            // Preencher dropdown de categorias nos filtros
            const filtroCategoriaSelect = document.getElementById('filtro-balcao-categoria');
            if (filtroCategoriaSelect && filtroCategoriaSelect.options.length <= 1) {
                Object.entries(categoriasBalcao).forEach(([key, cat]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = cat.nome;
                    filtroCategoriaSelect.appendChild(option);
                });
            }

            // Definir data do pedido como hoje por padr√£o
            const dataPedidoInput = document.getElementById('balcao-data-pedido');
            if (dataPedidoInput && !dataPedidoInput.value) {
                dataPedidoInput.value = getHojeString();
            }

            renderBalcaoPainel();

            // Inicializar sistema de abas - mostrar a aba atual
            mudarAbaBalcao(abaBalcaoAtual || 'cadastro');

            balcaoView.classList.remove('hidden');
            setTimeout(() => criarIcones(), 100);
        }

        function calcularPrazoBalcao(pedido) {
            const categoria = categoriasBalcao[pedido.categoria];
            const prazoHoras = categoria?.prazoHoras || 72;

            const dataPedido = new Date(pedido.dataPedido + 'T00:00:00');
            const agora = getDataHoraBrasilia();

            const horasPassadas = Math.floor((agora - dataPedido) / (1000 * 60 * 60));
            const diasPassados = Math.floor(horasPassadas / 24);

            const horasRestantes = prazoHoras - horasPassadas;
            const diasRestantes = Math.ceil(horasRestantes / 24);

            let status = 'no_prazo';
            if (horasRestantes <= 0) {
                status = 'vencido';
            } else if (horasRestantes <= 24) {
                status = 'vencendo';
            }

            return {
                prazoHoras,
                horasPassadas,
                diasPassados,
                horasRestantes,
                diasRestantes,
                status,
                vencido: horasRestantes <= 0
            };
        }

        function renderBalcaoPainel() {
            const painel = document.getElementById('balcao-painel');
            if (!painel) return;

            const pedidosArray = Object.values(pedidosBalcao).filter(p => p && p.status === 'pendente');

            let vencidos = 0;
            let vencendoHoje = 0;
            let noPrazo = 0;
            let totalPendentes = pedidosArray.length;

            pedidosArray.forEach(pedido => {
                const prazo = calcularPrazoBalcao(pedido);
                if (prazo.status === 'vencido') vencidos++;
                else if (prazo.status === 'vencendo') vencendoHoje++;
                else noPrazo++;
            });

            painel.innerHTML = `
                <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg p-6 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">Balc√£o Virtual - F√≥rum Major Izidoro</h2>
                            <p class="text-purple-100">Controle de pedidos e prazos</p>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-bold">${totalPendentes}</div>
                            <div class="text-purple-100 text-sm">pedidos pendentes</div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-red-600 font-medium">Vencidos</div>
                                <div class="text-3xl font-bold text-red-700">${vencidos}</div>
                            </div>
                            <i data-lucide="alert-triangle" class="h-10 w-10 text-red-400"></i>
                        </div>
                        ${vencidos > 0 ? '<div class="text-xs text-red-600 mt-2">‚ö†Ô∏è Necessita aten√ß√£o imediata!</div>' : ''}
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-yellow-600 font-medium">Vencendo Hoje</div>
                                <div class="text-3xl font-bold text-yellow-700">${vencendoHoje}</div>
                            </div>
                            <i data-lucide="clock" class="h-10 w-10 text-yellow-400"></i>
                        </div>
                        ${vencendoHoje > 0 ? '<div class="text-xs text-yellow-600 mt-2">‚è∞ Prazo expira em menos de 24h</div>' : ''}
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-green-600 font-medium">No Prazo</div>
                                <div class="text-3xl font-bold text-green-700">${noPrazo}</div>
                            </div>
                            <i data-lucide="check-circle" class="h-10 w-10 text-green-400"></i>
                        </div>
                    </div>
                </div>
            `;

            setTimeout(() => criarIcones(), 100);
        }

        function renderBalcaoLista() {
            const lista = document.getElementById('balcao-lista');
            if (!lista) return;

            // Obter filtros
            const filtroStatus = document.getElementById('filtro-balcao-status')?.value || 'pendente';
            const filtroCategoria = document.getElementById('filtro-balcao-categoria')?.value;
            const filtroAssessor = document.getElementById('filtro-balcao-assessor')?.value;
            const filtroPrazo = document.getElementById('filtro-balcao-prazo')?.value;

            let pedidosArray = Object.entries(pedidosBalcao)
                .filter(([key, p]) => p)
                .map(([key, p]) => ({ ...p, id: key }));

            // Filtro por status
            if (filtroStatus) {
                pedidosArray = pedidosArray.filter(p => p.status === filtroStatus);
            }

            // Filtro por categoria
            if (filtroCategoria) {
                pedidosArray = pedidosArray.filter(p => p.categoria === filtroCategoria);
            }

            // Filtro por assessor
            if (filtroAssessor) {
                pedidosArray = pedidosArray.filter(p => p.assessorId === filtroAssessor);
            }

            // Filtro por prazo
            if (filtroPrazo && filtroStatus === 'pendente') {
                pedidosArray = pedidosArray.filter(p => {
                    const prazo = calcularPrazoBalcao(p);
                    return prazo.status === filtroPrazo;
                });
            }

            // Ordenar por sequencial
            pedidosArray.sort((a, b) => (a.sequencial || 0) - (b.sequencial || 0));

            if (pedidosArray.length === 0) {
                lista.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i data-lucide="inbox" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                        <p>Nenhum pedido encontrado com os filtros aplicados.</p>
                    </div>
                `;
                setTimeout(() => criarIcones(), 100);
                return;
            }

            lista.innerHTML = `
                <div class="text-sm text-gray-600 mb-4">
                    Mostrando ${pedidosArray.length} pedido${pedidosArray.length !== 1 ? 's' : ''}
                </div>
                <div class="space-y-3">
                    ${pedidosArray.map(pedido => criarCardBalcao(pedido)).join('')}
                </div>
            `;

            setTimeout(() => criarIcones(), 100);
        }

        function criarCardBalcao(pedido) {
            const categoria = categoriasBalcao[pedido.categoria] || { nome: 'Desconhecida', cor: 'bg-gray-500' };
            const statusInfo = statusBalcao[pedido.status] || statusBalcao.pendente;
            const prazo = calcularPrazoBalcao(pedido);

            const prazoColor = {
                'vencido': 'bg-red-100 border-red-300 text-red-800',
                'vencendo': 'bg-yellow-100 border-yellow-300 text-yellow-800',
                'no_prazo': 'bg-green-100 border-green-300 text-green-800'
            };

            const prazoLabel = {
                'vencido': `‚ö†Ô∏è VENCIDO h√° ${Math.abs(prazo.diasRestantes)} dia${Math.abs(prazo.diasRestantes) !== 1 ? 's' : ''}`,
                'vencendo': `‚è∞ Vence em ${prazo.horasRestantes}h`,
                'no_prazo': `‚úì ${prazo.diasRestantes} dia${prazo.diasRestantes !== 1 ? 's' : ''} restante${prazo.diasRestantes !== 1 ? 's' : ''}`
            };

            const assessorNome = pedido.assessorNome || assessores[pedido.assessorId]?.nome || 'N√£o atribu√≠do';
            const pedidoIdSafe = escapeAttr(pedido.id);

            let botoesAcao = '';
            if (pedido.status === 'pendente') {
                // Se o usu√°rio atual √© o assessor respons√°vel ou √© juiz, pode marcar como minutado
                const podeMinutar = currentUser.isJuiz || pedido.assessorId === currentUser.assessorId;
                const podeEditarExcluir = pedido.assessorId === currentUser.assessorId || currentUser.isJuiz;

                if (podeEditarExcluir) {
                    botoesAcao = `
                        <button onclick="abrirModalEdicaoPedidoBalcao('${pedidoIdSafe}')" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors">
                            <i data-lucide="edit-2" class="h-3 w-3 mr-1 inline"></i>
                            Editar
                        </button>
                        <button onclick="excluirPedidoBalcao('${pedidoIdSafe}')" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">
                            <i data-lucide="trash-2" class="h-3 w-3 mr-1 inline"></i>
                            Excluir
                        </button>
                    `;
                }
                if (podeMinutar) {
                    botoesAcao += `
                        <button onclick="marcarComoMinutado('${pedidoIdSafe}')" class="px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-colors">
                            <i data-lucide="check" class="h-3 w-3 mr-1 inline"></i>
                            Marcar como Minutado
                        </button>
                    `;
                }
                if (currentUser.isJuiz) {
                    botoesAcao += `
                        <button onclick="cancelarPedidoBalcao('${pedidoIdSafe}')" class="px-3 py-1 bg-gray-500 text-white text-xs rounded hover:bg-gray-600 transition-colors">
                            Cancelar
                        </button>
                    `;
                }
            }

            return `
                <div class="border ${prazo.vencido && pedido.status === 'pendente' ? 'border-red-300 bg-red-50' : 'border-gray-200'} rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                <span class="font-bold text-gray-800">#${pedido.sequencial || '-'}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${categoria.cor} text-white">${categoria.nome}</span>
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusInfo.cor} text-white">${statusInfo.nome}</span>
                                <span class="px-2 py-1 rounded text-xs ${pedido.classe === 'criminal' ? 'bg-gray-700 text-white' : 'bg-blue-100 text-blue-800'}">${pedido.classe === 'criminal' ? 'Criminal' : 'C√≠vel'}</span>
                                ${pedido.despachoVirtual ? '<span class="px-2 py-1 rounded text-xs bg-blue-500 text-white">üìπ Despacho Virtual</span>' : ''}
                            </div>
                            <div class="text-sm text-gray-600 mb-2">
                                <div><strong>Processo:</strong> ${escapeHtml(pedido.numeroProcesso)}</div>
                                <div><strong>Assessor:</strong> ${escapeHtml(assessorNome)}</div>
                                <div><strong>Solicitante:</strong> ${escapeHtml(pedido.nomeSolicitante || '-')} (${pedido.tipoSolicitante === 'advogado' ? 'Advogado' : 'Parte'})</div>
                                <div><strong>Resumo:</strong> ${escapeHtml(pedido.resumo)}</div>
                                ${pedido.dataMinutado ? `<div class="text-green-600"><strong>Minutado em:</strong> ${formatarDataBrasilia(pedido.dataMinutado)}</div>` : ''}
                            </div>
                            ${pedido.status === 'pendente' ? `
                                <div class="inline-block px-3 py-1 rounded text-xs font-medium border ${prazoColor[prazo.status]}">
                                    ${prazoLabel[prazo.status]} (${prazo.diasPassados} dia${prazo.diasPassados !== 1 ? 's' : ''} desde o pedido)
                                </div>
                            ` : ''}
                            ${botoesAcao ? `<div class="flex gap-2 mt-3">${botoesAcao}</div>` : ''}
                        </div>
                        <div class="text-xs text-gray-500 text-right ml-4">
                            <div>Pedido: ${formatarDataBrasilia(pedido.dataPedido)}</div>
                            <div>Prazo: ${categoria.prazoHoras}h</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function cadastrarPedidoBalcao() {
            const numeroProcesso = document.getElementById('balcao-processo').value.trim();
            const sequencial = document.getElementById('balcao-sequencial').value;
            const classe = document.getElementById('balcao-classe').value;
            const categoria = document.getElementById('balcao-categoria').value;
            const dataPedido = document.getElementById('balcao-data-pedido').value;
            const tipoSolicitante = document.getElementById('balcao-tipo-solicitante').value;
            const nomeSolicitante = document.getElementById('balcao-nome-solicitante').value.trim();
            const resumo = document.getElementById('balcao-resumo').value.trim();
            const despachoVirtual = document.getElementById('balcao-despacho-virtual').checked;

            // Valida√ß√µes
            if (!numeroProcesso || !sequencial || !classe || !categoria || !dataPedido || !tipoSolicitante || !resumo) {
                showNotification('Por favor, preencha todos os campos obrigat√≥rios.', 'warning');
                return;
            }

            if (!validarNumeroProcesso(numeroProcesso)) {
                showNotification('N√∫mero do processo inv√°lido.', 'error');
                return;
            }

            const novoPedido = {
                numeroProcesso,
                sequencial: parseInt(sequencial),
                classe,
                categoria,
                dataPedido,
                tipoSolicitante,
                nomeSolicitante,
                resumo,
                despachoVirtual,
                assessorId: currentUser.assessorId || null,
                assessorNome: currentUser.nome,
                status: 'pendente',
                createdAt: getDataHoraBrasilia().getTime()
            };

            try {
                if (database) {
                    database.ref('pedidosBalcao').push(novoPedido)
                        .then((ref) => {
                            // Se marcou despacho virtual, criar notifica√ß√£o para o juiz
                            if (despachoVirtual) {
                                criarNotificacaoDespachoVirtual({
                                    ...novoPedido,
                                    id: ref.key
                                });
                            }

                            limparFormularioBalcao();
                            let mensagem = 'Pedido cadastrado com sucesso!';
                            if (despachoVirtual) {
                                mensagem += ' O juiz foi notificado sobre a solicita√ß√£o de despacho virtual.';
                            }
                            showNotification(mensagem, 'success');
                            renderBalcaoVirtual();
                        })
                        .catch((error) => {
                            log('Erro ao salvar pedido no Firebase:', error);
                            showNotification('Erro ao cadastrar pedido', 'error');
                        });
                } else {
                    const id = 'local_balcao_' + getDataHoraBrasilia().getTime();
                    pedidosBalcao[id] = novoPedido;
                    limparFormularioBalcao();
                    showNotification('Pedido cadastrado localmente', 'warning');
                    renderBalcaoVirtual();
                }
            } catch (error) {
                log('Erro ao cadastrar pedido:', error);
                showNotification('Erro ao cadastrar pedido', 'error');
            }
        }

        function limparFormularioBalcao() {
            document.getElementById('balcao-processo').value = '';
            document.getElementById('balcao-sequencial').value = '';
            document.getElementById('balcao-classe').value = '';
            document.getElementById('balcao-categoria').value = '';
            document.getElementById('balcao-data-pedido').value = getHojeString();
            document.getElementById('balcao-tipo-solicitante').value = '';
            document.getElementById('balcao-nome-solicitante').value = '';
            document.getElementById('balcao-resumo').value = '';
            document.getElementById('balcao-despacho-virtual').checked = false;
        }

        function limparFiltrosBalcao() {
            document.getElementById('filtro-balcao-status').value = 'pendente';
            document.getElementById('filtro-balcao-categoria').value = '';
            document.getElementById('filtro-balcao-assessor').value = '';
            document.getElementById('filtro-balcao-prazo').value = '';
            renderBalcaoLista();
        }

        function marcarComoMinutado(id) {
            if (!confirm('Confirma que este pedido foi minutado?')) return;

            const pedido = pedidosBalcao[id];
            if (!pedido) {
                showNotification('Pedido n√£o encontrado', 'error');
                return;
            }

            const pedidoAtualizado = {
                ...pedido,
                status: 'minutado',
                dataMinutado: getHojeString(),
                minutadoPor: currentUser.nome,
                minutadoEm: getDataHoraBrasilia().getTime()
            };

            if (database) {
                database.ref(`pedidosBalcao/${id}`).update(pedidoAtualizado)
                    .then(() => {
                        showNotification('Pedido marcado como minutado!', 'success');
                    })
                    .catch((error) => {
                        log('Erro ao atualizar pedido:', error);
                        showNotification('Erro ao atualizar pedido', 'error');
                    });
            } else {
                pedidosBalcao[id] = pedidoAtualizado;
                showNotification('Pedido atualizado localmente', 'warning');
                renderBalcaoVirtual();
            }
        }

        function cancelarPedidoBalcao(id) {
            if (!confirm('Tem certeza que deseja cancelar este pedido?')) return;

            const pedido = pedidosBalcao[id];
            if (!pedido) {
                showNotification('Pedido n√£o encontrado', 'error');
                return;
            }

            const pedidoAtualizado = {
                ...pedido,
                status: 'cancelado',
                canceladoPor: currentUser.nome,
                canceladoEm: getDataHoraBrasilia().getTime()
            };

            if (database) {
                database.ref(`pedidosBalcao/${id}`).update(pedidoAtualizado)
                    .then(() => {
                        showNotification('Pedido cancelado', 'success');
                    })
                    .catch((error) => {
                        log('Erro ao cancelar pedido:', error);
                        showNotification('Erro ao cancelar pedido', 'error');
                    });
            } else {
                pedidosBalcao[id] = pedidoAtualizado;
                showNotification('Pedido cancelado localmente', 'warning');
                renderBalcaoVirtual();
            }
        }

        function abrirModalEdicaoPedidoBalcao(id) {
            const pedido = pedidosBalcao[id];
            if (!pedido) {
                showNotification('Pedido n√£o encontrado', 'error');
                return;
            }

            // Verificar permiss√£o
            const podeEditar = pedido.assessorId === currentUser.assessorId || currentUser.isJuiz;
            if (!podeEditar) {
                showNotification('Voc√™ n√£o tem permiss√£o para editar este pedido', 'error');
                return;
            }

            // Preencher o dropdown de categorias
            const categoriaSelect = document.getElementById('edicao-pedido-categoria');
            categoriaSelect.innerHTML = '<option value="">Selecione...</option>';
            Object.entries(categoriasBalcao).forEach(([key, cat]) => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = cat.nome;
                categoriaSelect.appendChild(option);
            });

            // Preencher os campos com os dados do pedido
            document.getElementById('edicao-pedido-id').value = id;
            document.getElementById('edicao-pedido-sequencial').textContent = pedido.sequencial || '-';
            document.getElementById('edicao-pedido-sequencial-input').value = pedido.sequencial || '';
            document.getElementById('edicao-pedido-processo').value = pedido.numeroProcesso || '';
            document.getElementById('edicao-pedido-classe').value = pedido.classe || 'civel';
            document.getElementById('edicao-pedido-categoria').value = pedido.categoria || '';
            document.getElementById('edicao-pedido-data').value = pedido.dataPedido || '';
            document.getElementById('edicao-pedido-tipo-solicitante').value = pedido.tipoSolicitante || 'advogado';
            document.getElementById('edicao-pedido-nome-solicitante').value = pedido.nomeSolicitante || '';
            document.getElementById('edicao-pedido-resumo').value = pedido.resumo || '';
            document.getElementById('edicao-pedido-despacho-virtual').checked = pedido.despachoVirtual || false;

            // Abrir o modal
            document.getElementById('modal-edicao-pedido-balcao').classList.remove('hidden');
            setTimeout(() => criarIcones(), 100);
        }

        function fecharModalEdicaoPedidoBalcao() {
            document.getElementById('modal-edicao-pedido-balcao').classList.add('hidden');
        }

        function salvarEdicaoPedidoBalcao() {
            const id = document.getElementById('edicao-pedido-id').value;
            const pedidoOriginal = pedidosBalcao[id];

            if (!pedidoOriginal) {
                showNotification('Pedido n√£o encontrado', 'error');
                return;
            }

            // Coletar dados do formul√°rio
            const numeroProcesso = document.getElementById('edicao-pedido-processo').value.trim();
            const sequencial = document.getElementById('edicao-pedido-sequencial-input').value;
            const classe = document.getElementById('edicao-pedido-classe').value;
            const categoria = document.getElementById('edicao-pedido-categoria').value;
            const dataPedido = document.getElementById('edicao-pedido-data').value;
            const tipoSolicitante = document.getElementById('edicao-pedido-tipo-solicitante').value;
            const nomeSolicitante = document.getElementById('edicao-pedido-nome-solicitante').value.trim();
            const resumo = document.getElementById('edicao-pedido-resumo').value.trim();
            const despachoVirtual = document.getElementById('edicao-pedido-despacho-virtual').checked;

            // Valida√ß√µes
            if (!numeroProcesso || !sequencial || !classe || !categoria || !dataPedido || !tipoSolicitante || !resumo) {
                showNotification('Por favor, preencha todos os campos obrigat√≥rios.', 'warning');
                return;
            }

            if (!validarNumeroProcesso(numeroProcesso)) {
                showNotification('N√∫mero do processo inv√°lido.', 'error');
                return;
            }

            const pedidoAtualizado = {
                ...pedidoOriginal,
                numeroProcesso,
                sequencial: parseInt(sequencial),
                classe,
                categoria,
                dataPedido,
                tipoSolicitante,
                nomeSolicitante,
                resumo,
                despachoVirtual,
                editadoPor: currentUser.nome,
                editadoEm: getDataHoraBrasilia().getTime()
            };

            // Verificar se marcou despacho virtual e n√£o tinha antes
            const notificarDespacho = despachoVirtual && !pedidoOriginal.despachoVirtual;

            if (database) {
                database.ref(`pedidosBalcao/${id}`).update(pedidoAtualizado)
                    .then(() => {
                        // Se marcou despacho virtual agora, notificar o juiz
                        if (notificarDespacho) {
                            criarNotificacaoDespachoVirtual({
                                ...pedidoAtualizado,
                                id: id
                            });
                        }
                        fecharModalEdicaoPedidoBalcao();
                        let mensagem = 'Pedido atualizado com sucesso!';
                        if (notificarDespacho) {
                            mensagem += ' O juiz foi notificado sobre a solicita√ß√£o de despacho virtual.';
                        }
                        showNotification(mensagem, 'success');
                    })
                    .catch((error) => {
                        log('Erro ao atualizar pedido:', error);
                        showNotification('Erro ao atualizar pedido', 'error');
                    });
            } else {
                pedidosBalcao[id] = pedidoAtualizado;
                fecharModalEdicaoPedidoBalcao();
                showNotification('Pedido atualizado localmente', 'warning');
                renderBalcaoVirtual();
            }
        }

        function excluirPedidoBalcao(id) {
            const pedido = pedidosBalcao[id];
            if (!pedido) {
                showNotification('Pedido n√£o encontrado', 'error');
                return;
            }

            // Verificar permiss√£o
            const podeExcluir = pedido.assessorId === currentUser.assessorId || currentUser.isJuiz;
            if (!podeExcluir) {
                showNotification('Voc√™ n√£o tem permiss√£o para excluir este pedido', 'error');
                return;
            }

            const confirmMessage = `Tem certeza que deseja EXCLUIR permanentemente o pedido #${pedido.sequencial}?\n\nProcesso: ${pedido.numeroProcesso}\nResumo: ${pedido.resumo}\n\nEsta a√ß√£o n√£o pode ser desfeita!`;

            if (!confirm(confirmMessage)) return;

            if (database) {
                database.ref(`pedidosBalcao/${id}`).remove()
                    .then(() => {
                        showNotification('Pedido exclu√≠do com sucesso', 'success');
                    })
                    .catch((error) => {
                        log('Erro ao excluir pedido:', error);
                        showNotification('Erro ao excluir pedido', 'error');
                    });
            } else {
                delete pedidosBalcao[id];
                showNotification('Pedido exclu√≠do localmente', 'warning');
                renderBalcaoVirtual();
            }
        }

        // ==================== BALC√ÉO VIRTUAL - ABAS E RELAT√ìRIOS ====================

        let abaBalcaoAtual = 'cadastro';

        function mudarAbaBalcao(aba) {
            abaBalcaoAtual = aba;

            // Esconder todas as abas
            document.getElementById('balcao-aba-cadastro')?.classList.add('hidden');
            document.getElementById('balcao-aba-lista')?.classList.add('hidden');
            document.getElementById('balcao-aba-relatorios')?.classList.add('hidden');

            // Remover estilo ativo de todos os tabs
            document.querySelectorAll('.balcao-tab').forEach(tab => {
                tab.classList.remove('border-purple-500', 'text-purple-600');
                tab.classList.add('border-transparent', 'text-gray-500');
            });

            // Mostrar aba selecionada e ativar tab
            const abaElement = document.getElementById(`balcao-aba-${aba}`);
            const tabElement = document.getElementById(`tab-${aba}`);

            if (abaElement) {
                abaElement.classList.remove('hidden');
            }

            if (tabElement) {
                tabElement.classList.remove('border-transparent', 'text-gray-500');
                tabElement.classList.add('border-purple-500', 'text-purple-600');
            }

            // Se for a aba de lista, renderizar a lista
            if (aba === 'lista') {
                renderBalcaoLista();
            }

            setTimeout(() => criarIcones(), 100);
            log(`Aba do Balc√£o alterada para: ${aba}`);
        }

        function mostrarRelatorioBalcaoPersonalizado() {
            // Preencher dropdown de categorias
            const selectCategoria = document.getElementById('balcao-relatorio-categoria');
            if (selectCategoria && selectCategoria.options.length <= 1) {
                Object.entries(categoriasBalcao).forEach(([key, cat]) => {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = cat.nome;
                    selectCategoria.appendChild(option);
                });
            }

            // Pr√©-preencher com datas do m√™s atual
            const hoje = getDataHoraBrasilia();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);

            document.getElementById('balcao-relatorio-data-inicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('balcao-relatorio-data-fim').value = fimMes.toISOString().split('T')[0];

            document.getElementById('modal-relatorio-balcao-personalizado').classList.remove('hidden');
            setTimeout(() => criarIcones(), 100);
            log('Modal de relat√≥rio personalizado do Balc√£o aberto');
        }

        function fecharModalRelatorioBalcaoPersonalizado() {
            document.getElementById('modal-relatorio-balcao-personalizado').classList.add('hidden');
        }

        function gerarRelatorioBalcaoPersonalizado() {
            const dataInicio = document.getElementById('balcao-relatorio-data-inicio').value;
            const dataFim = document.getElementById('balcao-relatorio-data-fim').value;
            const categoriaFiltro = document.getElementById('balcao-relatorio-categoria').value;
            const assessorFiltro = document.getElementById('balcao-relatorio-assessor').value;

            if (!dataInicio || !dataFim) {
                showNotification('Por favor, selecione as datas de in√≠cio e fim', 'warning');
                return;
            }

            if (dataInicio > dataFim) {
                showNotification('A data de in√≠cio deve ser anterior √† data de fim', 'error');
                return;
            }

            fecharModalRelatorioBalcaoPersonalizado();
            gerarRelatorioBalcao('personalizado', new Date(dataInicio), new Date(dataFim), categoriaFiltro, assessorFiltro);
        }

        function gerarRelatorioBalcao(tipo, dataInicioCustom = null, dataFimCustom = null, categoriaFiltro = '', assessorFiltro = '') {
            try {
                const relatorioContent = document.getElementById('balcao-relatorio-content');
                if (!relatorioContent) {
                    throw new Error('Elemento balcao-relatorio-content n√£o encontrado');
                }

                const hoje = getDataHoraBrasilia();
                let inicio, fim, titulo;

                if (tipo === 'personalizado' && dataInicioCustom && dataFimCustom) {
                    inicio = dataInicioCustom;
                    fim = dataFimCustom;
                    titulo = `Relat√≥rio Personalizado - ${inicio.toLocaleDateString('pt-BR')} a ${fim.toLocaleDateString('pt-BR')}`;
                } else if (tipo === 'semanal') {
                    inicio = getInicioSemana(hoje);
                    fim = getFimSemana(hoje);
                    titulo = `Relat√≥rio Semanal - ${inicio.toLocaleDateString('pt-BR')} a ${fim.toLocaleDateString('pt-BR')}`;
                } else if (tipo === 'mensal') {
                    inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                    titulo = `Relat√≥rio Mensal - ${inicio.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
                } else {
                    throw new Error(`Tipo de relat√≥rio inv√°lido: ${tipo}`);
                }

                const inicioStr = inicio.toISOString().split('T')[0];
                const fimStr = fim.toISOString().split('T')[0];

                log(`Gerando relat√≥rio do Balc√£o ${tipo} para per√≠odo ${inicioStr} a ${fimStr}`);

                // Filtrar pedidos do per√≠odo
                let pedidosRelatorio = Object.values(pedidosBalcao).filter(p => {
                    if (!p || !p.dataPedido) return false;
                    return p.dataPedido >= inicioStr && p.dataPedido <= fimStr;
                });

                // Aplicar filtros adicionais
                if (categoriaFiltro) {
                    pedidosRelatorio = pedidosRelatorio.filter(p => p.categoria === categoriaFiltro);
                }
                if (assessorFiltro) {
                    pedidosRelatorio = pedidosRelatorio.filter(p => p.assessorId === assessorFiltro);
                }

                log(`Encontrados ${pedidosRelatorio.length} pedidos no per√≠odo`);

                // Calcular estat√≠sticas
                const estatisticas = calcularEstatisticasBalcao(pedidosRelatorio);

                // Gerar HTML do relat√≥rio
                let relatorioHtml = `
                    <div class="space-y-6">
                        <div class="text-center border-b pb-4">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">${titulo}</h3>
                            <p class="text-gray-600">Balc√£o Virtual - F√≥rum Major Izidoro</p>
                            <p class="text-sm text-gray-500">Gerado em ${hoje.toLocaleString('pt-BR')}</p>
                            ${categoriaFiltro ? `<p class="text-xs text-purple-600 mt-1">Filtro: ${categoriasBalcao[categoriaFiltro]?.nome || categoriaFiltro}</p>` : ''}
                            ${assessorFiltro ? `<p class="text-xs text-purple-600">Assessor: ${assessores[assessorFiltro]?.nome || assessorFiltro}</p>` : ''}
                        </div>

                        <!-- Resumo Executivo -->
                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 border border-purple-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-purple-800 mb-4">üìä Resumo Executivo</h4>
                            <div class="grid md:grid-cols-5 gap-4 text-center">
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-3xl font-bold text-purple-600">${estatisticas.total}</div>
                                    <div class="text-sm text-gray-600">Total de Pedidos</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-3xl font-bold text-green-600">${estatisticas.minutados}</div>
                                    <div class="text-sm text-gray-600">Minutados</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-3xl font-bold text-yellow-600">${estatisticas.pendentes}</div>
                                    <div class="text-sm text-gray-600">Pendentes</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-3xl font-bold text-red-600">${estatisticas.vencidos}</div>
                                    <div class="text-sm text-gray-600">Vencidos</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-3xl font-bold text-gray-600">${estatisticas.cancelados}</div>
                                    <div class="text-sm text-gray-600">Cancelados</div>
                                </div>
                            </div>
                        </div>

                        <!-- Indicadores de Performance -->
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-600">Taxa de Atendimento</span>
                                    <span class="text-lg font-bold ${estatisticas.taxaAtendimento >= 80 ? 'text-green-600' : estatisticas.taxaAtendimento >= 50 ? 'text-yellow-600' : 'text-red-600'}">${estatisticas.taxaAtendimento}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="${estatisticas.taxaAtendimento >= 80 ? 'bg-green-500' : estatisticas.taxaAtendimento >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-3 rounded-full" style="width: ${estatisticas.taxaAtendimento}%"></div>
                                </div>
                            </div>

                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-600">Cumprimento de Prazo</span>
                                    <span class="text-lg font-bold ${estatisticas.taxaCumprimentoPrazo >= 80 ? 'text-green-600' : estatisticas.taxaCumprimentoPrazo >= 50 ? 'text-yellow-600' : 'text-red-600'}">${estatisticas.taxaCumprimentoPrazo}%</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="${estatisticas.taxaCumprimentoPrazo >= 80 ? 'bg-green-500' : estatisticas.taxaCumprimentoPrazo >= 50 ? 'bg-yellow-500' : 'bg-red-500'} h-3 rounded-full" style="width: ${estatisticas.taxaCumprimentoPrazo}%"></div>
                                </div>
                            </div>

                            <div class="bg-white border border-gray-200 rounded-lg p-4">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-medium text-gray-600">Tempo M√©dio de Atendimento</span>
                                    <span class="text-lg font-bold text-blue-600">${estatisticas.tempoMedioAtendimento} dias</span>
                                </div>
                                <div class="text-xs text-gray-500">Baseado nos pedidos minutados</div>
                            </div>
                        </div>

                        <!-- Distribui√ß√£o por Categoria -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">üìã Distribui√ß√£o por Categoria</h4>
                            <div class="space-y-3">
                                ${Object.entries(estatisticas.porCategoria).map(([catKey, dados]) => {
                                    const categoria = categoriasBalcao[catKey] || { nome: catKey, cor: 'bg-gray-500' };
                                    const porcentagem = estatisticas.total > 0 ? Math.round((dados.total / estatisticas.total) * 100) : 0;
                                    return `
                                        <div class="flex items-center space-x-4">
                                            <div class="w-32 text-sm font-medium text-gray-600 truncate" title="${categoria.nome}">${categoria.nome}</div>
                                            <div class="flex-1 bg-gray-200 rounded-full h-4 relative">
                                                <div class="${categoria.cor} h-4 rounded-full" style="width: ${porcentagem}%"></div>
                                            </div>
                                            <div class="w-24 text-sm text-gray-600 text-right">
                                                ${dados.total} (${porcentagem}%)
                                            </div>
                                            <div class="w-20 text-xs text-green-600">
                                                ‚úì ${dados.minutados}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>

                        <!-- Distribui√ß√£o por Assessor -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-blue-800 mb-4">üë®‚Äçüíº Gilbert Juliano</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span>Total de pedidos:</span>
                                        <span class="font-bold">${estatisticas.porAssessor.gilbert?.total || 0}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Minutados:</span>
                                        <span class="font-bold text-green-600">${estatisticas.porAssessor.gilbert?.minutados || 0}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Pendentes:</span>
                                        <span class="font-bold text-yellow-600">${estatisticas.porAssessor.gilbert?.pendentes || 0}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Vencidos:</span>
                                        <span class="font-bold text-red-600">${estatisticas.porAssessor.gilbert?.vencidos || 0}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-green-800 mb-4">üë©‚Äçüíº La√≠se Vital</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between">
                                        <span>Total de pedidos:</span>
                                        <span class="font-bold">${estatisticas.porAssessor.laise?.total || 0}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Minutados:</span>
                                        <span class="font-bold text-green-600">${estatisticas.porAssessor.laise?.minutados || 0}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Pendentes:</span>
                                        <span class="font-bold text-yellow-600">${estatisticas.porAssessor.laise?.pendentes || 0}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Vencidos:</span>
                                        <span class="font-bold text-red-600">${estatisticas.porAssessor.laise?.vencidos || 0}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Distribui√ß√£o por Classe -->
                        <div class="bg-white border border-gray-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-4">‚öñÔ∏è Distribui√ß√£o por Classe</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                                    <div class="text-3xl font-bold text-blue-700">${estatisticas.porClasse.civel || 0}</div>
                                    <div class="text-sm text-blue-600">C√≠vel</div>
                                </div>
                                <div class="bg-gray-100 border border-gray-300 rounded-lg p-4 text-center">
                                    <div class="text-3xl font-bold text-gray-700">${estatisticas.porClasse.criminal || 0}</div>
                                    <div class="text-sm text-gray-600">Criminal</div>
                                </div>
                            </div>
                        </div>

                        <!-- Pedidos com Despacho Virtual -->
                        ${estatisticas.despachoVirtual > 0 ? `
                            <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <i data-lucide="video" class="h-6 w-6 text-indigo-600 mr-3"></i>
                                    <div>
                                        <div class="font-semibold text-indigo-800">${estatisticas.despachoVirtual} pedido${estatisticas.despachoVirtual !== 1 ? 's' : ''} com solicita√ß√£o de Despacho Virtual</div>
                                        <div class="text-sm text-indigo-600">Necessitam agendamento com o MM. Juiz</div>
                                    </div>
                                </div>
                            </div>
                        ` : ''}

                        <!-- Observa√ß√µes -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">üìù Observa√ß√µes</h4>
                            <div class="space-y-2 text-sm text-gray-700">
                                <p>‚Ä¢ <strong>Taxa de Atendimento:</strong> Percentual de pedidos minutados em rela√ß√£o ao total (excluindo cancelados)</p>
                                <p>‚Ä¢ <strong>Cumprimento de Prazo:</strong> Percentual de pedidos minutados dentro do prazo estabelecido</p>
                                <p>‚Ä¢ <strong>Prazos:</strong> Urg√™ncias e categorias especiais = 72 horas | Outros = 60 dias</p>
                                <p>‚Ä¢ <strong>Tempo M√©dio:</strong> Calculado com base na diferen√ßa entre data do pedido e data de minuta√ß√£o</p>
                            </div>
                        </div>
                    </div>
                `;

                relatorioContent.innerHTML = relatorioHtml;
                setTimeout(() => criarIcones(), 100);

                log(`Relat√≥rio do Balc√£o ${tipo} gerado com sucesso - ${pedidosRelatorio.length} pedidos processados`);
                showNotification(`Relat√≥rio ${tipo} gerado com sucesso!`, 'success');

            } catch (error) {
                log(`Erro ao gerar relat√≥rio do Balc√£o ${tipo}:`, error);
                showNotification('Erro ao gerar relat√≥rio', 'error');
            }
        }

        function calcularEstatisticasBalcao(pedidos) {
            const estatisticas = {
                total: pedidos.length,
                minutados: 0,
                pendentes: 0,
                cancelados: 0,
                vencidos: 0,
                taxaAtendimento: 0,
                taxaCumprimentoPrazo: 0,
                tempoMedioAtendimento: 0,
                despachoVirtual: 0,
                porCategoria: {},
                porAssessor: {
                    gilbert: { total: 0, minutados: 0, pendentes: 0, vencidos: 0 },
                    laise: { total: 0, minutados: 0, pendentes: 0, vencidos: 0 }
                },
                porClasse: { civel: 0, criminal: 0 }
            };

            let totalDiasAtendimento = 0;
            let pedidosMinutadosComData = 0;
            let minutadosDentroPrazo = 0;

            pedidos.forEach(pedido => {
                // Contagem por status
                if (pedido.status === 'minutado') {
                    estatisticas.minutados++;
                } else if (pedido.status === 'pendente') {
                    estatisticas.pendentes++;
                    // Verificar se est√° vencido
                    const prazo = calcularPrazoBalcao(pedido);
                    if (prazo.vencido) {
                        estatisticas.vencidos++;
                    }
                } else if (pedido.status === 'cancelado') {
                    estatisticas.cancelados++;
                }

                // Despacho virtual
                if (pedido.despachoVirtual) {
                    estatisticas.despachoVirtual++;
                }

                // Por categoria
                const cat = pedido.categoria || 'outros';
                if (!estatisticas.porCategoria[cat]) {
                    estatisticas.porCategoria[cat] = { total: 0, minutados: 0 };
                }
                estatisticas.porCategoria[cat].total++;
                if (pedido.status === 'minutado') {
                    estatisticas.porCategoria[cat].minutados++;
                }

                // Por assessor
                const assessorId = pedido.assessorId || 'gilbert';
                if (estatisticas.porAssessor[assessorId]) {
                    estatisticas.porAssessor[assessorId].total++;
                    if (pedido.status === 'minutado') {
                        estatisticas.porAssessor[assessorId].minutados++;
                    } else if (pedido.status === 'pendente') {
                        estatisticas.porAssessor[assessorId].pendentes++;
                        const prazo = calcularPrazoBalcao(pedido);
                        if (prazo.vencido) {
                            estatisticas.porAssessor[assessorId].vencidos++;
                        }
                    }
                }

                // Por classe
                if (pedido.classe === 'civel') {
                    estatisticas.porClasse.civel++;
                } else if (pedido.classe === 'criminal') {
                    estatisticas.porClasse.criminal++;
                }

                // Tempo m√©dio de atendimento
                if (pedido.status === 'minutado' && pedido.dataMinutado && pedido.dataPedido) {
                    const dataPedido = new Date(pedido.dataPedido);
                    const dataMinutado = new Date(pedido.dataMinutado);
                    const dias = Math.floor((dataMinutado - dataPedido) / (1000 * 60 * 60 * 24));
                    totalDiasAtendimento += dias;
                    pedidosMinutadosComData++;

                    // Verificar se foi dentro do prazo
                    const categoria = categoriasBalcao[pedido.categoria];
                    const prazoHoras = categoria?.prazoHoras || 72;
                    const prazoDias = Math.ceil(prazoHoras / 24);
                    if (dias <= prazoDias) {
                        minutadosDentroPrazo++;
                    }
                }
            });

            // Calcular taxas
            const pedidosAtivos = estatisticas.total - estatisticas.cancelados;
            estatisticas.taxaAtendimento = pedidosAtivos > 0 ? Math.round((estatisticas.minutados / pedidosAtivos) * 100) : 0;
            estatisticas.taxaCumprimentoPrazo = estatisticas.minutados > 0 ? Math.round((minutadosDentroPrazo / estatisticas.minutados) * 100) : 0;
            estatisticas.tempoMedioAtendimento = pedidosMinutadosComData > 0 ? Math.round(totalDiasAtendimento / pedidosMinutadosComData) : 0;

            return estatisticas;
        }

        // ==================== METAS - A√á√ïES PENAIS ====================

        let abaMetasAtual = 'lista';

        function renderMetasAcoesPenais() {
            const metasView = document.getElementById('metas-view');
            if (!metasView) return;

            renderMetasDashboard();
            mudarAbaMetas(abaMetasAtual || 'lista');

            metasView.classList.remove('hidden');
            setTimeout(() => criarIcones(), 100);
        }

        function mudarAbaMetas(aba) {
            abaMetasAtual = aba;

            // Esconder todas as abas
            document.getElementById('metas-aba-lista')?.classList.add('hidden');
            document.getElementById('metas-aba-cadastro')?.classList.add('hidden');
            document.getElementById('metas-aba-relatorios')?.classList.add('hidden');
            document.getElementById('metas-aba-importar')?.classList.add('hidden');

            // Resetar estilo dos bot√µes
            document.querySelectorAll('.metas-tab').forEach(tab => {
                tab.className = 'metas-tab px-6 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300';
            });

            // Mostrar aba selecionada e atualizar bot√£o
            const abaElement = document.getElementById(`metas-aba-${aba}`);
            const tabButton = document.getElementById(`tab-metas-${aba}`);

            if (abaElement) {
                abaElement.classList.remove('hidden');
            }
            if (tabButton) {
                tabButton.className = 'metas-tab px-6 py-3 text-sm font-medium border-b-2 border-amber-500 text-amber-600';
            }

            // Renderizar conte√∫do espec√≠fico
            if (aba === 'lista') {
                renderListaMetas();
            } else if (aba === 'relatorios') {
                renderRelatorioMetas();
            }

            setTimeout(() => criarIcones(), 100);
        }

        function renderMetasDashboard() {
            const dashboard = document.getElementById('metas-dashboard');
            if (!dashboard) return;

            const processos = Object.values(processosMetaAcoesPenais).filter(p => p);
            const total = processos.length;
            const baixados = processos.filter(p => p.status === 'baixado').length;
            const emAndamento = processos.filter(p => p.status === 'em_andamento').length;
            const suspensos = processos.filter(p => p.status === 'suspenso' || p.status === 'sobrestado').length;

            // Calcular processos parados (sem movimenta√ß√£o h√° mais de 30 dias)
            const hoje = getDataHoraBrasilia();
            const parados = processos.filter(p => {
                if (p.status === 'baixado') return false;
                const ultimaMov = new Date(p.ultimaMovimentacao + 'T00:00:00');
                const diasParado = Math.floor((hoje - ultimaMov) / (1000 * 60 * 60 * 24));
                return diasParado > 30;
            }).length;

            // Calcular dias at√© o prazo final
            const prazoFinal = new Date(META_ACOES_PENAIS.prazoFinal + 'T23:59:59');
            const diasRestantes = Math.ceil((prazoFinal - hoje) / (1000 * 60 * 60 * 24));

            // Percentual de conclus√£o
            const percentualConcluido = total > 0 ? Math.round((baixados / total) * 100) : 0;

            dashboard.innerHTML = `
                <div class="bg-gradient-to-r from-amber-600 to-amber-700 text-white rounded-lg p-6 mb-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold mb-2">${META_ACOES_PENAIS.nome}</h2>
                            <p class="text-amber-100">${META_ACOES_PENAIS.descricao}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-bold">${percentualConcluido}%</div>
                            <div class="text-amber-100 text-sm">conclu√≠do</div>
                        </div>
                    </div>
                    <div class="mt-4">
                        <div class="bg-amber-800 rounded-full h-4 overflow-hidden">
                            <div class="bg-green-400 h-full transition-all duration-500" style="width: ${percentualConcluido}%"></div>
                        </div>
                        <div class="flex justify-between text-xs text-amber-100 mt-1">
                            <span>${baixados} de ${total} processos baixados</span>
                            <span>Prazo: 19/12/2026 (${diasRestantes} dias)</span>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-blue-600 font-medium">Em Andamento</div>
                                <div class="text-3xl font-bold text-blue-700">${emAndamento}</div>
                            </div>
                            <i data-lucide="clock" class="h-10 w-10 text-blue-400"></i>
                        </div>
                    </div>

                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-green-600 font-medium">Baixados</div>
                                <div class="text-3xl font-bold text-green-700">${baixados}</div>
                            </div>
                            <i data-lucide="check-circle" class="h-10 w-10 text-green-400"></i>
                        </div>
                    </div>

                    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-yellow-600 font-medium">Suspensos/Sobrestados</div>
                                <div class="text-3xl font-bold text-yellow-700">${suspensos}</div>
                            </div>
                            <i data-lucide="pause-circle" class="h-10 w-10 text-yellow-400"></i>
                        </div>
                    </div>

                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-red-600 font-medium">Parados (+30 dias)</div>
                                <div class="text-3xl font-bold text-red-700">${parados}</div>
                            </div>
                            <i data-lucide="alert-triangle" class="h-10 w-10 text-red-400"></i>
                        </div>
                        ${parados > 0 ? '<div class="text-xs text-red-600 mt-2">‚ö†Ô∏è Necessita aten√ß√£o!</div>' : ''}
                    </div>
                </div>
            `;

            setTimeout(() => criarIcones(), 100);
        }

        function renderListaMetas() {
            const lista = document.getElementById('metas-lista-processos');
            if (!lista) return;

            // Obter filtros
            const filtroProcesso = document.getElementById('filtro-metas-processo')?.value?.toLowerCase() || '';
            const filtroStatus = document.getElementById('filtro-metas-status')?.value || '';
            const filtroFase = document.getElementById('filtro-metas-fase')?.value || '';
            const filtroParado = document.getElementById('filtro-metas-parado')?.value || '';

            let processosArray = Object.entries(processosMetaAcoesPenais)
                .filter(([key, p]) => p)
                .map(([key, p]) => ({ ...p, id: key }));

            // Aplicar filtros
            if (filtroProcesso) {
                processosArray = processosArray.filter(p =>
                    p.numeroProcesso?.toLowerCase().includes(filtroProcesso)
                );
            }
            if (filtroStatus) {
                processosArray = processosArray.filter(p => p.status === filtroStatus);
            }
            if (filtroFase) {
                processosArray = processosArray.filter(p => p.fase === filtroFase);
            }
            if (filtroParado) {
                const hoje = getDataHoraBrasilia();
                const diasFiltro = parseInt(filtroParado);
                processosArray = processosArray.filter(p => {
                    if (p.status === 'baixado') return false;
                    const ultimaMov = new Date(p.ultimaMovimentacao + 'T00:00:00');
                    const diasParado = Math.floor((hoje - ultimaMov) / (1000 * 60 * 60 * 24));
                    return diasParado >= diasFiltro;
                });
            }

            // Ordenar por √∫ltima movimenta√ß√£o (mais antigos primeiro)
            processosArray.sort((a, b) => {
                const dataA = new Date(a.ultimaMovimentacao || '2000-01-01');
                const dataB = new Date(b.ultimaMovimentacao || '2000-01-01');
                return dataA - dataB;
            });

            if (processosArray.length === 0) {
                lista.innerHTML = `
                    <div class="text-center text-gray-500 py-12">
                        <i data-lucide="scale" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                        <p>Nenhum processo encontrado${filtroProcesso || filtroStatus || filtroFase || filtroParado ? ' com os filtros aplicados' : ''}.</p>
                        <p class="text-sm mt-2">Cadastre processos na aba "Cadastrar Processo".</p>
                    </div>
                `;
                setTimeout(() => criarIcones(), 100);
                return;
            }

            lista.innerHTML = `
                <div class="text-sm text-gray-600 mb-4">
                    Mostrando ${processosArray.length} processo${processosArray.length !== 1 ? 's' : ''}
                </div>
                <div class="space-y-3">
                    ${processosArray.map(processo => criarCardProcessoMeta(processo)).join('')}
                </div>
            `;

            setTimeout(() => criarIcones(), 100);
        }

        function criarCardProcessoMeta(processo) {
            const statusInfo = statusProcessoMeta[processo.status] || statusProcessoMeta.em_andamento;
            const faseInfo = fasesProcessoMeta[processo.fase] || { nome: 'N√£o definida', ordem: 0 };

            // Calcular dias desde √∫ltima movimenta√ß√£o
            const hoje = getDataHoraBrasilia();
            const ultimaMov = new Date(processo.ultimaMovimentacao + 'T00:00:00');
            const diasParado = Math.floor((hoje - ultimaMov) / (1000 * 60 * 60 * 24));

            let alertaParado = '';
            let borderClass = 'border-gray-200';
            if (processo.status !== 'baixado' && diasParado > 30) {
                borderClass = 'border-red-300 bg-red-50';
                if (diasParado > 90) {
                    alertaParado = `<span class="px-2 py-1 bg-red-600 text-white text-xs rounded">‚ö†Ô∏è ${diasParado} dias parado!</span>`;
                } else if (diasParado > 60) {
                    alertaParado = `<span class="px-2 py-1 bg-red-500 text-white text-xs rounded">‚ö†Ô∏è ${diasParado} dias parado</span>`;
                } else {
                    alertaParado = `<span class="px-2 py-1 bg-yellow-500 text-white text-xs rounded">‚è∞ ${diasParado} dias parado</span>`;
                }
            }

            const processoIdSafe = escapeAttr(processo.id);

            return `
                <div class="border ${borderClass} rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2 flex-wrap">
                                <span class="font-bold text-gray-800">${escapeHtml(processo.numeroProcesso)}</span>
                                ${processo.classe ? `<span class="px-2 py-1 rounded text-xs bg-indigo-100 text-indigo-800">${escapeHtml(processo.classe)}</span>` : ''}
                                <span class="px-2 py-1 rounded-full text-xs font-medium ${statusInfo.cor} text-white">${statusInfo.nome}</span>
                                <span class="px-2 py-1 rounded text-xs bg-gray-200 text-gray-700">${faseInfo.nome}</span>
                                ${alertaParado}
                            </div>
                            <div class="text-sm text-gray-600 mb-2">
                                <div><strong>√öltima Movimenta√ß√£o:</strong> ${formatarDataBrasilia(processo.ultimaMovimentacao)}</div>
                                ${processo.situacaoOriginal ? `<div><strong>Situa√ß√£o Original:</strong> ${escapeHtml(processo.situacaoOriginal)}</div>` : ''}
                                ${processo.observacoes ? `<div><strong>Observa√ß√µes:</strong> ${escapeHtml(processo.observacoes)}</div>` : ''}
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button onclick="abrirModalEdicaoProcessoMeta('${processoIdSafe}')" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors">
                                    <i data-lucide="edit-2" class="h-3 w-3 mr-1 inline"></i>
                                    Atualizar
                                </button>
                                <button onclick="excluirProcessoMeta('${processoIdSafe}')" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">
                                    <i data-lucide="trash-2" class="h-3 w-3 mr-1 inline"></i>
                                    Excluir
                                </button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 text-right ml-4">
                            <div>Cadastrado: ${formatarDataBrasilia(processo.dataCadastro)}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function cadastrarProcessoMeta() {
            const numeroProcesso = document.getElementById('meta-processo-numero').value.trim();
            const status = document.getElementById('meta-processo-status').value;
            const fase = document.getElementById('meta-processo-fase').value;
            const ultimaMovimentacao = document.getElementById('meta-processo-ultima-mov').value;
            const observacoes = document.getElementById('meta-processo-observacoes').value.trim();

            // Valida√ß√µes
            if (!numeroProcesso || !status || !fase || !ultimaMovimentacao) {
                showNotification('Por favor, preencha todos os campos obrigat√≥rios.', 'warning');
                return;
            }

            if (!validarNumeroProcesso(numeroProcesso)) {
                showNotification('N√∫mero do processo inv√°lido.', 'error');
                return;
            }

            // Verificar se j√° existe
            const existe = Object.values(processosMetaAcoesPenais).some(p =>
                p && p.numeroProcesso === numeroProcesso
            );
            if (existe) {
                showNotification('Este processo j√° est√° cadastrado na meta.', 'error');
                return;
            }

            const novoProcesso = {
                numeroProcesso,
                status,
                fase,
                ultimaMovimentacao,
                observacoes,
                dataCadastro: getHojeString(),
                criadoPor: currentUser.nome,
                criadoEm: getDataHoraBrasilia().getTime()
            };

            if (database) {
                database.ref('processosMetaAcoesPenais').push(novoProcesso)
                    .then(() => {
                        limparFormularioMeta();
                        showNotification('Processo cadastrado na meta com sucesso!', 'success');
                        mudarAbaMetas('lista');
                    })
                    .catch((error) => {
                        log('Erro ao cadastrar processo na meta:', error);
                        showNotification('Erro ao cadastrar processo', 'error');
                    });
            } else {
                const id = 'local_' + Date.now();
                processosMetaAcoesPenais[id] = novoProcesso;
                limparFormularioMeta();
                showNotification('Processo cadastrado localmente', 'warning');
                renderMetasAcoesPenais();
            }
        }

        function limparFormularioMeta() {
            document.getElementById('meta-processo-numero').value = '';
            document.getElementById('meta-processo-status').value = 'em_andamento';
            document.getElementById('meta-processo-fase').value = '';
            document.getElementById('meta-processo-ultima-mov').value = '';
            document.getElementById('meta-processo-observacoes').value = '';
        }

        function limparFiltrosMetas() {
            document.getElementById('filtro-metas-processo').value = '';
            document.getElementById('filtro-metas-status').value = '';
            document.getElementById('filtro-metas-fase').value = '';
            document.getElementById('filtro-metas-parado').value = '';
            renderListaMetas();
        }

        function abrirModalEdicaoProcessoMeta(id) {
            const processo = processosMetaAcoesPenais[id];
            if (!processo) {
                showNotification('Processo n√£o encontrado', 'error');
                return;
            }

            document.getElementById('edicao-meta-processo-id').value = id;
            document.getElementById('edicao-meta-processo-numero-display').textContent = `Processo: ${processo.numeroProcesso}`;
            document.getElementById('edicao-meta-processo-status').value = processo.status || 'em_andamento';
            document.getElementById('edicao-meta-processo-fase').value = processo.fase || '';
            document.getElementById('edicao-meta-processo-ultima-mov').value = processo.ultimaMovimentacao || '';
            document.getElementById('edicao-meta-processo-observacoes').value = processo.observacoes || '';

            document.getElementById('modal-edicao-processo-meta').classList.remove('hidden');
            setTimeout(() => criarIcones(), 100);
        }

        function fecharModalEdicaoProcessoMeta() {
            document.getElementById('modal-edicao-processo-meta').classList.add('hidden');
        }

        function salvarEdicaoProcessoMeta() {
            const id = document.getElementById('edicao-meta-processo-id').value;
            const processoOriginal = processosMetaAcoesPenais[id];

            if (!processoOriginal) {
                showNotification('Processo n√£o encontrado', 'error');
                return;
            }

            const status = document.getElementById('edicao-meta-processo-status').value;
            const fase = document.getElementById('edicao-meta-processo-fase').value;
            const ultimaMovimentacao = document.getElementById('edicao-meta-processo-ultima-mov').value;
            const observacoes = document.getElementById('edicao-meta-processo-observacoes').value.trim();

            if (!status || !fase || !ultimaMovimentacao) {
                showNotification('Por favor, preencha todos os campos obrigat√≥rios.', 'warning');
                return;
            }

            const processoAtualizado = {
                ...processoOriginal,
                status,
                fase,
                ultimaMovimentacao,
                observacoes,
                editadoPor: currentUser.nome,
                editadoEm: getDataHoraBrasilia().getTime()
            };

            if (database) {
                database.ref(`processosMetaAcoesPenais/${id}`).update(processoAtualizado)
                    .then(() => {
                        fecharModalEdicaoProcessoMeta();
                        showNotification('Processo atualizado com sucesso!', 'success');
                    })
                    .catch((error) => {
                        log('Erro ao atualizar processo:', error);
                        showNotification('Erro ao atualizar processo', 'error');
                    });
            } else {
                processosMetaAcoesPenais[id] = processoAtualizado;
                fecharModalEdicaoProcessoMeta();
                showNotification('Processo atualizado localmente', 'warning');
                renderMetasAcoesPenais();
            }
        }

        function excluirProcessoMeta(id) {
            const processo = processosMetaAcoesPenais[id];
            if (!processo) {
                showNotification('Processo n√£o encontrado', 'error');
                return;
            }

            const confirmMessage = `Tem certeza que deseja EXCLUIR o processo da meta?\n\nProcesso: ${processo.numeroProcesso}\n\nEsta a√ß√£o n√£o pode ser desfeita!`;

            if (!confirm(confirmMessage)) return;

            if (database) {
                database.ref(`processosMetaAcoesPenais/${id}`).remove()
                    .then(() => {
                        showNotification('Processo removido da meta', 'success');
                    })
                    .catch((error) => {
                        log('Erro ao excluir processo:', error);
                        showNotification('Erro ao excluir processo', 'error');
                    });
            } else {
                delete processosMetaAcoesPenais[id];
                showNotification('Processo removido localmente', 'warning');
                renderMetasAcoesPenais();
            }
        }

        function renderRelatorioMetas() {
            const content = document.getElementById('metas-relatorio-content');
            if (!content) return;

            const processos = Object.values(processosMetaAcoesPenais).filter(p => p);
            const total = processos.length;

            if (total === 0) {
                content.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="bar-chart-3" class="mx-auto h-16 w-16 text-gray-300 mb-4"></i>
                        <p class="text-gray-600">Nenhum processo cadastrado para gerar relat√≥rio.</p>
                    </div>
                `;
                setTimeout(() => criarIcones(), 100);
                return;
            }

            // Estat√≠sticas por status
            const porStatus = {};
            Object.keys(statusProcessoMeta).forEach(key => {
                porStatus[key] = processos.filter(p => p.status === key).length;
            });

            // Estat√≠sticas por fase
            const porFase = {};
            Object.keys(fasesProcessoMeta).forEach(key => {
                porFase[key] = processos.filter(p => p.fase === key).length;
            });

            // Calcular dias at√© o prazo
            const hoje = getDataHoraBrasilia();
            const prazoFinal = new Date(META_ACOES_PENAIS.prazoFinal + 'T23:59:59');
            const diasRestantes = Math.ceil((prazoFinal - hoje) / (1000 * 60 * 60 * 24));

            // Processos parados
            const parados30 = processos.filter(p => {
                if (p.status === 'baixado') return false;
                const ultimaMov = new Date(p.ultimaMovimentacao + 'T00:00:00');
                const dias = Math.floor((hoje - ultimaMov) / (1000 * 60 * 60 * 24));
                return dias > 30;
            }).length;

            const percentualConcluido = total > 0 ? Math.round((porStatus.baixado / total) * 100) : 0;
            const processosRestantes = total - porStatus.baixado;
            const processosPorDia = diasRestantes > 0 ? (processosRestantes / diasRestantes).toFixed(2) : 0;

            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Resumo Executivo -->
                    <div class="bg-gradient-to-r from-amber-50 to-amber-100 border border-amber-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-amber-800 mb-4">Resumo Executivo - ${META_ACOES_PENAIS.nome}</h3>
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="text-center">
                                <div class="text-3xl font-bold text-amber-700">${percentualConcluido}%</div>
                                <div class="text-sm text-amber-600">Meta Conclu√≠da</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-amber-700">${diasRestantes}</div>
                                <div class="text-sm text-amber-600">Dias at√© o prazo</div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-bold text-amber-700">${processosPorDia}</div>
                                <div class="text-sm text-amber-600">Processos/dia necess√°rios</div>
                            </div>
                        </div>
                        ${parados30 > 0 ? `
                            <div class="mt-4 p-3 bg-red-100 border border-red-200 rounded-lg">
                                <span class="text-red-700 font-medium">‚ö†Ô∏è Aten√ß√£o: ${parados30} processo(s) parado(s) h√° mais de 30 dias</span>
                            </div>
                        ` : ''}
                    </div>

                    <!-- Distribui√ß√£o por Status -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Distribui√ß√£o por Status</h3>
                        <div class="space-y-3">
                            ${Object.entries(statusProcessoMeta).map(([key, info]) => {
                                const quantidade = porStatus[key] || 0;
                                const percentual = total > 0 ? Math.round((quantidade / total) * 100) : 0;
                                return `
                                    <div class="flex items-center">
                                        <div class="w-32 text-sm text-gray-700">${info.nome}</div>
                                        <div class="flex-1 mx-4">
                                            <div class="bg-gray-200 rounded-full h-4 overflow-hidden">
                                                <div class="${info.cor} h-full" style="width: ${percentual}%"></div>
                                            </div>
                                        </div>
                                        <div class="w-20 text-right text-sm font-medium">${quantidade} (${percentual}%)</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- Distribui√ß√£o por Fase -->
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Distribui√ß√£o por Fase Processual</h3>
                        <div class="grid md:grid-cols-2 gap-2">
                            ${Object.entries(fasesProcessoMeta)
                                .sort((a, b) => a[1].ordem - b[1].ordem)
                                .map(([key, info]) => {
                                    const quantidade = porFase[key] || 0;
                                    return `
                                        <div class="flex justify-between p-2 bg-gray-50 rounded">
                                            <span class="text-sm text-gray-700">${info.nome}</span>
                                            <span class="text-sm font-medium text-gray-800">${quantidade}</span>
                                        </div>
                                    `;
                                }).join('')}
                        </div>
                    </div>

                    <!-- Data do Relat√≥rio -->
                    <div class="text-center text-xs text-gray-500">
                        Relat√≥rio gerado em ${formatarDataBrasilia(getHojeString())} √†s ${getDataHoraBrasilia().toLocaleTimeString('pt-BR')}
                    </div>
                </div>
            `;

            setTimeout(() => criarIcones(), 100);
        }

        // ==================== METAS - IMPORTA√á√ÉO DE XLSX ====================

        let dadosXLSXImportacao = null;
        let processosParaImportar = [];
        let valoresSituacaoUnicos = [];
        let mapeamentoSituacao = {};

        // Mapeamento padr√£o de situa√ß√£o para status do sistema
        const mapeamentoPadraoSituacao = {
            'em andamento': 'em_andamento',
            'andamento': 'em_andamento',
            'ativo': 'em_andamento',
            'tramitando': 'em_andamento',
            'baixado': 'baixado',
            'baixa': 'baixado',
            'arquivado': 'arquivado',
            'arquivo': 'arquivado',
            'suspenso': 'suspenso',
            'suspens√£o': 'suspenso',
            'sobrestado': 'sobrestado',
            'sobrestamento': 'sobrestado'
        };

        function carregarArquivoXLSX(event) {
            const arquivo = event.target.files[0];
            if (!arquivo) return;

            document.getElementById('meta-arquivo-nome').textContent = arquivo.name;

            // Resetar estados anteriores
            document.getElementById('meta-selecao-coluna').classList.add('hidden');
            document.getElementById('meta-mapeamento-situacao').classList.add('hidden');
            document.getElementById('meta-preview-container').classList.add('hidden');
            document.getElementById('meta-opcoes-importacao').classList.add('hidden');
            document.getElementById('meta-botao-importar').classList.add('hidden');
            document.getElementById('meta-resultado-importacao').classList.add('hidden');
            document.getElementById('meta-progresso-importacao').classList.add('hidden');

            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // Pegar a primeira planilha
                    const primeiraPlanilha = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[primeiraPlanilha];

                    // Converter para JSON
                    dadosXLSXImportacao = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                    if (dadosXLSXImportacao.length === 0) {
                        showNotification('Arquivo vazio ou formato inv√°lido', 'error');
                        return;
                    }

                    // Detectar colunas (primeira linha como cabe√ßalho)
                    const primeiraLinha = dadosXLSXImportacao[0];

                    // Preencher os 3 dropdowns de colunas
                    const selectProcesso = document.getElementById('meta-coluna-processo');
                    const selectClasse = document.getElementById('meta-coluna-classe');
                    const selectSituacao = document.getElementById('meta-coluna-situacao');

                    selectProcesso.innerHTML = '<option value="">Selecione...</option>';
                    selectClasse.innerHTML = '<option value="">N√£o importar</option>';
                    selectSituacao.innerHTML = '<option value="">N√£o importar</option>';

                    primeiraLinha.forEach((coluna, index) => {
                        const nomeColuna = coluna ? String(coluna).trim() : `Coluna ${index + 1}`;

                        [selectProcesso, selectClasse, selectSituacao].forEach(select => {
                            const option = document.createElement('option');
                            option.value = index;
                            option.textContent = nomeColuna;
                            select.appendChild(option);
                        });
                    });

                    // Tentar detectar automaticamente as colunas
                    detectarColunasAutomaticamente(primeiraLinha);

                    document.getElementById('meta-selecao-coluna').classList.remove('hidden');

                    showNotification(`Arquivo carregado: ${dadosXLSXImportacao.length - 1} processos encontrados`, 'success');

                } catch (error) {
                    log('Erro ao ler arquivo XLSX:', error);
                    showNotification('Erro ao ler o arquivo. Verifique se √© um arquivo Excel v√°lido.', 'error');
                }
            };

            reader.onerror = function() {
                showNotification('Erro ao ler o arquivo', 'error');
            };

            reader.readAsArrayBuffer(arquivo);
        }

        function detectarColunasAutomaticamente(linha) {
            const selectProcesso = document.getElementById('meta-coluna-processo');
            const selectClasse = document.getElementById('meta-coluna-classe');
            const selectSituacao = document.getElementById('meta-coluna-situacao');

            const termosProcesso = ['processo', 'n√∫mero', 'numero', 'n¬∫', 'n¬∞', 'proc', 'npu'];
            const termosClasse = ['classe', 'tipo', 'natureza', 'class'];
            const termosSituacao = ['situa√ß√£o', 'situacao', 'status', 'estado', 'sit'];

            for (let i = 0; i < linha.length; i++) {
                const valor = String(linha[i] || '').toLowerCase().trim();

                if (termosProcesso.some(termo => valor.includes(termo))) {
                    selectProcesso.value = i;
                }
                if (termosClasse.some(termo => valor.includes(termo))) {
                    selectClasse.value = i;
                }
                if (termosSituacao.some(termo => valor.includes(termo))) {
                    selectSituacao.value = i;
                }
            }

            // Se detectou coluna de processo, atualizar preview
            if (selectProcesso.value !== '') {
                atualizarPreviewImportacao();
            }
        }

        function atualizarPreviewImportacao() {
            const colunaProcesso = document.getElementById('meta-coluna-processo').value;
            const colunaClasse = document.getElementById('meta-coluna-classe').value;
            const colunaSituacao = document.getElementById('meta-coluna-situacao').value;

            if (colunaProcesso === '') {
                document.getElementById('meta-mapeamento-situacao').classList.add('hidden');
                document.getElementById('meta-preview-container').classList.add('hidden');
                document.getElementById('meta-opcoes-importacao').classList.add('hidden');
                document.getElementById('meta-botao-importar').classList.add('hidden');
                return;
            }

            const indexProcesso = parseInt(colunaProcesso);
            const indexClasse = colunaClasse !== '' ? parseInt(colunaClasse) : -1;
            const indexSituacao = colunaSituacao !== '' ? parseInt(colunaSituacao) : -1;

            processosParaImportar = [];
            valoresSituacaoUnicos = [];
            const situacoesEncontradas = new Set();

            // Extrair processos (pular primeira linha = cabe√ßalho)
            for (let i = 1; i < dadosXLSXImportacao.length; i++) {
                const linha = dadosXLSXImportacao[i];
                const valorProcesso = String(linha[indexProcesso] || '').trim();

                if (valorProcesso) {
                    const processoNormalizado = normalizarNumeroProcesso(valorProcesso);
                    if (processoNormalizado && validarNumeroProcesso(processoNormalizado)) {
                        const jaExiste = Object.values(processosMetaAcoesPenais).some(p =>
                            p && p.numeroProcesso === processoNormalizado
                        );

                        const classe = indexClasse >= 0 ? String(linha[indexClasse] || '').trim() : '';
                        const situacao = indexSituacao >= 0 ? String(linha[indexSituacao] || '').trim() : '';

                        if (situacao && !situacoesEncontradas.has(situacao.toLowerCase())) {
                            situacoesEncontradas.add(situacao.toLowerCase());
                            valoresSituacaoUnicos.push(situacao);
                        }

                        processosParaImportar.push({
                            numero: processoNormalizado,
                            original: valorProcesso,
                            classe: classe,
                            situacao: situacao,
                            jaExiste: jaExiste
                        });
                    }
                }
            }

            // Mostrar mapeamento de situa√ß√£o se coluna foi selecionada
            if (indexSituacao >= 0 && valoresSituacaoUnicos.length > 0) {
                renderMapeamentoSituacao();
                document.getElementById('meta-mapeamento-situacao').classList.remove('hidden');
            } else {
                document.getElementById('meta-mapeamento-situacao').classList.add('hidden');
            }

            // Mostrar preview
            const listaPreview = document.getElementById('meta-preview-lista');
            const novos = processosParaImportar.filter(p => !p.jaExiste);
            const existentes = processosParaImportar.filter(p => p.jaExiste);

            if (processosParaImportar.length === 0) {
                listaPreview.innerHTML = '<div class="text-gray-500">Nenhum n√∫mero de processo v√°lido encontrado.</div>';
                document.getElementById('meta-preview-stats').innerHTML = '';
                document.getElementById('meta-opcoes-importacao').classList.add('hidden');
                document.getElementById('meta-botao-importar').classList.add('hidden');
            } else {
                // Mostrar at√© 30 processos no preview com todas as colunas
                const processosPreview = processosParaImportar.slice(0, 30);

                listaPreview.innerHTML = `
                    <table class="w-full text-xs">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="text-left p-1">Processo</th>
                                ${indexClasse >= 0 ? '<th class="text-left p-1">Classe</th>' : ''}
                                ${indexSituacao >= 0 ? '<th class="text-left p-1">Situa√ß√£o</th>' : ''}
                                <th class="text-right p-1">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${processosPreview.map(p => `
                                <tr class="border-b border-gray-100 ${p.jaExiste ? 'text-gray-400' : ''}">
                                    <td class="p-1 ${p.jaExiste ? 'line-through' : ''}">${escapeHtml(p.numero)}</td>
                                    ${indexClasse >= 0 ? `<td class="p-1">${escapeHtml(p.classe)}</td>` : ''}
                                    ${indexSituacao >= 0 ? `<td class="p-1">${escapeHtml(p.situacao)}</td>` : ''}
                                    <td class="p-1 text-right">
                                        ${p.jaExiste
                                            ? '<span class="bg-yellow-100 text-yellow-700 px-1 rounded">Existente</span>'
                                            : '<span class="bg-green-100 text-green-700 px-1 rounded">Novo</span>'}
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                if (processosParaImportar.length > 30) {
                    listaPreview.innerHTML += `<div class="text-gray-500 text-center py-2">... e mais ${processosParaImportar.length - 30} processos</div>`;
                }

                document.getElementById('meta-preview-stats').innerHTML = `
                    <span class="text-green-600 font-medium">${novos.length} novos</span> ‚Ä¢
                    <span class="text-yellow-600">${existentes.length} j√° cadastrados</span> ‚Ä¢
                    <span class="text-gray-600">${processosParaImportar.length} total</span>
                `;

                if (novos.length > 0) {
                    document.getElementById('meta-opcoes-importacao').classList.remove('hidden');
                    document.getElementById('meta-botao-importar').classList.remove('hidden');
                } else {
                    document.getElementById('meta-opcoes-importacao').classList.add('hidden');
                    document.getElementById('meta-botao-importar').classList.add('hidden');
                    showNotification('Todos os processos j√° est√£o cadastrados na meta.', 'warning');
                }
            }

            document.getElementById('meta-preview-container').classList.remove('hidden');
        }

        function renderMapeamentoSituacao() {
            const container = document.getElementById('meta-mapeamento-valores');

            container.innerHTML = valoresSituacaoUnicos.map(situacao => {
                const situacaoLower = situacao.toLowerCase();
                const statusSugerido = mapeamentoPadraoSituacao[situacaoLower] || 'em_andamento';

                return `
                    <div class="flex items-center gap-2 bg-white p-2 rounded border">
                        <span class="flex-1 text-sm font-medium text-gray-700">"${escapeHtml(situacao)}"</span>
                        <i data-lucide="arrow-right" class="h-4 w-4 text-gray-400"></i>
                        <select class="mapeamento-situacao-select border border-gray-300 rounded px-2 py-1 text-sm" data-situacao="${escapeAttr(situacao)}">
                            <option value="em_andamento" ${statusSugerido === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                            <option value="baixado" ${statusSugerido === 'baixado' ? 'selected' : ''}>Baixado</option>
                            <option value="suspenso" ${statusSugerido === 'suspenso' ? 'selected' : ''}>Suspenso</option>
                            <option value="sobrestado" ${statusSugerido === 'sobrestado' ? 'selected' : ''}>Sobrestado</option>
                            <option value="arquivado" ${statusSugerido === 'arquivado' ? 'selected' : ''}>Arquivado</option>
                        </select>
                    </div>
                `;
            }).join('');

            setTimeout(() => criarIcones(), 100);
        }

        function obterMapeamentoSituacao() {
            const mapeamento = {};
            document.querySelectorAll('.mapeamento-situacao-select').forEach(select => {
                const situacao = select.getAttribute('data-situacao');
                mapeamento[situacao.toLowerCase()] = select.value;
            });
            return mapeamento;
        }

        function normalizarNumeroProcesso(valor) {
            let normalizado = valor.replace(/\s+/g, '').trim();

            if (/^\d+$/.test(normalizado) && normalizado.length >= 15) {
                const match = normalizado.match(/^(\d{7})(\d{2})(\d{4})(\d)(\d{2})(\d{4})$/);
                if (match) {
                    return `${match[1]}-${match[2]}.${match[3]}.${match[4]}.${match[5]}.${match[6]}`;
                }
            }

            return normalizado;
        }

        async function executarImportacaoMeta() {
            const novosProcessos = processosParaImportar.filter(p => !p.jaExiste);

            if (novosProcessos.length === 0) {
                showNotification('N√£o h√° processos novos para importar.', 'warning');
                return;
            }

            const faseInicial = document.getElementById('meta-import-fase').value;
            const colunaSituacao = document.getElementById('meta-coluna-situacao').value;
            const mapeamento = colunaSituacao !== '' ? obterMapeamentoSituacao() : {};
            const dataHoje = getHojeString();

            // Mostrar progresso
            document.getElementById('meta-botao-importar').classList.add('hidden');
            document.getElementById('meta-progresso-importacao').classList.remove('hidden');

            let importados = 0;
            let erros = 0;
            const total = novosProcessos.length;

            for (let i = 0; i < novosProcessos.length; i++) {
                const processo = novosProcessos[i];

                // Determinar o status baseado no mapeamento da situa√ß√£o
                let statusProcesso = 'em_andamento'; // padr√£o
                if (processo.situacao && colunaSituacao !== '') {
                    const situacaoLower = processo.situacao.toLowerCase().trim();
                    statusProcesso = mapeamento[situacaoLower] || 'em_andamento';
                }

                const novoProcesso = {
                    numeroProcesso: processo.numero,
                    classe: processo.classe || '',
                    situacaoOriginal: processo.situacao || '',
                    status: statusProcesso,
                    fase: faseInicial,
                    ultimaMovimentacao: dataHoje,
                    observacoes: `Importado em lote${processo.classe ? ' | Classe: ' + processo.classe : ''}${processo.situacao ? ' | Situa√ß√£o: ' + processo.situacao : ''}`,
                    dataCadastro: dataHoje,
                    criadoPor: currentUser.nome,
                    criadoEm: getDataHoraBrasilia().getTime(),
                    importado: true
                };

                try {
                    if (database) {
                        await database.ref('processosMetaAcoesPenais').push(novoProcesso);
                    } else {
                        const id = 'local_' + Date.now() + '_' + i;
                        processosMetaAcoesPenais[id] = novoProcesso;
                    }
                    importados++;
                } catch (error) {
                    log(`Erro ao importar processo ${processo.numero}:`, error);
                    erros++;
                }

                // Atualizar progresso
                const percentual = Math.round(((i + 1) / total) * 100);
                document.getElementById('meta-progresso-barra').style.width = percentual + '%';
                document.getElementById('meta-progresso-texto').textContent = `${i + 1} de ${total}`;

                // Pequena pausa para n√£o sobrecarregar o Firebase
                if (i < novosProcessos.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
            }

            // Esconder progresso e mostrar resultado
            document.getElementById('meta-progresso-importacao').classList.add('hidden');

            const resultadoDiv = document.getElementById('meta-resultado-importacao');
            resultadoDiv.innerHTML = `
                <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                    <h4 class="font-medium text-green-800 mb-2">‚úÖ Importa√ß√£o Conclu√≠da!</h4>
                    <div class="text-sm text-green-700">
                        <p><strong>${importados}</strong> processo(s) importado(s) com sucesso.</p>
                        ${erros > 0 ? `<p class="text-red-600"><strong>${erros}</strong> erro(s) durante a importa√ß√£o.</p>` : ''}
                    </div>
                    <button onclick="mudarAbaMetas('lista')" class="mt-3 bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors text-sm">
                        <i data-lucide="list" class="h-4 w-4 mr-1 inline"></i>
                        Ver Lista de Processos
                    </button>
                </div>
            `;
            resultadoDiv.classList.remove('hidden');
            setTimeout(() => criarIcones(), 100);

            showNotification(`${importados} processo(s) importado(s) com sucesso!`, 'success');

            // Limpar dados de importa√ß√£o
            dadosXLSXImportacao = null;
            processosParaImportar = [];
            document.getElementById('meta-arquivo-xlsx').value = '';
            document.getElementById('meta-arquivo-nome').textContent = 'Nenhum arquivo selecionado';

            // Atualizar dashboard
            renderMetasDashboard();
        }

        // ==================== NOTIFICA√á√ïES DO JUIZ ====================

        function criarNotificacaoDespachoVirtual(pedido) {
            if (!database) {
                log('Firebase n√£o dispon√≠vel, notifica√ß√£o n√£o criada');
                return;
            }

            const notificacao = {
                tipo: 'despacho_virtual',
                titulo: 'Solicita√ß√£o de Despacho Virtual',
                mensagem: `${pedido.assessorNome} solicitou despacho virtual para o processo ${pedido.numeroProcesso}`,
                pedidoId: pedido.id || null,
                numeroProcesso: pedido.numeroProcesso,
                categoria: pedido.categoria,
                assessorId: pedido.assessorId,
                assessorNome: pedido.assessorNome,
                resumoPedido: pedido.resumo,
                lida: false,
                criadaEm: getDataHoraBrasilia().getTime(),
                data: getHojeString()
            };

            database.ref('notificacoesJuiz').push(notificacao)
                .then(() => {
                    log('Notifica√ß√£o de despacho virtual criada', pedido.numeroProcesso);
                })
                .catch((error) => {
                    log('Erro ao criar notifica√ß√£o:', error);
                });
        }

        function atualizarBadgeNotificacoes() {
            const naoLidas = Object.values(notificacoesJuiz).filter(n => n && !n.lida).length;
            const badge = document.getElementById('notificacoes-badge');
            const container = document.getElementById('notificacoes-container');

            if (container && currentUser?.isJuiz) {
                container.classList.remove('hidden');
            }

            if (badge) {
                if (naoLidas > 0) {
                    badge.textContent = naoLidas > 99 ? '99+' : naoLidas;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
            }

            // Atualizar contador no modal se estiver aberto
            const modalCount = document.getElementById('modal-notificacoes-count');
            if (modalCount) {
                modalCount.textContent = naoLidas;
            }
        }

        function abrirModalNotificacoes() {
            if (!currentUser?.isJuiz) {
                showNotification('Apenas o juiz pode acessar as notifica√ß√µes', 'warning');
                return;
            }

            renderListaNotificacoes();
            document.getElementById('modal-notificacoes').classList.remove('hidden');
            setTimeout(() => criarIcones(), 100);
        }

        function fecharModalNotificacoes() {
            document.getElementById('modal-notificacoes').classList.add('hidden');
        }

        function renderListaNotificacoes() {
            const lista = document.getElementById('notificacoes-lista');
            if (!lista) return;

            const notificacoesArray = Object.entries(notificacoesJuiz)
                .filter(([key, n]) => n)
                .map(([key, n]) => ({ ...n, id: key }))
                .sort((a, b) => (b.criadaEm || 0) - (a.criadaEm || 0));

            if (notificacoesArray.length === 0) {
                lista.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="bell-off" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                        <p>Nenhuma notifica√ß√£o</p>
                    </div>
                `;
                setTimeout(() => criarIcones(), 100);
                return;
            }

            lista.innerHTML = notificacoesArray.map(notif => {
                const dataFormatada = formatarDataBrasilia(notif.data);
                const horaFormatada = notif.criadaEm ? new Date(notif.criadaEm).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' }) : '';
                const categoria = categoriasBalcao[notif.categoria] || { nome: 'Outros', cor: 'bg-gray-500' };
                const notifIdSafe = escapeAttr(notif.id);

                return `
                    <div class="border ${notif.lida ? 'border-gray-200 bg-gray-50' : 'border-indigo-200 bg-indigo-50'} rounded-lg p-4 transition-all">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    ${!notif.lida ? '<span class="w-2 h-2 bg-indigo-500 rounded-full"></span>' : ''}
                                    <span class="font-semibold text-gray-800">${escapeHtml(notif.titulo)}</span>
                                    <span class="px-2 py-1 text-xs rounded-full ${categoria.cor} text-white">${escapeHtml(categoria.nome)}</span>
                                </div>
                                <p class="text-sm text-gray-700 mb-2">${escapeHtml(notif.mensagem)}</p>
                                <div class="text-xs text-gray-500 space-y-1">
                                    <div><strong>Processo:</strong> ${escapeHtml(notif.numeroProcesso)}</div>
                                    ${notif.resumoPedido ? `<div><strong>Resumo:</strong> ${escapeHtml(notif.resumoPedido)}</div>` : ''}
                                    <div><strong>Data:</strong> ${dataFormatada} √†s ${horaFormatada}</div>
                                </div>
                            </div>
                            <div class="flex flex-col gap-2 ml-4">
                                ${!notif.lida ? `
                                    <button onclick="marcarNotificacaoComoLida('${notifIdSafe}')" class="text-xs bg-indigo-500 text-white px-3 py-1 rounded hover:bg-indigo-600 transition-colors">
                                        Marcar como lida
                                    </button>
                                ` : ''}
                                <button onclick="excluirNotificacao('${notifIdSafe}')" class="text-xs bg-gray-400 text-white px-3 py-1 rounded hover:bg-gray-500 transition-colors">
                                    Excluir
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            setTimeout(() => criarIcones(), 100);
        }

        function marcarNotificacaoComoLida(id) {
            if (!database) {
                notificacoesJuiz[id] = { ...notificacoesJuiz[id], lida: true };
                renderListaNotificacoes();
                atualizarBadgeNotificacoes();
                return;
            }

            database.ref(`notificacoesJuiz/${id}`).update({ lida: true })
                .then(() => {
                    log(`Notifica√ß√£o ${id} marcada como lida`);
                })
                .catch((error) => {
                    log('Erro ao marcar notifica√ß√£o como lida:', error);
                });
        }

        function marcarTodasComoLidas() {
            const naoLidas = Object.entries(notificacoesJuiz)
                .filter(([key, n]) => n && !n.lida);

            if (naoLidas.length === 0) {
                showNotification('N√£o h√° notifica√ß√µes pendentes', 'info');
                return;
            }

            if (database) {
                const updates = {};
                naoLidas.forEach(([key, n]) => {
                    updates[`notificacoesJuiz/${key}/lida`] = true;
                });

                database.ref().update(updates)
                    .then(() => {
                        showNotification(`${naoLidas.length} notifica√ß√£o(√µes) marcada(s) como lida(s)`, 'success');
                        log(`${naoLidas.length} notifica√ß√µes marcadas como lidas`);
                    })
                    .catch((error) => {
                        log('Erro ao marcar todas como lidas:', error);
                        showNotification('Erro ao marcar notifica√ß√µes', 'error');
                    });
            } else {
                naoLidas.forEach(([key, n]) => {
                    notificacoesJuiz[key] = { ...n, lida: true };
                });
                renderListaNotificacoes();
                atualizarBadgeNotificacoes();
                showNotification(`${naoLidas.length} notifica√ß√£o(√µes) marcada(s) como lida(s)`, 'success');
            }
        }

        function excluirNotificacao(id) {
            if (!confirm('Deseja excluir esta notifica√ß√£o?')) return;

            if (database) {
                database.ref(`notificacoesJuiz/${id}`).remove()
                    .then(() => {
                        showNotification('Notifica√ß√£o exclu√≠da', 'success');
                        log(`Notifica√ß√£o ${id} exclu√≠da`);
                    })
                    .catch((error) => {
                        log('Erro ao excluir notifica√ß√£o:', error);
                        showNotification('Erro ao excluir notifica√ß√£o', 'error');
                    });
            } else {
                delete notificacoesJuiz[id];
                renderListaNotificacoes();
                atualizarBadgeNotificacoes();
                showNotification('Notifica√ß√£o exclu√≠da', 'success');
            }
        }

        // ==================== FIREBASE ====================

        function setupFirebaseListeners() {
            try {
                database.ref('minutas').on('value', (snapshot) => {
                    minutas = snapshot.val() || {};
                    log(`Minutas carregadas: ${Object.keys(minutas).length}`);
                    
                    // Atualizar todas as views quando os dados mudarem
                    if (currentView === 'dashboard') renderDashboard();
                    if (currentView === 'historico') renderHistorico();
                    if (currentView === 'calendario') renderCalendario();
                });

                database.ref('assessores').on('value', (snapshot) => {
                    const assessoresFirebase = snapshot.val();
                    if (assessoresFirebase) {
                        assessores = { ...assessores, ...assessoresFirebase };
                        log('Assessores atualizados');
                        
                        // Atualizar dashboard se necess√°rio
                        if (currentView === 'dashboard') renderDashboard();
                    }
                });

                database.ref('assessores').once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        database.ref('assessores').set(assessores);
                        log('Dados iniciais dos assessores criados');
                    }
                });

                // Listener para pedidos do Balc√£o Virtual
                database.ref('pedidosBalcao').on('value', (snapshot) => {
                    pedidosBalcao = snapshot.val() || {};
                    log(`Pedidos Balc√£o carregados: ${Object.keys(pedidosBalcao).length}`);

                    if (currentView === 'balcao') renderBalcaoVirtual();
                });

                // Listener para notifica√ß√µes do juiz
                database.ref('notificacoesJuiz').on('value', (snapshot) => {
                    notificacoesJuiz = snapshot.val() || {};
                    log(`Notifica√ß√µes carregadas: ${Object.keys(notificacoesJuiz).length}`);

                    // Atualizar badge de notifica√ß√µes
                    atualizarBadgeNotificacoes();

                    // Atualizar lista se o modal estiver aberto
                    const modalNotificacoes = document.getElementById('modal-notificacoes');
                    if (modalNotificacoes && !modalNotificacoes.classList.contains('hidden')) {
                        renderListaNotificacoes();
                    }
                });

                // Listener para processos da Meta de A√ß√µes Penais
                database.ref('processosMetaAcoesPenais').on('value', (snapshot) => {
                    processosMetaAcoesPenais = snapshot.val() || {};
                    log(`Processos Meta A√ß√µes Penais carregados: ${Object.keys(processosMetaAcoesPenais).length}`);

                    if (currentView === 'metas') renderMetasAcoesPenais();
                });

                database.ref('.info/connected').on('value', (snapshot) => {
                    const connected = snapshot.val();
                    const statusDiv = document.getElementById('connection-status');
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = connected ? 
                            `<div class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center">
                                <div class="w-2 h-2 bg-white rounded-full mr-2 pulse"></div>
                                Online
                            </div>` :
                            `<div class="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-medium">
                                Offline
                            </div>`;
                    }
                });

                log('Firebase configurado com sucesso');
                
            } catch (error) {
                log('Erro no Firebase - modo local ativado', error);
                
                const statusDiv = document.getElementById('connection-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium">
                            Modo Local
                        </div>
                    `;
                }
                
                // Tentar carregar dados do localStorage antes de usar demo data
                if (Object.keys(minutas).length === 0) {
                    carregarDadosLocais();
                }
            }
        }

        // Fun√ß√£o para carregar dados do localStorage
        function carregarDadosLocais() {
            try {
                const dadosSalvos = localStorage.getItem('minutas_backup');
                if (dadosSalvos) {
                    const dados = JSON.parse(dadosSalvos);
                    if (dados && Object.keys(dados).length > 0) {
                        minutas = dados;
                        log('Dados carregados do localStorage:', Object.keys(dados).length + ' minutas');
                        showNotification('Dados locais restaurados', 'info');
                        return;
                    }
                }
            } catch (error) {
                log('Erro ao carregar dados do localStorage:', error);
            }

            // Somente inicializa demo data se n√£o houver dados salvos
            inicializarDadosDemo();
        }

        // Fun√ß√£o para salvar dados no localStorage (backup)
        function salvarDadosLocalmente() {
            try {
                localStorage.setItem('minutas_backup', JSON.stringify(minutas));
                log('Dados salvos no localStorage');
            } catch (error) {
                log('Erro ao salvar no localStorage:', error);
            }
        }

        // Fun√ß√£o para inicializar dados de demonstra√ß√£o
        function inicializarDadosDemo() {
            const hoje = getHojeString();
            const ontem = new Date();
            ontem.setDate(ontem.getDate() - 1);
            const ontemStr = ontem.toISOString().split('T')[0];

            // Dados de exemplo para demonstra√ß√£o
            minutas = {
                'demo_1': {
                    assessorId: 'gilbert',
                    assessorNome: 'Gilbert Juliano',
                    numeroProcesso: '1234567-89.2024.8.12.3456',
                    tipoMinuta: 'Decis√£o',
                    categorias: ['meta1'],
                    observacoes: 'Minuta de exemplo - Gilbert',
                    status: 'pendente',
                    data: hoje,
                    timestamp: '09:30:00',
                    createdAt: Date.now() - 1000
                },
                'demo_2': {
                    assessorId: 'laise',
                    assessorNome: 'La√≠se Vital',
                    numeroProcesso: '7654321-10.2024.8.12.7890',
                    tipoMinuta: 'Despacho',
                    categorias: ['meta1', 'sem_movimento'],
                    observacoes: 'Minuta de exemplo - La√≠se',
                    status: 'assinada',
                    data: hoje,
                    timestamp: '10:15:00',
                    createdAt: Date.now() - 500
                },
                'demo_3': {
                    assessorId: 'gilbert',
                    assessorNome: 'Gilbert Juliano',
                    numeroProcesso: '9876543-21.2024.8.12.1357',
                    tipoMinuta: 'Senten√ßa',
                    categorias: ['meta2'],
                    observacoes: 'Senten√ßa da Meta 2 CNJ',
                    status: 'pendente',
                    data: ontemStr,
                    timestamp: '14:20:00',
                    createdAt: Date.now() - 2000
                },
                'demo_4': {
                    assessorId: 'laise',
                    assessorNome: 'La√≠se Vital',
                    numeroProcesso: '1111111-11.2024.8.12.1111',
                    tipoMinuta: 'Senten√ßa',
                    categorias: ['meta2'],
                    observacoes: 'Senten√ßa da Meta 2 CNJ - La√≠se',
                    status: 'assinada',
                    data: ontemStr,
                    timestamp: '16:30:00',
                    createdAt: Date.now() - 1500
                }
            };
            
            log('Dados de demonstra√ß√£o inicializados');
            
            // Atualizar views ap√≥s carregar dados demo
            if (currentView === 'dashboard') renderDashboard();
        }

        // ==================== REGISTRO DE MINUTAS ====================
        
        // Fun√ß√£o para validar formato do n√∫mero do processo (padr√£o CNJ)
        function validarNumeroProcesso(numero) {
            // Formato CNJ: NNNNNNN-DD.AAAA.J.TR.OOOO
            // Tamb√©m aceita formatos mais flex√≠veis com n√∫meros e pontos/tra√ßos
            const regexCNJ = /^\d{7}-\d{2}\.\d{4}\.\d{1,2}\.\d{2}\.\d{4}$/;
            const regexFlexivel = /^[\d.\-\/]+$/;

            if (regexCNJ.test(numero)) return true;
            if (regexFlexivel.test(numero) && numero.length >= 10) return true;

            return false;
        }

        function registrarMinuta() {
            const numeroProcesso = document.getElementById('numero-processo').value.trim();
            const tipoMinuta = document.getElementById('tipo-minuta').value;
            const observacoes = document.getElementById('observacoes-minuta').value.trim();
            const substituicao = document.getElementById('substituicao-checkbox').checked;

            const categoriasCheckboxes = document.querySelectorAll('input[name="categorias"]:checked');
            const categoriasSelecionadas = Array.from(categoriasCheckboxes).map(cb => cb.value);

            // Valida√ß√£o de campos obrigat√≥rios
            if (!numeroProcesso || !tipoMinuta || categoriasSelecionadas.length === 0) {
                showNotification('Por favor, preencha todos os campos obrigat√≥rios e selecione pelo menos uma categoria.', 'warning');
                return;
            }

            // Valida√ß√£o do formato do n√∫mero do processo
            if (!validarNumeroProcesso(numeroProcesso)) {
                showNotification('N√∫mero do processo inv√°lido. Use o formato CNJ (ex: 1234567-89.2024.8.12.0001) ou similar.', 'error');
                return;
            }

            // Valida√ß√£o de tamanho m√°ximo das observa√ß√µes
            if (observacoes.length > 500) {
                showNotification('As observa√ß√µes devem ter no m√°ximo 500 caracteres.', 'error');
                return;
            }

            if (categoriasSelecionadas.includes('meta2') && tipoMinuta !== 'Senten√ßa') {
                showNotification('Meta 2 CNJ aceita apenas minutas de Senten√ßa.', 'error');
                return;
            }

            if (categoriasSelecionadas.includes('meta10') && currentUser.assessorId !== 'gilbert') {
                showNotification('Apenas Gilbert pode registrar minutas da Meta 10 CNJ.', 'error');
                return;
            }

            if (categoriasSelecionadas.includes('seeu') && currentUser.assessorId !== 'laise') {
                showNotification('Apenas La√≠se pode registrar minutas do SEEU.', 'error');
                return;
            }

            const novaMinuta = {
                assessorId: currentUser.assessorId,
                assessorNome: currentUser.nome,
                numeroProcesso,
                tipoMinuta,
                categorias: categoriasSelecionadas,
                observacoes,
                substituicao,
                status: 'pendente',
                data: getHojeString(),
                timestamp: getDataHoraBrasilia().toLocaleTimeString('pt-BR'),
                createdAt: getDataHoraBrasilia().getTime()
            };

            try {
                if (database) {
                    database.ref('minutas').push({
                        ...novaMinuta,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        limparFormularioRegistro();
                        
                        let mensagem = 'Minuta registrada com sucesso!';
                        let tipo = 'success';
                        
                        if (categoriasSelecionadas.includes('meta2')) {
                            mensagem = 'üéØ Senten√ßa da Meta 2 CNJ registrada! Meta semanal cumprida!';
                        } else if (categoriasSelecionadas.includes('meta10')) {
                            mensagem = '‚ú® Minuta da Meta 10 CNJ registrada! Meta semanal cumprida!';
                        } else if (categoriasSelecionadas.includes('seeu')) {
                            mensagem = 'üõ°Ô∏è Acesso ao SEEU registrado! Controle de 10 dias cumprido (n√£o conta para meta di√°ria).';
                        } else if (categoriasSelecionadas.includes('alem_meta')) {
                            mensagem = '‚ûï Minuta "Al√©m da Meta" registrada! Produtividade adicional contabilizada (n√£o conta para meta di√°ria).';
                        }
                        
                        if (categoriasSelecionadas.length > 1) {
                            mensagem += ` Aplicada a ${categoriasSelecionadas.length} categorias.`;
                        }
                        
                        showNotification(mensagem, tipo);
                        showView('dashboard');
                        log('Minuta registrada no Firebase', numeroProcesso + ' - Categorias: ' + categoriasSelecionadas.join(', '));
                    }).catch((error) => {
                        log('Erro ao salvar no Firebase, salvando localmente:', error);
                        salvarMinutaLocal(novaMinuta);
                    });
                } else {
                    salvarMinutaLocal(novaMinuta);
                }

            } catch (error) {
                log('Erro ao registrar minuta:', error);
                salvarMinutaLocal(novaMinuta);
            }
        }

        function salvarMinutaLocal(minuta) {
            const id = 'local_' + getDataHoraBrasilia().getTime();
            minuta.id = id;
            minutas[id] = minuta;

            // Salvar backup no localStorage
            salvarDadosLocalmente();

            limparFormularioRegistro();
            showNotification('Minuta registrada localmente!', 'warning');
            showView('dashboard');
            log('Minuta salva localmente', minuta.numeroProcesso);
        }

        function limparFormularioRegistro() {
            document.getElementById('numero-processo').value = '';
            document.getElementById('tipo-minuta').value = '';
            document.getElementById('observacoes-minuta').value = '';
            document.getElementById('substituicao-checkbox').checked = false;

            const categoriasCheckboxes = document.querySelectorAll('input[name="categorias"]');
            categoriasCheckboxes.forEach(cb => cb.checked = false);

            validarTipoMinuta();
        }

        // ==================== FUN√á√ïES DE HIST√ìRICO ====================
        // (setupHistoricoFilters e limparFiltros definidas acima na se√ß√£o de navega√ß√£o)

        function renderDashboard() {
            try {
                const dashboard = document.getElementById('dashboard-view');
                if (!dashboard) return;

                const hoje = getDataHoraBrasilia();
                let content = '';

                // Alertas de corre√ß√£o para assessores
                if (!currentUser.isJuiz) {
                    const correcoesPendentes = Object.values(minutas).filter(m => {
                        if (!m || m.status !== 'correcao') return false;
                        
                        return m.assessorId === currentUser.assessorId || 
                               (currentUser.assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                               (currentUser.assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('La√≠se'))));
                    });

                    if (correcoesPendentes.length > 0) {
                        content += `
                            <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-6 mb-6 shadow-lg animate-pulse">
                                <div class="flex items-center">
                                    <i data-lucide="alert-triangle" class="h-8 w-8 text-red-600 mr-3"></i>
                                    <div>
                                        <h2 class="text-xl font-bold text-red-800">
                                            üö® ATEN√á√ÉO: ${correcoesPendentes.length} Corre√ß${correcoesPendentes.length === 1 ? '√£o Pendente' : '√µes Pendentes'}!
                                        </h2>
                                        <p class="text-red-700 font-medium">
                                            O juiz solicitou corre√ß√µes em suas minutas. Veja no hist√≥rico as instru√ß√µes completas.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                // Verificar se √© dia √∫til
                if (!isDiaUtil(hoje)) {
                    content += `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center mb-6">
                            <i data-lucide="calendar" class="mx-auto h-12 w-12 text-yellow-500 mb-4"></i>
                            <h3 class="text-lg font-semibold text-yellow-800 mb-2">Fim de Semana</h3>
                            <p class="text-yellow-700">Hoje n√£o √© um dia √∫til. O controle de produtividade ser√° retomado na pr√≥xima segunda-feira.</p>
                        </div>
                    `;
                }

                // Resumo geral do dia
                const totalMinutasHoje = Object.values(minutas).filter(m => m?.data === getHojeString() && m.status !== 'excluida').length;
                const minutasParaMeta = Object.values(minutas).filter(m => {
                    if (m?.data !== getHojeString() || m.status === 'excluida') return false;
                    const categorias = normalizarCategorias(m);
                    return categorias.some(cat => cat !== 'alem_meta' && cat !== 'seeu');
                }).length;
                
                const minutasAlemMeta = Object.values(minutas).filter(m => {
                    if (m?.data !== getHojeString() || m.status === 'excluida') return false;
                    const categorias = normalizarCategorias(m);
                    return categorias.includes('alem_meta');
                }).length;
                
                const minutasSEEU = Object.values(minutas).filter(m => {
                    if (m?.data !== getHojeString() || m.status === 'excluida') return false;
                    const categorias = normalizarCategorias(m);
                    return categorias.includes('seeu');
                }).length;
                
                const metaTotal = 20;

                // Card resumo do dia
                content += `
                    <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg p-6 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 class="text-2xl font-bold mb-2">Produtividade do Dia</h2>
                                <p class="text-blue-100">
                                    ${new Date().toLocaleDateString('pt-BR', {
                                        timeZone: 'America/Sao_Paulo',
                                        weekday: 'long',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric'
                                    })}
                                </p>
                            </div>
                            <div class="text-right">
                                <div class="text-3xl font-bold">${minutasParaMeta}/${metaTotal}</div>
                                <div class="text-blue-100 text-sm">minutas para metas CNJ</div>
                                ${(minutasAlemMeta > 0 || minutasSEEU > 0) ? `
                                    <div class="text-lg font-medium mt-2 text-blue-200">
                                        ${minutasAlemMeta > 0 ? `+${minutasAlemMeta} al√©m da meta` : ''}
                                        ${minutasAlemMeta > 0 && minutasSEEU > 0 ? ' ‚Ä¢ ' : ''}
                                        ${minutasSEEU > 0 ? `${minutasSEEU} SEEU` : ''}
                                    </div>
                                    <div class="text-blue-200 text-sm">Total produzido: ${totalMinutasHoje} minutas</div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;

                // Cards dos assessores
                content += renderAssessoresCards();

                // Metas semanais especiais
                if (currentUser.isJuiz) {
                    content += renderMetasSemanais();
                }

                // Pain√©is de acompanhamento (vis√≠veis para todos)
                content += renderPaineisAcompanhamento();

                dashboard.innerHTML = content;
                dashboard.classList.remove('hidden');
                
                setTimeout(() => criarIcones(), 100);
                log('Dashboard renderizado');
                
            } catch (error) {
                log('Erro ao renderizar dashboard', error);
                showNotification('Erro ao carregar dashboard', 'error');
            }
        }

        function renderMetasSemanais() {
            const meta2Gilbert = getMeta2Status('gilbert');
            const meta2Laise = getMeta2Status('laise');
            const meta10Status = getMeta10Status();
            const seuStatus = getSEEUStatus();

            return `
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4 mt-6">
                    <!-- Meta 2 Gilbert -->
                    <div class="bg-white rounded-lg shadow-md p-4 ${meta2Gilbert.metaSemanaCumprida ? 'meta2-success' : 'meta2-alert'}">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-sm text-gray-700">Meta 2 CNJ - Gilbert</h4>
                            <span class="text-xs px-2 py-1 rounded-full ${meta2Gilbert.metaSemanaCumprida ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${meta2Gilbert.metaSemanaCumprida ? 'OK' : 'Pendente'}
                            </span>
                        </div>
                        <div class="text-2xl font-bold ${meta2Gilbert.metaSemanaCumprida ? 'text-green-600' : 'text-red-600'}">
                            ${meta2Gilbert.metaSemanaCumprida ? '1/1' : '0/1'}
                        </div>
                        <div class="text-xs text-gray-600">Senten√ßa/semana</div>
                    </div>

                    <!-- Meta 2 Laise -->
                    <div class="bg-white rounded-lg shadow-md p-4 ${meta2Laise.metaSemanaCumprida ? 'meta2-success' : 'meta2-alert'}">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-sm text-gray-700">Meta 2 CNJ - La√≠se</h4>
                            <span class="text-xs px-2 py-1 rounded-full ${meta2Laise.metaSemanaCumprida ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${meta2Laise.metaSemanaCumprida ? 'OK' : 'Pendente'}
                            </span>
                        </div>
                        <div class="text-2xl font-bold ${meta2Laise.metaSemanaCumprida ? 'text-green-600' : 'text-red-600'}">
                            ${meta2Laise.metaSemanaCumprida ? '1/1' : '0/1'}
                        </div>
                        <div class="text-xs text-gray-600">Senten√ßa/semana</div>
                    </div>

                    <!-- Meta 10 -->
                    <div class="bg-white rounded-lg shadow-md p-4 ${meta10Status.metaSemanaCumprida ? 'meta10-success' : 'meta10-alert'}">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-sm text-gray-700">Meta 10 CNJ</h4>
                            <span class="text-xs px-2 py-1 rounded-full ${meta10Status.metaSemanaCumprida ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${meta10Status.metaSemanaCumprida ? 'OK' : 'Pendente'}
                            </span>
                        </div>
                        <div class="text-2xl font-bold ${meta10Status.metaSemanaCumprida ? 'text-green-600' : 'text-red-600'}">
                            ${meta10Status.metaSemanaCumprida ? '1/1' : '0/1'}
                        </div>
                        <div class="text-xs text-gray-600">Minuta/semana</div>
                    </div>

                    <!-- SEEU Status -->
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-sm text-gray-700">SEEU Status</h4>
                            <span class="text-xs px-2 py-1 rounded-full ${
                                seuStatus.status === 'em_dia' ? 'bg-green-100 text-green-800' :
                                seuStatus.status === 'atencao' ? 'bg-yellow-100 text-yellow-800' :
                                'bg-red-100 text-red-800'
                            }">
                                ${seuStatus.status === 'em_dia' ? 'Em dia' :
                                  seuStatus.status === 'atencao' ? 'Aten√ß√£o' :
                                  seuStatus.status === 'atrasado' ? 'Atrasado' : 'Nunca'}
                            </span>
                        </div>
                        <div class="text-2xl font-bold ${
                            seuStatus.status === 'em_dia' ? 'text-green-600' :
                            seuStatus.status === 'atencao' ? 'text-yellow-600' :
                            'text-red-600'
                        }">
                            ${seuStatus.diasSemSEEU}
                        </div>
                        <div class="text-xs text-gray-600">dias sem acesso</div>
                    </div>
                </div>
            `;
        }

        function renderRelatorios() {
            try {
                const relatoriosView = document.getElementById('relatorios-view');
                if (!relatoriosView) {
                    throw new Error('Elemento relatorios-view n√£o encontrado');
                }

                const relatorioContent = document.getElementById('relatorio-content');
                if (!relatorioContent) {
                    throw new Error('Elemento relatorio-content n√£o encontrado');
                }

                // Verificar se h√° minutas para gerar relat√≥rios
                const totalMinutas = Object.keys(minutas).length;
                
                // Inicializar com uma mensagem de boas-vindas e instru√ß√µes
                relatorioContent.innerHTML = `
                    <div class="text-center py-12">
                        <i data-lucide="bar-chart-3" class="mx-auto h-16 w-16 text-gray-300 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Relat√≥rios de Produtividade</h3>
                        <p class="text-gray-600 mb-6">Selecione o tipo de relat√≥rio que deseja gerar</p>
                        
                        ${totalMinutas > 0 ? `
                            <div class="mb-6 text-sm text-green-600 bg-green-50 border border-green-200 rounded-lg p-3 max-w-md mx-auto">
                                üìä ${totalMinutas} minuta${totalMinutas !== 1 ? 's' : ''} dispon√≠vel${totalMinutas !== 1 ? 'is' : ''} para an√°lise
                            </div>
                        ` : `
                            <div class="mb-6 text-sm text-yellow-600 bg-yellow-50 border border-yellow-200 rounded-lg p-3 max-w-md mx-auto">
                                ‚ö†Ô∏è Nenhuma minuta encontrada. Registre algumas minutas primeiro para gerar relat√≥rios.
                            </div>
                        `}
                        
                        <div class="grid md:grid-cols-3 gap-4 max-w-4xl mx-auto">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-left">
                                <h4 class="font-semibold text-blue-800 mb-2">üìÖ Relat√≥rio Semanal</h4>
                                <p class="text-sm text-blue-700 mb-3">An√°lise detalhada da semana atual com produtividade di√°ria e metas cumpridas.</p>
                                <button onclick="gerarRelatorio('semanal')" 
                                        class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm font-medium"
                                        ${totalMinutas === 0 ? 'disabled' : ''}>
                                    <i data-lucide="calendar-week" class="h-4 w-4 mr-1 inline"></i>
                                    Gerar Semanal
                                </button>
                            </div>
                            
                            <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-left">
                                <h4 class="font-semibold text-green-800 mb-2">üìä Relat√≥rio Mensal</h4>
                                <p class="text-sm text-green-700 mb-3">Vis√£o completa do m√™s com gr√°ficos de performance e comparativos semanais.</p>
                                <button onclick="gerarRelatorio('mensal')" 
                                        class="w-full bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors text-sm font-medium"
                                        ${totalMinutas === 0 ? 'disabled' : ''}>
                                    <i data-lucide="calendar-month" class="h-4 w-4 mr-1 inline"></i>
                                    Gerar Mensal
                                </button>
                            </div>
                            
                            <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 text-left">
                                <h4 class="font-semibold text-purple-800 mb-2">üéØ Relat√≥rio Personalizado</h4>
                                <p class="text-sm text-purple-700 mb-3">Escolha per√≠odo espec√≠fico e compare dados entre datas customizadas.</p>
                                <button onclick="mostrarRelatorioPersonalizado()" 
                                        class="w-full bg-purple-500 text-white px-4 py-2 rounded-md hover:bg-purple-600 transition-colors text-sm font-medium"
                                        ${totalMinutas === 0 ? 'disabled' : ''}>
                                    <i data-lucide="calendar-range" class="h-4 w-4 mr-1 inline"></i>
                                    Personalizar
                                </button>
                            </div>
                        </div>
                        
                        ${totalMinutas === 0 ? `
                            <div class="mt-6">
                                <button onclick="showView('registro')" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors text-sm">
                                    <i data-lucide="plus" class="h-4 w-4 mr-1 inline"></i>
                                    Registrar Primeira Minuta
                                </button>
                            </div>
                        ` : ''}
                        
                        <div class="mt-8 text-xs text-gray-500">
                            <p>üí° <strong>Dica:</strong> Os relat√≥rios s√£o gerados em tempo real com base nas minutas registradas.</p>
                            <p>üìù Para melhores resultados, registre minutas regularmente e mantenha os dados atualizados.</p>
                            <p>üéØ Use relat√≥rios personalizados para an√°lises espec√≠ficas de per√≠odos passados.</p>
                        </div>
                    </div>
                `;

                relatoriosView.classList.remove('hidden');
                setTimeout(() => criarIcones(), 100);
                log('Tela de relat√≥rios renderizada com sucesso');
                
            } catch (error) {
                log('Erro ao renderizar tela de relat√≥rios:', error);
                showNotification('Erro ao carregar p√°gina de relat√≥rios', 'error');
                
                // Fallback b√°sico
                const relatorioContent = document.getElementById('relatorio-content');
                if (relatorioContent) {
                    relatorioContent.innerHTML = `
                        <div class="text-center py-12">
                            <i data-lucide="alert-triangle" class="mx-auto h-16 w-16 text-red-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-red-800 mb-2">Erro ao Carregar Relat√≥rios</h3>
                            <p class="text-red-600 mb-4">Ocorreu um erro ao inicializar a p√°gina de relat√≥rios</p>
                            <button onclick="showView('dashboard')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                                Voltar ao Dashboard
                            </button>
                        </div>
                    `;
                }
                setTimeout(() => criarIcones(), 100);
            }
        }

        function renderAssessoresCards() {
            if (!currentUser) return '';

            if (currentUser.isJuiz) {
                return `
                    <div class="grid md:grid-cols-2 gap-6 mt-6">
                        ${renderAssessorCard('gilbert')}
                        ${renderAssessorCard('laise')}
                    </div>
                `;
            } else {
                return `
                    <div class="max-w-2xl mx-auto mt-6">
                        ${renderAssessorCard(currentUser.assessorId)}
                    </div>
                `;
            }
        }

        function renderAssessorCard(assessorId) {
            try {
                const assessor = assessores[assessorId];
                if (!assessor) {
                    log(`Assessor ${assessorId} n√£o encontrado em assessores:`, assessores);
                    return `<div class="bg-red-50 p-4 rounded-lg text-red-800">Erro: Assessor ${assessorId} n√£o encontrado</div>`;
                }

                const progressoTotal = getProgressoTotal(assessorId);
                const minutasHoje = getMinutasHoje(assessorId);

                // Detalhamento por categoria
                const detalhamentoHtml = Object.entries(categorias).filter(([catId, catInfo]) => {
                    // Filtrar categorias relevantes para cada assessor
                    if (assessorId === 'gilbert' && catId === 'seeu') return false;
                    if (assessorId === 'laise' && catId === 'meta10') return false;
                    return true;
                }).map(([catId, catInfo]) => {
                    const progresso = getProgressoCategoria(assessorId, catId);
                    if (catInfo.naoContaParaMeta) return ''; // N√£o mostrar categorias que n√£o contam
                    
                    return `
                        <div class="flex justify-between items-center text-sm py-1">
                            <span class="text-gray-600">${catInfo.nome}:</span>
                            <span class="font-medium ${progresso.atual >= (progresso.meta || 0) ? 'text-green-600' : 'text-gray-800'}">
                                ${progresso.atual}${progresso.meta > 0 ? `/${progresso.meta}` : ''}
                                ${progresso.semanal ? ' (semanal)' : ''}
                            </span>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-white rounded-lg shadow-md p-6 border-l-4 ${progressoTotal.atual >= 10 ? 'border-green-500' : 'border-yellow-500'}">
                        <div class="flex items-center justify-between mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">${assessor.nome}</h3>
                                <p class="text-sm text-gray-600">Assessor do Gabinete</p>
                            </div>
                            <div class="text-right">
                                <div class="px-3 py-1 rounded-full text-sm font-medium ${
                                    progressoTotal.atual >= 10 ? 'bg-green-100 text-green-800' : 
                                    progressoTotal.atual >= 5 ? 'bg-yellow-100 text-yellow-800' :
                                    'bg-red-100 text-red-800'
                                }">
                                    ${progressoTotal.atual}/10 minutas CNJ
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="flex justify-between text-sm text-gray-600 mb-2">
                                <span>Progresso Di√°rio (Metas CNJ)</span>
                                <span class="font-medium">${Math.round(progressoTotal.percentual)}%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-3">
                                <div class="${
                                    progressoTotal.atual >= 10 ? 'bg-green-500' : 
                                    progressoTotal.atual >= 5 ? 'bg-yellow-500' :
                                    'bg-red-500'
                                } h-3 rounded-full transition-all duration-300" style="width: ${Math.min(progressoTotal.percentual, 100)}%"></div>
                            </div>
                        </div>

                        <!-- Detalhamento por categoria -->
                        <div class="border-t pt-3 mb-4">
                            <h4 class="text-sm font-medium text-gray-700 mb-2">Detalhamento por Categoria:</h4>
                            <div class="space-y-1">
                                ${detalhamentoHtml || '<div class="text-sm text-gray-500">Nenhuma categoria aplic√°vel</div>'}
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 text-center text-sm border-t pt-3">
                            <div>
                                <div class="font-semibold text-gray-800">${minutasHoje.length}</div>
                                <div class="text-gray-600">Total Hoje</div>
                            </div>
                            <div>
                                <div class="font-semibold text-blue-600">${progressoTotal.alemDaMeta || 0}</div>
                                <div class="text-gray-600">Al√©m Meta</div>
                            </div>
                            <div>
                                <div class="font-semibold text-teal-600">${progressoTotal.seeu || 0}</div>
                                <div class="text-gray-600">SEEU</div>
                            </div>
                        </div>

                        ${!currentUser.isJuiz && progressoTotal.atual < 10 ? `
                            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                                <div class="text-blue-800 text-sm font-medium">
                                    <i data-lucide="target" class="h-4 w-4 mr-1 inline"></i>
                                    Faltam ${10 - progressoTotal.atual} minutas para completar a meta di√°ria
                                </div>
                            </div>
                        ` : ''}

                        ${!currentUser.isJuiz && progressoTotal.atual >= 10 ? `
                            <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                                <div class="text-green-800 text-sm font-medium">
                                    <i data-lucide="check-circle" class="h-4 w-4 mr-1 inline"></i>
                                    üéØ Meta di√°ria cumprida! Parab√©ns!
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
            } catch (error) {
                log(`Erro ao renderizar card ${assessorId}:`, error);
                return `<div class="bg-red-50 p-4 rounded-lg text-red-800">Erro ao carregar dados de ${assessorId}: ${error.message}</div>`;
            }
        }

        function renderHistorico() {
            try {
                const historico = document.getElementById('historico-view');
                if (!historico) {
                    log('Elemento historico-view n√£o encontrado');
                    return;
                }

                const historicoContent = document.getElementById('historico-content');
                if (!historicoContent) {
                    log('Elemento historico-content n√£o encontrado');
                    return;
                }

                // ===== CONFIGURAR FILTROS AUTOMATICAMENTE =====
                const filtrosContainer = document.getElementById('historico-filters');
                if (filtrosContainer && filtrosContainer.innerHTML.trim() === '') {
                    // Mostrar filtro de assessor apenas para o juiz
                    const filtroAssessorHtml = currentUser.isJuiz ? `
                        <select id="filtro-assessor" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="renderHistorico()">
                            <option value="">Todos os assessores</option>
                            <option value="gilbert">Gilbert Juliano</option>
                            <option value="laise">La√≠se Vital</option>
                        </select>
                    ` : '';

                    filtrosContainer.innerHTML = `
                        <div class="flex flex-wrap gap-2">
                            <input type="text" id="filtro-processo" placeholder="Buscar por n¬∫ do processo" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 min-w-48" oninput="renderHistorico()">
                            ${filtroAssessorHtml}
                            <select id="filtro-tipo" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="renderHistorico()">
                                <option value="">Todos os tipos</option>
                                <option value="Despacho">Despacho</option>
                                <option value="Decis√£o">Decis√£o</option>
                                <option value="Senten√ßa">Senten√ßa</option>
                            </select>
                            <select id="filtro-status" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="renderHistorico()">
                                <option value="">Todos os status</option>
                                <option value="pendente">Pendentes</option>
                                <option value="assinada">Assinadas</option>
                                <option value="correcao">Precisam Corre√ß√£o</option>
                                <option value="excluida">Exclu√≠das</option>
                            </select>
                            <select id="filtro-categoria" class="border border-gray-300 rounded-md px-3 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="renderHistorico()">
                                <option value="">Todas as categorias</option>
                                <option value="meta1">Meta 1 CNJ</option>
                                <option value="meta2">Meta 2 CNJ</option>
                                <option value="meta10">Meta 10 CNJ</option>
                                <option value="seeu">SEEU</option>
                                <option value="sem_movimento">Sem movimenta√ß√£o 60+</option>
                                <option value="outros">Pedidos/Atos</option>
                                <option value="alem_meta">Al√©m da Meta</option>
                                <optgroup label="Pain√©is de Acompanhamento">
                                    <option value="conhecimento_10anos">Conhecimento > 10 anos</option>
                                    <option value="violencia_domestica">Viol√™ncia Dom√©stica</option>
                                    <option value="acoes_saude">A√ß√µes de Sa√∫de</option>
                                    <option value="acoes_penais">A√ß√µes Penais</option>
                                    <option value="processos_juri">J√∫ri</option>
                                    <option value="acoes_ambientais">A√ß√µes Ambientais</option>
                                </optgroup>
                            </select>
                            <button onclick="limparFiltros()" class="bg-gray-500 text-white px-3 py-1 rounded-md hover:bg-gray-600 transition-colors text-sm">
                                <i data-lucide="x" class="h-3 w-3 mr-1 inline"></i>
                                Limpar
                            </button>
                        </div>
                    `;
                }

                // Verificar se minutas existe
                if (!minutas || typeof minutas !== 'object') {
                    log('Objeto minutas n√£o existe ou √© inv√°lido');
                    historicoContent.innerHTML = `
                        <div class="text-center text-gray-500 py-12">
                            <p>Nenhuma minuta encontrada.</p>
                        </div>
                    `;
                    historico.classList.remove('hidden');
                    return;
                }

                const minutasArray = [];
                for (const [key, minuta] of Object.entries(minutas)) {
                    if (minuta) {
                        minutasArray.push({
                            ...minuta,
                            id: key
                        });
                    }
                }

                // Ordenar por data de cria√ß√£o
                minutasArray.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

                let minutasFiltradas = minutasArray;

                // Filtro por usu√°rio (se n√£o for juiz)
                if (!currentUser.isJuiz) {
                    minutasFiltradas = minutasFiltradas.filter(m => {
                        if (!m.assessorId) return false;
                        return m.assessorId === currentUser.assessorId || 
                               (currentUser.assessorId === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                               (currentUser.assessorId === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('La√≠se'))));
                    });
                }

                // Aplicar filtros
                const filtroProcesso = document.getElementById('filtro-processo')?.value;
                const filtroTipo = document.getElementById('filtro-tipo')?.value;
                const filtroStatus = document.getElementById('filtro-status')?.value;
                const filtroCategoria = document.getElementById('filtro-categoria')?.value;
                const filtroAssessor = document.getElementById('filtro-assessor')?.value;

                if (filtroProcesso && filtroProcesso.trim()) {
                    const processoLower = filtroProcesso.toLowerCase().trim();
                    minutasFiltradas = minutasFiltradas.filter(m => {
                        const numeroProcesso = m.numeroProcesso || '';
                        return numeroProcesso.toLowerCase().includes(processoLower);
                    });
                }

                // Filtro por assessor (apenas para juiz)
                if (filtroAssessor && currentUser.isJuiz) {
                    minutasFiltradas = minutasFiltradas.filter(m => {
                        return m.assessorId === filtroAssessor ||
                               (filtroAssessor === 'gilbert' && (m.assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert')))) ||
                               (filtroAssessor === 'laise' && (m.assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('La√≠se'))));
                    });
                }

                if (filtroTipo) {
                    minutasFiltradas = minutasFiltradas.filter(m => m.tipoMinuta === filtroTipo);
                }

                if (filtroStatus) {
                    minutasFiltradas = minutasFiltradas.filter(m => m.status === filtroStatus);
                }

                if (filtroCategoria) {
                    minutasFiltradas = minutasFiltradas.filter(m => {
                        try {
                            const categorias = normalizarCategorias(m);
                            return categorias.includes(filtroCategoria);
                        } catch (error) {
                            log('Erro ao normalizar categorias:', error);
                            return false;
                        }
                    });
                }

                // Verificar se h√° resultados
                if (minutasFiltradas.length === 0) {
                    const temFiltros = filtroProcesso || filtroTipo || filtroStatus || filtroCategoria || filtroAssessor;
                    historicoContent.innerHTML = `
                        <div class="text-center text-gray-500 py-12">
                            <i data-lucide="file-text" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                            <p>Nenhuma minuta encontrada${temFiltros ? ' com os filtros aplicados' : ''}.</p>
                            ${temFiltros ? '<button onclick="limparFiltros()" class="mt-4 text-blue-600 hover:text-blue-800 text-sm">Limpar filtros</button>' : ''}
                        </div>
                    `;
                } else {
                    // Gerar o conte√∫do
                    const cardsHtml = minutasFiltradas.map(minuta => criarCardMinuta(minuta)).join('');
                    
                    historicoContent.innerHTML = `
                        <div class="mb-4 text-sm text-gray-600">
                            Mostrando ${minutasFiltradas.length} de ${minutasArray.length} minutas
                            ${filtroProcesso || filtroTipo || filtroStatus || filtroCategoria ? ' (filtros aplicados)' : ''}
                        </div>
                        <div class="space-y-3">
                            ${cardsHtml}
                        </div>
                    `;
                }

                historico.classList.remove('hidden');
                setTimeout(() => criarIcones(), 100);
                log('Hist√≥rico renderizado com sucesso');
                
            } catch (error) {
                log('Erro cr√≠tico ao renderizar hist√≥rico:', error);
                console.error('Stack trace completo:', error);
                showNotification('Erro ao carregar hist√≥rico: ' + error.message, 'error');
                
                // Fallback de emerg√™ncia
                const historicoContent = document.getElementById('historico-content');
                if (historicoContent) {
                    historicoContent.innerHTML = `
                        <div class="text-center text-red-500 py-12">
                            <i data-lucide="alert-triangle" class="mx-auto h-12 w-12 mb-4"></i>
                            <p>Erro ao carregar hist√≥rico</p>
                            <p class="text-sm mt-2">${error.message}</p>
                            <button onclick="renderHistorico()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded text-sm">Tentar Novamente</button>
                        </div>
                    `;
                }
            }
        }

        function criarCardMinuta(minuta) {
            try {
                if (!minuta) return '';

                // Dados b√°sicos com fallbacks seguros e sanitiza√ß√£o XSS
                const numeroProcesso = escapeHtml(minuta.numeroProcesso || 'N√£o informado');
                const tipoMinuta = escapeHtml(minuta.tipoMinuta || 'N√£o informado');
                const assessorNome = escapeHtml(minuta.assessorNome || assessores[minuta.assessorId]?.nome || 'Assessor');
                const observacoes = escapeHtml(minuta.observacoes || '');
                const dataFormatada = formatarDataBrasilia(minuta.data);
                const timestamp = escapeHtml(minuta.timestamp || '');
                const minutaIdSafe = escapeAttr(minuta.id);
                const substituicao = minuta.substituicao === true;
                
                // Status com fallback
                const status = statusOptions[minuta.status] || statusOptions['pendente'];
                
                // Categorias com tratamento seguro
                let categoriasHtml = '';
                let categoriasTexto = '';
                try {
                    const categoriasMinuta = normalizarCategorias(minuta);
                    if (categoriasMinuta.length > 0) {
                        categoriasHtml = categoriasMinuta.map(catId => {
                            const categoria = categorias[catId];
                            if (!categoria) return '';
                            return `<span class="px-2 py-1 rounded-full text-xs font-medium ${categoria.cor || 'bg-gray-500'} text-white">${categoria.nome || catId}</span>`;
                        }).filter(html => html).join(' ');
                        
                        if (categoriasMinuta.length > 1) {
                            categoriasTexto = `<div class="text-xs text-blue-600 mt-1"><strong>M√∫ltiplas categorias:</strong> ${categoriasMinuta.map(id => categorias[id]?.nome || id).join(', ')}</div>`;
                        }
                    }
                } catch (error) {
                    log('Erro ao processar categorias:', error);
                    categoriasHtml = '<span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-500 text-white">Erro ao carregar categorias</span>';
                }
                
                if (!categoriasHtml) {
                    categoriasHtml = '<span class="px-2 py-1 rounded-full text-xs font-medium bg-gray-500 text-white">Sem categoria</span>';
                }
                
                // Bot√µes de a√ß√£o (usando ID sanitizado)
                let botoesAcao = '';

                // Verificar se a minuta pertence ao assessor atual
                const isMinutaDoAssessor = !currentUser.isJuiz && (
                    minuta.assessorId === currentUser.assessorId ||
                    (currentUser.assessorId === 'gilbert' && (minuta.assessorId === 'assessor1' || (minuta.assessorNome && minuta.assessorNome.includes('Gilbert')))) ||
                    (currentUser.assessorId === 'laise' && (minuta.assessorId === 'assessor2' || (minuta.assessorNome && minuta.assessorNome.includes('La√≠se'))))
                );

                if (currentUser.isJuiz) {
                    // Bot√µes para o juiz
                    const botoes = [];

                    if (minuta.status !== 'assinada') {
                        botoes.push(`<button onclick="atualizarStatus('${minutaIdSafe}', 'assinada')" class="px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition-colors">Assinar</button>`);
                    }

                    if (minuta.status !== 'correcao') {
                        botoes.push(`<button onclick="solicitarCorrecao('${minutaIdSafe}')" class="px-3 py-1 bg-yellow-500 text-white text-xs rounded hover:bg-yellow-600 transition-colors">Corre√ß√£o</button>`);
                    }

                    botoes.push(`<button onclick="editarMinuta('${minutaIdSafe}')" class="px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors">Editar</button>`);
                    botoes.push(`<button onclick="excluirMinuta('${minutaIdSafe}')" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">Excluir</button>`);

                    botoesAcao = `<div class="flex gap-2 mt-3">${botoes.join('')}</div>`;
                } else if (isMinutaDoAssessor && minuta.status === 'pendente') {
                    // Bot√£o de excluir para assessor (apenas minutas pendentes que s√£o dele)
                    botoesAcao = `
                        <div class="flex gap-2 mt-3">
                            <button onclick="excluirMinutaAssessor('${minutaIdSafe}')" class="px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600 transition-colors">
                                Excluir Minuta
                            </button>
                        </div>
                    `;
                }

                // Alerta de corre√ß√£o para assessores (com sanitiza√ß√£o XSS)
                let alertaCorrecao = '';
                if (minuta.status === 'correcao' && !currentUser.isJuiz) {
                    const detalhesCorrecao = escapeHtml(minuta.correcaoDetalhes || 'Detalhes n√£o especificados');
                    alertaCorrecao = `
                        <div class="mt-3 p-3 bg-red-50 border border-red-200 rounded">
                            <div class="text-red-800 text-sm">
                                <strong>Corre√ß√£o solicitada:</strong> ${detalhesCorrecao}
                            </div>
                            <button onclick="marcarComoCorrigida('${minutaIdSafe}')" class="mt-2 px-3 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition-colors">
                                Marcar como Corrigida
                            </button>
                        </div>
                    `;
                }
                
                return `
                    <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2 flex-wrap">
                                    <span class="font-medium text-gray-800">${assessorNome}</span>
                                    ${categoriasHtml}
                                    <span class="status-badge ${status.cor}">${status.nome}</span>
                                    ${substituicao ? '<span class="px-2 py-1 rounded-full text-xs font-medium bg-amber-500 text-white">Substitui√ß√£o</span>' : ''}
                                </div>
                                <div class="text-sm text-gray-600 mb-2">
                                    <div><strong>Processo:</strong> ${numeroProcesso}</div>
                                    <div><strong>Tipo:</strong> ${tipoMinuta}</div>
                                    ${observacoes ? `<div><strong>Observa√ß√µes:</strong> ${observacoes}</div>` : ''}
                                    ${categoriasTexto}
                                </div>
                                ${botoesAcao}
                                ${alertaCorrecao}
                            </div>
                            <div class="text-xs text-gray-500 text-right ml-4">
                                <div>${dataFormatada}</div>
                                <div>${timestamp}</div>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                log('Erro ao criar card da minuta:', error);
                return `
                    <div class="border border-red-200 bg-red-50 rounded-lg p-4">
                        <div class="text-red-800 text-sm">
                            Erro ao carregar minuta: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // (limparFiltros j√° definida na se√ß√£o de navega√ß√£o/filtros)

        function renderCalendario() {
            try {
                const calendarioView = document.getElementById('calendario-view');
                if (!calendarioView) return;

                const mesAtual = calendarioData.mesAtual;
                const anoAtual = calendarioData.anoAtual;
                
                // Atualizar cabe√ßalho do m√™s/ano
                document.getElementById('calendario-mes-ano').textContent = 
                    new Date(anoAtual, mesAtual).toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

                // Gerar dias do calend√°rio
                const diasCalendario = gerarDiasCalendario(anoAtual, mesAtual);
                
                document.getElementById('calendario-dias').innerHTML = diasCalendario.map(dia => {
                    const minutasDoDia = getMinutasPorData(dia.data);
                    const isToday = dia.data === getHojeString();
                    const isSelected = dia.data === calendarioData.diaSelecionado;
                    const isOtherMonth = dia.outroMes;

                    let classes = 'calendar-day';
                    if (isToday) classes += ' today';
                    if (isSelected) classes += ' selected';
                    if (minutasDoDia.length > 0) classes += ' has-data';
                    if (isOtherMonth) classes += ' other-month';

                    // Indicadores especiais
                    let indicadores = '';
                    if (minutasDoDia.length > 0) {
                        indicadores += '<div class="productivity-indicator"></div>';
                    }

                    return `
                        <div class="${classes}" onclick="selecionarDia('${dia.data}')">
                            <div class="day-number">${dia.numero}</div>
                            ${minutasDoDia.length > 0 ? `<div class="day-count">${minutasDoDia.length}</div>` : ''}
                            ${indicadores}
                        </div>
                    `;
                }).join('');

                // Renderizar detalhes se um dia estiver selecionado
                if (calendarioData.diaSelecionado) {
                    renderDetalhesDoDia();
                }

                calendarioView.classList.remove('hidden');
                setTimeout(() => criarIcones(), 100);
                log('Calend√°rio renderizado');
                
            } catch (error) {
                log('Erro ao renderizar calend√°rio', error);
                showNotification('Erro ao carregar calend√°rio', 'error');
            }
        }

        function gerarDiasCalendario(ano, mes) {
            const dias = [];
            const primeiroDiaDoMes = new Date(ano, mes, 1);
            const ultimoDiaDoMes = new Date(ano, mes + 1, 0);
            const primeiroDiaSemana = primeiroDiaDoMes.getDay();
            
            // Dias do m√™s anterior
            const diasMesAnterior = new Date(ano, mes, 0).getDate();
            for (let i = primeiroDiaSemana - 1; i >= 0; i--) {
                const dia = diasMesAnterior - i;
                const data = new Date(ano, mes - 1, dia);
                dias.push({
                    numero: dia,
                    data: data.toISOString().split('T')[0],
                    outroMes: true
                });
            }
            
            // Dias do m√™s atual
            for (let dia = 1; dia <= ultimoDiaDoMes.getDate(); dia++) {
                const data = new Date(ano, mes, dia);
                dias.push({
                    numero: dia,
                    data: data.toISOString().split('T')[0],
                    outroMes: false
                });
            }
            
            // Dias do pr√≥ximo m√™s para completar a grade
            const diasRestantes = 42 - dias.length; // 6 semanas √ó 7 dias
            for (let dia = 1; dia <= diasRestantes; dia++) {
                const data = new Date(ano, mes + 1, dia);
                dias.push({
                    numero: dia,
                    data: data.toISOString().split('T')[0],
                    outroMes: true
                });
            }
            
            return dias;
        }

        function renderDetalhesDoDia() {
            const data = calendarioData.diaSelecionado;
            if (!data) return;

            const minutasDoDia = getMinutasPorData(data);
            const dataObj = new Date(data);
            const dataFormatada = dataObj.toLocaleDateString('pt-BR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let detalhesHtml = `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4 capitalize">${dataFormatada}</h3>
            `;

            if (minutasDoDia.length === 0) {
                detalhesHtml += `
                    <div class="text-center text-gray-500 py-8">
                        <i data-lucide="file-text" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                        <p>Nenhuma minuta registrada neste dia</p>
                    </div>
                `;
            } else {
                // Estat√≠sticas do dia
                const estatisticas = {};
                minutasDoDia.forEach(minuta => {
                    const cats = normalizarCategorias(minuta);
                    cats.forEach(cat => {
                        if (!estatisticas[cat]) estatisticas[cat] = 0;
                        estatisticas[cat]++;
                    });
                });

                detalhesHtml += `
                    <div class="mb-6">
                        <h4 class="text-md font-medium text-gray-700 mb-3">Resumo do Dia</h4>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div class="bg-blue-50 p-3 rounded">
                                <div class="font-semibold text-blue-800">${minutasDoDia.length}</div>
                                <div class="text-blue-600">Total de minutas</div>
                            </div>
                            ${Object.entries(estatisticas).map(([cat, count]) => {
                                const categoria = categorias[cat];
                                if (!categoria) return '';
                                return `
                                    <div class="bg-gray-50 p-3 rounded">
                                        <div class="font-semibold text-gray-800">${count}</div>
                                        <div class="text-gray-600 text-xs">${categoria.nome}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <div>
                        <h4 class="text-md font-medium text-gray-700 mb-3">Minutas do Dia</h4>
                        <div class="space-y-2 max-h-64 overflow-y-auto">
                            ${minutasDoDia.map(minuta => {
                                const cats = normalizarCategorias(minuta);
                                const status = statusOptions[minuta.status || 'pendente'];
                                
                                return `
                                    <div class="border border-gray-200 rounded p-3 text-sm">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="font-medium text-gray-800">${minuta.numeroProcesso}</div>
                                            <span class="status-badge ${status.cor} text-xs">${status.nome}</span>
                                        </div>
                                        <div class="text-gray-600">
                                            <div><strong>Assessor:</strong> ${minuta.assessorNome}</div>
                                            <div><strong>Tipo:</strong> ${minuta.tipoMinuta}</div>
                                            ${cats.length > 0 ? `<div><strong>Categorias:</strong> ${cats.map(c => categorias[c]?.nome || c).join(', ')}</div>` : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }

            detalhesHtml += '</div>';
            document.getElementById('calendario-detalhes').innerHTML = detalhesHtml;
            setTimeout(() => criarIcones(), 100);
        }

        // ==================== FUN√á√ïES DE A√á√ÉO (IMPLEMENTADAS) ====================
        
        function editarMinuta(id) {
            try {
                const minuta = minutas[id];
                if (!minuta) {
                    showNotification('Minuta n√£o encontrada', 'error');
                    return;
                }

                minutaEditando = id;
                
                document.getElementById('edit-numero-processo').value = minuta.numeroProcesso || '';
                document.getElementById('edit-tipo-minuta').value = minuta.tipoMinuta || 'Despacho';

                const categorias = normalizarCategorias(minuta);
                document.getElementById('edit-categoria-minuta').value = categorias[0] || 'meta1';

                document.getElementById('edit-observacoes-minuta').value = minuta.observacoes || '';
                document.getElementById('edit-substituicao-checkbox').checked = minuta.substituicao === true;

                validarTipoMinutaEdicao();
                document.getElementById('modal-edicao').classList.remove('hidden');
                
                log(`Editando minuta ${id}`);
            } catch (error) {
                log(`Erro ao editar minuta ${id}:`, error);
                showNotification('Erro ao carregar minuta para edi√ß√£o', 'error');
            }
        }

        function excluirMinuta(id) {
            try {
                if (!confirm('Tem certeza que deseja excluir esta minuta? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                const minuta = minutas[id];
                if (!minuta) {
                    showNotification('Minuta n√£o encontrada', 'error');
                    return;
                }

                const minutaAtualizada = {
                    ...minuta,
                    status: 'excluida',
                    excluidaEm: getDataHoraBrasilia().getTime(),
                    excluidaPor: currentUser.nome
                };

                if (database) {
                    database.ref(`minutas/${id}`).update(minutaAtualizada)
                        .then(() => {
                            showNotification('Minuta exclu√≠da com sucesso', 'success');
                            log(`Minuta ${id} exclu√≠da`);
                        })
                        .catch((error) => {
                            minutas[id] = minutaAtualizada;
                            showNotification('Minuta exclu√≠da localmente', 'warning');
                            renderHistorico();
                        });
                } else {
                    minutas[id] = minutaAtualizada;
                    showNotification('Minuta exclu√≠da localmente', 'warning');
                    renderHistorico();
                }
                
            } catch (error) {
                log(`Erro ao excluir minuta ${id}:`, error);
                showNotification('Erro ao excluir minuta', 'error');
            }
        }

        // Fun√ß√£o para assessor excluir sua pr√≥pria minuta (apenas pendentes)
        function excluirMinutaAssessor(id) {
            try {
                const minuta = minutas[id];
                if (!minuta) {
                    showNotification('Minuta n√£o encontrada', 'error');
                    return;
                }

                // Verificar se a minuta pertence ao assessor atual
                const isMinutaDoAssessor = (
                    minuta.assessorId === currentUser.assessorId ||
                    (currentUser.assessorId === 'gilbert' && (minuta.assessorId === 'assessor1' || (minuta.assessorNome && minuta.assessorNome.includes('Gilbert')))) ||
                    (currentUser.assessorId === 'laise' && (minuta.assessorId === 'assessor2' || (minuta.assessorNome && minuta.assessorNome.includes('La√≠se'))))
                );

                if (!isMinutaDoAssessor) {
                    showNotification('Voc√™ s√≥ pode excluir minutas registradas por voc√™', 'error');
                    return;
                }

                // Verificar se a minuta est√° pendente
                if (minuta.status !== 'pendente') {
                    showNotification('Apenas minutas pendentes podem ser exclu√≠das', 'error');
                    return;
                }

                if (!confirm('Tem certeza que deseja excluir esta minuta? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                const minutaAtualizada = {
                    ...minuta,
                    status: 'excluida',
                    excluidaEm: getDataHoraBrasilia().getTime(),
                    excluidaPor: currentUser.nome
                };

                if (database) {
                    database.ref(`minutas/${id}`).update(minutaAtualizada)
                        .then(() => {
                            showNotification('Minuta exclu√≠da com sucesso', 'success');
                            log(`Minuta ${id} exclu√≠da pelo assessor ${currentUser.nome}`);
                        })
                        .catch((error) => {
                            log('Erro ao excluir no Firebase:', error);
                            minutas[id] = minutaAtualizada;
                            salvarDadosLocalmente();
                            showNotification('Minuta exclu√≠da localmente', 'warning');
                            renderHistorico();
                        });
                } else {
                    minutas[id] = minutaAtualizada;
                    salvarDadosLocalmente();
                    showNotification('Minuta exclu√≠da localmente', 'warning');
                    renderHistorico();
                }

            } catch (error) {
                log(`Erro ao excluir minuta ${id}:`, error);
                showNotification('Erro ao excluir minuta', 'error');
            }
        }

        function atualizarStatus(id, status) {
            try {
                const minuta = minutas[id];
                if (!minuta) {
                    showNotification('Minuta n√£o encontrada', 'error');
                    return;
                }

                const minutaAtualizada = {
                    ...minuta,
                    status: status,
                    atualizadaEm: getDataHoraBrasilia().getTime(),
                    atualizadaPor: currentUser.nome
                };

                if (database) {
                    database.ref(`minutas/${id}`).update(minutaAtualizada)
                        .then(() => {
                            const statusMsg = status === 'assinada' ? 'assinada' : 'atualizada';
                            showNotification(`Minuta ${statusMsg} com sucesso`, 'success');
                            log(`Status da minuta ${id} atualizado para ${status}`);
                        })
                        .catch((error) => {
                            minutas[id] = minutaAtualizada;
                            showNotification('Status atualizado localmente', 'warning');
                            renderHistorico();
                        });
                } else {
                    minutas[id] = minutaAtualizada;
                    showNotification('Status atualizado localmente', 'warning');
                    renderHistorico();
                }
                
            } catch (error) {
                log(`Erro ao atualizar status da minuta ${id}:`, error);
                showNotification('Erro ao atualizar status', 'error');
            }
        }

        function solicitarCorrecao(id) {
            try {
                const minuta = minutas[id];
                if (!minuta) {
                    showNotification('Minuta n√£o encontrada', 'error');
                    return;
                }

                minutaCorrecao = id;
                
                document.getElementById('modal-correcao-processo').textContent = `Processo: ${minuta.numeroProcesso}`;
                document.getElementById('modal-correcao-assessor').textContent = `Assessor: ${minuta.assessorNome}`;
                document.getElementById('correcao-detalhes').value = '';
                
                document.getElementById('modal-correcao').classList.remove('hidden');
                document.getElementById('correcao-detalhes').focus();
                
                log(`Solicitando corre√ß√£o para minuta ${id}`);
            } catch (error) {
                log(`Erro ao solicitar corre√ß√£o da minuta ${id}:`, error);
                showNotification('Erro ao solicitar corre√ß√£o', 'error');
            }
        }

        // Vari√°vel para armazenar o ID da minuta sendo corrigida pelo assessor
        let minutaCorrigindoAssessor = null;

        function marcarComoCorrigida(id) {
            try {
                const minuta = minutas[id];
                if (!minuta) {
                    showNotification('Minuta n√£o encontrada', 'error');
                    return;
                }

                // Armazena o ID da minuta
                minutaCorrigindoAssessor = id;

                // Preenche as informa√ß√µes no modal
                document.getElementById('modal-comentario-processo').textContent = `Processo: ${minuta.numeroProcesso}`;
                document.getElementById('modal-comentario-correcao-solicitada').textContent = `Corre√ß√£o solicitada: ${minuta.correcaoDetalhes || 'N√£o especificada'}`;
                document.getElementById('comentario-correcao-assessor').value = '';

                // Abre o modal
                document.getElementById('modal-comentario-correcao').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('comentario-correcao-assessor').focus();
                    criarIcones();
                }, 100);

            } catch (error) {
                log(`Erro ao abrir modal de corre√ß√£o para minuta ${id}:`, error);
                showNotification('Erro ao abrir corre√ß√£o', 'error');
            }
        }

        function fecharModalComentarioCorrecao() {
            document.getElementById('modal-comentario-correcao').classList.add('hidden');
            minutaCorrigindoAssessor = null;
        }

        function confirmarCorrecaoAssessor() {
            try {
                if (!minutaCorrigindoAssessor) {
                    showNotification('Nenhuma minuta selecionada', 'error');
                    return;
                }

                const id = minutaCorrigindoAssessor;
                const minuta = minutas[id];
                if (!minuta) {
                    showNotification('Minuta n√£o encontrada', 'error');
                    fecharModalComentarioCorrecao();
                    return;
                }

                const comentarioAssessor = document.getElementById('comentario-correcao-assessor').value.trim();
                const dataCorrecao = new Date().toLocaleString('pt-BR');

                // Monta a observa√ß√£o com o coment√°rio do assessor
                let novaObservacao = (minuta.observacoes || '');
                novaObservacao += `\n[CORRE√á√ÉO APLICADA em ${dataCorrecao}]`;
                if (comentarioAssessor) {
                    novaObservacao += `\n[Coment√°rio do assessor: ${comentarioAssessor}]`;
                }

                const minutaAtualizada = {
                    ...minuta,
                    status: 'pendente',
                    corrigidaEm: getDataHoraBrasilia().getTime(),
                    corrigidaPor: currentUser.nome,
                    comentarioCorrecao: comentarioAssessor,
                    observacoes: novaObservacao
                };

                if (database) {
                    database.ref(`minutas/${id}`).update(minutaAtualizada)
                        .then(() => {
                            showNotification('Minuta marcada como corrigida', 'success');
                            log(`Minuta ${id} marcada como corrigida pelo assessor ${currentUser.nome}`);
                            fecharModalComentarioCorrecao();
                        })
                        .catch((error) => {
                            log('Erro ao salvar corre√ß√£o no Firebase:', error);
                            minutas[id] = minutaAtualizada;
                            salvarDadosLocalmente();
                            showNotification('Corre√ß√£o aplicada localmente', 'warning');
                            renderHistorico();
                            fecharModalComentarioCorrecao();
                        });
                } else {
                    minutas[id] = minutaAtualizada;
                    salvarDadosLocalmente();
                    showNotification('Corre√ß√£o aplicada localmente', 'warning');
                    renderHistorico();
                    fecharModalComentarioCorrecao();
                }

            } catch (error) {
                log(`Erro ao confirmar corre√ß√£o:`, error);
                showNotification('Erro ao aplicar corre√ß√£o', 'error');
            }
        }


        // ==================== RELAT√ìRIOS PERSONALIZADOS ====================
        
        function mostrarRelatorioPersonalizado() {
            // Pr√©-preencher com datas do m√™s atual
            const hoje = getDataHoraBrasilia();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            const fimMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
            
            document.getElementById('relatorio-data-inicio').value = inicioMes.toISOString().split('T')[0];
            document.getElementById('relatorio-data-fim').value = fimMes.toISOString().split('T')[0];
            
            document.getElementById('modal-relatorio-personalizado').classList.remove('hidden');
            document.getElementById('relatorio-data-inicio').focus();
            
            log('Modal de relat√≥rio personalizado aberto');
        }

        function fecharModalRelatorioPersonalizado() {
            document.getElementById('modal-relatorio-personalizado').classList.add('hidden');
        }

        function gerarRelatorioPersonalizado() {
            try {
                const dataInicio = document.getElementById('relatorio-data-inicio').value;
                const dataFim = document.getElementById('relatorio-data-fim').value;

                if (!dataInicio || !dataFim) {
                    showNotification('Por favor, selecione as datas de in√≠cio e fim', 'warning');
                    return;
                }

                if (dataInicio > dataFim) {
                    showNotification('A data de in√≠cio deve ser anterior √† data de fim', 'error');
                    return;
                }

                const inicio = new Date(dataInicio);
                const fim = new Date(dataFim);
                
                // Verificar se o per√≠odo n√£o √© muito longo (mais de 3 meses)
                const diffMeses = (fim.getFullYear() - inicio.getFullYear()) * 12 + (fim.getMonth() - inicio.getMonth());
                if (diffMeses > 3) {
                    if (!confirm('O per√≠odo selecionado √© superior a 3 meses. Isso pode gerar um relat√≥rio muito extenso. Deseja continuar?')) {
                        return;
                    }
                }

                fecharModalRelatorioPersonalizado();
                gerarRelatorio('personalizado', inicio, fim);
                
            } catch (error) {
                log('Erro ao gerar relat√≥rio personalizado:', error);
                showNotification('Erro ao gerar relat√≥rio personalizado', 'error');
            }
        }

        function gerarRelatorio(tipo, dataInicioCustom = null, dataFimCustom = null) {
            try {
                const relatorioContent = document.getElementById('relatorio-content');
                if (!relatorioContent) {
                    throw new Error('Elemento relatorio-content n√£o encontrado');
                }

                const hoje = getDataHoraBrasilia();
                let inicio, fim, titulo;

                if (tipo === 'personalizado' && dataInicioCustom && dataFimCustom) {
                    inicio = dataInicioCustom;
                    fim = dataFimCustom;
                    titulo = `Relat√≥rio Personalizado - ${inicio.toLocaleDateString('pt-BR')} a ${fim.toLocaleDateString('pt-BR')}`;
                } else if (tipo === 'semanal') {
                    inicio = getInicioSemana(hoje);
                    fim = getFimSemana(hoje);
                    titulo = `Relat√≥rio Semanal - ${inicio.toLocaleDateString('pt-BR')} a ${fim.toLocaleDateString('pt-BR')}`;
                } else if (tipo === 'mensal') {
                    inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                    titulo = `Relat√≥rio Mensal - ${inicio.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' })}`;
                } else {
                    throw new Error(`Tipo de relat√≥rio inv√°lido: ${tipo}`);
                }

                const inicioStr = inicio.toISOString().split('T')[0];
                const fimStr = fim.toISOString().split('T')[0];

                log(`Gerando relat√≥rio ${tipo} para per√≠odo ${inicioStr} a ${fimStr}`);

                const minutasRelatorio = Object.values(minutas).filter(m => {
                    if (!m || !m.data) return false;
                    return m.data >= inicioStr && m.data <= fimStr && m.status !== 'excluida';
                });

                log(`Encontradas ${minutasRelatorio.length} minutas no per√≠odo`);

                const estatisticas = {
                    gilbert: { 
                        total: 0, meta1: 0, meta2: 0, meta10: 0, sem_movimento: 0, 
                        outros: 0, alem_meta: 0, seeu: 0, pendentes: 0, assinadas: 0,
                        totalParaMeta: 0 // NOVO: total que conta para a meta di√°ria
                    },
                    laise: { 
                        total: 0, meta1: 0, meta2: 0, seeu: 0, sem_movimento: 0, 
                        outros: 0, alem_meta: 0, pendentes: 0, assinadas: 0,
                        totalParaMeta: 0 // NOVO: total que conta para a meta di√°ria
                    }
                };

                minutasRelatorio.forEach(m => {
                    try {
                        let assessorId = m.assessorId;
                        
                        // Normalizar IDs antigos
                        if (assessorId === 'assessor1' || (m.assessorNome && m.assessorNome.includes('Gilbert'))) {
                            assessorId = 'gilbert';
                        } else if (assessorId === 'assessor2' || (m.assessorNome && m.assessorNome.includes('La√≠se'))) {
                            assessorId = 'laise';
                        }
                        
                        if (estatisticas[assessorId]) {
                            estatisticas[assessorId].total++;
                            
                            // Contar por status
                            if (m.status === 'pendente') estatisticas[assessorId].pendentes++;
                            if (m.status === 'assinada') estatisticas[assessorId].assinadas++;
                            
                            const categorias = normalizarCategorias(m);
                            let contaParaMeta = false;
                            
                            categorias.forEach(cat => {
                                if (estatisticas[assessorId][cat] !== undefined) {
                                    estatisticas[assessorId][cat]++;
                                }
                                
                                // CORRE√á√ÉO: Verificar se conta para a meta di√°ria (excluir "alem_meta" e "seeu")
                                if (cat !== 'alem_meta' && cat !== 'seeu') {
                                    contaParaMeta = true;
                                }
                            });
                            
                            // Incrementar contador de minutas que contam para a meta
                            if (contaParaMeta) {
                                estatisticas[assessorId].totalParaMeta++;
                            }
                        }
                    } catch (err) {
                        log(`Erro ao processar minuta:`, err);
                    }
                });

                // Calcular dias √∫teis no per√≠odo - CORRE√á√ÉO: usar minutas que contam para meta
                const diasUteis = calcularDiasUteis(inicio, fim);
                const mediaGilbert = diasUteis > 0 ? (estatisticas.gilbert.totalParaMeta / diasUteis).toFixed(1) : '0';
                const mediaLaise = diasUteis > 0 ? (estatisticas.laise.totalParaMeta / diasUteis).toFixed(1) : '0';
                const mediaTotal = diasUteis > 0 ? ((estatisticas.gilbert.totalParaMeta + estatisticas.laise.totalParaMeta) / diasUteis).toFixed(1) : '0';

                let relatorioHtml = `
                    <div class="space-y-6">
                        <div class="text-center border-b pb-4">
                            <h3 class="text-2xl font-bold text-gray-800 mb-2">${titulo}</h3>
                            <p class="text-gray-600">Gerado em ${hoje.toLocaleString('pt-BR')}</p>
                            <p class="text-sm text-gray-500">Per√≠odo: ${diasUteis} dias √∫teis</p>
                            ${tipo === 'personalizado' ? `<p class="text-xs text-purple-600 mt-1">üìä Relat√≥rio personalizado solicitado pelo usu√°rio</p>` : ''}
                        </div>
                        
                        <!-- Resumo Executivo -->
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-blue-800 mb-4">üìä Resumo Executivo</h4>
                            <div class="grid md:grid-cols-4 gap-4 text-center">
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-3xl font-bold text-blue-600">${estatisticas.gilbert.totalParaMeta + estatisticas.laise.totalParaMeta}</div>
                                    <div class="text-sm text-gray-600">Minutas para Meta</div>
                                    <div class="text-xs text-gray-500 mt-1">(${estatisticas.gilbert.total + estatisticas.laise.total} total)</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-3xl font-bold text-green-600">${mediaTotal}</div>
                                    <div class="text-sm text-gray-600">M√©dia Di√°ria</div>
                                    <div class="text-xs text-gray-500 mt-1">minutas/dia √∫til</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-3xl font-bold text-orange-600">${estatisticas.gilbert.assinadas + estatisticas.laise.assinadas}</div>
                                    <div class="text-sm text-gray-600">Assinadas</div>
                                    <div class="text-xs text-gray-500 mt-1">status final</div>
                                </div>
                                <div class="bg-white rounded-lg p-4">
                                    <div class="text-3xl font-bold text-red-600">${estatisticas.gilbert.pendentes + estatisticas.laise.pendentes}</div>
                                    <div class="text-sm text-gray-600">Pendentes</div>
                                    <div class="text-xs text-gray-500 mt-1">aguardando</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Detalhes por Assessor -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-blue-800 mb-4">üë®‚Äçüíº Gilbert Juliano</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium">Minutas para meta:</span>
                                        <span class="text-lg font-bold text-blue-600">${estatisticas.gilbert.totalParaMeta}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium">Total produzido:</span>
                                        <span class="text-lg font-bold text-gray-700">${estatisticas.gilbert.total}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">M√©dia di√°ria:</span>
                                        <span class="font-medium">${mediaGilbert}/dia</span>
                                    </div>
                                    <hr class="border-blue-200">
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Meta 1 CNJ:</span>
                                            <span class="font-medium">${estatisticas.gilbert.meta1}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Meta 2 CNJ:</span>
                                            <span class="font-medium">${estatisticas.gilbert.meta2}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Meta 10 CNJ:</span>
                                            <span class="font-medium">${estatisticas.gilbert.meta10}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Sem movimenta√ß√£o:</span>
                                            <span class="font-medium">${estatisticas.gilbert.sem_movimento}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Pedidos/Atos:</span>
                                            <span class="font-medium">${estatisticas.gilbert.outros}</span>
                                        </div>
                                        <hr class="border-blue-100">
                                        <div class="flex justify-between text-gray-600">
                                            <span>Al√©m da Meta:</span>
                                            <span class="font-medium">${estatisticas.gilbert.alem_meta}</span>
                                        </div>
                                        <div class="flex justify-between text-gray-600">
                                            <span>SEEU:</span>
                                            <span class="font-medium">${estatisticas.gilbert.seeu || 0}</span>
                                        </div>
                                    </div>
                                    <hr class="border-blue-200">
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div class="text-center">
                                            <div class="text-lg font-bold text-green-600">${estatisticas.gilbert.assinadas}</div>
                                            <div class="text-gray-600">Assinadas</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-lg font-bold text-yellow-600">${estatisticas.gilbert.pendentes}</div>
                                            <div class="text-gray-600">Pendentes</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                                <h4 class="text-lg font-semibold text-green-800 mb-4">üë©‚Äçüíº La√≠se Vital</h4>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium">Minutas para meta:</span>
                                        <span class="text-lg font-bold text-green-600">${estatisticas.laise.totalParaMeta}</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium">Total produzido:</span>
                                        <span class="text-lg font-bold text-gray-700">${estatisticas.laise.total}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span class="text-sm">M√©dia di√°ria:</span>
                                        <span class="font-medium">${mediaLaise}/dia</span>
                                    </div>
                                    <hr class="border-green-200">
                                    <div class="space-y-2 text-sm">
                                        <div class="flex justify-between">
                                            <span>Meta 1 CNJ:</span>
                                            <span class="font-medium">${estatisticas.laise.meta1}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Meta 2 CNJ:</span>
                                            <span class="font-medium">${estatisticas.laise.meta2}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Sem movimenta√ß√£o:</span>
                                            <span class="font-medium">${estatisticas.laise.sem_movimento}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span>Pedidos/Atos:</span>
                                            <span class="font-medium">${estatisticas.laise.outros}</span>
                                        </div>
                                        <hr class="border-green-100">
                                        <div class="flex justify-between text-gray-600">
                                            <span>Al√©m da Meta:</span>
                                            <span class="font-medium">${estatisticas.laise.alem_meta}</span>
                                        </div>
                                        <div class="flex justify-between text-gray-600">
                                            <span>SEEU:</span>
                                            <span class="font-medium">${estatisticas.laise.seeu}</span>
                                        </div>
                                    </div>
                                    <hr class="border-green-200">
                                    <div class="grid grid-cols-2 gap-4 text-sm">
                                        <div class="text-center">
                                            <div class="text-lg font-bold text-green-600">${estatisticas.laise.assinadas}</div>
                                            <div class="text-gray-600">Assinadas</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-lg font-bold text-yellow-600">${estatisticas.laise.pendentes}</div>
                                            <div class="text-gray-600">Pendentes</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                `;

                // Adicionar gr√°fico semanal apenas para relat√≥rio mensal ou personalizado longo
                if (tipo === 'mensal' || (tipo === 'personalizado' && diasUteis >= 14)) {
                    try {
                        const graficoSemanal = renderGraficoSemanal(inicio, fim);
                        relatorioHtml += graficoSemanal;
                    } catch (graficoError) {
                        log('Erro ao gerar gr√°fico semanal:', graficoError);
                        // Continuar sem o gr√°fico
                        relatorioHtml += `
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="text-yellow-800 text-sm">
                                    ‚ö†Ô∏è Gr√°fico de performance semanal temporariamente indispon√≠vel
                                </div>
                            </div>
                        `;
                    }
                }
                        
                // Finalizar HTML
                relatorioHtml += `
                        <!-- Observa√ß√µes -->
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-gray-800 mb-3">üìù Observa√ß√µes</h4>
                            <div class="space-y-2 text-sm text-gray-700">
                                <p><strong>üí° Sobre o c√°lculo da m√©dia di√°ria:</strong></p>
                                <p>‚Ä¢ Meta di√°ria esperada: 10 minutas por assessor (20 total)</p>
                                <p>‚Ä¢ <strong>Minutas contabilizadas para meta:</strong> Meta 1 CNJ, Meta 2 CNJ, Meta 10 CNJ, Sem movimenta√ß√£o e Pedidos/Atos</p>
                                <p>‚Ä¢ <strong>Minutas N√ÉO contabilizadas:</strong> "Al√©m da Meta" e "SEEU" (s√£o produtividade adicional)</p>
                                <p>‚Ä¢ Meta 2 CNJ: 1 senten√ßa por semana por assessor</p>
                                <p>‚Ä¢ Meta 10 CNJ: 1 minuta semanal (Gilbert)</p>
                                <p>‚Ä¢ SEEU: Controle de acesso a cada 10 dias (La√≠se)</p>
                                ${tipo === 'personalizado' ? '<p>‚Ä¢ <strong>Relat√≥rio personalizado:</strong> Dados do per√≠odo selecionado pelo usu√°rio</p>' : ''}
                            </div>
                        </div>
                    </div>
                `;

                relatorioContent.innerHTML = relatorioHtml;

                // Mostrar a se√ß√£o de relat√≥rios
                document.getElementById('relatorios-view').classList.remove('hidden');
                
                log(`Relat√≥rio ${tipo} gerado com sucesso - ${minutasRelatorio.length} minutas processadas`);
                showNotification(`Relat√≥rio ${tipo} gerado com sucesso!`, 'success');
                
            } catch (error) {
                log(`Erro detalhado ao gerar relat√≥rio ${tipo}:`, error);
                console.error('Stack trace completo:', error);
                
                // Mostrar erro mais detalhado para o usu√°rio
                const relatorioContent = document.getElementById('relatorio-content');
                if (relatorioContent) {
                    relatorioContent.innerHTML = `
                        <div class="text-center py-12">
                            <i data-lucide="alert-triangle" class="mx-auto h-16 w-16 text-red-300 mb-4"></i>
                            <h3 class="text-xl font-semibold text-red-800 mb-2">Erro ao Gerar Relat√≥rio</h3>
                            <p class="text-red-600 mb-4">Ocorreu um erro ao processar o relat√≥rio ${tipo}</p>
                            <div class="bg-red-50 border border-red-200 rounded-lg p-4 max-w-md mx-auto">
                                <div class="text-sm text-red-700">
                                    <strong>Detalhes t√©cnicos:</strong><br>
                                    ${error.message || 'Erro desconhecido'}
                                </div>
                            </div>
                            <button onclick="renderRelatorios()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors">
                                Voltar
                            </button>
                        </div>
                    `;
                    setTimeout(() => criarIcones(), 100);
                }
                
                showNotification(`Erro ao gerar relat√≥rio ${tipo}: ${error.message}`, 'error');
            }
        }

        function calcularDiasUteis(inicio, fim) {
            try {
                if (!inicio || !fim) {
                    log('Erro: datas inv√°lidas para c√°lculo de dias √∫teis');
                    return 0;
                }

                let diasUteis = 0;
                let data = new Date(inicio);
                const dataFim = new Date(fim);
                
                // Prote√ß√£o contra loop infinito
                let contador = 0;
                const maxIteracoes = 366; // M√°ximo de 1 ano
                
                while (data <= dataFim && contador < maxIteracoes) {
                    if (isDiaUtil(data)) {
                        diasUteis++;
                    }
                    data.setDate(data.getDate() + 1);
                    contador++;
                }
                
                if (contador >= maxIteracoes) {
                    log('Aviso: C√°lculo de dias √∫teis interrompido para evitar loop infinito');
                }
                
                log(`Calculados ${diasUteis} dias √∫teis entre ${inicio.toISOString().split('T')[0]} e ${fim.toISOString().split('T')[0]}`);
                return diasUteis;
                
            } catch (error) {
                log('Erro ao calcular dias √∫teis:', error);
                return 0;
            }
        }

        function renderGraficoSemanal(inicio, fim) {
            try {
                if (!inicio || !fim) {
                    throw new Error('Par√¢metros de data inv√°lidos');
                }

                log(`Gerando gr√°fico semanal para per√≠odo ${inicio.toISOString().split('T')[0]} a ${fim.toISOString().split('T')[0]}`);

                // Dividir o per√≠odo em semanas e calcular produtividade por semana
                const semanas = [];
                let inicioSemana = new Date(inicio);
                
                while (inicioSemana <= fim) {
                    const fimSemana = new Date(inicioSemana);
                    fimSemana.setDate(fimSemana.getDate() + 6);
                    if (fimSemana > fim) {
                        fimSemana.setTime(fim.getTime());
                    }
                    
                    const inicioStr = inicioSemana.toISOString().split('T')[0];
                    const fimStr = fimSemana.toISOString().split('T')[0];
                    
                    const minutasSemana = Object.values(minutas).filter(m => {
                        if (!m || !m.data || m.status === 'excluida') return false;
                        return m.data >= inicioStr && m.data <= fimStr;
                    });
                    
                    // CORRE√á√ÉO: Contar apenas minutas que contam para meta
                    const minutasParaMeta = minutasSemana.filter(m => {
                        const categorias = normalizarCategorias(m);
                        return categorias.some(cat => cat !== 'alem_meta' && cat !== 'seeu');
                    });
                    
                    semanas.push({
                        inicio: new Date(inicioSemana),
                        fim: new Date(fimSemana),
                        total: minutasSemana.length,
                        paraMeta: minutasParaMeta.length,
                        semana: semanas.length + 1
                    });
                    
                    inicioSemana.setDate(inicioSemana.getDate() + 7);
                    
                    // Prote√ß√£o contra loop infinito
                    if (semanas.length > 15) {
                        log('Aviso: Muitas semanas detectadas, limitando a 15');
                        break;
                    }
                }
                
                if (semanas.length === 0) {
                    return `
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
                            <h4 class="text-lg font-semibold text-yellow-800 mb-3">üìà Performance Semanal</h4>
                            <div class="text-yellow-700 text-center py-4">
                                N√£o h√° dados suficientes para gerar o gr√°fico semanal
                            </div>
                        </div>
                    `;
                }
                
                const maxMinutas = Math.max(...semanas.map(s => s.paraMeta), 10); // Usar minutas para meta
                
                log(`Gr√°fico semanal: ${semanas.length} semanas, m√°ximo ${maxMinutas} minutas para meta`);
                
                return `
                    <div class="bg-white border border-gray-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-gray-800 mb-4">üìà Performance Semanal (Minutas para Meta)</h4>
                        <div class="space-y-3">
                            ${semanas.map((semana, index) => {
                                const porcentagem = maxMinutas > 0 ? (semana.paraMeta / maxMinutas) * 100 : 0;
                                const cor = semana.paraMeta >= 50 ? 'bg-green-500' : 
                                           semana.paraMeta >= 25 ? 'bg-yellow-500' : 'bg-red-500';
                                
                                return `
                                    <div class="flex items-center space-x-4">
                                        <div class="w-20 text-sm font-medium text-gray-600">
                                            Sem ${semana.semana}
                                        </div>
                                        <div class="flex-1 bg-gray-200 rounded-full h-6 relative">
                                            <div class="${cor} h-6 rounded-full transition-all duration-300" 
                                                 style="width: ${Math.max(porcentagem, 5)}%"></div>
                                            <div class="absolute inset-0 flex items-center justify-center text-sm font-medium text-white">
                                                ${semana.paraMeta} minutas ${semana.total > semana.paraMeta ? `(+${semana.total - semana.paraMeta})` : ''}
                                            </div>
                                        </div>
                                        <div class="w-24 text-sm text-gray-500">
                                            ${semana.inicio.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })} - ${semana.fim.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="mt-4 text-xs text-gray-500 text-center">
                            ${semanas.reduce((acc, s) => acc + s.paraMeta, 0)} minutas para meta ‚Ä¢ ${semanas.reduce((acc, s) => acc + s.total, 0)} total ‚Ä¢ ${semanas.length} semana${semanas.length !== 1 ? 's' : ''}
                        </div>
                    </div>
                `;
                
            } catch (error) {
                log('Erro ao renderizar gr√°fico semanal:', error);
                
                return `
                    <div class="bg-red-50 border border-red-200 rounded-lg p-6">
                        <h4 class="text-lg font-semibold text-red-800 mb-3">üìà Performance Semanal</h4>
                        <div class="text-red-700 text-center py-4">
                            <i data-lucide="alert-triangle" class="mx-auto h-8 w-8 mb-2"></i>
                            <div>Erro ao gerar gr√°fico: ${error.message}</div>
                            <div class="text-sm mt-2">Os dados do relat√≥rio est√£o completos, apenas o gr√°fico n√£o p√¥de ser exibido.</div>
                        </div>
                    </div>
                `;
            }
        }

        // ==================== MODAIS ====================
        
        function fecharModalEdicao() {
            document.getElementById('modal-edicao').classList.add('hidden');
            minutaEditando = null;
        }

        function fecharModalCorrecao() {
            document.getElementById('modal-correcao').classList.add('hidden');
            minutaCorrecao = null;
        }

        function salvarEdicao() {
            try {
                if (!minutaEditando) {
                    showNotification('Erro: nenhuma minuta selecionada para edi√ß√£o', 'error');
                    return;
                }

                const numeroProcesso = document.getElementById('edit-numero-processo').value.trim();
                const tipoMinuta = document.getElementById('edit-tipo-minuta').value;
                const categoria = document.getElementById('edit-categoria-minuta').value;
                const observacoes = document.getElementById('edit-observacoes-minuta').value.trim();
                const substituicao = document.getElementById('edit-substituicao-checkbox').checked;

                if (!numeroProcesso || !tipoMinuta || !categoria) {
                    showNotification('Por favor, preencha todos os campos obrigat√≥rios', 'warning');
                    return;
                }

                const minuta = minutas[minutaEditando];
                const minutaAtualizada = {
                    ...minuta,
                    numeroProcesso,
                    tipoMinuta,
                    categorias: [categoria], // Atualiza para array
                    observacoes,
                    substituicao,
                    editadaEm: getDataHoraBrasilia().getTime(),
                    editadaPor: currentUser.nome
                };

                if (database) {
                    database.ref(`minutas/${minutaEditando}`).update(minutaAtualizada)
                        .then(() => {
                            showNotification('Minuta editada com sucesso', 'success');
                            fecharModalEdicao();
                            log(`Minuta ${minutaEditando} editada`);
                        })
                        .catch((error) => {
                            minutas[minutaEditando] = minutaAtualizada;
                            showNotification('Minuta editada localmente', 'warning');
                            fecharModalEdicao();
                            renderHistorico();
                        });
                } else {
                    minutas[minutaEditando] = minutaAtualizada;
                    showNotification('Minuta editada localmente', 'warning');
                    fecharModalEdicao();
                    renderHistorico();
                }
                
            } catch (error) {
                log('Erro ao salvar edi√ß√£o:', error);
                showNotification('Erro ao salvar edi√ß√£o', 'error');
            }
        }

        function confirmarCorrecao() {
            try {
                if (!minutaCorrecao) {
                    showNotification('Erro: nenhuma minuta selecionada para corre√ß√£o', 'error');
                    return;
                }

                const correcaoDetalhes = document.getElementById('correcao-detalhes').value.trim();
                if (!correcaoDetalhes) {
                    showNotification('Por favor, especifique a corre√ß√£o necess√°ria', 'warning');
                    return;
                }

                const minuta = minutas[minutaCorrecao];
                const minutaAtualizada = {
                    ...minuta,
                    status: 'correcao',
                    correcaoDetalhes,
                    correcaoSolicitadaEm: getDataHoraBrasilia().getTime(),
                    correcaoSolicitadaPor: currentUser.nome
                };

                if (database) {
                    database.ref(`minutas/${minutaCorrecao}`).update(minutaAtualizada)
                        .then(() => {
                            showNotification('Corre√ß√£o solicitada com sucesso', 'success');
                            fecharModalCorrecao();
                            log(`Corre√ß√£o solicitada para minuta ${minutaCorrecao}`);
                        })
                        .catch((error) => {
                            minutas[minutaCorrecao] = minutaAtualizada;
                            showNotification('Corre√ß√£o solicitada localmente', 'warning');
                            fecharModalCorrecao();
                            renderHistorico();
                        });
                } else {
                    minutas[minutaCorrecao] = minutaAtualizada;
                    showNotification('Corre√ß√£o solicitada localmente', 'warning');
                    fecharModalCorrecao();
                    renderHistorico();
                }
                
            } catch (error) {
                log('Erro ao confirmar corre√ß√£o:', error);
                showNotification('Erro ao solicitar corre√ß√£o', 'error');
            }
        }

        // ==================== CALEND√ÅRIO ====================
        
        function navegarMes(direcao) {
            calendarioData.mesAtual += direcao;
            if (calendarioData.mesAtual > 11) {
                calendarioData.mesAtual = 0;
                calendarioData.anoAtual++;
            } else if (calendarioData.mesAtual < 0) {
                calendarioData.mesAtual = 11;
                calendarioData.anoAtual--;
            }
            renderCalendario();
            log(`Navegando para: ${calendarioData.mesAtual + 1}/${calendarioData.anoAtual}`);
        }

        function irParaHoje() {
            const hoje = getDataHoraBrasilia();
            calendarioData.mesAtual = hoje.getMonth();
            calendarioData.anoAtual = hoje.getFullYear();
            calendarioData.diaSelecionado = getHojeString();
            renderCalendario();
            log('Navegando para hoje');
        }

        function selecionarDia(data) {
            calendarioData.diaSelecionado = data;
            renderCalendario(); // Re-renderizar para atualizar sele√ß√£o
            log(`Dia selecionado: ${data}`);
        }

        // ==================== EVENTOS E INICIALIZA√á√ÉO FINAL ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                log('üöÄ Sistema de Produtividade Judicial iniciando...');

                // Registrar Service Worker para PWA
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.register('/sw.js')
                        .then((registration) => {
                            log('‚úÖ Service Worker registrado com sucesso');

                            // Verificar atualiza√ß√µes
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // Nova vers√£o dispon√≠vel
                                        log('üì± Nova vers√£o do app dispon√≠vel');
                                        if (confirm('Nova vers√£o dispon√≠vel! Deseja atualizar?')) {
                                            window.location.reload();
                                        }
                                    }
                                });
                            });
                        })
                        .catch((error) => {
                            log('‚ö†Ô∏è Erro ao registrar Service Worker: ' + error.message);
                        });
                }

                // Aguardar um pouco para garantir que todos os scripts carreguem
                setTimeout(() => {
                    criarIcones();
                    log('‚úÖ Interface inicializada');
                }, 200);
                
                // Configurar eventos de teclado
                document.addEventListener('keydown', function(e) {
                    // ESC para fechar modais
                    if (e.key === 'Escape') {
                        const modalEdicao = document.getElementById('modal-edicao');
                        const modalCorrecao = document.getElementById('modal-correcao');
                        const modalRelatorioPersonalizado = document.getElementById('modal-relatorio-personalizado');
                        const modalRelatorioBalcao = document.getElementById('modal-relatorio-balcao-personalizado');
                        const modalNotificacoes = document.getElementById('modal-notificacoes');
                        const modalEdicaoPedidoBalcao = document.getElementById('modal-edicao-pedido-balcao');
                        const modalEdicaoProcessoMeta = document.getElementById('modal-edicao-processo-meta');

                        if (modalEdicao && !modalEdicao.classList.contains('hidden')) {
                            fecharModalEdicao();
                        }
                        if (modalCorrecao && !modalCorrecao.classList.contains('hidden')) {
                            fecharModalCorrecao();
                        }
                        if (modalRelatorioPersonalizado && !modalRelatorioPersonalizado.classList.contains('hidden')) {
                            fecharModalRelatorioPersonalizado();
                        }
                        if (modalRelatorioBalcao && !modalRelatorioBalcao.classList.contains('hidden')) {
                            fecharModalRelatorioBalcaoPersonalizado();
                        }
                        if (modalNotificacoes && !modalNotificacoes.classList.contains('hidden')) {
                            fecharModalNotificacoes();
                        }
                        if (modalEdicaoPedidoBalcao && !modalEdicaoPedidoBalcao.classList.contains('hidden')) {
                            fecharModalEdicaoPedidoBalcao();
                        }
                        if (modalEdicaoProcessoMeta && !modalEdicaoProcessoMeta.classList.contains('hidden')) {
                            fecharModalEdicaoProcessoMeta();
                        }
                    }

                    // Ctrl+Enter para confirmar a√ß√µes em modais
                    if (e.ctrlKey && e.key === 'Enter') {
                        const modalEdicao = document.getElementById('modal-edicao');
                        const modalCorrecao = document.getElementById('modal-correcao');
                        const modalRelatorioPersonalizado = document.getElementById('modal-relatorio-personalizado');
                        const modalRelatorioBalcao = document.getElementById('modal-relatorio-balcao-personalizado');
                        const modalEdicaoPedidoBalcao = document.getElementById('modal-edicao-pedido-balcao');
                        const modalEdicaoProcessoMeta = document.getElementById('modal-edicao-processo-meta');

                        if (modalEdicao && !modalEdicao.classList.contains('hidden')) {
                            salvarEdicao();
                        }
                        if (modalCorrecao && !modalCorrecao.classList.contains('hidden')) {
                            confirmarCorrecao();
                        }
                        if (modalRelatorioPersonalizado && !modalRelatorioPersonalizado.classList.contains('hidden')) {
                            gerarRelatorioPersonalizado();
                        }
                        if (modalRelatorioBalcao && !modalRelatorioBalcao.classList.contains('hidden')) {
                            gerarRelatorioBalcaoPersonalizado();
                        }
                        if (modalEdicaoPedidoBalcao && !modalEdicaoPedidoBalcao.classList.contains('hidden')) {
                            salvarEdicaoPedidoBalcao();
                        }
                        if (modalEdicaoProcessoMeta && !modalEdicaoProcessoMeta.classList.contains('hidden')) {
                            salvarEdicaoProcessoMeta();
                        }
                    }
                    
                    // Teclas de atalho para navega√ß√£o (apenas para juiz)
                    if (currentUser && currentUser.isJuiz && e.altKey) {
                        switch(e.key) {
                            case '1':
                                showView('dashboard');
                                e.preventDefault();
                                break;
                            case '2':
                                showView('historico');
                                e.preventDefault();
                                break;
                            case '3':
                                showView('calendario');
                                e.preventDefault();
                                break;
                            case '4':
                                showView('relatorios');
                                e.preventDefault();
                                break;
                        }
                    }
                });
                
                // Detectar quando a p√°gina perde o foco (para salvar dados se necess√°rio)
                window.addEventListener('beforeunload', function(e) {
                    log('P√°gina sendo fechada/recarregada');
                    // N√£o fazer nada especial aqui por enquanto
                });
                
                // Detectar mudan√ßas de conectividade
                window.addEventListener('online', function() {
                    log('üåê Conex√£o restaurada');
                    showNotification('Conex√£o com a internet restaurada', 'success');
                });
                
                window.addEventListener('offline', function() {
                    log('üîå Conex√£o perdida');
                    showNotification('Conex√£o perdida - funcionando em modo offline', 'warning');
                });
                
                log('‚úÖ Sistema carregado e pronto para uso');
                
            } catch (error) {
                log('‚ùå Erro na inicializa√ß√£o da p√°gina:', error);
                console.error('Erro detalhado:', error);
                showNotification('Erro na inicializa√ß√£o do sistema', 'error');
            }
        });

        // ==================== FUN√á√ïES UTILIT√ÅRIAS FINAIS ====================
        
        // Fun√ß√£o para debug - mostrar estado atual do sistema
        function debugSystem() {
            if (typeof console !== 'undefined') {
                console.group('üîç Debug do Sistema');
                console.log('üë§ Usu√°rio atual:', currentUser);
                console.log('üìÑ Total de minutas:', Object.keys(minutas).length);
                console.log('üë• Assessores:', assessores);
                console.log('üéØ View atual:', currentView);
                console.log('üî• Firebase ativo:', !!database);
                console.log('üìÖ Data atual:', getHojeString());
                console.log('üïê Data/hora Bras√≠lia:', getDataHoraBrasilia());
                console.groupEnd();
            }
        }

        // Fun√ß√£o espec√≠fica para debug de relat√≥rios
        function debugRelatorios(tipo) {
            try {
                console.group(`üìä Debug Relat√≥rio ${tipo}`);
                
                const hoje = getDataHoraBrasilia();
                console.log('Data atual:', hoje);
                
                let inicio, fim;
                if (tipo === 'semanal') {
                    inicio = getInicioSemana(hoje);
                    fim = getFimSemana(hoje);
                } else if (tipo === 'mensal') {
                    inicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    fim = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0);
                }
                
                console.log('Per√≠odo:', {
                    inicio: inicio?.toISOString(),
                    fim: fim?.toISOString()
                });
                
                const minutasNoSistema = Object.values(minutas);
                console.log('Minutas no sistema:', minutasNoSistema.length);
                
                if (minutasNoSistema.length > 0) {
                    console.log('Primeira minuta:', minutasNoSistema[0]);
                    console.log('√öltima minuta:', minutasNoSistema[minutasNoSistema.length - 1]);
                }
                
                const inicioStr = inicio?.toISOString().split('T')[0];
                const fimStr = fim?.toISOString().split('T')[0];
                
                const minutasFiltradas = minutasNoSistema.filter(m => {
                    if (!m || !m.data) return false;
                    const dentroPer√≠odo = m.data >= inicioStr && m.data <= fimStr;
                    const naoExcluida = m.status !== 'excluida';
                    return dentroPer√≠odo && naoExcluida;
                });
                
                console.log('Minutas no per√≠odo:', minutasFiltradas.length);
                console.log('Minutas filtradas:', minutasFiltradas);
                
                console.groupEnd();
                
                return {
                    totalMinutas: minutasNoSistema.length,
                    minutasPer√≠odo: minutasFiltradas.length,
                    per√≠odo: { inicio, fim }
                };
                
            } catch (error) {
                console.error('Erro no debug de relat√≥rios:', error);
                return null;
            }
        }

        // Fun√ß√£o para limpar dados (apenas para desenvolvimento)
        function limparDados() {
            if (confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° limpar todos os dados! Confirma?')) {
                minutas = {};
                if (database) {
                    database.ref('minutas').remove()
                        .then(() => {
                            showNotification('Dados limpos com sucesso', 'success');
                            if (currentView === 'dashboard') renderDashboard();
                        })
                        .catch(() => {
                            showNotification('Dados limpos localmente', 'warning');
                            if (currentView === 'dashboard') renderDashboard();
                        });
                } else {
                    showNotification('Dados limpos localmente', 'warning');
                    if (currentView === 'dashboard') renderDashboard();
                }
                log('üóëÔ∏è Dados do sistema limpos');
            }
        }

        // Tornar fun√ß√µes de debug dispon√≠veis globalmente (apenas em desenvolvimento)
        if (typeof window !== 'undefined') {
            window.debugSystem = debugSystem;
            window.debugRelatorios = debugRelatorios;
            window.limparDados = limparDados;
            
            // Fun√ß√£o de teste para relat√≥rios
            window.testarRelatorio = function(tipo = 'mensal') {
                console.log(`üß™ Testando relat√≥rio ${tipo}...`);
                const debug = debugRelatorios(tipo);
                if (debug && debug.totalMinutas > 0) {
                    console.log('‚úÖ Dados dispon√≠veis, gerando relat√≥rio...');
                    gerarRelatorio(tipo);
                } else {
                    console.log('‚ùå Sem dados suficientes para o relat√≥rio');
                    console.log('üí° Executando inicializarDadosDemo()...');
                    inicializarDadosDemo();
                    setTimeout(() => {
                        console.log('üîÑ Tentando novamente...');
                        gerarRelatorio(tipo);
                    }, 1000);
                }
            };
        }

        // Log final
        log('üìã Sistema de Produtividade Judicial v4.2 - ERRO DEFINITIVAMENTE CORRIGIDO! ‚úÖ');
        log('üéØ Corre√ß√µes aplicadas:');
        log('  1. ‚úÖ setupHistoricoFilters movida para local definitivo (junto com setupNavigation)');
        log('  2. ‚úÖ Todas as duplica√ß√µes removidas');
        log('  3. ‚úÖ Ordem de defini√ß√£o das fun√ß√µes corrigida');
        log('  4. ‚úÖ Filtros de hist√≥rico totalmente funcionais');
        log('  5. ‚úÖ Sistema robusto implementado');
        
        // Aviso sobre fun√ß√µes de debug dispon√≠veis
        if (typeof console !== 'undefined') {
            console.log('üõ†Ô∏è  Fun√ß√µes de debug dispon√≠veis:');
            console.log('   ‚Ä¢ debugSystem() - Estado geral do sistema');
            console.log('   ‚Ä¢ debugRelatorios(tipo) - Debug espec√≠fico de relat√≥rios');
            console.log('   ‚Ä¢ testarRelatorio(tipo) - Testar gera√ß√£o de relat√≥rios');
            console.log('   ‚Ä¢ limparDados() - Limpar todos os dados');
            console.log('   üÜï setupHistoricoFilters agora est√° no local correto!');
        }
    </script>
</body>
</html>
