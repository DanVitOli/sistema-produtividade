<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Produtividade Judicial</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-pendente { background-color: #fef3c7; color: #92400e; }
        .status-assinada { background-color: #d1fae5; color: #065f46; }
        .status-excluida { background-color: #fee2e2; color: #991b1b; }
        .status-correcao { background-color: #dbeafe; color: #1e40af; }
        .status-badge {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
        }
        .calendar-day {
            min-height: 40px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 4px;
        }
        .calendar-day:hover {
            background-color: #f3f4f6;
        }
        .calendar-day.today {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .calendar-day.selected {
            background-color: #1d4ed8;
            color: white;
        }
        .calendar-day.has-data {
            background-color: #f0fdf4;
            border-color: #22c55e;
        }
        .calendar-day.has-data.selected {
            background-color: #15803d;
        }
        .calendar-day.other-month {
            color: #9ca3af;
            background-color: #f9fafb;
        }
        .productivity-indicator {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #22c55e;
        }
        .day-number {
            font-size: 0.875rem;
            font-weight: 500;
        }
        .day-count {
            font-size: 0.75rem;
            text-align: center;
            background-color: rgba(34, 197, 94, 0.1);
            border-radius: 4px;
            padding: 1px 3px;
            margin-top: 2px;
        }
        .meta10-alert {
            animation: pulse 2s infinite;
            border-left: 4px solid #ef4444;
        }
        .meta10-success {
            border-left: 4px solid #22c55e;
        }
        .meta2-alert {
            animation: pulse 2s infinite;
            border-left: 4px solid #dc2626;
        }
        .meta2-success {
            border-left: 4px solid #16a34a;
        }
        .week-indicator {
            position: absolute;
            top: 2px;
            left: 2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        .week-success { background-color: #22c55e; }
        .week-warning { background-color: #f59e0b; }
        .week-danger { background-color: #ef4444; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Indicador de Conexão -->
    <div id="connection-status" class="fixed top-4 right-4 z-50 no-print">
        <div class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium">
            Carregando...
        </div>
    </div>

    <!-- Tela de Login -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-lg p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <div class="mx-auto h-16 w-16 bg-blue-100 rounded-full flex items-center justify-center mb-4">
                    <i data-lucide="scale" class="h-8 w-8 text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 mb-2">Sistema de Produtividade Judicial</h1>
                <p class="text-gray-600">Digite suas credenciais para acessar</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                    <select id="login-usuario" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Selecione o usuário</option>
                        <option value="juiz">Juiz</option>
                        <option value="gilbert">Gilbert Juliano</option>
                        <option value="laise">Laíse Vital</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="login-senha" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite sua senha">
                </div>
                
                <button onclick="fazerLogin()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                    <i data-lucide="log-in" class="h-5 w-5 mr-2 inline"></i>
                    Entrar
                </button>
            </div>
        </div>
    </div>

    <!-- Aplicação Principal -->
    <div id="main-app" class="hidden p-4 max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-2xl font-bold text-gray-800">Sistema de Produtividade Judicial</h1>
                    <p id="user-info" class="text-gray-600"></p>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600 transition-colors flex items-center">
                    <i data-lucide="log-out" class="h-4 w-4 mr-2"></i>
                    Sair
                </button>
            </div>
            
            <!-- Navegação -->
            <div id="navigation" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard-view" class="hidden space-y-6"></div>

        <!-- Registro de Minuta -->
        <div id="registro-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center mb-6">
                    <i data-lucide="plus" class="h-6 w-6 text-blue-600 mr-2"></i>
                    <h2 class="text-xl font-semibold text-gray-800">Registrar Nova Minuta</h2>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Número do Processo *</label>
                        <input type="text" id="numero-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: 1234567-89.2024.8.12.3456">
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Minuta *</label>
                            <select id="tipo-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="validarTipoMinuta()">
                                <option value="">Selecione o tipo</option>
                                <option value="Despacho">Despacho</option>
                                <option value="Decisão">Decisão</option>
                                <option value="Sentença">Sentença</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Categorias/Metas Aplicáveis *</label>
                            <div class="text-xs text-gray-600 mb-2">
                                ℹ️ Selecione todas as categorias que se aplicam a esta minuta. Para a meta diária, contará como 1 única minuta.
                            </div>
                            <div class="space-y-2 border border-gray-300 rounded-md p-3 bg-gray-50" id="categorias-container">
                                <label class="flex items-center">
                                    <input type="checkbox" name="categorias" value="meta1" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Meta 1 CNJ (2/dia)</span>
                                </label>
                                <label class="flex items-center" id="meta2-checkbox" style="display: none;">
                                    <input type="checkbox" name="categorias" value="meta2" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Meta 2 CNJ (1 sentença/semana)</span>
                                </label>
                                <label class="flex items-center" id="meta10-checkbox" style="display: none;">
                                    <input type="checkbox" name="categorias" value="meta10" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Meta 10 CNJ (1/semana)</span>
                                </label>
                                <label class="flex items-center" id="seeu-checkbox" style="display: none;">
                                    <input type="checkbox" name="categorias" value="seeu" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">SEEU - Execução Penal (controle de acesso)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="categorias" value="sem_movimento" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Sem movimentação 100+ dias (5/dia)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="categorias" value="outros" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Pedidos/Atos/Urgentes (3/dia)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="checkbox" name="categorias" value="alem_meta" class="mr-2 h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                    <span class="text-sm">Além da Meta (produtividade adicional)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                        <textarea id="observacoes-minuta" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Comentários sobre a minuta (opcional)"></textarea>
                    </div>
                    
                    <button onclick="registrarMinuta()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-md hover:bg-blue-700 transition-colors font-medium">
                        <i data-lucide="save" class="h-5 w-5 mr-2 inline"></i>
                        Registrar Minuta
                    </button>
                    
                    <div class="text-xs text-gray-500 text-center mt-2 bg-gray-50 p-2 rounded">
                        ℹ️ Minutas registradas contam automaticamente para a produtividade. O juiz pode excluí-las da contagem posteriormente se necessário.<br>
                        📋 <strong>Nota:</strong> SEEU é apenas controle de acesso e não conta para a meta diária de 10 minutas.
                    </div>
                </div>
            </div>
        </div>

        <!-- Histórico -->
        <div id="historico-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="clock" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Histórico de Minutas</h2>
                    </div>
                    <div id="historico-filters" class="flex gap-2 no-print"></div>
                </div>
                <div id="historico-content"></div>
            </div>
        </div>

        <!-- Calendário -->
        <div id="calendario-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="calendar-days" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Calendário de Produtividade</h2>
                    </div>
                    <div class="flex items-center gap-2 no-print">
                        <button onclick="navegarMes(-1)" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                            <i data-lucide="chevron-left" class="h-5 w-5"></i>
                        </button>
                        <span id="calendario-mes-ano" class="text-lg font-medium px-4"></span>
                        <button onclick="navegarMes(1)" class="p-2 rounded-md hover:bg-gray-100 transition-colors">
                            <i data-lucide="chevron-right" class="h-5 w-5"></i>
                        </button>
                        <button onclick="irParaHoje()" class="ml-4 bg-blue-500 text-white px-3 py-1 rounded-md hover:bg-blue-600 transition-colors text-sm">
                            Hoje
                        </button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Calendário -->
                    <div class="space-y-4">
                        <!-- Cabeçalho dos dias da semana -->
                        <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600">
                            <div class="py-2">Dom</div>
                            <div class="py-2">Seg</div>
                            <div class="py-2">Ter</div>
                            <div class="py-2">Qua</div>
                            <div class="py-2">Qui</div>
                            <div class="py-2">Sex</div>
                            <div class="py-2">Sáb</div>
                        </div>
                        
                        <!-- Dias do calendário -->
                        <div id="calendario-dias" class="grid grid-cols-7 gap-1"></div>
                        
                        <!-- Legenda -->
                        <div class="mt-4 text-xs text-gray-600 space-y-1">
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-200 border border-blue-400 rounded"></div>
                                <span>Hoje</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-green-50 border border-green-500 rounded"></div>
                                <span>Dias com produtividade</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-4 h-4 bg-blue-800 rounded"></div>
                                <span>Dia selecionado</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                                <span>Meta 10 cumprida na semana</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                                <span>Meta 10 não cumprida</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 bg-teal-500 rounded-full"></div>
                                <span>SEEU acessado</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detalhes do dia selecionado -->
                    <div id="calendario-detalhes" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <i data-lucide="calendar-check" class="mx-auto h-12 w-12 text-gray-300 mb-4"></i>
                            <p>Clique em um dia para ver os detalhes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relatórios -->
        <div id="relatorios-view" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center">
                        <i data-lucide="bar-chart" class="h-6 w-6 text-gray-600 mr-2"></i>
                        <h2 class="text-xl font-semibold text-gray-800">Relatórios de Produtividade</h2>
                    </div>
                    <div class="flex gap-2 no-print">
                        <button onclick="gerarRelatorio('semanal')" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition-colors text-sm">
                            <i data-lucide="calendar-week" class="h-4 w-4 mr-1 inline"></i>
                            Relatório Semanal
                        </button>
                        <button onclick="gerarRelatorio('mensal')" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition-colors text-sm">
                            <i data-lucide="calendar-month" class="h-4 w-4 mr-1 inline"></i>
                            Relatório Mensal
                        </button>
                        <button onclick="window.print()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition-colors text-sm">
                            <i data-lucide="printer" class="h-4 w-4 mr-1 inline"></i>
                            Imprimir
                        </button>
                    </div>
                </div>
                <div id="relatorio-content"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Correção -->
    <div id="modal-correcao" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalCorrecao()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <i data-lucide="edit" class="h-5 w-5 text-blue-600 mr-2"></i>
                    Solicitar Correção
                </h3>
                <button onclick="fecharModalCorrecao()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="text-sm text-blue-800">
                        <div class="font-medium" id="modal-correcao-processo">Processo: </div>
                        <div class="text-xs mt-1" id="modal-correcao-assessor">Assessor: </div>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Especifique a correção necessária: *
                    </label>
                    <textarea 
                        id="correcao-detalhes" 
                        rows="4" 
                        class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                        placeholder="Descreva detalhadamente o que precisa ser corrigido nesta minuta..."
                    ></textarea>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="confirmarCorrecao()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        <i data-lucide="check" class="h-4 w-4 mr-1 inline"></i>
                        Solicitar Correção
                    </button>
                    <button onclick="fecharModalCorrecao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
                
                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">💡 Ctrl+Enter: Confirmar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="modal-edicao" class="hidden modal-overlay no-print" onclick="event.target === this && fecharModalEdicao()">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Editar Minuta</h3>
                <button onclick="fecharModalEdicao()" class="text-gray-500 hover:text-gray-700">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Número do Processo *</label>
                    <input type="text" id="edit-numero-processo" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Minuta *</label>
                    <select id="edit-tipo-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="validarTipoMinutaEdicao()">
                        <option value="Despacho">Despacho</option>
                        <option value="Decisão">Decisão</option>
                        <option value="Sentença">Sentença</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Categoria *</label>
                    <select id="edit-categoria-minuta" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="meta1">Meta 1 CNJ</option>
                        <option value="meta2">Meta 2 CNJ</option>
                        <option value="meta10" id="edit-meta10-option" class="hidden">Meta 10 CNJ</option>
                        <option value="seeu" id="edit-seeu-option" class="hidden">SEEU - Execução Penal (controle)</option>
                        <option value="sem_movimento">Sem movimentação 100+ dias</option>
                        <option value="outros">Pedidos/Atos/Urgentes</option>
                        <option value="alem_meta">Além da Meta (produtividade adicional)</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Observações</label>
                    <textarea id="edit-observacoes-minuta" rows="3" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                
                <div class="flex gap-2 pt-4">
                    <button onclick="salvarEdicao()" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors">
                        <i data-lucide="save" class="h-4 w-4 mr-1 inline"></i>
                        Salvar
                    </button>
                    <button onclick="fecharModalEdicao()" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400 transition-colors">
                        Cancelar
                    </button>
                </div>
                
                <div class="text-xs text-gray-500 text-center">
                    <span class="mr-4">💡 Ctrl+Enter: Salvar</span>
                    <span>ESC: Cancelar</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURAÇÃO ====================
        
        const firebaseConfig = {
            apiKey: "AIzaSyCzuoRgbvKQSjOFssde-qUEtNDqGNJML7E",
            authDomain: "produtividade-gabinete.firebaseapp.com",
            databaseURL: "https://produtividade-gabinete-default-rtdb.firebaseio.com",
            projectId: "produtividade-gabinete",
            storageBucket: "produtividade-gabinete.firebasestorage.app",
            messagingSenderId: "370364917935",
            appId: "1:370364917935:web:a6205cc718748abcbdcc5a"
        };

        // Credenciais seguras
        const credenciais = {
            'juiz': { senha: 'Juiz@2024!', nome: 'Juiz', tipo: 'juiz' },
            'gilbert': { senha: 'Gilbert@2024!', nome: 'Gilbert Juliano', tipo: 'assessor', assessorId: 'gilbert' },
            'laise': { senha: 'Laise@2024!', nome: 'Laíse Vital', tipo: 'assessor', assessorId: 'laise' }
        };

        const categorias = {
            'meta1': { nome: 'Meta 1 CNJ', cor: 'bg-red-500', meta: 2 },
            'meta2': { nome: 'Meta 2 CNJ', cor: 'bg-pink-500', meta: 1, semanal: true, requerSentenca: true },
            'meta10': { 
                nome: 'Meta 10 CNJ (minutar semanalmente)', 
                cor: 'bg-purple-500', 
                meta: 1, 
                semanal: true, 
                explicacao: 'Minutar semanalmente em qualquer dos 9 processos mais antigos para impulsionar julgamentos'
            },
            'seeu': { nome: 'SEEU - Execução Penal (controle de acesso)', cor: 'bg-teal-500', meta: 1, prazo: 10, naoContaParaMeta: true },
            'sem_movimento': { nome: 'Sem movimentação 100+ dias', cor: 'bg-orange-500', meta: 5 },
            'outros': { nome: 'Pedidos/Atos/Urgentes', cor: 'bg-blue-500', meta: 3 },
            'alem_meta': { nome: 'Além da Meta (produtividade adicional)', cor: 'bg-gray-500', meta: 0, semMeta: true, naoContaParaMeta: true }
        };

        const statusOptions = {
            'pendente': { nome: 'Pendente', cor: 'status-pendente' },
            'assinada': { nome: 'Assinada', cor: 'status-assinada' },
            'excluida': { nome: 'Excluída', cor: 'status-excluida' },
            'correcao': { nome: 'Precisa Correção', cor: 'status-correcao' }
        };

        // ==================== ESTADO GLOBAL ====================
        
        let firebase, database;
        let currentUser = null;
        let currentView = 'dashboard';
        let minutas = {};
        let minutaEditando = null;
        let minutaCorrecao = null;
        let calendarioData = {
            mesAtual: getDataHoraBrasilia().getMonth(),
            anoAtual: getDataHoraBrasilia().getFullYear(),
            diaSelecionado: null
        };
        let assessores = {
            gilbert: { nome: 'Gilbert Juliano', ativo: true },
            laise: { nome: 'Laíse Vital', ativo: true }
        };

        // ==================== UTILITÁRIOS ====================
        
        function isDiaUtil(data) {
            const dataParaVerificar = data || getDataHoraBrasilia();
            const dia = dataParaVerificar.getDay();
            return dia >= 1 && dia <= 5;
        }

        function getHojeString() {
            const agora = new Date();
            const brasiliaOffset = -3;
            const utc = agora.getTime() + (agora.getTimezoneOffset() * 60000);
            const brasilia = new Date(utc + (brasiliaOffset * 3600000));
            
            const ano = brasilia.getFullYear();
            const mes = String(brasilia.getMonth() + 1).padStart(2, '0');
            const dia = String(brasilia.getDate()).padStart(2, '0');
            
            return `${ano}-${mes}-${dia}`;
        }

        function getDataHoraBrasilia() {
            const agora = new Date();
            const brasiliaOffset = -3;
            const utc = agora.getTime() + (agora.getTimezoneOffset() * 60000);
            const brasilia = new Date(utc + (brasiliaOffset * 3600000));
            
            return brasilia;
        }

        function getInicioSemana(data) {
            const d = new Date(data);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }

        function getFimSemana(data) {
            const inicio = getInicioSemana(data);
            const fim = new Date(inicio);
            fim.setDate(inicio.getDate() + 6);
            return fim;
        }

        function getNumeroSemana(data) {
            const d = new Date(data);
            const inicio = new Date(d.getFullYear(), 0, 1);
            return Math.ceil(((d - inicio) / 86400000 + inicio.getDay() + 1) / 7);
        }

        function log(message, data = null) {
            const brasilia = getDataHoraBrasilia();
            const timestamp = brasilia.toLocaleTimeString('pt-BR');
            console.log(`[${timestamp} BRT] ${message}`, data || '');
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500',
                warning: 'bg-yellow-500'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 left-1/2 transform -translate-x-1/2 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.transform = 'translate(-50%, -100px)';
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function validarTipoMinuta() {
            const tipoMinuta = document.getElementById('tipo-minuta').value;
            const meta2Checkbox = document.getElementById('meta2-checkbox');
            
            if (tipoMinuta === 'Sentença') {
                meta2Checkbox.style.display = 'block';
            } else {
                meta2Checkbox.style.display = 'none';
                const meta2Input = meta2Checkbox.querySelector('input[value="meta2"]');
                if (meta2Input) meta2Input.checked = false;
            }
        }

        function validarTipoMinutaEdicao() {
            const tipoMinuta = document.getElementById('edit-tipo-minuta').value;
            const meta2Option = document.getElementById('edit-categoria-minuta').querySelector('option[value="meta2"]');
            
            if (tipoMinuta === 'Sentença') {
                meta2Option.style.display = 'block';
            } else {
                meta2Option.style.display = 'none';
                const selectCategoria = document.getElementById('edit-categoria-minuta');
                if (selectCategoria.value === 'meta2') {
                    selectCategoria.value = 'meta1';
                }
            }
        }

        // ==================== AUTENTICAÇÃO ====================
        
        function fazerLogin() {
            const usuario = document.getElementById('login-usuario').value;
            const senha = document.getElementById('login-senha').value;

            if (!usuario || !senha) {
                showNotification('Por favor, selecione o usuário e digite a senha.', 'warning');
                return;
            }

            const cred = credenciais[usuario];
            if (!cred || cred.senha !== senha) {
                showNotification('Usuário ou senha incorretos.', 'error');
                return;
            }

            currentUser = {
                usuario: usuario,
                nome: cred.nome,
                tipo: cred.tipo,
                isJuiz: cred.tipo === 'juiz',
                assessorId: cred.assessorId
            };

            log('Login realizado', currentUser.nome);
            
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            setTimeout(() => {
                showNotification('🕐 Sistema ajustado para o Horário de Brasília. Minutas agora são registradas com data/hora corretas!', 'info');
            }, 1000);
            
            initializeApp();
        }

        function logout() {
            log('Logout realizado', currentUser?.nome);
            currentUser = null;
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-usuario').value = '';
            document.getElementById('login-senha').value = '';
        }

        function initializeApp() {
            try {
                try {
                    firebase = window.firebase;
                    firebase.initializeApp(firebaseConfig);
                    database = firebase.database();
                    
                    firebase.auth().signInAnonymously()
                        .then(() => {
                            console.log('✅ Firebase autenticado com sucesso');
                            
                            setupUserInfo();
                            setupNavigation();
                            setupMeta10Options();
                            if (database) setupFirebaseListeners();
                            showView('dashboard');
                            
                            log('Aplicação inicializada com sucesso');
                        })
                        .catch((error) => {
                            console.error('❌ Erro na autenticação:', error);
                            setupUserInfo();
                            setupNavigation();
                            setupMeta10Options();
                            showView('dashboard');
                            log('Aplicação inicializada sem autenticação Firebase');
                        });
                        
                } catch (error) {
                    log('Firebase não disponível - modo offline', error);
                    database = null;
                    setupUserInfo();
                    setupNavigation();
                    setupMeta10Options();
                    showView('dashboard');
                }
                
            } catch (error) {
                log('Erro na inicialização', error);
                showNotification('Erro ao inicializar aplicação', 'error');
            }
        }

        function setupUserInfo() {
            document.getElementById('user-info').textContent = `Logado como: ${currentUser.nome}`;
        }

        function setupMeta10Options() {
            const meta10Checkbox = document.getElementById('meta10-checkbox');
            const editMeta10Option = document.getElementById('edit-meta10-option');
            
            const seuCheckbox = document.getElementById('seeu-checkbox');
            const editSeuOption = document.getElementById('edit-seeu-option');
            
            if (currentUser.assessorId === 'gilbert') {
                meta10Checkbox?.style.setProperty('display', 'block');
                editMeta10Option?.classList.remove('hidden');
                seuCheckbox?.style.setProperty('display', 'none');
                editSeuOption?.classList.add('hidden');
            } else if (currentUser.assessorId === 'laise') {
                meta10Checkbox?.style.setProperty('display', 'none');
                editMeta10Option?.classList.add('hidden');
                seuCheckbox?.style.setProperty('display', 'block');
                editSeuOption?.classList.remove('hidden');
            } else {
                meta10Checkbox?.style.setProperty('display', 'none');
                editMeta10Option?.classList.add('hidden');
                seuCheckbox?.style.setProperty('display', 'none');
                editSeuOption?.classList.add('hidden');
            }
        }

        function setupNavigation() {
            const nav = document.getElementById('navigation');
            let buttons = '';

            buttons += `
                <button onclick="showView('dashboard')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-blue-600 text-white">
                    <i data-lucide="bar-chart-3" class="h-4 w-4 mr-2"></i>
                    Dashboard
                </button>
            `;

            if (!currentUser.isJuiz) {
                buttons += `
                    <button onclick="showView('registro')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                        Registrar Minuta
                    </button>
                `;
            }

            buttons += `
                <button onclick="showView('historico')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                    <i data-lucide="clock" class="h-4 w-4 mr-2"></i>
                    Histórico
                </button>
            `;

            if (currentUser.isJuiz) {
                buttons += `
                    <button onclick="showView('calendario')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="calendar-days" class="h-4 w-4 mr-2"></i>
                        Calendário
                    </button>
                    <button onclick="showView('relatorios')" class="nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
                        <i data-lucide="bar-chart" class="h-4 w-4 mr-2"></i>
                        Relatórios
                    </button>
                `;
            }

            nav.innerHTML = buttons;
            lucide.createIcons();
        }

        function showView(view) {
            try {
                log(`Navegando para: ${view}`);
                
                document.querySelectorAll('[id$="-view"]').forEach(el => {
                    if (el) el.classList.add('hidden');
                });

                document.querySelectorAll('.nav-btn').forEach(btn => {
                    if (btn) {
                        btn.className = 'nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200';
                    }
                });

                const activeBtn = event?.target?.closest('button');
                if (activeBtn) {
                    activeBtn.className = 'nav-btn flex items-center px-4 py-2 rounded-md font-medium transition-colors bg-blue-600 text-white';
                }

                currentView = view;

                switch(view) {
                    case 'dashboard':
                        renderDashboard();
                        break;
                    case 'registro':
                        document.getElementById('registro-view')?.classList.remove('hidden');
                        break;
                    case 'historico':
                        setupHistoricoFilters();
                        renderHistorico();
                        break;
                    case 'calendario':
                        renderCalendario();
                        break;
                    case 'relatorios':
                        document.getElementById('relatorios-view')?.classList.remove('hidden');
                        break;
                }

                log(`View ${view} carregada`);
                
            } catch (error) {
                log(`Erro ao carregar view ${view}`, error);
                showNotification(`Erro ao carregar ${view}`, 'error');
            }
        }

        // ==================== FIREBASE ====================
        
        function setupFirebaseListeners() {
            try {
                database.ref('minutas').on('value', (snapshot) => {
                    minutas = snapshot.val() || {};
                    log(`Minutas carregadas: ${Object.keys(minutas).length}`);
                    
                    if (currentView === 'dashboard') renderDashboard();
                    if (currentView === 'historico') renderHistorico();
                    if (currentView === 'calendario') renderCalendario();
                });

                database.ref('assessores').on('value', (snapshot) => {
                    const assessoresFirebase = snapshot.val();
                    if (assessoresFirebase) {
                        assessores = { ...assessores, ...assessoresFirebase };
                        log('Assessores atualizados');
                    }
                });

                database.ref('assessores').once('value', (snapshot) => {
                    if (!snapshot.exists()) {
                        database.ref('assessores').set(assessores);
                        log('Dados iniciais dos assessores criados');
                    }
                });

                database.ref('.info/connected').on('value', (snapshot) => {
                    const connected = snapshot.val();
                    const statusDiv = document.getElementById('connection-status');
                    
                    if (statusDiv) {
                        statusDiv.innerHTML = connected ? 
                            `<div class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium flex items-center">
                                <div class="w-2 h-2 bg-white rounded-full mr-2 pulse"></div>
                                Online
                            </div>` :
                            `<div class="bg-orange-500 text-white px-3 py-1 rounded-full text-sm font-medium">
                                Offline
                            </div>`;
                    }
                });

                log('Firebase configurado com sucesso');
                
            } catch (error) {
                log('Erro no Firebase - modo local ativado', error);
                
                const statusDiv = document.getElementById('connection-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `
                        <div class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm font-medium">
                            Modo Local
                        </div>
                    `;
                }
            }
        }

        // ==================== REGISTRO DE MINUTAS ====================
        
        function registrarMinuta() {
            const numeroProcesso = document.getElementById('numero-processo').value.trim();
            const tipoMinuta = document.getElementById('tipo-minuta').value;
            const observacoes = document.getElementById('observacoes-minuta').value.trim();
            
            const categoriasCheckboxes = document.querySelectorAll('input[name="categorias"]:checked');
            const categoriasSelecionadas = Array.from(categoriasCheckboxes).map(cb => cb.value);

            if (!numeroProcesso || !tipoMinuta || categoriasSelecionadas.length === 0) {
                showNotification('Por favor, preencha todos os campos obrigatórios e selecione pelo menos uma categoria.', 'warning');
                return;
            }

            if (categoriasSelecionadas.includes('meta2') && tipoMinuta !== 'Sentença') {
                showNotification('Meta 2 CNJ aceita apenas minutas de Sentença.', 'error');
                return;
            }

            if (categoriasSelecionadas.includes('meta10') && currentUser.assessorId !== 'gilbert') {
                showNotification('Apenas Gilbert pode registrar minutas da Meta 10 CNJ.', 'error');
                return;
            }

            if (categoriasSelecionadas.includes('seeu') && currentUser.assessorId !== 'laise') {
                showNotification('Apenas Laíse pode registrar minutas do SEEU.', 'error');
                return;
            }

            const novaMinuta = {
                assessorId: currentUser.assessorId,
                assessorNome: currentUser.nome,
                numeroProcesso,
                tipoMinuta,
                categorias: categoriasSelecionadas,
                observacoes,
                status: 'pendente',
                data: getHojeString(),
                timestamp: getDataHoraBrasilia().toLocaleTimeString('pt-BR'),
                createdAt: getDataHoraBrasilia().getTime()
            };

            try {
                if (database) {
                    database.ref('minutas').push({
                        ...novaMinuta,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    }).then(() => {
                        limparFormularioRegistro();
                        
                        let mensagem = 'Minuta registrada com sucesso!';
                        let tipo = 'success';
                        
                        if (categoriasSelecionadas.includes('meta2')) {
                            mensagem = '🎯 Sentença da Meta 2 CNJ registrada! Meta semanal cumprida!';
                        } else if (categoriasSelecionadas.includes('meta10')) {
                            mensagem = '✨ Minuta da Meta 10 CNJ registrada! Meta semanal cumprida!';
                        } else if (categoriasSelecionadas.includes('seeu')) {
                            mensagem = '🛡️ Acesso ao SEEU registrado! Controle de 10 dias cumprido (não conta para meta diária).';
                        } else if (categoriasSelecionadas.includes('alem_meta')) {
                            mensagem = '➕ Minuta "Além da Meta" registrada! Produtividade adicional contabilizada (não conta para meta diária).';
                        }
                        
                        if (categoriasSelecionadas.length > 1) {
                            mensagem += ` Aplicada a ${categoriasSelecionadas.length} categorias.`;
                        }
                        
                        showNotification(mensagem, tipo);
                        showView('dashboard');
                        log('Minuta registrada no Firebase', numeroProcesso + ' - Categorias: ' + categoriasSelecionadas.join(', '));
                    }).catch(() => {
                        salvarMinutaLocal(novaMinuta);
                    });
                } else {
                    salvarMinutaLocal(novaMinuta);
                }
                
            } catch (error) {
                salvarMinutaLocal(novaMinuta);
            }
        }

        function salvarMinutaLocal(minuta) {
            const id = 'local_' + getDataHoraBrasilia().getTime();
            minutas[id] = minuta;
            
            limparFormularioRegistro();
            showNotification('Minuta registrada localmente!', 'warning');
            showView('dashboard');
            log('Minuta salva localmente', minuta.numeroProcesso);
        }

        function limparFormularioRegistro() {
            document.getElementById('numero-processo').value = '';
            document.getElementById('tipo-minuta').value = '';
            document.getElementById('observacoes-minuta').value = '';
            
            const categoriasCheckboxes = document.querySelectorAll('input[name="categorias"]');
            categoriasCheckboxes.forEach(cb => cb.checked = false);
            
            validarTipoMinuta();
        }

        // ==================== RENDERIZAÇÃO (PLACEHOLDER) ====================
        
        function renderDashboard() {
            try {
                const dashboard = document.getElementById('dashboard-view');
                if (!dashboard) return;

                dashboard.innerHTML = `
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Dashboard</h2>
                        <p>Sistema funcionando! Firebase Auth carregado com sucesso.</p>
                        <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded">
                            <p class="text-green-800">✅ Firebase autenticado e funcionando</p>
                            <p class="text-green-800">✅ Dados seguros com regras aplicadas</p>
                        </div>
                    </div>
                `;
                
                dashboard.classList.remove('hidden');
                setTimeout(() => lucide.createIcons(), 100);
                
            } catch (error) {
                log('Erro ao renderizar dashboard', error);
            }
        }

        function renderHistorico() {
            const historico = document.getElementById('historico-view');
            if (!historico) return;
            
            historico.classList.remove('hidden');
        }

        function renderCalendario() {
            const calendario = document.getElementById('calendario-view');
            if (!calendario) return;
            
            calendario.classList.remove('hidden');
        }

        function setupHistoricoFilters() {
            // Implementação dos filtros
        }

        function gerarRelatorio(tipo) {
            log(`Gerando relatório ${tipo}`);
        }

        function editarMinuta(id) {
            log(`Editando minuta ${id}`);
        }

        function excluirMinuta(id) {
            log(`Excluindo minuta ${id}`);
        }

        function atualizarStatus(id, status) {
            log(`Atualizando status da minuta ${id} para ${status}`);
        }

        function marcarComoCorrigida(id) {
            log(`Marcando minuta ${id} como corrigida`);
        }

        function fecharModalEdicao() {
            document.getElementById('modal-edicao').classList.add('hidden');
        }

        function fecharModalCorrecao() {
            document.getElementById('modal-correcao').classList.add('hidden');
        }

        function salvarEdicao() {
            log('Salvando edição');
        }

        function confirmarCorrecao() {
            log('Confirmando correção');
        }

        function navegarMes(direcao) {
            log(`Navegando mês: ${direcao}`);
        }

        function irParaHoje() {
            log('Indo para hoje');
        }

        function selecionarDia(data) {
            log(`Selecionando dia: ${data}`);
        }

        // ==================== EVENTOS ====================
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                lucide.createIcons();
                log('Aplicação carregada');
                
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        if (!document.getElementById('modal-edicao').classList.contains('hidden')) {
                            fecharModalEdicao();
                        }
                        if (!document.getElementById('modal-correcao').classList.contains('hidden')) {
                            fecharModalCorrecao();
                        }
                    }
                    
                    if (e.ctrlKey && e.key === 'Enter') {
                        if (!document.getElementById('modal-edicao').classList.contains('hidden')) {
                            salvarEdicao();
                        }
                        if (!document.getElementById('modal-correcao').classList.contains('hidden')) {
                            confirmarCorrecao();
                        }
                    }
                });
                
            } catch (error) {
                log('Erro na inicialização da página', error);
            }
        });
    </script>
</body>
</html>
